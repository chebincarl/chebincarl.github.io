<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="什么是状态模式状态(State)设计模式是GoF提出的最吸引人的模式之一,也是一种最有用的模式。游戏通常就采用状态模式,因为游戏中的对象往往会非常频繁地改变状态。状态模式的作用就是允许对象在状态改变时改变其行为。">
<meta property="og:type" content="article">
<meta property="og:title" content="状态设计模式">
<meta property="og:url" content="http://yoursite.com/2018/11/26/状态设计模式/index.html">
<meta property="og:site_name" content="车斌的博客">
<meta property="og:description" content="什么是状态模式状态(State)设计模式是GoF提出的最吸引人的模式之一,也是一种最有用的模式。游戏通常就采用状态模式,因为游戏中的对象往往会非常频繁地改变状态。状态模式的作用就是允许对象在状态改变时改变其行为。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/2.png">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/4.png">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/5.png">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/15.png">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/lights/nada.png">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/lights/brightest.png">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/lights/nada.pne">
<meta property="og:image" content="http://yoursite.com/2018/11/26/状态设计模式/lights/off.png">
<meta property="og:updated_time" content="2018-11-26T16:17:38.966Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="状态设计模式">
<meta name="twitter:description" content="什么是状态模式状态(State)设计模式是GoF提出的最吸引人的模式之一,也是一种最有用的模式。游戏通常就采用状态模式,因为游戏中的对象往往会非常频繁地改变状态。状态模式的作用就是允许对象在状态改变时改变其行为。">
<meta name="twitter:image" content="http://yoursite.com/2018/11/26/状态设计模式/2.png">






  <link rel="canonical" href="http://yoursite.com/2018/11/26/状态设计模式/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>状态设计模式 | 车斌的博客</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/26/状态设计模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Che Bin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">状态设计模式
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-26 22:55:04" itemprop="dateCreated datePublished" datetime="2018-11-26T22:55:04+08:00">2018-11-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-27 00:17:38" itemprop="dateModified" datetime="2018-11-27T00:17:38+08:00">2018-11-27</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="什么是状态模式"><a href="#什么是状态模式" class="headerlink" title="什么是状态模式"></a>什么是状态模式</h2><p>状态(State)设计模式是GoF提出的最吸引人的模式之一,也是一种最有用的模式。游戏通常就采用状态模式,因为游戏中的对象往往会非常频繁地改变状态。<font color="red">状态模式的作用就是允许对象在状态改变时改变其行为。<br><a id="more"></a></font></p>
<p>还有很多其他模拟应用(不一定是游戏)也依赖于状态模式。你会发现状态模式有很多应用(这一章将会谈到)。图10-1用类图方式显示了这种基本设计模式。<br>如图所示,这里没有Client类;不过, GoF指出Context是客户的主要接口。查看这个模式时,可以认为Client类通过ConText类做出请求。要理解并且有效地使用状态设计模式,需要了解很多内容,所以对目前来说,先来单看一下这个类图,具体的细节会在后面逐步展开。</p>
<img src="/2018/11/26/状态设计模式/2.png">
<h2 id="何时使用状态模式"><a href="#何时使用状态模式" class="headerlink" title="何时使用状态模式"></a>何时使用状态模式</h2><p>如前所述,游戏和模拟器开发人员通常使用状态模式来处理不同的状态。PHP中几乎每一个应用都会有一些状态改变,一个对象依赖于它的状态时,它肯定会频繁地改变,在这种情况下,状态模式就有绝对的优势。<br>对象中频繁的状态改变非常依赖于条件语句。就其自身来说,条件语句本身没有什么问题(如switch语句或那些带else子句的语句) 。不过,如果选项太多,以至于程序开始出现混乱,或者增加或改变选项需要花费太多时间,甚至成为一种负担,这就出现了问题。<br>先来看模拟器或游戏的一个简单例子。假设有一个3 x 3的矩阵,也就是9个状态,不同的单元格(共有9个单元格)会有不同的选择。考虑图10-2中的矩阵。</p>
<img src="/2018/11/26/状态设计模式/4.png">
<p>假设你创建了一个程序,可以上下移动和左右移动,但是不能沿对角线方向移动。如果在单元格5 (见图10-2)上,对象可以向任何方向移动(上下和左右都可以),不过除了这个单元格以外,采用传统方式编程时,对于其他单元格都需要某个条件语句。考虑单元格4的移动,可能会有类似下面的代码:<br>if($this-&gt;moveUp())<br>{<br>    $this-&gt;currentCell=$cell_1;<br>}<br>elseif ($this-&gt;moveDown())<br>{<br>    $this-&gt;currentCell=$cell_7;<br>}<br>elseif ($this-&gt;moveRight())<br>{<br>    $this-&gt;currentCell=$cell_5;<br>}<br>elseif ($this-&gt;moveLeft())<br>{<br>    $this-&gt;currentCell=$errorMove;<br>}</p>
<p>在此基础上,程序必须跟踪对象在哪些单元格“中” 。可以看到,条件语句的个数(或switch语句中的case个数)可能会大幅增长,使程序变得纠缠不清。<br>对于状态设计模式,每个状态都有自己的具体类,它们实现一个公共接口。我们不打算查看对象的控制流,而是从另一个角度来考虑,即对象的状态。下一节分析状态机,通过介绍,你将更好地理解“以状态为中心”的思路。</p>
<h2 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h2><p>状态机是一个模型,其重点包括不同的状态、一个状态到另一个状态的变迁,以及导致状态改变的触发器。要研究状态机,最好的起点是状态图(statechart) ,我们将用状态图来分析,而不是一个计算机流程图或类图。图10-3为一个简单的状态图,其中一个灯泡的状态从关(off)变为开(on) 。</p>
<img src="/2018/11/26/状态设计模式/5.png">
<p>与类图相似,状态图强调的是控制流以外的东西。从图10-3可以看到状态模型的本质:</p>
<ul>
<li>状态（关灯和开灯)</li>
<li>变迁(从关灯到开灯,以及从开灯到关灯)</li>
<li>触发器(灯开关).<br>对于打开和关上的灯,其状态、变迁和触发器都非常简单。变迁是即时的,触发器就是灯开关。不过,触发器请求一个改变之后,有些变迁可能需要渐进完成,或者要采用更复杂的方式完成。例如,天气触发树叶颜色的改变,这个变迁就是渐进完成的。不过,可以使用这个状态模型来理解从夏天状态变换到秋天状态,另外只要是通过一个触发器激活从一个状态到另一个状态的状态变迁,这种情况都可以使用这个状态模型来理解。</li>
</ul>
<h2 id="开灯关灯-最简单的状态设计模式"><a href="#开灯关灯-最简单的状态设计模式" class="headerlink" title="开灯关灯:最简单的状态设计模式"></a>开灯关灯:最简单的状态设计模式</h2><p>尽管状态机的概念相当简单,但要知道,即使是最基本的状态设计模式也可能很有难度。考虑到这一点,这个最简单的PHP模式例子将重点考虑创建模式的步骤。有一个好消息,如果你能完成一个简单的状态设计模式,那么更大规模的模式也能轻松应对。所以我们慢慢来,先来看这个模式中的各个参与者,</p>
<h3 id="情境为王"><a href="#情境为王" class="headerlink" title="情境为王"></a>情境为王</h3><p>所有状态模式都需要一个参与者来跟踪对象所处的状态。例如,对于前面的灯泡状态例子,就很有必要记住图10-2中的矩形。如果当前状态是单元格4,系统需要知道可以通过哪些变迁进入其他状态。这正是ConText类要完成的任务。要知道第一个例子只处理两个状态,即灯的状态(关或开) . Context要知道当前状态是什么。使用图10-3中的状态图作为指导,可以看到初始状态为关(由一个带箭头的黑色小球指示)。<br>作为一个参考点,首先来看ConText类。下面几小节将分析这个上下文,了解它的各个部分以及各部分的角色:</p>
<p>&lt;?php<br>//Context.php<br>class Context<br>{<br>    private $offState;<br>    private $onState;<br>    private $currentState;<br>    public function __construct()<br>    {<br>        $this-&gt;offState=new OffState($this);<br>        $this-&gt;onState=new OnState($this);</p>
<pre><code>    //开始状态为off
    $this-&gt;currentState=$this-&gt;offState;
}
//调用状态方法触发器
public function turnOnLight()
{
    $this-&gt;currentState-&gt;turnLightOn();
}

public function turnOffLight()
{
    $this-&gt;currentState-&gt;turnLightOff();
}
//设置当前状态
public function setState(IState $state)
{
    $this-&gt;currentstate=$state;
}

//获得状态
public function getOnState():
{
    return $this-&gt;onState;
}

public function getOffState()
{
    return $this-&gt;offState;
}
</code></pre><p>?&gt;</p>
<p>ConText类建立了3个属性,可见性均为私有(private) :<br>$offState<br>$onState<br>$currentState</p>
<p>前两个分别是两个状态的实例,第三个属性用来跟踪给定时间系统所处的状态。</p>
<p>ConText类中的状态实例<br>在构造函数中,Context实例化IState实现的两个实例–一个对应关(off)状态,另一个对应开(on)状态:<br>$this-&gt;offState=new OffState($this);<br>$this-&gt;onState=new OnState($this);</p>
<p>这个实例化过程用到了一种递归,称为自引用(self-referral) 。构造函数参数中的实参写为$this,这是Context类自身的一个引用。状态类希望接收一个ConText类实例作为参数,为了在ConText类中实例化一个状态实例,它必须使用sthis作为实参。</p>
<p>由于必然有某个状态作为启动时的当前状态,将$currentState属性赋为$offState值。(可以这样考虑,刚走进一个房间,当时灯是关着的。)这是offState类的一个实例。查看图10-3中的状态图,可以看到开始状态是off状态,所以代码只是遵循了状态图中的结构。</p>
<p><strong> 调用状态方法:上下文触发器方法 </strong></p>
<p>Context类中的一些方法要调用状态类中的方法。可以把这些方法想成是触发器(triggers) 。调用这些触发器,就会启动从当前状态到另外一个不同状态的变迁。举例来说,下面的方法就是一个触发器:<br>public function turnOnLight()<br>{<br>    $this-&gt;currentState-&gt;turnLightOn();<br>}<br>注意, context方法的名字与状态方法稍有不同:这里是turnonLight而不是turnLighton,这些差别只是为了将Context类中的触发器方法与状态实例中的方法相区别。</p>
<p><strong> 设置当前状态 </strong></p>
<p>Context类最重要的作用是跟踪当前状态,从而为系统提供一个正确的上下文或窗口。再回到图10-2中的矩阵,矩阵中的每一步移动都取决于当前单元格。对于单元格9,可以移到单元格8或单元格6 (不允许沿对角线方向移动) 。不过,系统必须知道它的当前状态是单元格9,这样才能知道有哪些选择。<br>要设置一个当前状态,必须以某种方式向Context类发送信息,指定当前状态。这是通过某个状态类完成的。一旦触发一个状态,这个状态就会向Context发送一个消息,指示“我是当前状态” :.<br>public function setState(IState $state)<br>{<br>    $this-&gt;currentState=$state;<br>}<br>setState()方法需要一个状态对象作为实参(由Istate类型提示指示) 。触发器方法触发时,它会调用一个状态和相关的方法。这个状态的方法必须向Context发送一个消息,指出现在该状态是当前状态。所以最近触发的状态会调用setState()方法,使它成为当前状态。</p>
<p><strong> 状态获取方法 </strong><br>最后, context类需要有办法得到当前状态发送的消息。这个消息通过获取方法传递。对于每一个状态, context都要有相应的获取方法。由于这个例子有两个状态类,所以只需要两个获取方法。Offstate的获取方法如下:.<br>public function getOffState()<br>{<br>    return $this-&gt;offState;<br>}</p>
<p>OnState的获取方法如下:<br>public function getOnState()<br>{<br>    return $this-&gt;onState;<br>}<br>在实现的状态类中可以看到,这些方法将在设置当前状态时使用。<br>Context类小结<br>Context实例化所有状态的实例,并设置默认状态。Context包含有一些方法,可以通过调用具体状态中的相应方法来触发不同的状态。设置方法会跟踪当前状态。为了帮助跟踪当前状态,对于每个状态Context还有一个获取方法,会在状态有改变调用。</p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><p>如果了解了具体状态类如何实现Istate接口,就更能看出Context类的意义。这个接口只包含两个要实现的状态方法:<br>&lt;?php<br>//IState.php<br>interface IState<br>{<br>    public function turnLightOn();<br>    public function turnLightOff();<br>}<br>?&gt;<br>在Context类中,这两个方法都称为状态改变触发器。不过,重要的细节都在以下这两个状态类的实现中: Onstate和OffState.</p>
<p>OnState</p>
<p>&lt;?php<br>//OnState.php<br>class OnState implements IState<br>{<br>    private $context;</p>
<pre><code>public function __construct(Context $contextNow)
{
    $this-&gt;context=$contextNow;
}
public function turnLightOn()
{  
    echo &quot;Light is already on-&gt; take no action&lt;br/&gt;&quot;;
}

public function turnLightOff()
{
    echo &quot;Lights off!&lt;br/&gt;&quot;;
    $this-&gt;context-&gt;setState(
    $this-&gt;context-getOffState());
}
</code></pre><p>}<br>?&gt;</p>
<p>OffState</p>
<p>&lt;?php<br>//OffState.php<br>class OffState implements IState<br>{<br>    private $context;<br>    public function __construct(Context $contextNow)<br>        $this-&gt;context=$contextNow;<br>    }<br>    public function turnLightOn()<br>    {<br>        echo “Lights on! Now I can see <br>“;<br>        $this-&gt;context-&gt;setState($this-&gt;context-&gt;getOnState());<br>    }</p>
<pre><code>public function turnLightOff()
{
    echo &quot;Light is already off-&gt; take no action&lt;br/&gt;&quot;;
}
</code></pre><p>}<br>?&gt;</p>
<p>Onstate和offstate类是Istate的简单实现,会有文本消息指示这些状态。状态类在构造函数中包含了Context类的一个引用。应该记得, Context会实例化状态实例,并为状态构造函数类提供一个自引用。<br>默认状态是Offstate,它必须实现IState方法turnLighton和turnLightoff. Context调用turnlighton方法,这会显示”Lights on! Now I can see” (开灯了,现在我能看见了)。然后它向Context方法getonstate发送一个消息,将Onstate作为当前状态。不过,如果是调用offState中的turnlightoff,就只有一个消息指示灯已经关了,不会有</p>
<p>任何动作。它不会重置Context中的当前状态,因为这已经是当前状态。基本说来,如果请求一个状态启动它自身,就什么也不会做。类似地,如果请求触发一个无法触发的状态,同样什么也不会做。<br>再来看图10-2中9个单元格的矩阵。从单元格3可以合法地移动到单元格2或单元格6。不过,在单元格3状态中,它不能上移或右移。所以,如果它接收到一个指令,要求启动一个它无法达到的状态,对于这种不可达到的状态,通常程序员会提供一个null条件。</p>
<h2 id="客户通过上下文做出请求"><a href="#客户通过上下文做出请求" class="headerlink" title="客户通过上下文做出请求"></a>客户通过上下文做出请求</h2><p>Client的所有请求都通过Context做出。 Client与任何状态类之间都没有直接连接,包括IState接口。下面的Client显示了触发两个状态类中所有方法的请求:<br>&lt;?php<br>//Client.php<br>function <strong>autoload($class_name)<br>{<br>    include $class_name . ‘.php’;<br>}<br>class Client<br>{<br>    private $context;<br>    public function </strong>construct()<br>    {<br>        $this-&gt;context=new Context();<br>        $this-&gt;context-&gt;turnOnLight();<br>        $this-&gt;context-&gt;turnOnLight();<br>        $this-&gt;context-&gt;turnOffLight();<br>        $this-&gt;context-&gt;turnOffLight();<br>    }<br>}<br>$worker=new Client();<br>?&gt;</p>
<p>实例化一个Context实例之后,初始请求是打开灯,因为灯的默认状态是“关” (off)状态。第二个请求是一样的,不过它只生成一个消息,指示系统目前所处的状态正是请求的这个状态,什么也不会发生。以下输出显示了这些请求的结果:</p>
<p>Lights on! Now I can see!<br>Light is already on-&gt; take no action<br>Lights off!<br>Light is already off-&gt; take no action</p>
<p>OffState请求的工作类似于OnState请求。如果变迁是从一个状态到另一个状态(off-&gt;on) ,就会启动这个改变。不过,如果再次请求当前状态(off-&gt;off) ,只会生成一个消息,指示什么也不会发生。</p>
<h2 id="增加状态"><a href="#增加状态" class="headerlink" title="增加状态"></a>增加状态</h2><p>对于所有设计模式来说,很重要的一个方面是:利用这些设计模式可以很容易地做出修改。与其他模式一样,状态模式同样也很易于更新和改变。对于前面最简单的例子(只包含基本的on/off状态) ,为了查看增加状态有什么影响,下面这个例子会扩展on/off状态,变成一个3路灯泡。在这个新应用中,状态将加倍,变成4个状态:</p>
<ul>
<li>关(Off)</li>
<li>开(On)</li>
<li>更亮(Brighter)</li>
<li>最亮(Brightest)</li>
</ul>
<p>图10-4显示了这个更新后的4态状态图。</p>
<img src="/2018/11/26/状态设计模式/15.png">
<p>查看这4个状态,序列有所改变。“关” (off)状态只能变到“开” (on)状态, on状态不能变到ff状态。实际上,现在规则有变化, on状态只能变到“更亮” (brighter)状态和“最亮” (brightest)状态。只有brightesr状态可以变到“关” (off)状态。</p>
<h3 id="改变接口"><a href="#改变接口" class="headerlink" title="改变接口"></a>改变接口</h3><p>要改变的第一个参与者是接口Istate,这个接口中必须指定相应的方法,可以用来迁移到brighter和brightest状态:<br>&lt;?php<br>//IState.php<br>interface IState<br>{<br>    public function turnLightOff();<br>    public function turnLightOn();<br>    public function turnBrighter();<br>    public function turnBrightest();<br>}<br>?&gt;<br>现在所有状态类都必须包括这4个方法,它们都需要结合到Context类中。</p>
<h3 id="改变状态"><a href="#改变状态" class="headerlink" title="改变状态"></a>改变状态</h3><p>状态设计模式中有改变时,这些新增的改变会对模式整体的其他各方面带来影响。不过,增加改变相当简单,因为状态图显示了变迁,而且在这种情况下,每个状态只有一个特定的变迁。我们不再使用文本,现在每个状态都有该状态的一个图形表示。如果变迁合法,就会显示一个特定的图像(如果变迁不合法,会显示nada.png图像) 。<br><strong> OffState </strong><br>&lt;?php<br>//OffState.php<br>class OffState implements IState<br>{<br>    private $context;<br>    public function __construct(Context $contextNow)<br>    {<br>        $this-&gt;contexto$contextNow;<br>    }</p>
<pre><code>public function turnLighton()
{
    echo &quot;&lt;img src=&apos;lights/on.png&apos;&gt;&quot;;
    $this-&gt;context-&gt;setState($this-&gt;context-getOnState());
}

public function turnBrighter()
{
    echo &quot;&lt;img src=&apos;lights/nada.png&apos;&gt;&quot;;
}
public function turnBrightest()
{
    echo &quot;&lt;img src=&apos;lights/nada.png&apos;&gt;&quot;;
}
public function turnLightOff()
{
    echo &quot;&lt;img src=&apos;lights/nada.png&apos;&gt;&quot;;
  }
</code></pre><p>}<br>?&gt;</p>
<p><strong> OnState </strong><br>&lt;?php<br>//OnState.php<br>class Onstate implements IState<br>{<br>    private $context;<br>    public function construct(Context $contextNow)sthis-&gt;contexts$contextNow:।<br>    public function turnlighton()</p>
<pre><code>}

echo &quot;&lt;img src=&apos;lights/nada.png&apos;&gt;&quot;;
.
public function turnBrighter()
-
echo &quot;&lt;img srcs&apos;lights/brighter.png&apos;&gt;&quot;;
sthis-&gt;context-&gt;setstate(sthis-&gt;context-getBrighterstate());public function turnBrightest().
echo &quot;&lt;img srcs&apos;lights/nada.png&apos;&gt;&quot;;
}
public function turnLightoff()
echo &quot;&lt;img src-&apos;lights/nada.png&apos;&gt;&quot;;
</code></pre><p>}</p>
<p><strong> BrighterState </strong><br>&lt;?php<br>//Brighterstate.php<br>class BrighterState implements IState<br>    private scontext;<br>    public function construct(Context $contextNow).t  1 $this-ycontext=$contextNow:public function turnlighton()techo “<img src-'lights="" nada.png'="">“;}<br>    public function turnBrighter()<br>        echo “<img src="lights/nada.png">“;}<br>    public function turnBrightest().<br>    .<br>        echo “<img src="lights/brightest.png">“;<br>    .$this-&gt;context-&gt;setstate(sthis-&gt;context-&gt;getBrightestState());public function turntightoff()<br>    echo “<img srce'lights="" nada.png'="">“;<br>}<br>?&gt;</p>
<p>-</p>
<p><strong> BrightestState </strong><br>&lt;?php<br>//Brighteststate.php</p>
<p>class BrightestState implements IState<br>    f orivate scontext;<br>    public function construct(Context scontextNow)<br>    $this-ycontext-scontextNow<br>    public function turnlighton()1<br>    1  echo “ime src=’lights/nada.png’&gt;”;public function turnBrighter()<br>        echo “<img src="lights/nada.pne">“;}<br>    public function turnBrightest()<br>        echo “&lt;img src=”lights/nada.png’ “;1<br>    public function turnlightoff()<br>    echo “<img src="lights/off.png">“;<br>}<br>?&gt;<br>$this-&gt;context-&gt;setstate(sthis-&gt;context-getoffstate());<br>需要说明,各个状态的方法中有且仅有一个方法会建立负图像。不过,三路灯具正是采用这种方式使用三路灯泡。打开灯之后,它必须经过另外两个状态(brighter和brightest),才会最后关掉。<br>10.5.3更新Context类<br>最后一步是更新Context类,增加新的触发器,并加入新状态。另外, Context还需要为每个新状态增加状态实例和获取方法:<br>&lt;?phg<br>//Context.phpclass Context</p>
<p>private soffState;<br>private $onState;<br>private sbrighterstate:private $brightestState;private scurrentstate;public function construct().t sthis-offstate-new OffState(sthis);<br>    $this-&gt;onstatemnew Onstate(sthis);<br>-</p>
<p>sthis-brighterstate-new Brighterstate(sthis);$this-&gt;brighteststate-new Brighteststate(sthis);<br>1/开始状态为0ff<br>sthis-xcurrentstate-sthis-&gt;offstate:<br>//调用状态方法<br>public function turnOnLight().।<br>}  sthis-&gt;currentState-&gt;turnLightOn();public function turnoffLightC)।<br>了  sthis-&gt;currentstate-&gt;turnlightoff(:public function turnBrighterLight(<br>1  1 Sthis-currentState-&gt;turnBrighter():public function turnBrightestlight()t<br>    sthis-&gt;currentstate-&gt;turnBrightest();//设置当前状态<br>public function setstate(Istate state?।<br>    sthis-ocurrentstate=sstate</p>
<p>,<br>//获得状态public function getonstate().1<br>}  return sthis-onstatepublic function getoffstate()return sthis-offstate;।public function getBrighterstate()<br>    return sthis-brighterstate;</p>
<p>上public function getBrightestState()(return sthis-&gt;brightestState;</p>
<p>增加的代码与之前状态的方法以及实例化是一样的。尽管Context类增加了代码,不过与原来的代码很类似,只是有更多内容。</p>
<p>10.5.4更新客户<br>在最初的例子中, Client可以请求两个状态on或off. 增加两个状态后, Client有了更多选择,不过默认状态仍然是off,第一个请求必然是on状态。一旦建立on状态,接下来可以请求brighter状态,然后是brightes状态,之后才能再次请求off:<br>&lt;?php<br>//Client.php<br>function autoload(sclass name)t<br>include sclass name. “.php’;<br>class Client<br>private $context;<br>public function construct()<br>sthis-&gt;context-new Context();<br>sthis-&gt;context-&gt;turnOnLight();<br>sthis-&gt;context-&gt;turnBrighterLight();$this-&gt;context-&gt;turnBrightestLight();sthis-&gt;context-&gt;turnoffLight();<br>sthis-xcontext-&gt;turnBrightestLight();<br>sworker-new Client();</p>
<p>修改后的Client中,按正确的序列发出请求,首先变迁到on状态。不过,在经过各个不同状态回到0f状态之后, Client请求返回brightest状态。此时,会出现“错误指示灯” 。图10-5显示了请求序列得到的不同图像。<br>前面4个灯泡从左到右分别显示了on, brighter, brightest和off状态。不过,第5个灯泡指示请求出现错误。在典型的状态模式实现中,不会出现错误消息(或图像) 。这个请求将被简单忽略。</p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/26/MySQL事务机制/" rel="next" title="MySQL事务机制">
                <i class="fa fa-chevron-left"></i> MySQL事务机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/27/MySQL优化/" rel="prev" title="MySQL优化">
                MySQL优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Che Bin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是状态模式"><span class="nav-number">1.</span> <span class="nav-text">什么是状态模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#何时使用状态模式"><span class="nav-number">2.</span> <span class="nav-text">何时使用状态模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#状态机"><span class="nav-number">3.</span> <span class="nav-text">状态机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开灯关灯-最简单的状态设计模式"><span class="nav-number">4.</span> <span class="nav-text">开灯关灯:最简单的状态设计模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#情境为王"><span class="nav-number">4.1.</span> <span class="nav-text">情境为王</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#状态"><span class="nav-number">5.</span> <span class="nav-text">状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#客户通过上下文做出请求"><span class="nav-number">6.</span> <span class="nav-text">客户通过上下文做出请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#增加状态"><span class="nav-number">7.</span> <span class="nav-text">增加状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#改变接口"><span class="nav-number">7.1.</span> <span class="nav-text">改变接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#改变状态"><span class="nav-number">7.2.</span> <span class="nav-text">改变状态</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Che Bin</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
