<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  Delegate和delegate的区别是什么？public abstract Delegate Action {get;set;}是什么意思？ internal和public的区别是什么？哪个范围更大？ IEnumerator里面基本都是while(true)。怎么理解？ 每个a.json文件都对应一个a.cs实体数据文件。暗黑战神每个xml对应一个数据实体cs文件，都是">
<meta name="keywords" content="商业源码">
<meta property="og:type" content="article">
<meta property="og:title" content="暗黑战神">
<meta property="og:url" content="http://chebincarl.github.io/2018/11/08/暗黑战神/index.html">
<meta property="og:site_name" content="车斌的博客">
<meta property="og:description" content="思考并回答以下问题：  Delegate和delegate的区别是什么？public abstract Delegate Action {get;set;}是什么意思？ internal和public的区别是什么？哪个范围更大？ IEnumerator里面基本都是while(true)。怎么理解？ 每个a.json文件都对应一个a.cs实体数据文件。暗黑战神每个xml对应一个数据实体cs文件，都是">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://chebincarl.github.io/2018/11/08/暗黑战神/1.png">
<meta property="og:image" content="http://chebincarl.github.io/2018/11/08/暗黑战神/2.png">
<meta property="og:image" content="http://chebincarl.github.io/2018/11/08/暗黑战神/3.png">
<meta property="og:updated_time" content="2019-11-27T13:15:40.405Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="暗黑战神">
<meta name="twitter:description" content="思考并回答以下问题：  Delegate和delegate的区别是什么？public abstract Delegate Action {get;set;}是什么意思？ internal和public的区别是什么？哪个范围更大？ IEnumerator里面基本都是while(true)。怎么理解？ 每个a.json文件都对应一个a.cs实体数据文件。暗黑战神每个xml对应一个数据实体cs文件，都是">
<meta name="twitter:image" content="http://chebincarl.github.io/2018/11/08/暗黑战神/1.png">






  <link rel="canonical" href="http://chebincarl.github.io/2018/11/08/暗黑战神/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>暗黑战神 | 车斌的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注，重复10遍</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chebincarl.github.io/2018/11/08/暗黑战神/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chebin">
      <meta itemprop="description" content="记录自己的学习过程">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">暗黑战神

              
            
          </h1>
        

        <div class="post-meta">

          
            <i class="fa fa-thumb-tack"></i>
            <font color="FF0000">置顶</font>
            <span class="post-meta-divider">|</span>
          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-08 11:25:02" itemprop="dateCreated datePublished" datetime="2018-11-08T11:25:02+08:00">2018-11-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-11-27 21:15:40" itemprop="dateModified" datetime="2019-11-27T21:15:40+08:00">2019-11-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">204k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">3:05</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>Delegate和delegate的区别是什么？public abstract Delegate Action {get;set;}是什么意思？</li>
<li>internal和public的区别是什么？哪个范围更大？</li>
<li>IEnumerator里面基本都是while(true)。怎么理解？</li>
<li>每个a.json文件都对应一个a.cs实体数据文件。暗黑战神每个xml对应一个数据实体cs文件，都是GameData的子类。然后还有一个GameDataController类来管理所有这些GameData的子类。怎么理解？</li>
<li>静态构造函数主要目的是用于初始化一些静态的变量。怎么理解？</li>
<li>基本没有脚本是预先挂载的，都是动态挂载。</li>
<li>扩展方法第一个参数前缀为this，表示需要扩展类对象，从第二个参数开始，为扩展方法参数列表。怎么理解？</li>
<li>default(T)是什么意思？为什么要这样写？if(default(T) == null)是判断什么的？</li>
</ul>
<a id="more"></a>
<h1 id="资源加载"><a href="#资源加载" class="headerlink" title="资源加载"></a>资源加载</h1><p>Unity3d常用的两种加载资源方案：Resources.Load和AssetBundle。</p>
<p>1、Resources.Load：使用这种方式加载资源，首先需要在Asset目录下创建一个名为Resources的文件夹，这个命名是U3D规定的方式，然后把资源文件放进去，当然也可以在Resources中再创建子文件夹，当然在代码加载时需要添加相应的资源路径。</p>
<p>2、项目中更常用的是使用AssetBundle的方式动态加载游戏对象。<br>使用AssetBundle打包预设或者场景可以将与其相关的所有资源打包，这样很好地解决资源的依赖问题，使得我们可以方便的加载GameObject。</p>
<blockquote>
<p>\client\Assets\Scripts\ClientCore\Resource.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Resource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> AssetBundleCreateRequest createRequest;</span><br><span class="line">    <span class="keyword">internal</span> WWW www;</span><br><span class="line">    <span class="keyword">internal</span> List&lt;Resource&gt; dependencies;</span><br><span class="line">    <span class="keyword">internal</span> Byte[] fileData;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> referenceCount;</span><br><span class="line">    <span class="keyword">internal</span> UnityEngine.Object m_object;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">bool</span> m_isDone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">float</span> m_progress</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (www != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> www.progress;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> RelativePath &#123; <span class="keyword">get</span>; <span class="keyword">internal</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsLoading &#123; <span class="keyword">get</span>; <span class="keyword">internal</span> <span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>client\Assets\Scripts\ClientCore\ResourceManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Eddy;</span><br><span class="line"><span class="keyword">using</span> Eddy.Extensions;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Security;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Util</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 静态类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ResourceManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> MetaFileName = <span class="string">"Meta.xml"</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, Resource&gt; resources = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Resource&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; <span class="title">GetResourceRoots</span>(<span class="params"><span class="keyword">string</span> resourceName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> resources)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (item.Value.dependencies != <span class="literal">null</span> &amp;&amp; item.Value.dependencies.FirstOrDefault(t =&gt; Utils.GetFileNameWithoutExtention(t.RelativePath) == resourceName) != <span class="literal">null</span>)</span><br><span class="line">                    result.Add(item.Key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="游戏初始化"><a href="#游戏初始化" class="headerlink" title="游戏初始化"></a>游戏初始化</h1><img src="/2018/11/08/暗黑战神/1.png">
<img src="/2018/11/08/暗黑战神/2.png">
<img src="/2018/11/08/暗黑战神/3.png">
<p>最开始的是InitScene，只有这个场景在Scenes文件下，其他都在Resources文件夹下。这个场景只有一个Driver空对象，带有Initializer脚本。这个脚本放在Plugins文件夹下。</p>
<blockquote>
<p>\client\Assets\Plugins\Init\Initializer.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Initializer</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        gameObject.AddComponent&lt;Driver&gt;();</span><br><span class="line">        DestroyImmediate(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\MogoSolution\LoaderLib\Init\PluginCallback.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Plugins\Init\Driver.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UNITY_IPHONE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Driver</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> bLoodLib = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String FileName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"MogoRes"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// C#的DES只支持64bits的Key</span></span><br><span class="line">    <span class="comment">// http://msdn.microsoft.com/en-us/library/system.security.cryptography.des.key(VS.80).aspx</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] Number</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Utils.GetResNumber();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> IsRunOnAndroid = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> Action LevelWasLoaded;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Driver Instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UNITY_EDITOR</span></span><br><span class="line">        LoggerHelper.CurrentLogLevels = LogLevel.Info | LogLevel.ERROR | LogLevel.CRITICAL | LogLevel.EXCEPT; <span class="comment">// | LogLevel.WARNING</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>        </span></span><br><span class="line">        LoggerHelper.Info(<span class="string">"Game Start!"</span>);</span><br><span class="line">        SystemSwitch.InitSystemSwitch();</span><br><span class="line">        <span class="comment">// 防止设备休眠</span></span><br><span class="line">        Screen.sleepTimeout = (<span class="keyword">int</span>)SleepTimeout.NeverSleep;</span><br><span class="line">        DontDestroyOnLoad(transform.gameObject);</span><br><span class="line">        Instance = <span class="keyword">this</span>;</span><br><span class="line">        gameObject.AddComponent&lt;DriverLib&gt;();</span><br><span class="line">        Application.targetFrameRate = <span class="number">30</span>;</span><br><span class="line">        DefaultUI.InitLanguageInfo();</span><br><span class="line">        GameObject.Find(<span class="string">"MogoForwardLoadingUIPanel"</span>).AddComponent&lt;MogoForwardLoadingUIPanel&gt;();</span><br><span class="line">        TryToInit();</span><br><span class="line">        <span class="comment">// 1秒后调用Tick方法，之后每隔0.02秒调用一次</span></span><br><span class="line">        InvokeRepeating(<span class="string">"Tick"</span>, <span class="number">1</span>, <span class="number">0.02f</span>);</span><br><span class="line">        gameObject.AddComponent&lt;AudioListener&gt;()</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a><span style="color:#339AFF;">配置文件</span></h1><h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a><span style="color:#00ACC1;">XML</span></h2><blockquote>
<p>暗黑战神\client\Assets\Resources\data\xml\FXData.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">record</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>910101<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionID</span>&gt;</span>8<span class="tag">&lt;/<span class="name">actionID</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span>Bip_master<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">duration</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">duration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">isConflict</span>&gt;</span>1<span class="tag">&lt;/<span class="name">isConflict</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">isStatic</span>&gt;</span>0<span class="tag">&lt;/<span class="name">isStatic</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span>&gt;</span>0<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>0<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">locationType</span>&gt;</span>1<span class="tag">&lt;/<span class="name">locationType</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>0.0, 0.0, 0.0<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">player</span>&gt;</span>Avatar_101_blade<span class="tag">&lt;/<span class="name">player</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resourcePath</span>&gt;</span>H_blade_skill_1_1.prefab<span class="tag">&lt;/<span class="name">resourcePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">record</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>910102<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionID</span>&gt;</span>8<span class="tag">&lt;/<span class="name">actionID</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span>Bip_master<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">duration</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">duration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">isConflict</span>&gt;</span>1<span class="tag">&lt;/<span class="name">isConflict</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">isStatic</span>&gt;</span>0<span class="tag">&lt;/<span class="name">isStatic</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span>&gt;</span>0<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>0<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">locationType</span>&gt;</span>3<span class="tag">&lt;/<span class="name">locationType</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>0.0, 0.0, 0.0<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">player</span>&gt;</span>Avatar_101_blade<span class="tag">&lt;/<span class="name">player</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resourcePath</span>&gt;</span>H_blade_skill_1_2.prefab<span class="tag">&lt;/<span class="name">resourcePath</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">delay</span>&gt;</span>0.23<span class="tag">&lt;/<span class="name">delay</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>MogoSolution\GameData\GameData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，公司名</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：GameData</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：配置数据抽象类。</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> HMF;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">GameData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> id &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, T&gt; GetDataMap&lt;T&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            Dictionary&lt;<span class="keyword">int</span>, T&gt; dataMap;</span><br><span class="line">            <span class="comment">// Stopwatch一般用来测量代码执行所用的时间或者计算性能数据，在优化代码性能上可以使用Stopwatch来测量时间。</span></span><br><span class="line">            Stopwatch sw = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">            sw.Start();</span><br><span class="line">            <span class="keyword">var</span> type = <span class="keyword">typeof</span>(T);</span><br><span class="line">            <span class="comment">// 继承GameData的子类有这个字段</span></span><br><span class="line">            <span class="keyword">var</span> fileNameField = type.GetField(<span class="string">"fileName"</span>); <span class="comment">// 返回FieldInfo类型</span></span><br><span class="line">            <span class="keyword">if</span> (fileNameField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> fileName = fileNameField.GetValue(<span class="literal">null</span>) <span class="keyword">as</span> String; <span class="comment">// 如果该字段为静态，obj则忽略。对于非静态字段，obj应为继承或声明该字段的类的实例。</span></span><br><span class="line">                <span class="keyword">var</span> result = GameDataControler.Instance.FormatData(fileName, <span class="keyword">typeof</span>(Dictionary&lt;<span class="keyword">int</span>, T&gt;), type); <span class="comment">// 返回实例对象</span></span><br><span class="line">                <span class="comment">// (xml/FXData, Type类实例(Dictionary), Type类实例(FXData))</span></span><br><span class="line">                dataMap = result <span class="keyword">as</span> Dictionary&lt;<span class="keyword">int</span>, T&gt;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                dataMap = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, T&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            sw.Stop();</span><br><span class="line">            LoggerHelper.Info(String.Concat(type, <span class="string">" time: "</span>, sw.ElapsedMilliseconds));</span><br><span class="line">            <span class="keyword">return</span> dataMap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class GameData&lt;T&gt; : GameData where T : GameData&lt;T&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, T&gt; m_dataMap;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, T&gt; dataMap</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_dataMap == <span class="literal">null</span>)</span><br><span class="line">                    m_dataMap = GetDataMap&lt;T&gt;();</span><br><span class="line">                <span class="keyword">return</span> m_dataMap;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_dataMap = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataControler</span> : <span class="title">DataLoader</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Type&gt; m_defaultData = <span class="keyword">new</span> List&lt;Type&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">typeof</span>(GlobalData), <span class="keyword">typeof</span>(MapData), <span class="keyword">typeof</span>(LanguageData), <span class="keyword">typeof</span>(UIMapData),<span class="keyword">typeof</span>(SoundData), <span class="keyword">typeof</span>(InstanceLevelGridPosData),<span class="keyword">typeof</span>(MapUIMappingData)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> GameDataControler m_instance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> state GameDataControler Instance </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_instance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 静态构造函数是在构造函数方法前面添加了static关键字之后形成的，并且没有修饰符(public,private)，没有参数。</span></span><br><span class="line">        <span class="comment">// 若一个类中有静态构造函数，在首次实例化该类或任何的静态成员被引用时，.NET自动调用静态构造函数来初始化该类。注意是“首次”，即继续实例化该类时，不会调用该类的静态构造函数。</span></span><br><span class="line">        <span class="comment">// 主要目的是用于初始化一些静态的变量。</span></span><br><span class="line">        <span class="comment">// 如果我们在类中定义了静态变量，但是又没有定义静态构造函数，那么框架也会帮助我们来生成一个静态构造函数来让框架自身来调用。</span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="title">GameDataControler</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_instance = <span class="keyword">new</span> GameDataControler();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">object</span> <span class="title">FormatData</span>(<span class="params"><span class="keyword">string</span> fileName, Type dicType, Type type</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (SystemSwitch.UseHmf)</span><br><span class="line">                <span class="keyword">return</span> FormatHmfData(String.Concat(m_resourcePath, fileName, m_fileExtention), dicType, type);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> FormatXMLData(String.Concat(m_resourcePath, fileName, m_fileExtention), dicType, type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> xml</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回Dictionary<span class="doctag">&lt;int, FXData&gt;</span>字典</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="fileName"&gt;</span>文件路径与文件名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dicType"&gt;</span>字典Type<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="type"&gt;</span>子类Type<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">object</span> <span class="title">FormatXMLData</span>(<span class="params"><span class="keyword">string</span> fileName, Type dicType, Type type</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">object</span> result = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LoggerHelper.Debug(fileName);</span></span><br><span class="line">                <span class="comment">//var dicType = dicProp.PropertyType;</span></span><br><span class="line">                <span class="comment">// Type.EmptyTypes表示Type类型的空数组。此字段为只读。</span></span><br><span class="line">                <span class="comment">// 相当于new一个字典类型</span></span><br><span class="line">                result = dicType.GetConstructor(Type.EmptyTypes).Invoke(<span class="literal">null</span>);</span><br><span class="line">                Dictionary&lt;Int32, Dictionary&lt;String, String&gt;&gt; map;<span class="comment">// int32为id,string为属性名,string为属性值</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 以FXData举例，实例化FXData对象并根据xml给其属性赋值</span></span><br><span class="line">                <span class="keyword">if</span> (XMLParser.LoadIntMap(fileName, m_isUseOutterConfig, <span class="keyword">out</span> map))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 返回PropertyInfo[]表示当前PropertyInfo的所有公共属性的Type对象数组。</span></span><br><span class="line">                    <span class="keyword">var</span> props = type.GetProperties();<span class="comment">// 获取实体属性</span></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> map)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> t = type.GetConstructor(Type.EmptyTypes).Invoke(<span class="literal">null</span>);<span class="comment">// 构造实体实例</span></span><br><span class="line">                        <span class="keyword">foreach</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> props)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (prop.Name == <span class="string">"id"</span>)</span><br><span class="line">                            &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// PropertyInfo.SetValue 设置指定对象的属性值。</span></span><br><span class="line">                                <span class="comment">// t 将设置其属性值的对象。</span></span><br><span class="line">                                <span class="comment">// item.Key 新的属性值。</span></span><br><span class="line">                                prop.SetValue(t, item.Key, <span class="literal">null</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">if</span> (item.Value.ContainsKey(prop.Name))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">var</span> <span class="keyword">value</span> = Utils.GetValue(item.Value[prop.Name], prop.PropertyType);</span><br><span class="line">                                    prop.SetValue(t, <span class="keyword">value</span>, <span class="literal">null</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// Dictionary&lt;int, T&gt;</span></span><br><span class="line">                        <span class="comment">// MethodBase.Invoke 调用由此MethodInfo实例反射的方法或构造函数。</span></span><br><span class="line">                        <span class="comment">// 使用指定参数调用由当前实例表示的方法或构造函数。</span></span><br><span class="line">                        <span class="comment">// result 在其上调用方法或构造函数的对象。</span></span><br><span class="line">                        <span class="comment">// new object[] &#123; item.Key, t &#125; 调用方法或构造函数的参数列表。</span></span><br><span class="line">                    </span><br><span class="line">                        <span class="comment">// 即调用Add方法，存入数据</span></span><br><span class="line">                        dicType.GetMethod(<span class="string">"Add"</span>).Invoke(result, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; item.Key, t &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Error(<span class="string">"FormatData Error: "</span> + fileName + <span class="string">"  "</span> + ex.Message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">Action&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; progress = <span class="literal">null</span>, Action finished = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载数据逻辑</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="gameDataType"&gt;</span>加载数据列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="formatData"&gt;</span>处理数据方法<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="progress"&gt;</span>数据处理进度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadData</span>(<span class="params">List&lt;Type&gt; gameDataType, Func&lt;<span class="keyword">string</span>, Type, Type, <span class="keyword">object</span>&gt; formatData, Action&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; progress</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> count = gameDataType.Count;</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> gameDataType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// BindingFlags.DeclaredOnly，仅搜索Type上声明的成员，而不搜索被简单继承的成员。</span></span><br><span class="line">            <span class="keyword">var</span> p = item.GetProperty(<span class="string">"dataMap"</span>, ~BindingFlags.DeclaredOnly);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> fileNameField = item.GetField(<span class="string">"fileName"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p != <span class="literal">null</span> &amp;&amp; fileNameField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> fileName = fileNameField.GetValue(<span class="literal">null</span>) <span class="keyword">as</span> String;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// public abstract Type PropertyType &#123; get; &#125;</span></span><br><span class="line">                <span class="keyword">var</span> result = formatData(String.Concat(m_resourcePath, fileName, m_fileExtention), p.PropertyType, item);</span><br><span class="line">                <span class="comment">// GetSetMethod()返回此属性的公共set访问器。</span></span><br><span class="line">                <span class="comment">// public abstract System.Reflection.MethodInfo GetSetMethod (bool nonPublic);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// MethodInfo.Invoke(Object, Object[])</span></span><br><span class="line">                <span class="comment">// public object Invoke (object obj, object[] parameters);</span></span><br><span class="line">                p.GetSetMethod().Invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="keyword">object</span>[]&#123;result&#125;);</span><br><span class="line">                <span class="keyword">if</span> (progress != <span class="literal">null</span>)</span><br><span class="line">                    progress(i, count);</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">DataLoader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">bool</span> m_isPreloadData = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> String m_resourcePath; <span class="comment">// 资源路径</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> String m_fileExtention; <span class="comment">// 文件扩展名</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> <span class="keyword">bool</span> m_isUseOutterConfig;</span><br><span class="line">    <span class="keyword">protected</span> Action&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; m_progress; <span class="comment">// 加载进度</span></span><br><span class="line">    <span class="keyword">protected</span> Action m_finished; <span class="comment">// 完成后的回调</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">DataLoader</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_isUseOutterConfig = SystemConfig.IsUseOutterConfig;</span><br><span class="line">        <span class="keyword">if</span> (m_isUseOutterConfig)</span><br><span class="line">        &#123;</span><br><span class="line">            m_resourcePath = String.Concat(SystemConfig.OutterPath, SystemConfig.CONFIG_SUB_FOLDER);</span><br><span class="line">            m_fileExtention = SystemConfig.XML;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            m_resourcePath = SystemConfig.CONFIG_SUB_FOLDER;<span class="comment">//兼容文件模块</span></span><br><span class="line">            m_fileExtention = SystemConfig.CONFIG_FILE_EXTENSION;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>暗黑战神\client\MogoSolution\GameData\FXData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，公司名</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：FXData</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：特效配置实体。</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class FXData : GameData&lt;FXData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> player &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否一直保留。0不保留，1保留</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> FXStatic isStatic &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否与其他特效冲突。0不冲突，1冲突</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> FXConflict isConflict &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 0为普通，1为飞行物</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> EffectType effectType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> FXLocationType locationType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> level &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> <span class="keyword">group</span> &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Vector3 location &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String slot &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String resourcePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> duration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String weaponTailSlot &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String weaponTailMaterial &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> weaponTailEmitTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> weaponTailLeftTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> weaponTailDurationTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> weaponTailSubdivisions &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String anim &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> soundDelay &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> fadeDelay &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> fadeDulation &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> fadeStart &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> fadeEnd &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String shader &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; rimWidth &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; rimPower &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; finalPower &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; r &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; g &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; b &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; a &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; shaderDuration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String dissonShader &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String nosieTexture &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> nosieOffetFrom &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> nosieOffetTo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Color dissonColor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> dissonDuration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> dissonDelay &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// xml文件路径，这个字段会在加载xml使用</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/FXData"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> EffectType : <span class="keyword">byte</span></span><br><span class="line">    &#123;</span><br><span class="line">        Normal = <span class="number">0</span>,</span><br><span class="line">        Flying = <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> FXConflict : <span class="keyword">byte</span></span><br><span class="line">    &#123;</span><br><span class="line">        NotConflict = <span class="number">0</span>,</span><br><span class="line">        Conflict = <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> FXStatic : <span class="keyword">byte</span></span><br><span class="line">    &#123;</span><br><span class="line">        NotStatic = <span class="number">0</span>,</span><br><span class="line">        Static = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> FXLocationType : <span class="keyword">byte</span></span><br><span class="line">    &#123;</span><br><span class="line">        World = <span class="number">0</span>,</span><br><span class="line">        SelfLocal = <span class="number">1</span>,</span><br><span class="line">        SelfSlot = <span class="number">2</span>,</span><br><span class="line">        SelfWorld = <span class="number">3</span>,</span><br><span class="line">        SlotWorld = <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用FXData</strong></p>
<p>1、FXData.dataMap.ContainsKey(hitFx)<br>2、Linq<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FXData.dataMap.Values.Where(t =&gt; t.player.Contains(playerName) &amp;&amp; !String.IsNullOrEmpty(t.resourcePath) &amp;&amp; !t.resourcePath.Contains(weaponType)).Select(t =&gt; t.resourcePath)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fx = FXData.dataMap.Get(id);</span><br></pre></td></tr></table></figure>
<h1 id="MogoSolution"><a href="#MogoSolution" class="headerlink" title="MogoSolution"></a><span style="color:#339AFF;">MogoSolution</span></h1><blockquote>
<p>\client\MogoSolution\LoaderLib\Utils\SystemConfig.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：SystemConfig</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：系统参数配置。</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Util</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 系统参数配置。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment">// C#可以将类、结构或接口的定义拆分到两个或多个源文件中，在类声明前添加partial关键字即可。</span></span><br><span class="line">    <span class="comment">// （一）什么情况下使用分部类？</span></span><br><span class="line">    <span class="comment">// 处理大型项目时，使一个类分布于多个独立文件中可以让多位程序员同时对该类进行处理（相当于支持并行处理，很实用）；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">SystemConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 常量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">string</span> XML = <span class="string">".xml"</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">string</span> CONFIG_SUB_FOLDER = <span class="string">"data/"</span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">ulong</span>, String&gt; GuideTimes&#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> IsUseOutterConfig</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Debug(<span class="string">"Application.platform: "</span> + Application.platform);</span><br><span class="line">                <span class="keyword">if</span> (Application.platform == RuntimePlatform.Android)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Directory.Exists(String.Concat(AndroidPath, CONFIG_SUB_FOLDER)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Application.platform == RuntimePlatform.IPhonePlayer)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Directory.Exists(String.Concat(IOSPath, CONFIG_SUB_FOLDER)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Application.platform == RuntimePlatform.WindowsPlayer)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Directory.Exists(String.Concat(PCPath, CONFIG_SUB_FOLDER)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 外部资源目录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> String OutterPath</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Debug(<span class="string">"Application.platform: "</span> + Application.platform);</span><br><span class="line">                <span class="keyword">if</span> (Application.platform == RuntimePlatform.Android)</span><br><span class="line">                    <span class="keyword">return</span> AndroidPath;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Application.platform == RuntimePlatform.IPhonePlayer)</span><br><span class="line">                    <span class="keyword">return</span> IOSPath;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Application.platform == RuntimePlatform.WindowsPlayer)</span><br><span class="line">                    <span class="keyword">return</span> PCPath;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Application.platform == RuntimePlatform.WindowsEditor)</span><br><span class="line">                    <span class="keyword">return</span> PCPath;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Application.platform == RuntimePlatform.OSXEditor)</span><br><span class="line">                    <span class="keyword">return</span> IOSPath;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>MogoSolution\Common\Utils\MecanimEvent.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，公司名</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：MecanimEvent</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：动作事件触发器。</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MecanimEvent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Animator m_animator;</span><br><span class="line">    <span class="keyword">private</span> AnimationClip m_currentMark;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_isNotFadeing = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> passTime = <span class="number">0</span>; <span class="comment">// 当前帧累积时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构造函数。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="animator"&gt;</span>Mecanim动作系统对象。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MecanimEvent</span>(<span class="params">Animator animator</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_animator = animator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监测动作状态变迁。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="StateChanged"&gt;</span>动画状态变化事件。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> String: 动画名称。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Boolean: 动画变化状态。true: 动画开始；false: 动画结束。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>迭代器。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnumerator <span class="title">CheckAnimationChange</span>(<span class="params">Action&lt;<span class="keyword">string</span>, Boolean&gt; StateChanged</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> state = m_animator.GetCurrentAnimationClipState(<span class="number">0</span>); <span class="comment">// 获取当前播放动作状态</span></span><br><span class="line">            <span class="keyword">if</span>(state.Length != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (state[<span class="number">0</span>].weight != <span class="number">1</span>) <span class="comment">// 当前动作正在融合</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 判断已标记为融合，如果不是融合，则表示为刚开始融合，此刻为下一个动作的开始点</span></span><br><span class="line">                    <span class="keyword">if</span> (m_isNotFadeing)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> nextState = m_animator.GetNextAnimationClipState(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (StateChanged != <span class="literal">null</span> &amp;&amp; nextState.Length != <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            StateChanged(nextState[<span class="number">0</span>].clip.name, <span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        m_currentMark = state[<span class="number">0</span>].clip; <span class="comment">// 更新当前动作</span></span><br><span class="line">                        m_isNotFadeing = <span class="literal">false</span>; <span class="comment">// 标记为融合状态</span></span><br><span class="line">                        <span class="comment">// 等待直到下一个固定帧速率更新函数。</span></span><br><span class="line">                        <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForFixedUpdate</span>(<span class="params"></span>)</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> </span><br><span class="line">                &#123;   </span><br><span class="line">                    <span class="comment">// 在动作变迁时，state会瞬间变为新动作，weight变为1，所以需判断state是否已改变，此刻为旧动作结束点</span></span><br><span class="line">                    <span class="keyword">if</span> (m_currentMark != state[<span class="number">0</span>].clip)</span><br><span class="line">                    &#123; </span><br><span class="line">                        <span class="keyword">if</span> (m_currentMark != <span class="literal">null</span> &amp;&amp; StateChanged != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            StateChanged(m_currentMark.name, <span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        m_currentMark = state[<span class="number">0</span>].clip; ;<span class="comment">// 更新当前动作</span></span><br><span class="line">                        m_isNotFadeing = <span class="literal">true</span>; <span class="comment">// 标记为非融合状态</span></span><br><span class="line"></span><br><span class="line">                        <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForFixedUpdate</span>(<span class="params"></span>)</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForFixedUpdate</span>(<span class="params"></span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监测动作状态变迁。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="StateChanged"&gt;</span>动画状态变化事件。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> String: 动画名称。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Boolean: 动画变化状态。true: 动画开始；false: 动画结束。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>迭代器。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnumerator <span class="title">CheckAnimationChange</span>(<span class="params">Action&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt; StateChanged</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> state = m_animator.GetCurrentAnimatorStateInfo(<span class="number">0</span>);<span class="comment">//获取当前播放动作状态</span></span><br><span class="line">            passTime = passTime + Time.deltaTime;</span><br><span class="line">            <span class="keyword">if</span> (passTime &gt;= state.length)</span><br><span class="line">            &#123;</span><br><span class="line">                StateChanged(state.nameHash, state.loop);</span><br><span class="line">                passTime = <span class="number">0</span>;</span><br><span class="line">                <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForFixedUpdate</span>(<span class="params"></span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForFixedUpdate</span>(<span class="params"></span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\MogoSolution\LoaderLib\Utils\Timer\TimerData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Util</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定时器抽象实体</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment">// 程序集就是一个项目，多个项目构成一个解决方案。internal的权限小于public</span></span><br><span class="line">    <span class="comment">// 访问级别： private(私人，类内) &lt; protected(家内，类和子类内) &lt; internal (族内，项目内)&lt; public(公家，无限制)</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbsTimerData</span></span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">uint</span> m_nTimerId; <span class="comment">// 任务id</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span> NTimerId</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_nTimerId; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_nTimerId = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_nInterval; <span class="comment">// 间隔多少秒，重复这个任务</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> NInterval</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_nInterval; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_nInterval = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">ulong</span> m_unNextTick; <span class="comment">// 下一次触发的时间点</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">ulong</span> UnNextTick</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_unNextTick; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_unNextTick = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Delegate是个类，基类，抽象类。delegate是一个关键字</span></span><br><span class="line">        <span class="comment">// 此处的Action是个属性名，set的时候返回委托</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">abstract</span> Delegate Action</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">DoAction</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无参数定时器实体</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">TimerData</span> : <span class="title">AbsTimerData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Action m_action;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重写委托</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">override</span> Delegate Action</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_action; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_action = <span class="keyword">value</span> <span class="keyword">as</span> Action; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 执行委托</span></span><br><span class="line">            m_action();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1个参数定时器实体</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>参数1<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    internal class TimerData&lt;T&gt; : AbsTimerData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Action&lt;T&gt; m_action;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">override</span> Delegate Action</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_action; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_action = <span class="keyword">value</span> <span class="keyword">as</span> Action; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> T m_arg1;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> T Arg1</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_arg1; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_arg1 = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_action(m_arg1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    internal class TimerData&lt;T, U&gt; : AbsTimerData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Action&lt;T, U&gt; m_action;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">override</span> Delegate Action</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_action; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_action = <span class="keyword">value</span> <span class="keyword">as</span> Action&lt;T, U&gt;; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> T m_arg1;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> T Arg1</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_arg1; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_arg1 = <span class="keyword">value</span>;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> U m_arg2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> U Arg2</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_arg2; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; m_arg2 = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_action(m_arg1, m_arg2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>TimerHeap.cs heap堆</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，公司名</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：TimerHeap</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：定时触发器。</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> MS;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Util</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定时触发器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TimerHeap</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">uint</span> m_nNextTimerId;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">uint</span> m_unTick;</span><br><span class="line">        <span class="comment">// 带键值的优先队列</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> KeyedPriorityQueue&lt;<span class="keyword">uint</span>, AbsTimerData, <span class="keyword">ulong</span>&gt; m_queue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Stopwatch m_stopWatch;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">object</span> m_queueLock = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 私有构造函数，封闭实例化。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">TimerHeap</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="title">TimerHeap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_queue = <span class="keyword">new</span> KeyedPriorityQueue&lt;<span class="keyword">uint</span>, AbsTimerData, <span class="keyword">ulong</span>&gt;();</span><br><span class="line">            m_stopWatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加定时对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="start"&gt;</span>延迟启动时间。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="interval"&gt;</span>重复间隔，为零不重复。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="handler"&gt;</span>定时处理方法<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>定时对象Id<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">uint</span> <span class="title">AddTimer</span>(<span class="params"><span class="keyword">uint</span> start, <span class="keyword">int</span> interval, Action handler</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//起始时间会有一个tick的误差,tick精度越高,误差越低</span></span><br><span class="line">            <span class="keyword">var</span> p = GetTimerData(<span class="keyword">new</span> TimerData(), start, interval);</span><br><span class="line">            p.Action = handler;</span><br><span class="line">            <span class="keyword">return</span> AddTimer(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加定时对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>参数类型1<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="start"&gt;</span>延迟启动时间。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="interval"&gt;</span>重复间隔，为零不重复。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="handler"&gt;</span>定时处理方法<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg1"&gt;</span>参数1<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>定时对象Id<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">uint</span> AddTimer&lt;T&gt;(<span class="keyword">uint</span> start, <span class="keyword">int</span> interval, Action&lt;T&gt; handler, T arg1)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> p = GetTimerData(<span class="keyword">new</span> TimerData&lt;T&gt;(), start, interval);</span><br><span class="line">            p.Action = handler;</span><br><span class="line">            p.Arg1 = arg1;</span><br><span class="line">            <span class="keyword">return</span> AddTimer(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加定时对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>参数类型1<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="U"&gt;</span>参数类型2<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="start"&gt;</span>延迟启动时间。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="interval"&gt;</span>重复间隔，为零不重复。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="handler"&gt;</span>定时处理方法<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg1"&gt;</span>参数1<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg2"&gt;</span>参数2<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>定时对象Id<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">uint</span> AddTimer&lt;T, U&gt;(<span class="keyword">uint</span> start, <span class="keyword">int</span> interval, Action&lt;T, U&gt; handler, T arg1, U arg2)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> p = GetTimerData(<span class="keyword">new</span> TimerData&lt;T, U&gt;(), start, interval);</span><br><span class="line">            p.Action = handler;</span><br><span class="line">            p.Arg1 = arg1;</span><br><span class="line">            p.Arg2 = arg2;</span><br><span class="line">            <span class="keyword">return</span> AddTimer(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加定时对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>参数类型1<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="U"&gt;</span>参数类型2<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="V"&gt;</span>参数类型3<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="start"&gt;</span>延迟启动时间。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="interval"&gt;</span>重复间隔，为零不重复。（毫秒）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="handler"&gt;</span>定时处理方法<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg1"&gt;</span>参数1<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg2"&gt;</span>参数2<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg3"&gt;</span>参数3<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>定时对象Id<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">uint</span> AddTimer&lt;T, U, V&gt;(<span class="keyword">uint</span> start, <span class="keyword">int</span> interval, Action&lt;T, U, V&gt; handler, T arg1, U arg2, V arg3)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> p = GetTimerData(<span class="keyword">new</span> TimerData&lt;T, U, V&gt;(), start, interval);</span><br><span class="line">            p.Action = handler;</span><br><span class="line">            p.Arg1 = arg1;</span><br><span class="line">            p.Arg2 = arg2;</span><br><span class="line">            p.Arg3 = arg3;</span><br><span class="line">            <span class="keyword">return</span> AddTimer(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除定时对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="timerId"&gt;</span>定时对象Id<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DelTimer</span>(<span class="params"><span class="keyword">uint</span> timerId</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (m_queueLock)</span><br><span class="line">                m_queue.Remove(timerId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 周期调用触发任务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Tick</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_unTick += (<span class="keyword">uint</span>)m_stopWatch.ElapsedMilliseconds;</span><br><span class="line">            m_stopWatch.Reset();</span><br><span class="line">            m_stopWatch.Start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (m_queue.Count != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AbsTimerData p;</span><br><span class="line">                <span class="keyword">lock</span> (m_queueLock)</span><br><span class="line">                    p = m_queue.Peek();</span><br><span class="line">                <span class="keyword">if</span> (m_unTick &lt; p.UnNextTick)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">lock</span> (m_queueLock)</span><br><span class="line">                    m_queue.Dequeue();</span><br><span class="line">                <span class="keyword">if</span> (p.NInterval &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    p.UnNextTick += (<span class="keyword">ulong</span>)p.NInterval;</span><br><span class="line">                    <span class="keyword">lock</span> (m_queueLock)</span><br><span class="line">                        m_queue.Enqueue(p.NTimerId, p, p.UnNextTick);</span><br><span class="line">                    p.DoAction();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    p.DoAction();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 重置定时触发器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_unTick = <span class="number">0</span>;</span><br><span class="line">            m_nNextTimerId = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">lock</span> (m_queueLock)</span><br><span class="line">                <span class="keyword">while</span> (m_queue.Count != <span class="number">0</span>)</span><br><span class="line">                    m_queue.Dequeue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">uint</span> <span class="title">AddTimer</span>(<span class="params">AbsTimerData p</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (m_queueLock)</span><br><span class="line">                m_queue.Enqueue(p.NTimerId, p, p.UnNextTick);</span><br><span class="line">            <span class="keyword">return</span> p.NTimerId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> T GetTimerData&lt;T&gt;(T p, <span class="keyword">uint</span> start, <span class="keyword">int</span> interval) <span class="keyword">where</span> T : AbsTimerData</span><br><span class="line">        &#123;</span><br><span class="line">            p.NInterval = interval;</span><br><span class="line">            p.NTimerId = ++m_nNextTimerId;</span><br><span class="line">            p.UnNextTick = m_unTick + <span class="number">1</span> + start;</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Actors"><a href="#Actors" class="headerlink" title="Actors"></a><span style="color:#339AFF;">Actors</span></h1><p>Actor开头的脚本都是挂载到游戏对象上的。</p>
<blockquote>
<p>\Actors\ActorParent.cs 需要继承MonoBehavior</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Actor对象的基类</span></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Object = UnityEngine.Object;</span><br><span class="line"></span><br><span class="line">public class ActorParent&lt;T&gt; : ActorParent where T : EntityParent</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> T m_theEntity;</span><br><span class="line">    <span class="keyword">private</span> T theEntity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_theEntity; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; m_theEntity = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> EntityParent <span class="title">GetEntity</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_theEntity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ActorParent</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">string</span> ON_EQUIP_DONE = <span class="string">"ActorParent.ON_EQUIP_DONE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MecanimEvent m_mecanimEvent;</span><br><span class="line">    <span class="keyword">protected</span> Animator m_animator;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> preActionName = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> Action&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; ActChangeHandle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Action&lt;String, Boolean&gt; m_animatorStateChanged;</span><br><span class="line">    <span class="keyword">public</span> Action&lt;String, Boolean&gt; AnimatorStateChanged</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_animatorStateChanged;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_animatorStateChanged = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Action&lt;String, Boolean&gt; m_hitStateChanged;</span><br><span class="line">    <span class="keyword">public</span> Action&lt;String, Boolean&gt; HitStateChanged</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_hitStateChanged;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            m_hitStateChanged = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> isNeedInitEquip = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">uint</span> m_checkAnimationChangeTimeHeapId = <span class="keyword">uint</span>.MaxValue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> EntityParent <span class="title">GetEntity</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_animator = GetComponent&lt;Animator&gt;();</span><br><span class="line">        <span class="keyword">if</span> (m_animator)</span><br><span class="line">        &#123;</span><br><span class="line">            m_mecanimEvent = <span class="keyword">new</span> MecanimEvent(m_animator);</span><br><span class="line">            m_checkAnimationChangeTimeHeapId = TimerHeap.AddTimer(<span class="number">500</span>, <span class="number">0</span>, StartCheckAnimationChange);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceLoaded, InstanceLoaded);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.LogError("ActorParent Awake" + tag);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RemoveOld();</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceLoaded, InstanceLoaded);</span><br><span class="line">        TimerHeap.DelTimer(m_checkAnimationChangeTimeHeapId);</span><br><span class="line">        StopCoroutine(<span class="string">"CheckAnimationChange"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> idleCnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 行为改变，子类调用或重写</span></span><br><span class="line">    <span class="comment">// 子类的Update里每帧调用</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ActChange</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_animator == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (m_animator.IsInTransition(<span class="number">0</span>)) <span class="comment">// 融合期间</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> state = m_animator.GetCurrentAnimationClipState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state.Length == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">string</span> currName = state[<span class="number">0</span>].clip.name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currName != preActName) <span class="comment">// 动作变换</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(ActChangeHandle != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ActChangeHandle(preActName, currName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!currName.EndsWith(<span class="string">"ready"</span>) &amp;&amp; !currName.EndsWith(<span class="string">"run"</span>) &amp;&amp; !currName.EndsWith(<span class="string">"idle"</span>) &amp;&amp; !currName.EndsWith(<span class="string">"powercharge"</span>) &amp;&amp;</span><br><span class="line">                !currName.EndsWith(<span class="string">"powercharge_loop"</span>) &amp;&amp; !currName.EndsWith(<span class="string">"powercharge_left"</span>) &amp;&amp;</span><br><span class="line">                !currName.EndsWith(<span class="string">"roll"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                SkillAction a = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (GetEntity().currSpellID != <span class="number">-1</span> &amp;&amp;</span><br><span class="line">                    SkillAction.dataMap.TryGetValue(SkillData.dataMap[GetEntity().currSpellID].skillAction[<span class="number">0</span>], <span class="keyword">out</span> a))</span><br><span class="line">                &#123;<span class="comment">// 只为当前版本所用，新版本中动作不一样了要去掉</span></span><br><span class="line">                    <span class="keyword">if</span> (a.duration &lt;= <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_animator.SetInteger(<span class="string">"Action"</span>, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;<span class="comment">// 旋风斩之类技能使用</span></span><br><span class="line">                        m_animator.SetInteger(<span class="string">"Action"</span>, <span class="number">-3</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    m_animator.SetInteger(<span class="string">"Action"</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            preActName = currName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((currName.EndsWith(<span class="string">"hit"</span>) &amp;&amp; preActName.EndsWith(<span class="string">"hit"</span>)) ||</span><br><span class="line">            (currName.EndsWith(<span class="string">"push"</span>) &amp;&amp; preActName.EndsWith(<span class="string">"push"</span>)) ||</span><br><span class="line">            (currName.EndsWith(<span class="string">"hitair"</span>) &amp;&amp; preActName.EndsWith(<span class="string">"hitair"</span>)) ||</span><br><span class="line">            (currName.EndsWith(<span class="string">"knockdown"</span>) &amp;&amp; preActName.EndsWith(<span class="string">"knockdown"</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> act = m_animator.GetInteger(<span class="string">"Action"</span>);</span><br><span class="line">            <span class="keyword">if</span> (act != <span class="number">0</span> &amp;&amp; act != <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_animator.SetInteger(<span class="string">"Action"</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (GetEntity() != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            currName != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            GetEntity().stiff &amp;&amp;</span><br><span class="line">            (currName.EndsWith(<span class="string">"ready"</span>) ||</span><br><span class="line">            currName.EndsWith(<span class="string">"run"</span>) ||</span><br><span class="line">            currName.EndsWith(<span class="string">"run_left"</span>) ||</span><br><span class="line">            currName.EndsWith(<span class="string">"run_right"</span>) ||</span><br><span class="line">            currName.EndsWith(<span class="string">"run_back"</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            idleCnt++;</span><br><span class="line">            <span class="keyword">if</span> (idleCnt &gt; <span class="number">5</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                GetEntity().ClearHitAct();</span><br><span class="line">                idleCnt = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            idleCnt = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Release</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RemoveAll();</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceLoaded, InstanceLoaded);</span><br><span class="line">        TimerHeap.DelTimer(m_checkAnimationChangeTimeHeapId);</span><br><span class="line">        StopCoroutine(<span class="string">"CheckAnimationChange"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Attack</span>(<span class="params"><span class="keyword">int</span> _SpellID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Idle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnHit</span>(<span class="params"><span class="keyword">int</span> _SpellID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Walk</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放AnimatorController</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleaseController</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_animator != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_animator.runtimeAnimatorController != <span class="literal">null</span>)</span><br><span class="line">                AssetCacheMgr.ReleaseResource(m_animator.runtimeAnimatorController);</span><br><span class="line">            m_animator = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveOld</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_equipList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            AssetCacheMgr.ReleaseInstance(m_equipList[i], <span class="literal">false</span>);</span><br><span class="line">            m_equipList[i] = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_equipMeshOrMaterialList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            AssetCacheMgr.ReleaseResource(m_equipMeshOrMaterialList[i], <span class="literal">false</span>);</span><br><span class="line">            m_equipMeshOrMaterialList[i] = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_smrList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// SkinnedMeshRenderer.sharedMaterial</span></span><br><span class="line">            <span class="comment">// The shared material of this object.</span></span><br><span class="line">            m_smrList[i].sharedMaterial = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// SkinnedMeshRenderer.sharedMesh</span></span><br><span class="line">            <span class="comment">// 用于蒙皮的网格。</span></span><br><span class="line">            m_smrList[i].sharedMesh = <span class="literal">null</span>; </span><br><span class="line">            m_smrList[i] = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_smrList.Clear();</span><br><span class="line">        m_equipList.Clear();</span><br><span class="line">        m_equipMeshOrMaterialList.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">StartCheckAnimationChange</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.gameObject.activeSelf)</span><br><span class="line">            StartCoroutine(<span class="string">"CheckAnimationChange"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">CheckAnimationChange</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_mecanimEvent.CheckAnimationChange(OnStateChanged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnStateChanged</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">bool</span> isStart</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (AnimatorStateChanged != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            AnimatorStateChanged(name, isStart);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (HitStateChanged != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            HitStateChanged(name, isStart);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ClearOriginalModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_smrAllList.Count &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span>(Transform t <span class="keyword">in</span> transform)</span><br><span class="line">            &#123;</span><br><span class="line">                SkinnedMeshRenderer smr = t.GetComponent&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line">                <span class="keyword">if</span> (smr == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                smr.gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line">                smr.sharedMesh = <span class="literal">null</span>;</span><br><span class="line">                m_smrAllList.Add(smr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GetEquipObjectList</span>(<span class="params">List&lt;EquipData&gt; equipDataList, Action&lt;Dictionary&lt;<span class="keyword">int</span>, EquipObjectData&gt;, Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; onLoad</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        HashSet&lt;<span class="keyword">int</span>&gt; equipIdSet = <span class="keyword">new</span> HashSet&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\Actors\ActorPlayer.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"></span><br><span class="line">public class ActorPlayer : ActorPlayer&lt;EntityPlayer&gt; &#123; &#125;</span><br><span class="line"></span><br><span class="line">public class ActorPlayer&lt;T&gt; : ActorParent&lt;T&gt; where T : EntityPlayer</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> Transform m_billboardTrans;</span><br><span class="line">    <span class="keyword">protected</span> Transform m_wingBone;</span><br><span class="line"></span><br><span class="line">    GameObject m_goWing;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (isNeedInitEquip) InitEquipment();</span><br><span class="line"></span><br><span class="line">        m_billboardTrans = transform.FindChild(<span class="string">"slot_billboard"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ActChange();</span><br><span class="line">        <span class="keyword">if</span> (m_billboardTrans != <span class="literal">null</span> &amp;&amp; theEntity != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BillboardViewManager.Instance.UpdateBillboardPos(m_billboardTrans.position, theEntity.ID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> currWing;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddWing</span>(<span class="params"><span class="keyword">string</span> wingName, System.Action callBack</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_wingBone == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_wingBone = transform.FindChild(<span class="string">"Bip_master/Bip001 Pelvis/Bip001 Spine/bip_wing"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currWing == wingName)  <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        currWing = wingName;</span><br><span class="line"></span><br><span class="line">        AssetCacheMgr.GetInstance(</span><br><span class="line">            wingName,</span><br><span class="line">            (name, id, obj) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                m_goWing = (GameObject)obj;</span><br><span class="line">                m_goWing.transform.parent = m_wingBone;</span><br><span class="line">                m_goWing.transform.localPosition = Vector3.zero;</span><br><span class="line">                m_goWing.transform.localEulerAngles = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">90</span>, <span class="number">90</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">switch</span>(theEntity.vocation)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> Vocation.Warrior:</span><br><span class="line">                        m_goWing.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">1.7f</span>, <span class="number">1.7f</span>, <span class="number">1.7f</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> Vocation.Mage:</span><br><span class="line">                        m_goWing.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">1.3f</span>, <span class="number">1.3f</span>, <span class="number">1.3f</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> Vocation.Assassin:</span><br><span class="line">                        m_goWing.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">1.15f</span>, <span class="number">1.15f</span>, <span class="number">1.15f</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> Vocation.Archer:</span><br><span class="line">                        m_goWing.transform.localScale = <span class="keyword">new</span> Vector3(<span class="number">1.3f</span>, <span class="number">1.3f</span>, <span class="number">1.3f</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (callBack != <span class="literal">null</span>)</span><br><span class="line">                    callBack();</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveWing</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_goWing)</span><br><span class="line">        &#123;    </span><br><span class="line">            currWing = <span class="string">""</span>;</span><br><span class="line">            AssetCacheMgr.ReleaseInstance(m_goWing);</span><br><span class="line">            m_goWing = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayer</span>(<span class="params"><span class="keyword">int</span> layer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SetObjectLayer(layer, m_goWing);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetObjectLayer</span>(<span class="params"><span class="keyword">int</span> layer, GameObject obj</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!obj)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        obj.layer = layer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (Transform item <span class="keyword">in</span> obj.transform)</span><br><span class="line">        &#123;</span><br><span class="line">            SetObjectLayer(layer, item.gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\Actors\ActorDummy.cs 纯客户端的怪物</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"></span><br><span class="line">public class ActorDummy : ActorParent&lt;EntityDummy&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> Transform m_billboardTrans;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_billboardTrans = transform.FindChild(<span class="string">"slot_billboard"</span>);</span><br><span class="line">        <span class="keyword">base</span>.Awake();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ActChange();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_billboardTrans != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BillboardViewManager.Instance.UpdateBillboardPos(m_billboardTrans.position, theEntity.ID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\Actors\ActorBullet.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 飞行物控制器（用于火球，弓箭等物体的特效播放，追踪目标的显示逻辑</span></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 动态绑定到游戏对象上</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ActorBullet</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> speed = <span class="number">10</span>; <span class="comment">// 移动速度</span></span><br><span class="line">    <span class="keyword">public</span> Transform target; <span class="comment">// 目标</span></span><br><span class="line">    <span class="keyword">public</span> Vector3 targetPosition; <span class="comment">// 目标位置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> isSetup = <span class="literal">false</span>; <span class="comment">// 是否设置了目标</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁回调，外界可定制</span></span><br><span class="line">    <span class="keyword">public</span> System.Action OnDestroy = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否设置了目标</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="target"&gt;</span>目标<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="speed"&gt;</span>子弹移动速度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="targetPosition"&gt;</span>目标位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Setup</span>(<span class="params">Transform target, <span class="keyword">float</span> speed, Vector3 targetPosition</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.targetPosition = targetPosition;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            targetPosition = target.position;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.speed = speed;</span><br><span class="line"></span><br><span class="line">        isSetup = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isSetup) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 射向目标</span></span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            targetPosition = target.position;</span><br><span class="line">        &#125;</span><br><span class="line">        transform.LookAt(targetPosition);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> step = speed * Time.deltaTime; <span class="comment">// 速度 * 时间 = 距离</span></span><br><span class="line">        <span class="keyword">float</span> distance = Vector3.Distance(targetPosition, transform.position);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (distance &lt; step) <span class="comment">// 到达目标</span></span><br><span class="line">        &#123;</span><br><span class="line">            transform.position = targetPosition;</span><br><span class="line">            <span class="comment">// 销毁</span></span><br><span class="line">            <span class="keyword">if</span> (OnDestroy != <span class="literal">null</span>)</span><br><span class="line">                OnDestroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">// 距离 * 方向</span></span><br><span class="line">            transform.TransLate(step * transform.forward, Space.World);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a><span style="color:#339AFF;">GUI</span></h1><blockquote>
<p>\client\Assets\Scripts\GUI\MogoFx\MogoCameraCullByLayer.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MogoCameraCullByLayer</span> : <span class="title">MonoBehaviour</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; LayerList;</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; DistanceList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 定义大小为32的一维数组，用来存储所有层的剔除信息</span></span><br><span class="line">        <span class="keyword">float</span>[] distance = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; LayerList.Count; ++i)</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">// 设置每层的剔除距离</span></span><br><span class="line">            distance[LayerList[i]] = DistanceList[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Camera.layerCullDistances属性用来设置摄像机基于层的消隐距离。摄像机可以通过基于层（GameObject.layer）的方式来设置不同层物体的消隐距离，但这个距离必须小于或等于摄像机的farClipPlane才有效。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        相机跟每一层的剔除距离。比如，在视野中有很多npc，可以把npc设置到npc层，并在代码中为npc层设置较小的layerCullDistances剔除距离，这样就可以只渲染npc层剔除距离内的npc，减少性能开销。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将数组赋给摄像机的layerCullDistances</span></span><br><span class="line">        Camera.main.layerCullDistances = distance;</span><br><span class="line">        <span class="comment">// 在相机转动时，不会影响哪些对象可见或不可见，也就是不会转动中，有些原来显示的对象被隐藏</span></span><br><span class="line">        Camera.main.layerCullSpherical = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GUI/Mogo/UILogicManager.cs UI逻辑绑定管理</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UI逻辑绑定管理。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">UILogicManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;INotifyPropChanged&gt; m_itemSources = <span class="keyword">new</span> HashSet&lt;INotifyPropChanged&gt;();</span><br><span class="line">    <span class="keyword">private</span> EventController m_eventController;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定数据源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> INotifyPropChanged ItemSource</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> != <span class="literal">null</span> &amp;&amp; !m_itemSources.Contains(<span class="keyword">value</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                m_itemSources.Add(<span class="keyword">value</span>);</span><br><span class="line">                <span class="keyword">value</span>.SetEventController(m_eventController);</span><br><span class="line">                <span class="keyword">value</span>.AddUnloadCallback(() =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (m_itemSources != <span class="literal">null</span> &amp;&amp; m_itemSources.Contains(<span class="keyword">value</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_itemSources.Remove(<span class="keyword">value</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 默认构造函数。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UILogicManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_eventController = <span class="keyword">new</span> EventController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置绑定。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>绑定参数类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="key"&gt;</span>绑定关键字<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="action"&gt;</span>绑定调用方法<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> SetBinding&lt;T&gt;(String key, Action&lt;T&gt; action)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_eventController.ContainsEvent(key))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        m_eventController.AddEventListener(key, action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据数据源更新UI。（效率不高，不要频繁调用）</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> itemSource <span class="keyword">in</span> m_itemSources)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (itemSource != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> type = itemSource.GetType();</span><br><span class="line">                <span class="comment">//获取带一个参数回调方法的TriggerEvent。</span></span><br><span class="line">                <span class="keyword">var</span> mTriggerEvent = m_eventController.GetType().GetMethods().FirstOrDefault(t =&gt; t.Name == <span class="string">"TriggerEvent"</span> &amp;&amp; t.IsGenericMethod &amp;&amp; t.GetGenericArguments().Length == <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> m_eventController.TheRouter)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> prop = type.GetProperty(item.Key);</span><br><span class="line">                    <span class="keyword">if</span> (prop == <span class="literal">null</span>)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">var</span> method = mTriggerEvent.MakeGenericMethod(prop.PropertyType);<span class="comment">//对泛型进行类型限定</span></span><br><span class="line">                    <span class="keyword">var</span> <span class="keyword">value</span> = prop.GetGetMethod().Invoke(itemSource, <span class="literal">null</span>);<span class="comment">//获取参数值</span></span><br><span class="line">                    method.Invoke(m_eventController, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; item.Key, <span class="keyword">value</span> &#125;);<span class="comment">//调用对应参数类型的触发方法</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Release</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 不注释：清空属性监听, 需要在UI重新Load的时候重新设置属性监听ItemSource</span></span><br><span class="line">        <span class="comment">// 注释：保留属性监听，不需要重新设置ItemSource</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> m_itemSources)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span>)</span><br><span class="line">                item.RemoveEventController(m_eventController);</span><br><span class="line">        &#125;</span><br><span class="line">        m_itemSources.Clear(); <span class="comment">// 如果RemoveEventController，需要把m_itemSources列表同时清空，否则无法重新设置EventController</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 需要清空，在UI重新Load的时候重新添加监听</span></span><br><span class="line">        m_eventController.Cleanup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MogoUIBehaviour</span> : <span class="title">MFUIUnit</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 向客户端发出某一属性值已更改的通知。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">INotifyPropChanged</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置事件控制器。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="controller"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SetEventController</span>(<span class="params">EventController controller</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除事件控制器。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="controller"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoveEventController</span>(<span class="params">EventController controller</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在更改属性值时发生。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>属性类型。<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="propertyName"&gt;</span>属性名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="value"&gt;</span>属性值。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="keyword">void</span> OnPropertyChanged&lt;T&gt;(<span class="keyword">string</span> propertyName, T <span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听实体资源释放回调。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="onUnload"&gt;</span>回调事件处理<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddUnloadCallback</span>(<span class="params">Action onUnload</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">NotifyPropChanged</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;EventController&gt; m_uiBindingSet = <span class="keyword">new</span> HashSet&lt;EventController&gt;();</span><br><span class="line">    <span class="keyword">private</span> Action m_onUnload;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加UI事件绑定。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="controller"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetEventController</span>(<span class="params">EventController controller</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_uiBindingSet.Add(controller);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除UI事件绑定。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="controller"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveEventController</span>(<span class="params">EventController controller</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_uiBindingSet.Remove(controller);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化处理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>属性值类型。<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="propertyName"&gt;</span>属性名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="value"&gt;</span>属性值。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> OnPropertyChanged&lt;T&gt;(<span class="keyword">string</span> propertyName, T <span class="keyword">value</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> m_uiBindingSet)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span>)</span><br><span class="line">                item.TriggerEvent(propertyName, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听实体资源释放回调。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="onUnload"&gt;</span>回调事件处理<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddUnloadCallback</span>(<span class="params">Action onUnload</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_onUnload = onUnload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 清理绑定数据。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ClearBinding</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_onUnload != <span class="literal">null</span>)</span><br><span class="line">            m_onUnload();</span><br><span class="line">        m_uiBindingSet.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="GameLogic"><a href="#GameLogic" class="headerlink" title="GameLogic"></a><span style="color:#339AFF;">GameLogic</span></h1><blockquote>
<p>\client\Assets\Scripts\GameLogic\IEventManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，公司名</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：IEventManager</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：子系统事件接口</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEventManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 子系统事件接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">AddEventListener</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 移除事件订阅。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RemoveListeners</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>EntityParent.cs 客户端Entity基类，这是个partial类，方法在这里，属性在ParentProperty.cs里</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.RPC;</span><br><span class="line"><span class="keyword">using</span> Mogo.Task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 逻辑控制类，这里处理Entity数据变化，状态变化等逻辑</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">EntityParent</span> : <span class="title">NotifyPropChanged</span>, <span class="title">INotifyPropChanged</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 虚方法</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MainCameraCompleted</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (GameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                MogoWorld.GameObjects.Add(GameObject.GetInstanceID(), <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateActualModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateDefaultModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ApplyRootMotion</span>(<span class="params"><span class="keyword">bool</span> b</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animator == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            animator.applyRootMotion = b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetAction</span>(<span class="params"><span class="keyword">int</span> act</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animator == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            animator.SetInteger(<span class="string">"Action"</span>, act);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (weaponAnimator)</span><br><span class="line">            &#123;</span><br><span class="line">                weaponAnimator.SetInteger(<span class="string">"Action"</span>, act);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (act == ActionConstants.HIT_AIR)</span><br><span class="line">            &#123;</span><br><span class="line">                stiff = <span class="literal">true</span>; <span class="comment">// 僵硬的</span></span><br><span class="line">                hitAir = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (act == ActionConstants.KNOCK_DOWN)</span><br><span class="line">            &#123;</span><br><span class="line">                stiff = <span class="literal">true</span>;</span><br><span class="line">                knockDown = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (act == ActionConstants.HIT)</span><br><span class="line">            &#123;</span><br><span class="line">                stiff = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (act == ActionConstants.PUSH)</span><br><span class="line">            &#123;</span><br><span class="line">                stiff = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (act == ActionConstants.HIT_GROUND)</span><br><span class="line">            &#123;</span><br><span class="line">                stiff = <span class="literal">true</span>;</span><br><span class="line">                hitGround = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HitStateChange</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">bool</span> start</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((name.EndsWith(<span class="string">"ready"</span>) || name.EndsWith(<span class="string">"run"</span>)) &amp;&amp; start)</span><br><span class="line">            &#123;</span><br><span class="line">                Actor.HitStateChanged = <span class="literal">null</span>;</span><br><span class="line">                ClearHitAct();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearHitAct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> EntityMyself)</span><br><span class="line">            &#123;</span><br><span class="line">                currSpellID = <span class="number">-1</span>; <span class="comment">// 用于攻击中受击打断后的再次容错</span></span><br><span class="line">            &#125;</span><br><span class="line">            ChangeMotionState(MotionState.IDLE);</span><br><span class="line">            hitAir = <span class="literal">false</span>;</span><br><span class="line">            knockDown = <span class="literal">false</span>;</span><br><span class="line">            hitGround = <span class="literal">false</span>;</span><br><span class="line">            stiff = <span class="literal">false</span>;</span><br><span class="line">            EventDispatcher.TriggerEvent(Events.AIEvent.DummyStiffEnd, Transform.gameObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DelayCheck</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animator == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (CurrentMotionState == MotionState.HIT &amp;&amp; animator.GetInteger(<span class="string">"Action"</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ClearHitAct();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (stiff &amp;&amp; animator.GetInteger(<span class="string">"Action"</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ClearHitAct();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetSpeed</span>(<span class="params"><span class="keyword">float</span> speed</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animator == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            animator.SetFloat(<span class="string">"Speed"</span>, speed);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsInTransition</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> animator.IsInTransition(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeMotionState</span>(<span class="params"><span class="keyword">string</span> newState, <span class="keyword">params</span> System.Object[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            fsmMotion.ChangeStatus(<span class="keyword">this</span>, newState, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeMotionStateInFrames</span>(<span class="params"><span class="keyword">string</span> newState, <span class="keyword">params</span> System.Object[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            fsmMotion.ChangeStatus(<span class="keyword">this</span>, newState, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对象进入场景，在这里初始化各种数据， 资源， 模型等</span></span><br><span class="line">        <span class="comment">// 传入数据。</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnEnterWorld</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            buffManager = <span class="keyword">new</span> BuffManager(<span class="keyword">this</span>);</span><br><span class="line">            EventDispatcher.AddEventListener&lt;GameObject, Vector3&gt;(MogoMotor.ON_MOVE_TO, OnMoveTo);</span><br><span class="line">            EventDispatcher.AddEventListener&lt;GameObject, Vector3, <span class="keyword">float</span>&gt;(MogoMotor.ON_MOVE_TO_FALSE, OnMoveToFalse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对象从场景中删除， 在这里释放资源</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnLeaveWorld</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventDispatcher.RemoveEventListener&lt;GameObject, Vector3&gt;(MogoMotor.ON_MOVE_TO, OnMoveTo);</span><br><span class="line">            EventDispatcher.RemoveEventListener&lt;GameObject, Vector3, <span class="keyword">float</span>&gt;(MogoMotor.ON_MOVE_TO_FALSE, OnMoveToFalse);</span><br><span class="line">            <span class="keyword">if</span> (buffManager != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                buffManager.Clean();</span><br><span class="line">            &#125;</span><br><span class="line">            RemoveListener();</span><br><span class="line">            ClearBinding();</span><br><span class="line">            <span class="keyword">if</span> (GameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                MogoWorld.GameObjects.Remove(GameObject.GetInstanceID());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Actor)</span><br><span class="line">                Actor.ReleaseController();</span><br><span class="line">            GameObject.Destroy(GameObject);</span><br><span class="line"></span><br><span class="line">            GameObject = <span class="literal">null</span>;</span><br><span class="line">            Transform = <span class="literal">null</span>;</span><br><span class="line">            weaponAnimator = <span class="literal">null</span>;</span><br><span class="line">            animator = <span class="literal">null</span>;</span><br><span class="line">            motor = <span class="literal">null</span>;</span><br><span class="line">            sfxHandler = <span class="literal">null</span>;</span><br><span class="line">            audioSource = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Idle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">this</span> <span class="keyword">is</span> EntityMyself) &amp;&amp; (<span class="keyword">this</span> <span class="keyword">as</span> EntityMyself).deathFlag == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (battleManger == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ChangeMotionState(MotionState.IDLE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.battleManger.Idle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Roll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.battleManger.Roll();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 公共方法</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 技能相关</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 去除重力，会连动作的自带位移都去掉，慎用</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> （animator对带chactorController的物体自带一个重力，暂没找到更好的去除方法）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveGravity</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            motor.gravity = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetGravity</span>(<span class="params"><span class="keyword">float</span> gravity = <span class="number">20</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            motor.gravity = gravity;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 冻结</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetFreeze</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> EntityMyself)</span><br><span class="line">            &#123;</span><br><span class="line">                motor.enableStick = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            SetSpeedReduce();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 解冻</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetThaw</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            SetSpeedRecover();</span><br><span class="line">            motor.enableStick = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;summary&gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 减速</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="speedRate"&gt;</span>减速率<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetSpeedReduce</span>(<span class="params"><span class="keyword">float</span> speedRate = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (isSrcSpeed)</span><br><span class="line">            &#123;</span><br><span class="line">                isSrcSpeed = <span class="literal">false</span>;</span><br><span class="line">                srcSpeed = animator.speed;</span><br><span class="line">                gearMoveSpeedRate = speedRate;</span><br><span class="line">            &#125;</span><br><span class="line">            animator.speed = srcSpeed * speedRate;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 恢复速度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetSpeedRecover</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSrcSpeed)</span><br><span class="line">            &#123;</span><br><span class="line">                gearMoveSpeedRate = <span class="number">1</span>;</span><br><span class="line">                isSrcSpeed = <span class="literal">true</span>;</span><br><span class="line">                animator.speed = srcSpeed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\Entities\ParentPartial\ParentProperty.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.RPC;</span><br><span class="line"><span class="keyword">using</span> Mogo.Task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">EntityParent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> ActorParent Actor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\Entities\EntityMonster.cs 服务器端控制的怪物</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EntityMonster</span> : <span class="title">EntityParent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">static</span> <span class="keyword">int</span> Goddess = <span class="number">5010</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">static</span> <span class="keyword">int</span> Tower1 = <span class="number">42101</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">static</span> <span class="keyword">int</span> Tower2 = <span class="number">42201</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_model;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_clientTrapId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> UInt32 m_monsterId;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">CreateModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (clientTrapId == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                CreateActualModel();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Debug(<span class="string">"CreateBuildingModel"</span>);</span><br><span class="line"></span><br><span class="line">                IsGolem = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                attachBuildingTime = TimerHeap.AddTimer(<span class="number">500</span>, <span class="number">0</span>, AttachBuildingModel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 附加建筑模型</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AttachBuildingModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 所有含有GearParent及其子类组件的对象</span></span><br><span class="line">            GearParent[] gears = (GearParent[])GameObject.FindObjectsOfType(<span class="keyword">typeof</span>(GearParent));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回数组，需要遍历</span></span><br><span class="line">            <span class="keyword">foreach</span> (GearParent gear <span class="keyword">in</span> gears)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (gear.ID == (<span class="keyword">uint</span>)clientTrapId)</span><br><span class="line">                &#123;</span><br><span class="line">                    gear.gameObject.tag = <span class="string">"Monster"</span>;</span><br><span class="line"></span><br><span class="line">                    LoggerHelper.Debug(<span class="string">"CreateBuildingModel Position: "</span> + gear.transform.position);</span><br><span class="line"></span><br><span class="line">                    animator = gear.gameObject.GetComponent&lt;Animator&gt;();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ActorMonster是继承MonoBehavior的</span></span><br><span class="line">                    ActorMonster ap = gear.gameObject.GetComponent&lt;ActorMonster&gt;();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ap == <span class="literal">null</span>)</span><br><span class="line">                        ap = gear.gameObject.AddComponent&lt;ActorMonster&gt;();</span><br><span class="line"></span><br><span class="line">                    ap.theEntity = <span class="keyword">this</span>;</span><br><span class="line">                    <span class="keyword">this</span>.Actor = ap;</span><br><span class="line"></span><br><span class="line">                    golem = gear.gameObject.GetComponentInChildren&lt;GolemAnimation&gt;();</span><br><span class="line">                    golemFx = gear.gameObject.GetComponentInChildren&lt;GolemFx&gt;();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (golem != <span class="literal">null</span>)</span><br><span class="line">                        golem.Activate()</span><br><span class="line">                    <span class="keyword">if</span> (golemFx != <span class="literal">null</span>)</span><br><span class="line">                        golemFx.Activate();</span><br><span class="line"></span><br><span class="line">                    BornHandler();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">CreateDefaultModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            AvatarModelData data = AvatarModelData.dataMap[<span class="number">999</span>];</span><br><span class="line">            LoggerHelper.Debug(<span class="string">"monster create:"</span> + ID + <span class="string">",name:"</span> + data.prefabName);</span><br><span class="line">            GameObject go = AssetCacheMgr.GetLocalInstance(data.prefabName) <span class="keyword">as</span> GameObject;</span><br><span class="line"></span><br><span class="line">            go.transform.localScale = scale;</span><br><span class="line">            go.tag = <span class="string">"Monster"</span>;</span><br><span class="line">            motor = go.AddComponent&lt;MogoMotorServer&gt;();</span><br><span class="line">            animator = go.GetComponent&lt;Animator&gt;();</span><br><span class="line"></span><br><span class="line">            ActorMonster ap = go.AddComponent&lt;ActorMonster&gt;();</span><br><span class="line">            ap.theEntity = <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">this</span>.Actor = ap;</span><br><span class="line">            UpdatePosition();</span><br><span class="line">            <span class="keyword">base</span>.CreateModel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameLogic/BattleSystem/BattleManager.cs 战斗管理系统</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// 属性</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BattleAttr</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> ATTACK = <span class="string">"atk"</span>; <span class="comment">// 伤害</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> DEFENSE = <span class="string">"def"</span>; <span class="comment">// 防御</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> FIGHT_FORCE = <span class="string">"fightForce"</span>; <span class="comment">// 攻击力</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> HIT = <span class="string">"hit"</span>; <span class="comment">// 命中</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> HEALTH = <span class="string">"curHp"</span>; <span class="comment">// 生命</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> CRIT = <span class="string">"crit"</span>; <span class="comment">//暴击</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> ANTI_CRIT = <span class="string">"antiCrit"</span>; <span class="comment">// 抗暴击</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> TRUE_STRIKE = <span class="string">"trueStrike"</span>; <span class="comment">// 破击</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> ANTI_TRUE_STRIKE = <span class="string">"antiTrueStrike"</span>; <span class="comment">// 抗破击</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> ANTI_DEFENSE = <span class="string">"antiDefense"</span>; <span class="comment">// 穿刺</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> CRIT_EXTRA_ATTACK = <span class="string">"critExtraAttack"</span>; <span class="comment">// 爆伤加成</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> PVP_ADDITION = <span class="string">"pvpAddition"</span>; <span class="comment">// PVP强度</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> PVP_ANTI = <span class="string">"pvpAnti"</span>; <span class="comment">// PVE强度</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> CD_REDUCE = <span class="string">"cdReduce"</span>; <span class="comment">// CD减少</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> SPEED_ADD_RATE = <span class="string">"speedAddRate"</span>; <span class="comment">// 速度增加</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> EARTH_DAMAGE = <span class="string">"earthDamage"</span>; <span class="comment">// 土元素伤害</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> AIR_DAMAGE = <span class="string">"airDamage"</span>; <span class="comment">// 风元素伤害</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> WATER_DAMAGE = <span class="string">"waterDamage"</span>; <span class="comment">// 水元素伤害</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> FIRE_DAMAGE = <span class="string">"fireDamage"</span>; <span class="comment">// 火元素伤害</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> ALL_ELEMENTS_DAMAGE = <span class="string">"allElementsDamage"</span>; <span class="comment">// 全元素伤害</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> EARTH_DEFENSE = <span class="string">"earthDefense"</span>; <span class="comment">// 土元素抗性</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> AIR_DEFENSE = <span class="string">"airDefense"</span>; <span class="comment">// 风元素抗性</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> WATER_DEFENSE = <span class="string">"waterDefense"</span>; <span class="comment">// 水元素抗性</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> FIRE_DEFENSE = <span class="string">"fireDefense"</span>; <span class="comment">// 火元素抗性</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> ALL_ELEMENTS_DEFENSE = <span class="string">"allElementsDefense"</span>; <span class="comment">// 全元素抗性</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BattleManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">protected</span> EntityParent theOwner; <span class="comment">// 实体父类</span></span><br><span class="line">        <span class="keyword">protected</span> SkillManager skillManager; <span class="comment">// 技能管理</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> currentSpellID = <span class="number">0</span>; <span class="comment">// 当前正在使用的技能配置数据（未使用技能时为0）</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> currentHitSpellID = <span class="number">0</span>; <span class="comment">// 受击技能</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> CurrentSpellID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> currentSpellID; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; currentSpellID = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> CurrentHitSpellID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> currentHitSpellID; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; currentHitSpellID = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BattleManager</span>(<span class="params">EntityParent _owner, SkillManager _skillManager</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            theOwner = _owner;</span><br><span class="line">            skillManager = _skillManager;</span><br><span class="line">            <span class="comment">// 添加监听</span></span><br><span class="line">            theOwner.AddUniqEventListener&lt;<span class="keyword">int</span>&gt;(Events.FSMMotionEvent.OnPrepareEnd, OnPrepareEnd);</span><br><span class="line"></span><br><span class="line">            theOwner.AddUniqEventListener&lt;<span class="keyword">int</span>&gt;(Events.FSMMotionEvent.OnAttackingEnd, OnAttackingEnd);</span><br><span class="line"></span><br><span class="line">            theOwner.AddUniqEventListener(Events.FSMMotionEvent.OnRollEnd, OnRollEnd);</span><br><span class="line"></span><br><span class="line">            EventDispatcher.AddEventListener&lt;<span class="keyword">int</span>, <span class="keyword">uint</span>, <span class="keyword">uint</span>, List&lt;<span class="keyword">int</span>&gt;&gt;(Events.FSMMotionEvent.OnHit, OnHit);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 析构函数，移除监听的各种事件</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clean</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            theOwner.RemoveUniqEventListener&lt;<span class="keyword">int</span>&gt;(Events.FSMMotionEvent.OnPrepareEnd, OnPrepareEnd);</span><br><span class="line">            theOwner.RemoveUniqEventListener&lt;<span class="keyword">int</span>&gt;(Events.FSMMotionEvent.OnAttackingEnd, OnAttackingEnd);</span><br><span class="line">            theOwner.RemoveUniqEventListener&lt;<span class="keyword">int</span>&gt;(Events.FSMMotionEvent.OnHitAnimEnd, OnHitAnimEnd);</span><br><span class="line">            theOwner.RemoveUniqEventListener(Events.FSMMotionEvent.OnRollEnd, OnRollEnd);</span><br><span class="line"></span><br><span class="line">            EventDispatcher.RemoveEventListener&lt;<span class="keyword">int</span>, <span class="keyword">uint</span>, <span class="keyword">uint</span>, List&lt;<span class="keyword">int</span>&gt;&gt;(Events.FSMMotionEvent.OnHit, OnHit);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameLogic/BattleSystem/PlayerBattleManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerBattleManager</span> : <span class="title">BattleManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> lastAttackTime = <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">private</span> PlayerSkillManager skillManager;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="keyword">int</span>&gt; preCmds = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">uint</span> timeOutId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PlayerBattleManager</span>(<span class="params">EntityParent _owner, SkillManager _skillManager</span>) : <span class="title">base</span>(<span class="params">_owner, _skillManager</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            skillManager = _skillManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 析构函数，移除监听的各种事件</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Clean</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">base</span>.Clean();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当受击的时候出来</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnHit</span>(<span class="params"><span class="keyword">int</span> _spellID, <span class="keyword">uint</span> _attackerID, <span class="keyword">uint</span> woundId, List&lt;<span class="keyword">int</span>&gt; harm</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (MogoWorld.inCity ||</span><br><span class="line">                theOwner.ID != woundId ||</span><br><span class="line">                !theOwner.canBeHit ||</span><br><span class="line">                theOwner.ID == _attackerID ||</span><br><span class="line">                ((EntityMyself)theOwner).deathFlag &gt; <span class="number">0</span> ||</span><br><span class="line">                theOwner.charging)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameLogic\SfxSystem\SfxHandler.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，公司名</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：HandleCur</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：动作事件处理器。</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 动作事件处理器。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SfxHandler</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, Transform&gt; m_locationDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Transform&gt;();</span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, Dictionary&lt;<span class="keyword">int</span>, GameObject&gt;&gt; m_fxDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, Dictionary&lt;<span class="keyword">int</span>, GameObject&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">int</span>&gt;&gt; m_groupFXList = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MeleeWeaponTrail是一个武器轨迹插件</span></span><br><span class="line">    <span class="comment">// Melee近战</span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, MeleeWeaponTrail&gt; m_weaponTrailsDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, MeleeWeaponTrail&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, Material&gt; m_weaponTrailMaterial = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Material&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, AnimationClip&gt; m_animationClip = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, AnimationClip&gt;();</span><br><span class="line">    <span class="keyword">private</span> Renderer[] m_renderer;</span><br><span class="line">    <span class="keyword">private</span> Material[] m_mat;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HashSet&lt;T&gt;类，主要被设计用来存储集合，做高性能集运算，例如两个集合求交集、并集、差集等。</span></span><br><span class="line">    <span class="comment">// 这个集合类包含不重复项的无序列表。</span></span><br><span class="line">    <span class="comment">// 特性：</span></span><br><span class="line">    <span class="comment">// 1.HasSet中的值不能重复</span></span><br><span class="line">    <span class="comment">// 2.HashSet中的值没有顺序</span></span><br><span class="line">    <span class="comment">// 3.HashSet的容量按需自动添加</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 适用场景：</span></span><br><span class="line">    <span class="comment">// 高性能检索。Contains的方法性能好。HashSet&lt;T&gt;的Contains方法复杂度是O(1)，List&lt;T&gt;的Contains方法复杂度是O(n)，后者数据量越大速度越慢，而HashSet&lt;T&gt;不受数据量的影响。</span></span><br><span class="line">    <span class="comment">// HashSet&lt;T&gt;集合会对加入的数据distinct，如果之前已经存在则就不会Add进去了。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HashSet&lt;<span class="keyword">string</span>&gt; m_loadedFX = <span class="keyword">new</span> HashSet&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录SlotCueHandler</span></span><br><span class="line">    SlotCueHandler slotCueHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        slotCueHandler = gameObject.GetComponent&lt;slotCueHandler&gt;();</span><br><span class="line">        GetMaterials();</span><br><span class="line">        EventDispatcher.AddEventListener&lt;GameObject&gt;(Events.OtherEvent.OnChangeWeapon, OnChangeWeapon);</span><br><span class="line">        EventDispatcher.AddEventListener(ActorParent.ON_EQUIP_DONE, OnEquitDone);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;GameObject&gt;(Events.OtherEvent.OnChangeWeapon, OnChangeWeapon);</span><br><span class="line">        EventDispatcher.RemoveEventListener(ActorParent.ON_EQUIP_DONE, OnEquitDone);</span><br><span class="line">        Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddloadedFX</span>(<span class="params">String fxResourceName</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_loadedFX.Add(fxResourceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UnloadAllFXs</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> item <span class="keyword">in</span> m_loadedFX)</span><br><span class="line">        &#123;</span><br><span class="line">            AssetCacheMgr.ReleaseResourceImmediate(item);</span><br><span class="line">        &#125;</span><br><span class="line">        m_loadedFX.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发射弓箭或火球等</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="shootSfxId"&gt;</span>飞行物<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="boomSfxId"&gt;</span>碰撞后特效,-1代表无<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="target"&gt;</span>目标<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="speed"&gt;</span>速度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="distance"&gt;</span>如果目标为null时，到前方一定距离后就消失<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Shoot</span>(<span class="params">FXData fx, Transform target, <span class="keyword">float</span> speed = <span class="number">10</span>, <span class="keyword">float</span> distance = <span class="number">30</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        PlayFX(fx.id, fx, (go, guid) =&gt; </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> bullet = go.AddComponent&lt;ActorBullect&gt;();</span><br><span class="line">            bullet.OnDestroy = () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                RemoveFx(fx.id, guid);</span><br><span class="line">            &#125;;</span><br><span class="line">            Vector3 targetPosition = Vector3.zero;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (target == <span class="literal">null</span>)</span><br><span class="line">                targetPosition = go.transform.position + transform.forward * distance;</span><br><span class="line"></span><br><span class="line">            bullet.Setup(target, speed, targetPosition);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 播放特效</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="id"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="fx"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="action"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="bone_path"&gt;</span>绑特效的骨骼，默认为空（即使用xml里面指定的骨骼）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PlayFX</span>(<span class="params"><span class="keyword">int</span> id, FXData fx, Action&lt;GameObject, <span class="keyword">int</span>&gt; action = <span class="literal">null</span>, <span class="keyword">string</span> bone_path = <span class="string">""</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GetMaterials</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> renders = <span class="keyword">new</span> List&lt;Renderer&gt;();</span><br><span class="line">        <span class="comment">// true表示游戏对象下的子物体激活的没激活的都会被拿到,包括游戏对象本身</span></span><br><span class="line">        <span class="comment">// includeInactive </span></span><br><span class="line">        <span class="keyword">var</span> smr = GetComponentsInChildren&lt;SkinnedMeshRenderer&gt;(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">var</span> mr = GetComponentsInChildren&lt;MeshRenderer&gt;(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加实现了接口IEnumerable&lt;T&gt;的一个泛型集合的所有元素到指定泛型集合末尾</span></span><br><span class="line">        <span class="comment">// List&lt;int&gt; list1 = new List&lt;int&gt;() &#123; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 &#125;;</span></span><br><span class="line">        <span class="comment">// List&lt;int&gt; list2 = new List&lt;int&gt;() &#123; 11,12&#125;;</span></span><br><span class="line">        <span class="comment">// list1.AddRange(list2); </span></span><br><span class="line">        <span class="comment">// Add 是每次将单个元素添加到集合里面。但是AddRange可以一次性添加多个元素到集合里面</span></span><br><span class="line">        renders.AddRange(smr);</span><br><span class="line">        renders.AddRange(mr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (renders.Count != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_renderer = renders.ToArray();</span><br><span class="line">            m_mat = <span class="keyword">new</span> Material[m_renderer.Length];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_renderer.Length; i++)</span><br><span class="line">            &#123;   </span><br><span class="line">                m_mat[i] = m_renderer[i].material; <span class="comment">// Renderer.material</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_renderer = <span class="literal">null</span>;</span><br><span class="line">            m_mat = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnChangeWeapon</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> &amp;&amp; go)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> wt = go.GetComponent&lt;MeleeWeaponTrail&gt;();</span><br><span class="line">            <span class="keyword">if</span> (wt)</span><br><span class="line">            &#123;</span><br><span class="line">                m_weaponTrailsDic[wt.transform.parent.name] = wt;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Debug(<span class="string">"No MeleeWeaponTrail: "</span> + go.name);</span><br><span class="line">                <span class="keyword">if</span> (m_weaponTrailsDic.ContainsKey(wt.transform.parent.name))</span><br><span class="line">                    m_weaponTrailsDic.Remove(wt.transform.parent.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEquitDone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>)</span><br><span class="line">            GetMaterials();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RemoveAllFX();</span><br><span class="line">        m_mat = <span class="literal">null</span>;</span><br><span class="line">        m_renderer = <span class="literal">null</span>;</span><br><span class="line">        m_weaponTrailsDic.Clear();</span><br><span class="line">        m_locationDic.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveAllFX</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        List&lt;<span class="keyword">int</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> fxs <span class="keyword">in</span> m_fxDic)</span><br><span class="line">        &#123;   </span><br><span class="line">            list.Add(fxs.Key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> list)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveFXs(item);</span><br><span class="line">        &#125;</span><br><span class="line">        m_fxDic.Clear();</span><br><span class="line">        StopShaderFX();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveFXs</span>(<span class="params"><span class="keyword">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">var</span> fx = FXData.dataMap.Get(id);</span><br><span class="line">        RemoveFXs(id, fx.<span class="keyword">group</span>);</span><br><span class="line">        <span class="keyword">if</span> (id == currentShaderFx)</span><br><span class="line">            StopShaderFX();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveFXS</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">int</span> <span class="keyword">group</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_fxDic.ContainsKey(id))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            KeyValuePair 和 Dictionary 的关系</span></span><br><span class="line"><span class="comment">            1、KeyValuePair </span></span><br><span class="line"><span class="comment">                a、KeyValuePair是一个结构体（struct）；</span></span><br><span class="line"><span class="comment">                b、KeyValuePair只包含一个Key、Value的键值对。</span></span><br><span class="line"><span class="comment">            2、Dictionary </span></span><br><span class="line"><span class="comment">                a、Dictionary可以简单的看作是KeyValuePair 的集合；</span></span><br><span class="line"><span class="comment">                b、Dictionary可以包含多个Key、Value的键值对。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            List&lt;KeyValuePair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; list = <span class="keyword">new</span> List&lt;KeyValuePair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> m_fxDic[id])</span><br><span class="line">            &#123;</span><br><span class="line">                list.Add(<span class="keyword">new</span> KeyValuePair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;(id, item.Key));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> list)</span><br><span class="line">            &#123;</span><br><span class="line">                RemoveFX(item.Key, item.Value, <span class="keyword">group</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            m_fxDic.Remove(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveFX</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">int</span> guid</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_fxDic.ContainsKey(id) &amp;&amp; m_fxDic[id].ContainsKey(guid))</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject.Destroy(m_fxDic[id][guid]);</span><br><span class="line">            <span class="comment">//AssetCacheMgr.ReleaseInstance(guid);</span></span><br><span class="line">            m_fxDic[id].Remove(guid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveFXByGroup</span>(<span class="params"><span class="keyword">int</span> <span class="keyword">group</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_groupFXList.ContainsKey(<span class="keyword">group</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> list = m_groupFXList[<span class="keyword">group</span>].ToArray();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> list)</span><br><span class="line">            &#123;</span><br><span class="line">                RemoveFXs(item, <span class="keyword">group</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopShaderFX</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//StopCoroutine("UpdateShader");</span></span><br><span class="line">        updatingShader = <span class="literal">false</span>;</span><br><span class="line">        SetMatShader(orgShader);</span><br><span class="line">        currentShaderFx = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetMatShader</span>(<span class="params">Shader shader</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_mat != <span class="literal">null</span> &amp;&amp; shader)</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> m_mat)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LoggerHelper.Error("SetMatShader item: " + item.name);</span></span><br><span class="line">                item.shader = shader; <span class="comment">// Material.shader</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Resources\data\xml\SkillBuff.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">skill_buff</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name_s</span>&gt;</span>11001<span class="tag">&lt;/<span class="name">name_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saveDB_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">saveDB_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">show_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">show_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">removeMode_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">removeMode_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">totalTime_i</span>&gt;</span>5000<span class="tag">&lt;/<span class="name">totalTime_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeSkill_m</span>&gt;</span>0:9000,1000:9000,2000:9000<span class="tag">&lt;/<span class="name">activeSkill_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sfx_i</span>&gt;</span>101163<span class="tag">&lt;/<span class="name">sfx_i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">skill_buff</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">skill_buff</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name_s</span>&gt;</span>11002<span class="tag">&lt;/<span class="name">name_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saveDB_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">saveDB_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">show_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">show_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">removeMode_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">removeMode_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">totalTime_i</span>&gt;</span>8000<span class="tag">&lt;/<span class="name">totalTime_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeSkill_m</span>&gt;</span>0:9000,1000:9000,2000:9000,3000:9000,4000:9000<span class="tag">&lt;/<span class="name">activeSkill_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sfx_i</span>&gt;</span>101163<span class="tag">&lt;/<span class="name">sfx_i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">skill_buff</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\MogoSolution\GameData\SkillBuffData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，爱游</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：buff表</span></span><br><span class="line"><span class="comment">// 创建者：莫卓豪</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：2013-7-10</span></span><br><span class="line"><span class="comment">// 模块描述：</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class SkillBuffData : GameData&lt;SkillBuffData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> name &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> show &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> showPriority &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> removeMode &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> totalTime &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; excludeBuff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; replaceBuff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; appendState &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; activeSkill &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">int</span>&gt; attrEffect &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> sfx &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> notifyEvent &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> vipLevel &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tips &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/SkillBuff"</span>;</span><br><span class="line">        <span class="comment">//static public Dictionary&lt;int, SkillBuffData&gt; dataMap &#123; get; set; &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetName</span>(<span class="params"><span class="keyword">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> rst = <span class="string">"no name"</span>;</span><br><span class="line">            <span class="keyword">if</span> (!dataMap.ContainsKey(id))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> rst;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!LanguageData.dataMap.ContainsKey(dataMap[id].name))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> rst;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> LanguageData.GetContent(dataMap[id].name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\BattleSystem\BuffManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuffManager</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuffManager</span></span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ClientBuff</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> totalTime;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> startTime;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">ClientBuff</span>(<span class="params">SkillBuffData cfg</span>)</span></span><br><span class="line"><span class="function"></span>            &#123;</span><br><span class="line">                id = cfg.id;</span><br><span class="line">                totalTime = cfg.totalTime;</span><br><span class="line">                startTime = (<span class="keyword">int</span>)(Time.realtimeSinceStartup * <span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">uint</span> timer = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, ClientBuff&gt; clientBuffs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> EntityParent m_theOwner;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BuffManager</span>(<span class="params">EntityParent theOwner</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_theOwner = theOwner;</span><br><span class="line">            clientBuffs = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, ClientBuff&gt;();</span><br><span class="line">            EventDispatcher.AddEventListener(Events.OtherEvent.SecondPast, CountDownSkillBuffTime);</span><br><span class="line">            timer = TimerHeap.AddTimer(<span class="number">500</span>, <span class="number">100</span>, UpdateBuff);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_hasGotLoginBuff = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> HasGotLoginBuff</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_hasGotLoginBuff;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_hasGotLoginBuff = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> BuffData</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> buffId;</span><br><span class="line">            <span class="keyword">public</span> UInt32 lastTime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;BuffData&gt; m_skillBuffDataList = <span class="keyword">new</span> List&lt;BuffData&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clean</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TimerHeap.DelTimer(timer);</span><br><span class="line">            EventDispatcher.RemoveEventListener(Events.OtherEvent.SecondPast, CountDownSkillBuffTime);</span><br><span class="line">            clientBuffs.Clear();</span><br><span class="line">            m_skillBuffDataList.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Gears"><a href="#Gears" class="headerlink" title="Gears"></a><span style="color:#339AFF;">Gears</span></h1><blockquote>
<p>暗黑战神\client\Assets\Scripts\Gears\GearParent\GearParent.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，公司名</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：GearParent</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 最后修改日期：</span></span><br><span class="line"><span class="comment">// 模块描述：机关父类，每个机关功能通过一个或多个机关子类组合实现</span></span><br><span class="line"><span class="comment">// 代码版本：发布版V3.0</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GearParent</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 静态常量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> MogoPlayerTag = <span class="string">"Player"</span>; <span class="comment">// 角色的tag</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">byte</span> EnableByte = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">byte</span> DisableByte = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">byte</span> StateOneByte = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">byte</span> StateTwoByte = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 动态变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> defaultID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> ID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> gearType &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125; <span class="comment">// 机关类型名，每个子类维护自己的类型名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> triggleEnable = <span class="literal">false</span>; <span class="comment">// 是否可触发</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> stateOne = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 创建与销毁</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        gearType = <span class="string">"GearParent"</span>;</span><br><span class="line">        ID = (<span class="keyword">uint</span>)defaultID;</span><br><span class="line">        triggleEnable = <span class="literal">true</span>;</span><br><span class="line">        stateOne = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        AddListeners();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁的时候去掉监听</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RemoveListeners();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 事件监听</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;   </span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEnable, SetGearEnable);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearDisable, SetGearDisable);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearStateOne, SetGearStateOne);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearStateTwo, SetGearStateTwo);</span><br><span class="line"></span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventEnable, SetGearEventEnable);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventDisable, SetGearEventDisable);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventStateOne, SetGearEventStateOne);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventStateTwo, SetGearEventStateTwo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RemoveListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEnable, SetGearEnable);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearDisable, SetGearDisable);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearStateOne, SetGearStateOne);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearStateTwo, SetGearStateTwo);</span><br><span class="line"></span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventEnable, SetGearEventEnable);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventDisable, SetGearEventDisable);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventStateOne, SetGearEventStateOne);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">uint</span>&gt;(Events.GearEvent.SetGearEventStateTwo, SetGearEventStateTwo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 机关事件</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearEventEnable</span>(<span class="params"><span class="keyword">uint</span> enableID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (enableID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            triggleEnable = <span class="literal">true</span>;</span><br><span class="line">            EventDispatcher.TriggerEvent(Events.GearEvent.UploadAllGear);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearEventDisable</span>(<span class="params"><span class="keyword">uint</span> disableID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (disableID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            triggleEnable = <span class="literal">false</span>;</span><br><span class="line">            EventDispatcher.TriggerEvent(Events.GearEvent.UploadAllGear);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearEventStateOne</span>(<span class="params"><span class="keyword">uint</span> stateOneID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (stateOneID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            stateOne = <span class="literal">true</span>;</span><br><span class="line">            EventDispatcher.TriggerEvent(Events.GearEvent.UploadAllGear);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearEventStateTwo</span>(<span class="params"><span class="keyword">uint</span> stateTwoID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (stateTwoID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            stateOne = <span class="literal">false</span>;</span><br><span class="line">            EventDispatcher.TriggerEvent(Events.GearEvent.UploadAllGear);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 断线重连</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearEnable</span>(<span class="params"><span class="keyword">uint</span> enableID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (enableID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            triggleEnable = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearDisable</span>(<span class="params"><span class="keyword">uint</span> disableID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (disableID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            triggleEnable = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearStateOne</span>(<span class="params"><span class="keyword">uint</span> stateOneID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (stateOneID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            stateOne = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetGearStateTwo</span>(<span class="params"><span class="keyword">uint</span> stateTwoID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (stateTwoID == ID)</span><br><span class="line">        &#123;</span><br><span class="line">            stateOne = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>暗黑战神\client\Assets\Scripts\Gears\DropRock\DropRock.cs 丢石头机关</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DropRock</span> : <span class="title">GearParent</span> <span class="comment">// 所有机关都继承自GearParent机关父类</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> canAttackDummy = <span class="literal">false</span>; <span class="comment">// 是否可以攻击怪物</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> radius; <span class="comment">// 半径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> percentage; <span class="comment">// 进度</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> damageMin; <span class="comment">// 最小伤害</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> damageMax; <span class="comment">// 最大伤害</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> SfxHandler sfxHandler &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;  <span class="comment">// 特效交给专门的类来处理</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">uint</span> timerID; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        gearType = <span class="string">"DropRock"</span>; <span class="comment">// 每个子类维护自己的类型名</span></span><br><span class="line">        gameObject.AddComponent&lt;Rigidbody&gt;(); <span class="comment">// 添加刚体</span></span><br><span class="line">        triggleEnable = <span class="literal">true</span>; </span><br><span class="line"></span><br><span class="line">        sfxHandler = gameObject.AddComponent&lt;SfxHandler&gt;(); <span class="comment">// 添加特效处理脚本</span></span><br><span class="line">        timerID = <span class="keyword">uint</span>.MaxValue;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        TimerHeap.DelTimer(timerID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span>(<span class="params">Collider other</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(triggleEnable)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(other.gameObject.layer == <span class="number">9</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                MogoMainCamera.Instance.Shake(<span class="number">5</span>, <span class="number">0.1f</span>);</span><br><span class="line">                sfxHandler.HandlerFx(<span class="number">500102</span>);</span><br><span class="line"></span><br><span class="line">                SetDamage(MogoUtils.GetEntitiesInRange(transform, radius));</span><br><span class="line"></span><br><span class="line">                triggleEnable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (timerID == <span class="keyword">uint</span>.MaxValue)</span><br><span class="line">                    timerID = TimerHeap.AddTimer(<span class="number">5000</span>, <span class="number">0</span>, RockDestroy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RockDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        sfxHandler.RemoveFXs(<span class="number">500102</span>);</span><br><span class="line">        <span class="comment">// sfxHandler.RemoveFXs(6011);</span></span><br><span class="line">        Destroy(<span class="keyword">this</span>.gameObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetDamage</span>(<span class="params">List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt; entities</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (entities.Count != <span class="number">4</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;<span class="keyword">uint</span>&gt; dummyList = entities[<span class="number">0</span>];</span><br><span class="line">        List&lt;<span class="keyword">uint</span>&gt; playerList = entities[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (canAttackDummy)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">uint</span> id <span class="keyword">in</span> dummyList)</span><br><span class="line">            &#123;</span><br><span class="line">                EventDispatcher.TriggerEvent(Events.GearEvent.Damage, id, <span class="number">9003</span>, (<span class="keyword">int</span>)<span class="number">2</span>, CalcDamage(MogoWorld.GetEntity(id) <span class="keyword">as</span> EntityParent));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">uint</span> id <span class="keyword">in</span> playerList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (id == MogoWorld.thePlayer.ID)</span><br><span class="line">            &#123;</span><br><span class="line">                EventDispatcher.TriggerEvent(Events.GearEvent.Damage, id, <span class="number">9003</span>, (<span class="keyword">int</span>)<span class="number">2</span>, CalcDamage(MogoWorld.thePlayer <span class="keyword">as</span> EntityParent));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">CalcDamage</span>(<span class="params">EntityParent entity</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(entity.hp * percentage + RandomHelper.GetRandomInt(damageMin, damageMax));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="MogoWorld"><a href="#MogoWorld" class="headerlink" title="MogoWorld"></a><span style="color:#339AFF;">MogoWorld</span></h1><blockquote>
<p>暗黑战神\client\Assets\Scripts\GameLogic\MogoWorld.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：MogoWorld</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：游戏全局数据管理器</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.RPC;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MogoWorld</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> Properties</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> GlobalData globalSetting;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="EntityMyself"><a href="#EntityMyself" class="headerlink" title="EntityMyself"></a>EntityMyself</h1><blockquote>
<p>\client\Assets\Scripts\GameLogic\Entities\EntityMyself.cs 玩家控制的角色的逻辑控制类</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：EntityMyself</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：2</span></span><br><span class="line"><span class="comment">// 模块描述：角色控制对像</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Mogo.Task;</span><br><span class="line"><span class="keyword">using</span> Mogo.Mission;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.RPC;</span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.AI;</span><br><span class="line"><span class="keyword">using</span> Mogo.AI.BT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> VipRealStateEnum</span><br><span class="line">&#123;</span><br><span class="line">    DAILY_GOLD_METALLURGY_TIMES = <span class="number">1</span>, <span class="comment">// 每日已炼金次数</span></span><br><span class="line">    DAILY_RUNE_WISH_TIMES = <span class="number">2</span>, <span class="comment">// 符文已许愿次数</span></span><br><span class="line">    DAILY_ENERGY_BUY_TIMES = <span class="number">3</span>, <span class="comment">// 体力已购买次数</span></span><br><span class="line">    DAILY_EXTRA_CHALLENGE_TIMES = <span class="number">4</span>, <span class="comment">// 每日额外挑战次数</span></span><br><span class="line">    DAILY_HARD_MOD_RESET_TIMES = <span class="number">5</span>, <span class="comment">// 困难副本进入已重置次数</span></span><br><span class="line">    DAILY_RAID_SWEEP_TIMES = <span class="number">6</span>, <span class="comment">// 剧情关卡已扫荡次数</span></span><br><span class="line">    DAILY_TOWER_SWEEP_TIMES = <span class="number">7</span>, <span class="comment">// 试炼之塔已扫荡次数</span></span><br><span class="line">    DAILY_TIME_STAMP = <span class="number">8</span>, <span class="comment">// 每日玩家时间戳记录</span></span><br><span class="line">    DAILY_ITEM_CAN_BUY_ENTER_SDTIMES = <span class="number">9</span>, <span class="comment">// 圣域守卫战额外购买次数</span></span><br><span class="line">    DAILY_MISSION_TIMES = <span class="number">10</span>,<span class="comment">// 每天副本的进入次数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">EntityMyself</span> : <span class="title">EntityPlayer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateActualModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            isCreatingModel = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get()是什么？</span></span><br><span class="line">            AvatarModelData data = AvatarModelData.dataMap.Get((<span class="keyword">int</span>)vocation);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="场景管理"><a href="#场景管理" class="headerlink" title="场景管理"></a>场景管理</h1><p>场景自带了fog，然后light是disable的，没有摄像机。</p>
<blockquote>
<p>\client\Assets\Resources\data\xml\GlobalData.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>0<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chooseServerScene</span>&gt;</span>10001<span class="tag">&lt;/<span class="name">chooseServerScene</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loginScene</span>&gt;</span>10002<span class="tag">&lt;/<span class="name">loginScene</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chooseCharaterScene</span>&gt;</span>10003<span class="tag">&lt;/<span class="name">chooseCharaterScene</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">homeScene</span>&gt;</span>10004<span class="tag">&lt;/<span class="name">homeScene</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loginUI</span>&gt;</span>MogoMainUI.prefab<span class="tag">&lt;/<span class="name">loginUI</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chooseServerUI</span>&gt;</span>MogoMainUI.prefab<span class="tag">&lt;/<span class="name">chooseServerUI</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chooseCharaterUI</span>&gt;</span>MogoMainUI.prefab<span class="tag">&lt;/<span class="name">chooseCharaterUI</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">homeUI</span>&gt;</span>MogoMainUI.prefab<span class="tag">&lt;/<span class="name">homeUI</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">battleUI</span>&gt;</span>MogoMainUI.prefab<span class="tag">&lt;/<span class="name">battleUI</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mainCamera</span>&gt;</span>Main_Camera.prefab<span class="tag">&lt;/<span class="name">mainCamera</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tower_all_sweep_vip_level_i</span>&gt;</span>5<span class="tag">&lt;/<span class="name">tower_all_sweep_vip_level_i</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\MogoSolution\GameData\GlobalData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class GlobalData : GameData&lt;GlobalData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Int32 loginScene &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Int32 chooseServerScene &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Int32 chooseCharaterScene &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Int32 homeScene &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String loginUI &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String chooseServerUI &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String chooseCharaterUI &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String homeUI &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String battleUI &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String mainCamera &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tower_all_sweep_vip_level &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/GlobalData"</span>;</span><br><span class="line">        <span class="comment">//public static Dictionary&lt;int, GlobalData&gt; dataMap &#123; get; set; &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>client\Assets\Resources\data\xml\map_setting.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>10003<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">type_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enterX_i</span>&gt;</span>743<span class="tag">&lt;/<span class="name">enterX_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enterY_i</span>&gt;</span>975<span class="tag">&lt;/<span class="name">enterY_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maxPlayerNum_i</span>&gt;</span>10<span class="tag">&lt;/<span class="name">maxPlayerNum_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modelName</span>&gt;</span>10003_ChooseCharactor.prefab:1<span class="tag">&lt;/<span class="name">modelName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cameraColor</span>&gt;</span>29, 31, 63, 255<span class="tag">&lt;/<span class="name">cameraColor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cameraFar</span>&gt;</span>400<span class="tag">&lt;/<span class="name">cameraFar</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapname_s</span>&gt;</span>test<span class="tag">&lt;/<span class="name">mapname_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">width</span>&gt;</span>100<span class="tag">&lt;/<span class="name">width</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">height</span>&gt;</span>100<span class="tag">&lt;/<span class="name">height</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fog</span>&gt;</span>True<span class="tag">&lt;/<span class="name">fog</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fogColor</span>&gt;</span>29, 31, 63, 255<span class="tag">&lt;/<span class="name">fogColor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fogMode</span>&gt;</span>1<span class="tag">&lt;/<span class="name">fogMode</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">linearFogStart</span>&gt;</span>4<span class="tag">&lt;/<span class="name">linearFogStart</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">linearFogEnd</span>&gt;</span>50<span class="tag">&lt;/<span class="name">linearFogEnd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ambientLight</span>&gt;</span>175,175,175,255<span class="tag">&lt;/<span class="name">ambientLight</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sceneName</span>&gt;</span>10003_ChooseCharactor<span class="tag">&lt;/<span class="name">sceneName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trapID_i</span>&gt;</span>10003<span class="tag">&lt;/<span class="name">trapID_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backgroundMusic</span>&gt;</span>45<span class="tag">&lt;/<span class="name">backgroundMusic</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lightmap</span>&gt;</span>10003_Lightmap.exr<span class="tag">&lt;/<span class="name">lightmap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\MogoSolution\GameData\MapData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class MapData : GameData&lt;MapData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> MapType type &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">short</span> enterX &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">short</span> enterY &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String lightmap &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String lightProbes &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;String, <span class="keyword">bool</span>&gt; modelName &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Color cameraColor &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> cameraFar &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> fog &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Color fogColor &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> FogMode fogMode &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> linearFogStart &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> linearFogEnd &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Color ambientLight &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, Vector3&gt; monstors &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; layerList &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; distanceList &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> String sceneName &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> LightType characherLight &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; npcList &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> trapID &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; backgroundMusic &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/map_setting"</span>;</span><br><span class="line">        <span class="comment">//public static Dictionary&lt;int, MapData&gt; dataMap &#123; get; set; &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MapData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            sceneName = <span class="string">"InstanceScene"</span>;</span><br><span class="line">            enterX = <span class="number">-200</span>;</span><br><span class="line">            enterY = <span class="number">-200</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsSceneShowDeadTip</span>(<span class="params"><span class="keyword">ushort</span> sceneId</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataMap == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!dataMap.ContainsKey(sceneId))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dataMap[sceneId].type == MapType.Special</span><br><span class="line">                || dataMap[sceneId].type == MapType.ARENA)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> LightType : <span class="keyword">byte</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 不加光</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        None = <span class="number">0</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 普通光</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        Normal = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> MapType : <span class="keyword">byte</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 普通地图</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        Normal = <span class="number">0</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 副本地图</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        Special = <span class="number">1</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 试炼之塔</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        ClimbTower = <span class="number">2</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 多人非组队</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        MULTIPLAYER = <span class="number">3</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 世界boss</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        WORLDBOSS = <span class="number">4</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 湮灭之门</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        BURY = <span class="number">5</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 竞技场地图</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        ARENA = <span class="number">6</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 塔防地图</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        TOWERDEFENCE = <span class="number">8</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 袭击地图</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        ASSAULT = <span class="number">9</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> PVP地图</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        OCCUPY_TOWER = <span class="number">11</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 迷雾深渊地图</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        FOGGYABYSS = <span class="number">12</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\ScenesManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">region</span> 模块信息</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：ScenesManager</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：场景管理器</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> HMF;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScenesManager</span> : <span class="title">IEventManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Int32 m_lastScene = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">string</span> m_lastSceneResourceName = String.Empty;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> MapData m_currentMap;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前场景的对象</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;UnityEngine.Object&gt; m_sceneObjects;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ScenesManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_sceneObjects = <span class="keyword">new</span> List&lt;UnityEngine.Object&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 加载摄像机。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="missionID"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="data"&gt;</span>场景地图数据实体对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="loaded"&gt;</span>加载完成后的回调<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadCamera</span>(<span class="params"><span class="keyword">int</span> missionID, MapData data, Action loaded = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            AssetCacheMgr.GetInstanceAutoRelease(</span><br><span class="line">                MogoWorld.globalSetting.mainCamera,</span><br><span class="line">                (prefab, id, go) =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (m_currentMap != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        go.name = Mogo.Util.Utils.GetFileNameWithoutExtention(MogoWorld.globalSetting.mainCamera);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> obj = go <span class="keyword">as</span> GameObject;</span><br><span class="line">                        obj.AddComponent&lt;MogoMainCamera&gt;();</span><br><span class="line"></span><br><span class="line">                        Camera camera = obj.GetComponent&lt;Camera&gt;();</span><br><span class="line"></span><br><span class="line">                        UnityEngine.Object.Destroy(camera.GetComponent&lt;AudioListener&gt;());</span><br><span class="line"></span><br><span class="line">                        camera.backgroundColor = m_currentMap.cameraColor;</span><br><span class="line">                        <span class="comment">// 远剪切平面距离。</span></span><br><span class="line">                        camera.farClipPlane = m_currentMap.cameraFar;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; data.layerList != <span class="literal">null</span> &amp;&amp; data.layerList.Count != <span class="number">0</span> &amp;&amp; data.distanceList != <span class="literal">null</span> &amp;&amp; data.distanceList.Count != <span class="number">0</span> &amp;&amp; data.layerList.Count == data.distanceList.Count )</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">var</span> cull = (go <span class="keyword">as</span> GameObject).AddComponent&lt;MogoCameraCullByLayer&gt;();</span><br><span class="line"></span><br><span class="line">                            cull.LayerList = data.layerList;</span><br><span class="line">                            cull.DistanceList = data.distanceList;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        EventDispatcher.TriggerEvent(SettingEvent.BuildSoundEnvironment, missionID);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (loaded != <span class="literal">null</span>)</span><br><span class="line">                        loaded();</span><br><span class="line">                    TimerHeap.AddTimer(<span class="number">500</span>, <span class="number">0</span>, MogoMessageBox.HideLoading);</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 加载场景。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="data"&gt;</span>场景地图数据实体对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="loaded"&gt;</span>加载结束，参数为是否加载场景<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="sceneName"&gt;</span>场景名称<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="process"&gt;</span>传入UI 加载进度的函数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadScene</span>(<span class="params">MapData data, Action&lt;Boolean&gt; loaded, <span class="keyword">string</span> sceneName, Action&lt;<span class="keyword">int</span>&gt; process = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// try catch避免崩溃</span></span><br><span class="line">            <span class="keyword">try</span> </span><br><span class="line">            &#123;       </span><br><span class="line">                <span class="comment">// 读取和加载是两件事情</span></span><br><span class="line">                <span class="comment">// 定义场景文件读取完毕后的处理函数</span></span><br><span class="line">                Action sceneWasLoaded = () =&gt; </span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 定义场景文件加载完毕后处理</span></span><br><span class="line">                    Action LevelWasLoaded = () =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        LoggerHelper.Debug(<span class="string">"LevelWasLoaded: "</span> + sceneName);</span><br><span class="line">                        <span class="comment">// 找不到对应的prefab</span></span><br><span class="line">                        <span class="keyword">if</span> (data.modelName.Count == <span class="number">0</span>)</span><br><span class="line">                            <span class="keyword">if</span> (loaded != <span class="literal">null</span>)</span><br><span class="line">                                <span class="comment">// 执行加载完成委托</span></span><br><span class="line">                                loaded(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                        LoggerHelper.Debug(<span class="string">"modelName Count: "</span> + data.modelName.Count);</span><br><span class="line">                        <span class="keyword">if</span> (process != <span class="literal">null</span>)</span><br><span class="line">                            process(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 处理prefab</span></span><br><span class="line">                        <span class="comment">// modelName是字典Dictionary&lt;String, bool&gt;</span></span><br><span class="line">                        <span class="comment">// 获得KeyList</span></span><br><span class="line">                        <span class="keyword">var</span> models = data.modelName.Keys.ToList();</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; models.Count; i ++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">var</span> currentOrder = i;</span><br><span class="line">                            LoggerHelper.Debug(<span class="string">"modelName order: "</span> + currentOrder);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 加载场景模型</span></span><br><span class="line">                            <span class="comment">// 参数：prefab名，string类型</span></span><br><span class="line">                            <span class="comment">// 资源实例加载完成回调Action&lt;String, int, Object&gt; loaded，所以go是个对象，可以给它的字段赋值</span></span><br><span class="line">                            <span class="comment">// progress回调 Action&lt;float&gt; progress</span></span><br><span class="line">                            AssetCacheMgr.GetSceneInstance(models[currentOrder], (pref, id, go) =&gt; </span><br><span class="line">                            &#123;</span><br><span class="line">                                go.name = Util.GetFileNameWithoutExtention(models[currentOrder]);</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (data.modelName[models[currentOrder]])</span><br><span class="line">                                    <span class="comment">// Unity可以勾选static来进行静态合批， 运行时也可以 StaticBatchingUtility.Combine()来进行合批。</span></span><br><span class="line">                                    StaticBatchingUtility.Combine(go <span class="keyword">as</span> GameObject);</span><br><span class="line">                                LoggerHelper.Debug(<span class="string">"sceneLoaded: "</span> + go.name);</span><br><span class="line"></span><br><span class="line">                                m_sceneObjects.Add(go);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// currentOrder是List的下标，这儿判断是否是最后一个</span></span><br><span class="line">                                <span class="keyword">if</span> (currentOrder == data.modelName.Count <span class="number">-1</span>)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    AssetCacheMgr.UnloadAssetbundles(models.ToArray());</span><br><span class="line">                                    SwitchLightMapFog(data, loaded);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;, (process) =&gt; </span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">float</span> cur = <span class="number">60</span> * ((progress + currentOrder) / models.Count) + <span class="number">20</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (process != <span class="literal">null</span>)</span><br><span class="line">                                        process((<span class="keyword">int</span>)(cur));</span><br><span class="line">                                &#125;</span><br><span class="line">                            );</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 委托置空</span></span><br><span class="line">                        Driver.Instance.LevelWasLoaded = <span class="literal">null</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ↑ LevelWasLoaded委托赋值完毕，判断然后执行</span></span><br><span class="line">                    <span class="keyword">if</span> (sceneName != <span class="string">"10002_Login"</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Driver.Instance.LevelWasLoaded = () =&gt;</span><br><span class="line">                        &#123;</span><br><span class="line">                            Driver.Instance.StartCoroutine(</span><br><span class="line">                                UnloadUnusedAssets(() =&gt; </span><br><span class="line">                                &#123;</span><br><span class="line">                                    GC.Collect();</span><br><span class="line">                                    LevelWasLoaded();</span><br><span class="line">                                &#125;));</span><br><span class="line">                        &#125;</span><br><span class="line">                        Application.LoadLevel(sceneName);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> </span><br><span class="line">                    &#123;</span><br><span class="line">                        LevelWasLoaded();</span><br><span class="line">                    &#125;</span><br><span class="line">                    LoggerHelper.Debug(<span class="string">"LoadLevel: "</span> + sceneName);</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ↑ sceneWasLoaded委托已经赋值，下面进行判断然后执行</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (SystemSwitch.ReleaseMode)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (process != <span class="literal">null</span>)</span><br><span class="line">                        process(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">                    m_lastSceneResourceName = <span class="keyword">string</span>.Concat(sceneName, <span class="string">".unity"</span>);</span><br><span class="line">                    AssetCacheMgr.GetResource(m_lastSceneResourceName, </span><br><span class="line">                        (scene) =&gt;  <span class="comment">// Action&lt;Object&gt; loaded 资源对象加载完成回调</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            sceneLoaded();</span><br><span class="line">                        &#125;,</span><br><span class="line">                        (progress) =&gt; </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">float</span> cur = <span class="number">15</span> * progress + <span class="number">5</span>;</span><br><span class="line">                            <span class="keyword">if</span> (process != <span class="literal">null</span>)</span><br><span class="line">                                process((<span class="keyword">int</span>)(cur));</span><br><span class="line">                        &#125;</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    sceneWasLoaded();</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Except(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="AssetCacheMgr"><a href="#AssetCacheMgr" class="headerlink" title="AssetCacheMgr"></a>AssetCacheMgr</h1><blockquote>
<p>\client\MogoSolution\LoaderLib\Utils\AssetCacheMgr.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Object = UnityEngine.Object;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须实现接口的所有方法。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILoadAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadInstance</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;String, <span class="keyword">int</span>, Object loaded&gt;</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadInstance</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;String, <span class="keyword">int</span>, Object&gt; loaded, Action&lt;<span class="keyword">float</span>&gt; progress</span>)</span>;</span><br><span class="line">    <span class="function">Object <span class="title">SynLoadInstance</span>(<span class="params"><span class="keyword">string</span> prefab</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadSceneInstance</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;String, <span class="keyword">int</span>, Object&gt; loaded, Action&lt;<span class="keyword">float</span>&gt; progress</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadAsset</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;Object&gt; loaded</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadAsset</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;Object&gt; loaded, Action&lt;<span class="keyword">float</span>&gt; progress</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadUIAsset</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;Object&gt; loaded, Action&lt;<span class="keyword">float</span>&gt; progress</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SecondLoadAsset</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;Object&gt; loaded, Action&lt;<span class="keyword">float</span>&gt; progress</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SecondLoadUIAsset</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;Object&gt; loaded, Action&lt;<span class="keyword">float</span>&gt; progress</span>)</span>;</span><br><span class="line">    <span class="function">Object <span class="title">SynLoadAsset</span>(<span class="params"><span class="keyword">string</span> prefab</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadSceneAsset</span>(<span class="params"><span class="keyword">string</span> prefab, Action&lt;Object&gt; loaded</span>)</span>;</span><br><span class="line">    <span class="function">Object <span class="title">LoadLocalInstance</span>(<span class="params"><span class="keyword">string</span> prefab</span>)</span>;</span><br><span class="line">    <span class="function">Object <span class="title">LoadLocalAsset</span>(<span class="params"><span class="keyword">string</span> prefab</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ReleaseLocalAsset</span>(<span class="params"><span class="keyword">string</span> prefab</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Release</span>(<span class="params"><span class="keyword">string</span> prefab</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Release</span>(<span class="params"><span class="keyword">string</span> prefab, Boolean releaseAsset</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ReleaseUnusedAssets</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SetPathMap</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ForceClear</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ClearLoadAssetTasks</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UnloadAsset</span>(<span class="params"><span class="keyword">string</span> prefab</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AssetCacheMgr</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">string</span>&gt; m_gameObjectNameMapping = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ILoadAsset m_assetMgr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ILoadAsset AssetMgr</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_assetMgr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            m_assetMgr = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取场景资源实例。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="resourceName"&gt;</span>资源文件名（不带路径，带后缀）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="loaded"&gt;</span>资源实例加载完成回调<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=""&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetSceneInstance</span>(<span class="params"><span class="keyword">string</span> resourceName, Action&lt;String, <span class="keyword">int</span>, Object&gt; loaded, Action&lt;<span class="keyword">float</span>&gt; progress</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_assetMgr.LoadSceneInstance(resourceName, (pref, guid, go) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(guid == <span class="number">-1</span>)</span><br><span class="line">                m_gameObjectNameMapping.Add(guid, resourceName);</span><br><span class="line">            <span class="keyword">if</span> (loaded != <span class="literal">null</span>)</span><br><span class="line">                loaded(pref, guid, go);</span><br><span class="line">        &#125;, progress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="任务与剧情"><a href="#任务与剧情" class="headerlink" title="任务与剧情"></a><span style="color:#339AFF;">任务与剧情</span></h1><blockquote>
<p>\client\Assets\Resources\data\xml\ChineseData.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">record</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>100001<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content_s</span>&gt;</span>刺耳的龙吼，炽热的熔岩，这些都消失了！我又看见这久违的阳光了……<span class="tag">&lt;/<span class="name">content_s</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">record</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>100002<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content_s</span>&gt;</span>神使&#123;0&#125;，一年不见了。一年前，你还在屠龙的征途上。<span class="tag">&lt;/<span class="name">content_s</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">record</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>100003<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content_s</span>&gt;</span>一年！多么不可思议！小精灵，请告诉我，为何我会被困在那无止境的噩梦里，请告诉我，混沌军团已经被主神大人击退了。<span class="tag">&lt;/<span class="name">content_s</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>client\MogoSolution\GameData\LanguageData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，爱游</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：LanguageData</span></span><br><span class="line"><span class="comment">// 创建者：Steven Yang</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：2013-2-7</span></span><br><span class="line"><span class="comment">// 模块描述：本地化语言信息数据模块</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class LanguageData : GameData&lt;LanguageData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Monster 数据</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/ChineseData"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LanguageData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            content = <span class="keyword">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Format</span>(<span class="params"><span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">string</span>.Format(content, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> MONEY &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> dataMap.Get(<span class="number">20002</span>).content; &#125;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> EXP &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> dataMap.Get(<span class="number">20003</span>).content; &#125; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> DIAMOND &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> dataMap.Get(<span class="number">20004</span>).content; &#125; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetContent</span>(<span class="params"><span class="keyword">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.ContainsKey(id))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> dataMap.Get(id).content;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Error(String.Format(<span class="string">"Language key &#123;0:0&#125; is not exist "</span>, id));</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"***"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetContent</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.ContainsKey(id))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> dataMap.Get(id).Format(args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Error(String.Format(<span class="string">"Language key &#123;0:0&#125; is not exist "</span>, id));</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"***"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetPVPLevelName</span>(<span class="params"><span class="keyword">int</span> PVPLevel</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> dataMap.Get(<span class="number">3000</span> + PVPLevel).content;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>client\Assets\Resources\data\xml\TaskData.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">task</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name_i</span>&gt;</span>120000<span class="tag">&lt;/<span class="name">name_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nextId_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">nextId_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">level_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">npc_i</span>&gt;</span>150000<span class="tag">&lt;/<span class="name">npc_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pathPoint_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pathPoint_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exp_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">exp_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">money_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">money_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conditionType_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">conditionType_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">condition_l</span>&gt;</span>150000<span class="tag">&lt;/<span class="name">condition_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text_m</span>&gt;</span>100001:0,100002:150000,100003:0,100004:150000,100005:0,100006:150000,100007:150000<span class="tag">&lt;/<span class="name">text_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">autoIcon_i</span>&gt;</span>31310<span class="tag">&lt;/<span class="name">autoIcon_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">isShowNPCTip_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">isShowNPCTip_i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">task</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">task</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name_i</span>&gt;</span>120000<span class="tag">&lt;/<span class="name">name_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nextId_i</span>&gt;</span>3<span class="tag">&lt;/<span class="name">nextId_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">level_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">npc_i</span>&gt;</span>150006<span class="tag">&lt;/<span class="name">npc_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pathPoint_i</span>&gt;</span>150021<span class="tag">&lt;/<span class="name">pathPoint_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exp_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">exp_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">money_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">money_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conditionType_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">conditionType_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">condition_l</span>&gt;</span>150006<span class="tag">&lt;/<span class="name">condition_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text_m</span>&gt;</span>100008:150006,100009:0,100010:150006,100011:150006,100012:150006<span class="tag">&lt;/<span class="name">text_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">autoIcon_i</span>&gt;</span>31310<span class="tag">&lt;/<span class="name">autoIcon_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">isShowNPCTip_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">isShowNPCTip_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tiptext_i</span>&gt;</span>110001<span class="tag">&lt;/<span class="name">tiptext_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">awards1_m</span>&gt;</span>1312001:1,1711011:5<span class="tag">&lt;/<span class="name">awards1_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">awards2_m</span>&gt;</span>1332001:1,1711011:5<span class="tag">&lt;/<span class="name">awards2_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">awards3_m</span>&gt;</span>1372001:1,1711011:5<span class="tag">&lt;/<span class="name">awards3_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">awards4_m</span>&gt;</span>1362001:1,1711011:5<span class="tag">&lt;/<span class="name">awards4_m</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">task</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\MogoSolution\GameData\TaskData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：MissionData</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：任务数据结构</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class TaskData : GameData&lt;TaskData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> type &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> nextId &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> level &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> npc &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; text &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tiptext &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> pathPoint &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> exp &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> money &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; awards1 &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; awards2 &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; awards3 &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; awards4 &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> time &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> conditionType &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; condition &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> cameraAniId &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> avatarAniId &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> autoIcon &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> isShowNPCTip &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/TaskData"</span>;</span><br><span class="line">        <span class="comment">//static public Dictionary&lt;int, TaskData&gt; dataMap &#123; get; set; &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\TaskSystem\TaskManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：MissionManager</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：任务管理器(逻辑层)</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Task</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TaskManager</span> : <span class="title">IEventManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> SkyNPCID = <span class="number">150000</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> InstanceNPCID = <span class="number">149999</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> DialogueRelationship</span><br><span class="line">        &#123;</span><br><span class="line">            You = <span class="number">1</span>,</span><br><span class="line">            OlderToYounger = <span class="number">2</span>,</span><br><span class="line">            YoungerToOlder = <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> EntityMyself theOwner;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> curNPCID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> TaskData m_playerCurrentTask;</span><br><span class="line">        <span class="keyword">public</span> TaskData PlayerCurrentTask</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_playerCurrentTask;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">bool</span> isTalking = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">bool</span> isFirstTask = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 回城延时</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> delayHandleTaskID = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TaskManager</span>(<span class="params">EntityMyself owner, <span class="keyword">int</span> taskMain</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            theOwner = owner;</span><br><span class="line">            InitAvatarTaskList(taskMain);</span><br><span class="line"></span><br><span class="line">            AddListeners();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 初始化任务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=""&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitAvatarTaskList</span>(<span class="params"><span class="keyword">int</span> taskMain</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (taskMain &lt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Debug(<span class="string">"任务ID初始化不合法"</span>);</span><br><span class="line">                taskMain = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (taskMain == <span class="number">1</span>)</span><br><span class="line">                isFirstTask = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (TaskData.dataMap.ContainsKey(taskMain))</span><br><span class="line">                m_playerCurrentTask = TaskData.dataMap[taskMain];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 增加监听</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventDispatcher.AddEventListener&lt;<span class="keyword">int</span>&gt;(Events.TaskEvent.NPCInSight, OnNPCInSight);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除监听</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventDispatcher.RemoveEventListener&lt;<span class="keyword">int</span>&gt;(Events.TaskEvent.NPCInSight, OnNPCInSight);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示对话框</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ShowTaskDialogue</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Mogo.Util.LoggerHelper.Debug(<span class="string">"ShowTaskDialogue"</span>);</span><br><span class="line">            <span class="comment">// m_playerCurrentTask是数据实体类</span></span><br><span class="line">            <span class="keyword">if</span> (m_playerCurrentTask == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Debug(<span class="string">"PlayerCurrentTask == null"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 没有谈话内容，直接谈话结束</span></span><br><span class="line">            <span class="keyword">if</span>(m_playerCurrentTask.text == <span class="literal">null</span>)</span><br><span class="line">            &#123;   </span><br><span class="line">                OnTalkEnd();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_playerCurrentTask.text.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                OnTalkEnd();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;<span class="keyword">string</span>&gt; allName = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">            List&lt;<span class="keyword">string</span>&gt; allImg = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">            List&lt;<span class="keyword">string</span>&gt; allText = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> item <span class="keyword">in</span> m_playerCurrentTask.text)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> npcID = item.Value;</span><br><span class="line">                <span class="keyword">string</span> imageName = <span class="string">""</span>, npcName = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (npcID == <span class="number">0</span>) <span class="comment">// 等于0是自己的英雄</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">int</span> imgID = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">switch</span>(MogoWorld.thePlayer.vocation)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> Vocation.Warrior:</span><br><span class="line">                            imageID = <span class="number">310</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Vocation.Assassin:</span><br><span class="line">                            imageID = <span class="number">311</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Vocation.Archer:</span><br><span class="line">                            imageID = <span class="number">312</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Vocation.Mage:</span><br><span class="line">                            imageID = <span class="number">313</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    imageName = IconData.dataMap.Get(imageID).path;</span><br><span class="line">                    npcName = MogoWorld.thePlayer.name;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="comment">// 不为0就是npc</span></span><br><span class="line">                &#123;</span><br><span class="line">                    imageName = IconData.dataMap.Get(NPCData.dataMap[npcID].dialogBoxImage).path;</span><br><span class="line">                    npcName = LanguageData.GetContent(NPCData.dataMap[npcID].name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">string</span>[] tempText = LanguageData.GetContent(item.Key).Split(<span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tempText.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    tempText[i] = FormatTaskText(tempText[i]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> count = tempText.Length;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    allName.Add(npcName);</span><br><span class="line">                    allImg.Add(imageName);</span><br><span class="line">                    allText.Add(tempText[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ShowMogoTaskUI(allName.ToArray(), allImg.ToArray(), allText.ToArray(), MogoUIManager.Instance.m_NormalMainUI);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="CG"><a href="#CG" class="headerlink" title="CG"></a>CG</h1><blockquote>
<p>\client\Assets\Resources\data\xml\StoryCG1.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>ResetControlStick<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>WhiteCamera 0,0 250<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>3<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>RemoveEntities<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>4<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 500<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>5<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>SetPosition 0 23.38,-0.945,9.16<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>6<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>SetRotation 0 0,25,0<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>7<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>CreateModel 1 2016 3078 1501 0,245,0<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 500<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>9<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>MoveCamera 1 5,5,62,0 5,5,62,0 4000<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>10<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>NormalCamera 0,0 1000<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>11<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 500<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>12<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>ShowDialog 150018 399 105003<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>13<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>OpenUI<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>14<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Wait 6<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>15<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>CloseUI<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>16<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 500<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>17<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>PlaySfx 1 6015<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>18<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>PlayOneAction 1 17<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>19<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>CreateModel 2 1011 1177 1555 0,122,0<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>20<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 1000<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>21<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>ZoomCamera 2 3 5,112 1500 1500<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>22<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 1500<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>23<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>ShowDialog 150019 399 105004<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>24<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>OpenUI<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>25<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Wait 6<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>26<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>CloseUI<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>27<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>MoveCamera 2 3,5,112,0 4,5,112,0 4000<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>28<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 500<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>29<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>MoveTo 2 6.758,-2.412,18.8 1000<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>30<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>Sleep 1000<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>31<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>DestroyModel 1<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>32<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>DestroyModel 2<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>33<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>LockSight<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">story</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>34<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">storyText</span>&gt;</span>End<span class="tag">&lt;/<span class="name">storyText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">story</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\StorySystem\StoryManager.cs CG故事管理</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Task;</span><br><span class="line"><span class="keyword">using</span> HMF;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StoryManager</span> : <span class="title">IEventManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 单例模式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StoryManager m_instance;</span><br><span class="line">    <span class="comment">// CG流程由策划定制</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> config_xml = <span class="string">"xml/storyCG"</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_currentStoryID = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 字典里面套字典，然后以ID为外层字典的key是存储数据的好方式</span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, Dictionary&lt;<span class="keyword">int</span>, String&gt;&gt; m_mapOfStoryMap = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, Dictionary&lt;<span class="keyword">int</span>, String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;String[]&gt; m_commandQueue = <span class="keyword">new</span> Queue&lt;String[]&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 面向接口编程</span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, EntityParent&gt; m_entityList = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, EntityParent&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对象字典</span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, GameObject&gt; m_objectList = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, GameObject&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Action m_callback = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> IsShake &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> IsOpen &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StoryManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_entityList.Add(<span class="number">0</span>, MogoWorld.thePlayer);</span><br><span class="line">        IsOpen = <span class="literal">true</span>;</span><br><span class="line">        IsShake = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StoryManager Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_instance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_instance = <span class="keyword">new</span> StoryManager();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> m_instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EventDispatcher.AddEventListener&lt;SignalEvents&gt;(Events.CommandEvent.CommandEnd, HandleWaitingEvent);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceLoaded, HandleEnterInstance);</span><br><span class="line">        EventDispatcher.AddEventListener(TeachUILogicManager.TEACHUICRASHED, ClearGuide);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;SignalEvents&gt;(Events.CommandEvent.CommandEnd, HandleWaitingEvent);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceLoaded, HandleEnterInstance);</span><br><span class="line">        EventDispatcher.RemoveEventListener(TeachUILogicManager.TEACHUICRASHED, ClearGuide);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 函数适配</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建模型，因为是CG，只创建怪兽模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="id"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="model"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="mapx"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="mapy"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="vec"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="playBornFX"&gt;</span>是否播放出生特效<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CreateModel</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">int</span> model, <span class="keyword">int</span> mapx, <span class="keyword">int</span> mapy, Vector3 vec, <span class="keyword">bool</span> playBornFX = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 创建模型交给专门的怪物逻辑控制类去完成</span></span><br><span class="line">        EntityMonster entity = <span class="keyword">new</span> EntityMonster();</span><br><span class="line">        <span class="comment">// 给怪物逻辑控制类的属性赋值</span></span><br><span class="line">        entity.ID = (<span class="keyword">uint</span>)id;</span><br><span class="line">        entity.model = model;</span><br><span class="line">        Vector3 Point = <span class="keyword">new</span> Vector3();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 在这个位置创建</span></span><br><span class="line">        MogoUtils.GetPointInTerrain((<span class="keyword">float</span>)mapx / <span class="number">100</span>, (<span class="keyword">float</span>)mapy / <span class="number">100</span>, <span class="keyword">out</span> Point);</span><br><span class="line"></span><br><span class="line">        entity.PlayBornFX = playBornFX;</span><br><span class="line">        entity.BillBoard = <span class="literal">false</span>; <span class="comment">// 头顶的标志牌</span></span><br><span class="line">        entity.position = Point;</span><br><span class="line">        entity.rotation = vec;</span><br><span class="line">        <span class="comment">// 创建模型交给怪物逻辑控制类去完成</span></span><br><span class="line">        entity.CreateModel();</span><br><span class="line">        <span class="comment">// entity类的OnMoveTo方法监听MogoMotor.ON_MOVE_TO事件</span></span><br><span class="line">        <span class="comment">// 并获得两个参数，一个是GameObject类型的，一个是Vector3类型的</span></span><br><span class="line">        EventDispatcher.AddEventListener&lt;GameObject, Vector3&gt;(MogoMotor.ON_MOVE_TO, entity.OnMoveTo);</span><br><span class="line">        m_entityList[id] = entity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">PlaySfx</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">int</span> sfxID, <span class="keyword">int</span> start, Vector3 vec</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        GameObject sfx = <span class="keyword">new</span> GameObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="NPC"><a href="#NPC" class="headerlink" title="NPC"></a>NPC</h1><blockquote>
<p>client\Assets\Resources\data\xml\NPCData.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>150001<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name_i</span>&gt;</span>150001<span class="tag">&lt;/<span class="name">name_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mode_i</span>&gt;</span>150001<span class="tag">&lt;/<span class="name">mode_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tips_l</span>&gt;</span>160001<span class="tag">&lt;/<span class="name">tips_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapx_i</span>&gt;</span>4730<span class="tag">&lt;/<span class="name">mapx_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapy_i</span>&gt;</span>4461<span class="tag">&lt;/<span class="name">mapy_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rotation_l</span>&gt;</span>0.0, 251, 0.0<span class="tag">&lt;/<span class="name">rotation_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">colliderRange_f</span>&gt;</span>5<span class="tag">&lt;/<span class="name">colliderRange_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dialogBoxImage_i</span>&gt;</span>300<span class="tag">&lt;/<span class="name">dialogBoxImage_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">standbyAction_i</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">standbyAction_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionList_m</span>&gt;</span>-1:20,21:30<span class="tag">&lt;/<span class="name">actionList_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thinkInterval_l</span>&gt;</span>5000,15000<span class="tag">&lt;/<span class="name">thinkInterval_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">idleTimeRange_l</span>&gt;</span>2000,4000<span class="tag">&lt;/<span class="name">idleTimeRange_l</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>150000<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name_i</span>&gt;</span>150000<span class="tag">&lt;/<span class="name">name_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mode_i</span>&gt;</span>150000<span class="tag">&lt;/<span class="name">mode_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tips_l</span>&gt;</span>0<span class="tag">&lt;/<span class="name">tips_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapx_i</span>&gt;</span>2699<span class="tag">&lt;/<span class="name">mapx_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapy_i</span>&gt;</span>3313<span class="tag">&lt;/<span class="name">mapy_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rotation_l</span>&gt;</span>0.0, 0.0, 0.0<span class="tag">&lt;/<span class="name">rotation_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">colliderRange_f</span>&gt;</span>131<span class="tag">&lt;/<span class="name">colliderRange_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dialogBoxImage_i</span>&gt;</span>305<span class="tag">&lt;/<span class="name">dialogBoxImage_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">standbyAction_i</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">standbyAction_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionList_m</span>&gt;</span>-1:10<span class="tag">&lt;/<span class="name">actionList_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thinkInterval_l</span>&gt;</span>14000,24000<span class="tag">&lt;/<span class="name">thinkInterval_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">idleTimeRange_l</span>&gt;</span>2000,5000<span class="tag">&lt;/<span class="name">idleTimeRange_l</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Resources\data\xml\NPCData.xml</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：NPCData</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：NPC数据结构</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class NPCData : GameData&lt;NPCData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> name &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> mode &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> mapx &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> mapy &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; rotation &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> colliderRange &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> dialogBoxImage &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tips &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> standbyAction &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; actionList &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; thinkInterval &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; idleTimeRange &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">             </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/NPCData"</span>;</span><br><span class="line">        <span class="comment">//static public Dictionary&lt;int, NPCData&gt; dataMap &#123; get; set; &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\Actors\ActorNPC.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ActorNPC</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> EntityNPC theEntity;</span><br><span class="line">    <span class="comment">// 头顶的名字</span></span><br><span class="line">    <span class="keyword">public</span> Transform billboardTrans = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        billboardTrans = transform.FindChild(<span class="string">"slot_billboard"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 变得可见的时候</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnBecameVisible</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        theEntity.SetFlush(<span class="literal">true</span>);</span><br><span class="line">        EventDispatcher.TriggerEvent&lt;<span class="keyword">int</span>&gt;(Events.TaskEvent.NPCInSight, (<span class="keyword">int</span>)theEntity.ID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnBecameInvisible</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        theEntity.SetFlush(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span>(<span class="params">Collider collider</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (collider.tag == <span class="string">"Player"</span> &amp;&amp; MogoWorld.thePlayer.CurrentTask != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 触发消息</span></span><br><span class="line">            <span class="comment">// 靠近NPC</span></span><br><span class="line">            EventDispatcher.TriggerEvent(Events.TaskEvent.CloseToNPC, (<span class="keyword">int</span>)theEntity.ID);</span><br><span class="line">            <span class="comment">// NPC转向玩家</span></span><br><span class="line">            <span class="comment">// 第一个参数是npc</span></span><br><span class="line">            <span class="comment">// 第二个参数是玩家位置</span></span><br><span class="line">            EventDispatcher.TriggerEvent(Events.NPCEvent.TurnToPlayer, MogoWorld.thePlayer.CurrentTask.npc, MogoWorld.thePlayer.Transform);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnTriggerExit</span>(<span class="params">Collider collider</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (collider.tag == <span class="string">"Player"</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 触发消息</span></span><br><span class="line">            <span class="comment">// 离开NPC，参数是NPC的实体ID</span></span><br><span class="line">            EventDispatcher.TriggerEvent(Events.TaskEvent.LeaveFromNPC, (<span class="keyword">int</span>)theEntity.ID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (MogoWorld.thePlayer != <span class="literal">null</span> &amp;&amp; MogoWorld.thePlayer.sceneId == MogoWorld.globalSetting.homeScene &amp;&amp; billboardTrans != <span class="literal">null</span> &amp;&amp; theEntity != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BillboardViewManager.Instance.UpdateBillboardPos(billboardTrans.position, theEntity.ID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GUI\Mogo\MogoObjOptWorker.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MogoObjOptWorker</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    Transform m_myTransform;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Action BecameVisibleCB;</span><br><span class="line">    <span class="keyword">public</span> Action BecameInVisibleCB;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnBecameVisible</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (BecameVisibleCB != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BecameVisibleCB();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnBecameInvisible</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (BecameInVisibleCB != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BecameInVisibleCB();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GUI\Mogo\MogoObjOpt.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> MogoObjType</span><br><span class="line">&#123;</span><br><span class="line">    NPC,</span><br><span class="line">    Player,</span><br><span class="line">    Dummy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MogoObjOpt</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    SkinnedMeshRenderer m_smr;</span><br><span class="line">    MeshRenderer m_mr;</span><br><span class="line">    Transform m_myTransform;</span><br><span class="line">    List&lt;Animation&gt; m_listAnimation = <span class="keyword">new</span> List&lt;Animation&gt;();</span><br><span class="line">    List&lt;Animator&gt; m_listAnimator = <span class="keyword">new</span> List&lt;Animator&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MogoObjType ObjType = MogoObjType.NPC;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_myTransform = transform;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参数true表示不活跃的也可以找到</span></span><br><span class="line">        <span class="keyword">if</span> (m_myTransform.GetComponentsInChildren&lt;SkinnedMeshRenderer&gt;(<span class="literal">true</span>).Length &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_smr = m_myTransform.GetComponentsInChildren&lt;SkinnedMeshRenderer&gt;(<span class="literal">true</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            MogoObjOptWorker worker = m_smr.gameObject.AddComponent&lt;MogoObjOptWorker&gt;();</span><br><span class="line"></span><br><span class="line">            worker.BecameVisibleCB = whenObjBecameInvisible;</span><br><span class="line">            worker.BecameVisibleCB = WhenObjBecameVisible;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_myTransform.GetComponentsInChildren&lt;Animation&gt;(<span class="literal">true</span>).Length &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_myTransform.GetComponentsInChildren&lt;Animation&gt;(<span class="literal">true</span>).Length; ++i)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_listAnimation.Add(m_myTransform.GetComponentsInChildren&lt;Animation&gt;(<span class="literal">true</span>)[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_myTransform.GetComponent&lt;Animation&gt;() != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_listAnimation.Add(m_myTransform.GetComponent&lt;Animation&gt;());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_myTransform.GetComponentsInChildren&lt;Animator&gt;(<span class="literal">true</span>).Length &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_myTransform.GetComponentsInChildren&lt;Animator&gt;(<span class="literal">true</span>).Length; ++i)&#123;</span><br><span class="line"></span><br><span class="line">                                    m_listAnimator.Add(m_myTransform.GetComponentsInChildren&lt;Animator&gt;(<span class="literal">true</span>)[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_myTransform.GetComponent&lt;Animator&gt;() != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_listAnimator.Add(m_myTransform.GetComponent&lt;Animator&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WhenObjBecameVisible</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_listAnimation.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            m_listAnimation[i].enabled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_listAnimator.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            m_listAnimator[i].enabled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (ObjType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> MogoObjType.NPC:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MogoObjType.Player:</span><br><span class="line">                BillboardViewManager.Instance.ShowBillboard(GetComponent&lt;ActorPlayer&gt;().theEntity.ID, <span class="literal">true</span>);</span><br><span class="line">                GetComponent&lt;ActorPlayer&gt;().enabled = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MogoObjType.Dummy:</span><br><span class="line">                BillboardViewManager.Instance.ShowBillboard(GetComponent&lt;ActorDummy&gt;().theEntity.ID, <span class="literal">true</span>);</span><br><span class="line">                GetComponent&lt;ActorDummy&gt;().enabled = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">whenObjBecameInvisible</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_listAnimation.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            m_listAnimation[i].enabled = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_listAnimator.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            m_listAnimator[i].enabled = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (ObjType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> MogoObjType.NPC:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MogoObjType.Player:</span><br><span class="line">                BillboardViewManager.Instance.ShowBillboard(GetComponent&lt;ActorPlayer&gt;().theEntity.ID, <span class="literal">false</span>);</span><br><span class="line">                GetComponent&lt;ActorPlayer&gt;().enabled = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MogoObjType.Dummy:</span><br><span class="line">                BillboardViewManager.Instance.ShowBillboard(GetComponent&lt;ActorDummy&gt;().theEntity.ID, <span class="literal">false</span>);</span><br><span class="line">                GetComponent&lt;ActorDummy&gt;().enabled = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\Entities\EntityNPC.cs NPC的逻辑控制</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Mogo.RPC;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EntityNPC</span> : <span class="title">EntityParent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 常量</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 粒子</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> NPC_QUESTION_MARK_NAME = <span class="string">"fx_ui_jt_l.prefab"</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> NPC_EXCLAMATION_MARK_NAME = <span class="string">"fx_ui_jt_h.prefab"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> SIGN_SLOT = <span class="string">"Bip01_Master/Bip01"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 动画触发条件，参数Action为-1就闲逛，-2就讲话</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> IDLE_ACTION = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> TALKING_ACTION = <span class="number">-2</span>; </span><br><span class="line">        </span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 公共变量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> NPCSignState</span><br><span class="line">        &#123;</span><br><span class="line">            Doing,</span><br><span class="line">            Done,</span><br><span class="line">            None</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> NPCSignState signState = NPCSignState.None;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> GameObject NPCDoingSign = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> GameObject NPCDoneSign = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> standbyAction;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; actionList;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; thinkInterval;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; idleTimeRange;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span> idleTime;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 私有变量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> isFrush = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> MogoMotorNPC npcMotor;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">int</span> fixSum;</span><br><span class="line">        <span class="keyword">protected</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; fixActionList;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">uint</span> thinkTimer;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">uint</span> resetTimer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Actor开头的都是挂载到游戏对象上的</span></span><br><span class="line">        <span class="keyword">protected</span> ActorNPC ap;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">CreateModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            LoggerHelper.Debug(<span class="string">"EntityNPC create:"</span> + ID);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> modelID = NPCData.dataMap[(<span class="keyword">int</span>)ID].mode;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 没有模型且不是精灵，退出</span></span><br><span class="line">            <span class="keyword">if</span> (!AvatarModelData.dataMap.ContainsKey(modelID) &amp;&amp; modelID != <span class="number">150000</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 不是精灵，精灵没有模型</span></span><br><span class="line">            <span class="keyword">if</span> (modelID != <span class="number">150000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AvatarModelData data = AvatarModelData.dataMap[modelID];</span><br><span class="line"></span><br><span class="line">                AssetCacheMgr.GetInstanceAutoRelease(</span><br><span class="line">                    data.prefabName,</span><br><span class="line">                    (prefab, guid, gameObject) =&gt; </span><br><span class="line">                    &#123;</span><br><span class="line">                        GameObject = gameObject <span class="keyword">as</span> GameObject;</span><br><span class="line">                        Transform = (gameObject <span class="keyword">as</span> GameObject).transform;</span><br><span class="line">                        Transform.position = position;</span><br><span class="line"></span><br><span class="line">                        Transform.eulerAngles = rotation;</span><br><span class="line"></span><br><span class="line">                        animator = GameObject.GetComponent&lt;Animator&gt;();</span><br><span class="line">                        SetIdleAction();</span><br><span class="line"></span><br><span class="line">                        motor = <span class="literal">null</span>;</span><br><span class="line">                        npcMotor = GameObject.AddComponent&lt;MogoMotorNPC&gt;();</span><br><span class="line"></span><br><span class="line">                        GameObject.tag = <span class="string">"NPC"</span>;</span><br><span class="line">                        GameObject.layer = <span class="number">17</span>;</span><br><span class="line"></span><br><span class="line">                        UpdatePosition();</span><br><span class="line"></span><br><span class="line">                        ap = Transform.GetComponent&lt;ActorNPC&gt;();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ap == <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Transform.gameObject.AddComponent&lt;ActorNPC&gt;();</span><br><span class="line">                            ap = Transform.GetComponent&lt;ActorNPC&gt;();</span><br><span class="line">                            (ap <span class="keyword">as</span> ActorNPC).theEntity = <span class="keyword">this</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        SphereCollider collider = Transform.gameObject.AddComponent&lt;SphereCollider&gt;();</span><br><span class="line">                        collider.isTrigger = <span class="literal">true</span>;</span><br><span class="line">                        collider.center = Vector3.zero;</span><br><span class="line"></span><br><span class="line">                        collider.radius = NPCData.dataMap[(<span class="keyword">int</span>)ID].colliderRange / ((Transform.localScale.x &lt; Transform.localScale.y ? Transform.localScale.x : Transform.localScale.y) &lt; Transform.localScale.z ? (Transform.localScale.x &lt; Transform.localScale.y ? Transform.localScale.x : Transform.localScale.y) : Transform.localScale.z);</span><br><span class="line"></span><br><span class="line">                        BillboardLogicManager.Instance.AddInfoBillboard(ID, Transform, <span class="keyword">this</span>, <span class="literal">false</span>);</span><br><span class="line">                        BillboardLogicManager.Instance.SetHead(<span class="keyword">this</span>);</span><br><span class="line">                        EventDispatcher.TriggerEvent&lt;Vector3,<span class="keyword">uint</span>&gt;(BillboardLogicManager.BillboardLogicEvent.UPDATEBILLBOARDPOS, Transform.position,ID);</span><br><span class="line"></span><br><span class="line">                        MogoFXManager.Instance.AddShadow(GameObject, ID, <span class="number">1</span> / Transform.localScale.x, <span class="number">1</span> / Transform.localScale.y, <span class="number">1</span> / Transform.localScale.z);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (MogoWorld.thePlayer.CurrentTask != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (MogoWorld.thePlayer.CurrentTask.conditionType == <span class="number">1</span> &amp;&amp; MogoWorld.thePlayer.CurrentTask.condition != <span class="literal">null</span></span><br><span class="line">                                &amp;&amp; MogoWorld.thePlayer.CurrentTask.condition.Count &gt;= <span class="number">3</span> &amp;&amp; TaskData.dataMap.Get(MogoWorld.thePlayer.CurrentTask.condition[<span class="number">2</span>]).npc == (<span class="keyword">int</span>)ID)</span><br><span class="line">                            &#123;</span><br><span class="line">                                SetNPCSign(NPCSignState.Doing);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (MogoWorld.thePlayer.CurrentTask.isShowNPCTip == <span class="number">1</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                SetNPCSign(NPCSignState.Done);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        ((GameObject)gameObject).AddComponent&lt;MogoObjOpt&gt;().ObjType = MogoObjType.NPC;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (((GameObject)gameObject).GetComponent&lt;Animator&gt;() != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ((GameObject)gameObject).GetComponent&lt;Animator&gt;().enabled = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (((GameObject)gameObject).GetComponent&lt;Animation&gt;() != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ((GameObject)gameObject).GetComponent&lt;Animation&gt;().enabled = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!NPCManager.npcEntitiePosition.ContainsKey((<span class="keyword">uint</span>)ID))</span><br><span class="line">                            NPCManager.npcEntitiePosition.Add((<span class="keyword">uint</span>)ID, Transform.position);</span><br><span class="line"></span><br><span class="line">                        EventDispatcher.TriggerEvent(Events.TaskEvent.CheckNpcInRange);</span><br><span class="line"></span><br><span class="line">                        NPCCheckThink();</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="comment">// 精灵没有模型</span></span><br><span class="line">            &#123;</span><br><span class="line">                GameObject = <span class="keyword">new</span> GameObject();</span><br><span class="line">                GameObject.name = <span class="string">"Sky_NPC"</span>;</span><br><span class="line">                Transform = GameObject.transform;</span><br><span class="line">                Transform.position = position;</span><br><span class="line">                Transform.eulerAngles = rotation;</span><br><span class="line"></span><br><span class="line">                GameObject.tag = <span class="string">"NPC"</span>;</span><br><span class="line"></span><br><span class="line">                UpdatePosition();</span><br><span class="line"></span><br><span class="line">                ActorNPC ap = Transform.GetComponent&lt;ActorNPC&gt;();</span><br><span class="line">                <span class="keyword">if</span> (ap == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Transform.gameObject.AddComponent&lt;ActorNPC&gt;();</span><br><span class="line">                    ap = Transform.GetComponent&lt;ActorNPC&gt;();</span><br><span class="line">                    (ap <span class="keyword">as</span> ActorNPC).theEntity = <span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                SphereCollider collider = Transform.gameObject.AddComponent&lt;SphereCollider&gt;();</span><br><span class="line">                collider.isTrigger = <span class="literal">true</span>;</span><br><span class="line">                collider.center = Vector3.zero;</span><br><span class="line">                collider.radius = <span class="number">5</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetIdleAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animator != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                animator.SetInteger(<span class="string">"Action"</span>, standbyAction);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetTalkAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animator != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                animator.SetInteger(<span class="string">"Action"</span>, TALKING_ACTION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TalkEnd</span>(<span class="params"><span class="keyword">int</span> npcID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (npcID == ID)</span><br><span class="line">            &#123;</span><br><span class="line">                SetIdleAction();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdatePosition</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector3 point;</span><br><span class="line"></span><br><span class="line">            LoggerHelper.Debug(<span class="string">"model info "</span> + position.x + <span class="string">" z: "</span> + position.z);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Mogo.Util.MogoUtils.GetPointInTerrain(position.x, position.z, <span class="keyword">out</span> point) &amp;&amp; Transform)</span><br><span class="line">                Transform.position = <span class="keyword">new</span> Vector3(point.x, point.y, point.z);</span><br><span class="line"></span><br><span class="line">            Transform.eulerAngles = <span class="keyword">new</span> Vector3(<span class="number">0</span>, rotation.y, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\AvatarControl\MogoMotorNPC.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MogoMotorNPC</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> rotateSpeed = <span class="number">360f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> isTurningTo = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> Transform turnToTarget;</span><br><span class="line">    <span class="keyword">private</span> Action turnEndAction;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> direction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Destroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (turnToTarget)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">float</span> deltaTime = Time.deltaTime;</span><br><span class="line">            <span class="comment">// 计算角度</span></span><br><span class="line">            <span class="keyword">float</span> deltaAngle = Vector3.Angle(transform.forward, FixPosition(turnToTarget.position) - transform.position);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (deltaAngle == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                StopTurnTo();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (rotateSpeed * deltaTime &gt; deltaAngle)</span><br><span class="line">                &#123;</span><br><span class="line">                    StopTurnTo();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (direction)</span><br><span class="line">                &#123;</span><br><span class="line">                    transform.Rotate(<span class="number">0</span>, -rotateSpeed * deltaTime, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    transform.Rotate(<span class="number">0</span>, rotateSpeed * deltaTime, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 转向</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TurnTo</span>(<span class="params">Transform theTarget, Action action = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">float</span> deltaAngle = Vector3.Angle(transform.forward, FixPosition(theTarget.position) - transform.position);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deltaAngle &gt; <span class="number">25</span> || deltaAngle &lt; <span class="number">-25</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            isTurningTo = <span class="literal">true</span>;</span><br><span class="line">            turnToTarget = theTarget;</span><br><span class="line">            turnEndAction = action;</span><br><span class="line"></span><br><span class="line">            Vector2 vsrc = <span class="keyword">new</span> Vector2(transform.forward.x, transform.forward.z);</span><br><span class="line">            Vector2 vdes = <span class="keyword">new</span> Vector2(theTarget.position.x - transform.forward.x, theTarget.position.z - transform.forward.z);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (vsrc * vdes.y - vsrc.y * vsrc.x &lt; <span class="number">0</span>)</span><br><span class="line">                direction = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                direction = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            action();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckStopTurnTo</span>(<span class="params">GameObject theEntityGameObject, Vector3 thePosition</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (isTurningTo)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (theEntityGameObject == MogoWorld.thePlayer.GameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                StopTurnTo();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">StopTurnTo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        isTurningTo = <span class="literal">false</span>;</span><br><span class="line">        transform.LookAt(FixPosition(turnToTarget.position));</span><br><span class="line">        turnToTarget = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (turnEndAction != <span class="literal">null</span>)</span><br><span class="line">            turnEndAction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用这个脚本挂载的对象的y轴</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Vector3 <span class="title">FixPosition</span>(<span class="params">Vector3 srcPosition</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Vector3(srcPosition.x, transform.position.y, srcPosition.z);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="PathPoint"><a href="#PathPoint" class="headerlink" title="PathPoint"></a>PathPoint</h1><blockquote>
<p>\client\Assets\Plugins\Utils\PathPoint.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Copyright (C) 2013 广州，爱游</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 模块名：PathPoint</span></span><br><span class="line"><span class="comment">// 创建者：</span></span><br><span class="line"><span class="comment">// 修改者列表：</span></span><br><span class="line"><span class="comment">// 创建日期：</span></span><br><span class="line"><span class="comment">// 模块描述：寻路点，随便绑在某个物体上，id必须唯一</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------*/</span></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PathPoint</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 路径点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, Vector3&gt; pathPointDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, Vector3&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt; pathPointDistance = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, Vector3&gt; tempPathPointDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, Vector3&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt; tempPathPointDistance = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> RANDOM_SUBPATHPOINT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> distance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pathPointDic.ContainsKey(id))</span><br><span class="line">        &#123;</span><br><span class="line">            pathPoint.Add(id, transform.position);</span><br><span class="line">            <span class="keyword">if</span> (!pathPointDistance.ContainsKey(id))</span><br><span class="line">                pathPointDistance.Add(id, distance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加子路径点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="id"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="position"&gt;</span>位置向量<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="stopDistance"&gt;</span>停止距离<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddSubPathPoint</span>(<span class="params"><span class="keyword">int</span> id, Vector3 position, <span class="keyword">float</span> stopDistance</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pathPointDic.ContainsKey(id))</span><br><span class="line">        &#123;</span><br><span class="line">            pathPointDic.Add(id, position);</span><br><span class="line">            <span class="keyword">if</span> (!pathPointDistance.ContainsKey(id))</span><br><span class="line">                pathPointDistance.Add(id, stopDistance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 得到最近的地点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="playerPosition"&gt;</span>玩家位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="main"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="stardardPosition"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>字典索引<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GetFixNearestPlace</span>(<span class="params">Vector3 playerPosition, <span class="keyword">int</span> main, Vector3 stardardPosition</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        tempPathPointDic.Clear();</span><br><span class="line">        tempPathPointDistance.Clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pathPointDistance[main] &lt;= <span class="number">1.5</span>)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 导航系统计算出的路径。</span></span><br><span class="line">        NavMeshPath path = <span class="keyword">new</span> NavMeshPath(); </span><br><span class="line">        <span class="comment">// NavMesh.CalculatePath（Vector3 sourcePosition所请求路径的初始位置， Vector3 targetPosition所请求路径的最终位置，int areaMask一个位域掩码，指定在计算路径时可以通过哪些NavMesh区域， AI.NavMeshPath path结果路径）;计算两点之间的路径并存储结果路径。</span></span><br><span class="line">        <span class="keyword">if</span> (!NavMesh.CalculatePath(playerPosition, pathPointDic[main], <span class="number">-1</span>, path))</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        <span class="comment">// NavMeshPath.corners路径的路点（waypoints）</span></span><br><span class="line">        <span class="keyword">if</span> (path.corners.Length &lt; <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; RANDOM_SUBPATHPOINT; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 fixPosition = GetRandomVector3InRangeCircle(pathPointDistance[main] - <span class="number">1.5f</span>);</span><br><span class="line"></span><br><span class="line">            tempPathPointDic.Add(<span class="number">100</span> * main + i, fixPosition + stardardPosition);</span><br><span class="line">            tempPathPointDistance.Add(<span class="number">100</span> * main + i, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Vector3 turn = path.corners[path.corners.Length - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> standardDistance = Vector3.Distance(turn, pathPointDic[main]);</span><br><span class="line">        <span class="keyword">float</span> resultDistance = standardDistance;</span><br><span class="line">        <span class="keyword">float</span> offset = standardDistance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> tempData <span class="keyword">in</span> tempPathPointDic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">float</span> tempSourceDistance = Vector3.Distance(pathPointDic[main], tempData.Value);</span><br><span class="line">            <span class="keyword">if</span> (tempSourceDistance &lt; <span class="number">0.6f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> tempDistance1 = Vector3.Distance(tempData.Value, pathPointDic[main]);</span><br><span class="line">            <span class="keyword">float</span> tempDistance2 = Vector3.Distance(tempData.Value, turn);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tempDistance1 &lt; standardDistance &amp;&amp; tempDistance2 &lt; standardDistance</span><br><span class="line">                &amp;&amp; tempDistance1 &gt; <span class="number">0</span> &amp;&amp; tempDistance2 &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> tempData.Key;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GetNearestPlace</span>(<span class="params">Vector3 playerPosition, <span class="keyword">int</span> main</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> GetFixNearestPlace(playerPosition, main, pathPointDic[main]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> System.Random globalRandomGenerator = Utils.CreateRandom();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">GetRandomFloat</span>(<span class="params"><span class="keyword">float</span> min, <span class="keyword">float</span> max</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (min &lt; max)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">float</span>)globalRandomGenerator.NextDouble() * (max - min) + min;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">GetRandomVector3InRangeCircle</span>(<span class="params"><span class="keyword">float</span> rangeTo, <span class="keyword">float</span> rangeFrom = <span class="number">0</span>, <span class="keyword">float</span> angleTo = <span class="number">360</span>, <span class="keyword">float</span> angleFrom = <span class="number">0</span>, floay y = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">float</span> length = GetRandomFloat(rangeFrom, rangeTo);</span><br><span class="line">        <span class="keyword">float</span> angle = GetRandomFloat(angleFrom, angleTo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Vector3((<span class="keyword">float</span>)(length * Math.Sin(angle * Math.PI / <span class="number">180.0</span>)),</span><br><span class="line">            y,</span><br><span class="line">            (<span class="keyword">float</span>)(length * Math.Cos(angle * Math.PI / <span class="number">180.0</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Plugins\Utils\SubPathPoint.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SubPathPoint</span> : <span class="title">PathPoint</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mainPathPoint;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">int</span>&gt;&gt; pathPointLink = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        PathPoint.AddSubPathPoint(id, transform.position, distance);</span><br><span class="line">        AddMainPathPointLink();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddMainPathPointLink</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pathPointLink.ContainsKey(mainPathPoint))</span><br><span class="line">            pathPointLink.Add(mainPathPoint, <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pathPointLink[mainPathPoint] == <span class="literal">null</span>)</span><br><span class="line">            pathPointLink[mainPathPoint] = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!pathPointLink[mainPathPoint].Contains(id))</span><br><span class="line">            pathPointLink[mainPathPoint].Add(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GetNearestSubPoint</span>(<span class="params">Vector3 playerPosition, <span class="keyword">int</span> main</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pathPointLink.ContainsKey(main))</span><br><span class="line">            <span class="keyword">return</span> main;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pathPointLink[main] == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> main;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">float</span> resultDistance = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pathPointDic.ContainsKey(main))</span><br><span class="line">        &#123;</span><br><span class="line">            result = main;</span><br><span class="line">            resultDistance = Vector3.Distance(playerPosition, pathPointDic[main]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">int</span> subID <span class="keyword">in</span> pathPointLink[main])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">float</span> tempDistance = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pathPointDic.ContainsKey(subID))</span><br><span class="line">                tempDistance = Vector3.Distance(playerPosition, pathPointDic[subID]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tempDistance &lt; resultDistance &amp;&amp; tempDistance &gt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                result = subID;</span><br><span class="line">                resultDistance = tempDistance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="新手引导"><a href="#新手引导" class="headerlink" title="新手引导"></a><span style="color:#339AFF;">新手引导</span></h1><blockquote>
<p>\client\Assets\Resources\data\xml\guide.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>91<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group_i</span>&gt;</span>17<span class="tag">&lt;/<span class="name">group_i</span>&gt;</span> <span class="comment">&lt;!-- 组 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">step_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">step_i</span>&gt;</span> <span class="comment">&lt;!-- 第几步 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conditionEvent_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">conditionEvent_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">event_arg1_s</span>&gt;</span>90+<span class="tag">&lt;/<span class="name">event_arg1_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">guideLevel_l</span>&gt;</span>90,99<span class="tag">&lt;/<span class="name">guideLevel_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">guideTimes_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">guideTimes_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_i</span>&gt;</span>6<span class="tag">&lt;/<span class="name">target_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_arg2_s</span>&gt;</span>0<span class="tag">&lt;/<span class="name">target_arg2_s</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 15000是精灵NPCData.xml --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">            9110是ChineseData.xml的数据 </span></span><br><span class="line"><span class="comment">            您在战斗中获得了竞技场积分，我们看一下它能怎样使用吧！</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">openDialog_s</span>&gt;</span>150000 305 9110<span class="tag">&lt;/<span class="name">openDialog_s</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>92<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group_i</span>&gt;</span>17<span class="tag">&lt;/<span class="name">group_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">step_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">step_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">target_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_arg1_s</span>&gt;</span>7<span class="tag">&lt;/<span class="name">target_arg1_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_arg2_s</span>&gt;</span>1<span class="tag">&lt;/<span class="name">target_arg2_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text_i</span>&gt;</span>9111<span class="tag">&lt;/<span class="name">text_i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>93<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group_i</span>&gt;</span>17<span class="tag">&lt;/<span class="name">group_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">step_i</span>&gt;</span>3<span class="tag">&lt;/<span class="name">step_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">target_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_arg1_s</span>&gt;</span>204<span class="tag">&lt;/<span class="name">target_arg1_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_arg2_s</span>&gt;</span>1<span class="tag">&lt;/<span class="name">target_arg2_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text_i</span>&gt;</span>9112<span class="tag">&lt;/<span class="name">text_i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>94<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group_i</span>&gt;</span>17<span class="tag">&lt;/<span class="name">group_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">step_i</span>&gt;</span>4<span class="tag">&lt;/<span class="name">step_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_i</span>&gt;</span>6<span class="tag">&lt;/<span class="name">target_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target_arg2_s</span>&gt;</span>0<span class="tag">&lt;/<span class="name">target_arg2_s</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">openDialog_s</span>&gt;</span>150000 305 9113<span class="tag">&lt;/<span class="name">openDialog_s</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\MogoSolution\GameData\GuideXMLData.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class GuideXMLData : GameData&lt;GuideXMLData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 表格对应数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> <span class="keyword">group</span> &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125; <span class="comment">// 组</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> step &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125; <span class="comment">// 第几步</span></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt; restriction &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125; <span class="comment">// 限制</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> conditionEvent &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 触发条件</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> event_arg1 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> event_arg2 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; guideLevel &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 引导等级</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> guideTimes &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 引导事件</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> priority &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 优先级</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> target &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 目标</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> target_arg1 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> target_arg2 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> openGUI &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> openDialog &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 打开对话</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> text &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/guide"</span>;</span><br><span class="line">   </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 二次抽取数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="keyword">int</span>&gt; m_events;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; ConditionEvent</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_events == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_IPHONE</span></span><br><span class="line">                    m_events = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">                    <span class="keyword">foreach</span>(<span class="keyword">var</span> v <span class="keyword">in</span> dataMap)</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_events.Add(v.<span class="keyword">value</span>.conditionEvent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Distinct是List自带的函数，去重</span></span><br><span class="line">                    m_events.Distinct();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                    m_events = (<span class="keyword">from</span> data <span class="keyword">in</span> dataMap <span class="keyword">select</span> data.<span class="keyword">value</span>.conditionEvent).Distinct().ToList();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>            </span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> m_events;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">int</span>&gt;&gt; m_links;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">int</span>&gt;&gt; Links</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_links == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_IPHONE</span></span><br><span class="line">                    m_links = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">int</span>&gt;&gt;();</span><br><span class="line">                    List&lt;<span class="keyword">int</span>&gt; temp;</span><br><span class="line">                    <span class="keyword">foreach</span>(<span class="keyword">var</span> v <span class="keyword">in</span> dataMap)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!m_links.ContainsKey(v.Value.<span class="keyword">group</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            temp = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">                            temp.Add(v.Value.step);</span><br><span class="line">                            m_links.Add(v.Key, temp);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> </span><br><span class="line">                        &#123;</span><br><span class="line">                            m_links[v.Value.<span class="keyword">group</span>].Add(v.Value.step);</span><br><span class="line">                            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                            List.sort()有四种形式：</span></span><br><span class="line"><span class="comment">                            如果T是基本类型的话，.sort()是可以直接使用的，比如List、List等</span></span><br><span class="line"><span class="comment">                            如果是我们自己定义的Class的话，我们就必须自己定义，这时我们需要：IComparer接口中的Compare函数</span></span><br><span class="line"><span class="comment">                            1. .sort()</span></span><br><span class="line"><span class="comment">                                 在List中的元素对象必须继承于IComparer，而且实现了CompareTo()方法，基本上所有的值类型都有，也包括string等</span></span><br><span class="line"><span class="comment">                            2. .sort(IComparer&lt;T&gt;)</span></span><br><span class="line"><span class="comment">                                 基于自定义的类实现</span></span><br><span class="line"><span class="comment">                            3. .sort(IComparison&lt;T&gt;)</span></span><br><span class="line"><span class="comment">                            4. .sort(int32,int32,IComparer&lt;T&gt;)</span></span><br><span class="line"><span class="comment">                                 是第二种形式的扩展，可以规定排序范围</span></span><br><span class="line"><span class="comment">                            */</span></span><br><span class="line">                            m_links[v.Value.<span class="keyword">group</span>].Sort();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                    m_links = dataMap.GroupBy(a =&gt; a.Value.<span class="keyword">group</span>)</span><br><span class="line">                            .ToDictionary(gdc =&gt; gdc.Key, </span><br><span class="line">                                gdc =&gt; gdc.OrderBy(x=&gt;x.Value.step)</span><br><span class="line">                            .Select(x=&gt;x.Value.id)</span><br><span class="line">                            .ToList());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>                </span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> m_links;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据读取方法，包括切片和联合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="events"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; <span class="title">GetIDByEvent</span>(<span class="params"><span class="keyword">int</span> events</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_IPHONE</span></span><br><span class="line">            List&lt;<span class="keyword">int</span>&gt;   lRet=<span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> v <span class="keyword">in</span> dataMap)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(v.Value.conditionEvent==events)</span><br><span class="line">                &#123;</span><br><span class="line">                    lRet.Add(v.Key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> lRet;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            <span class="keyword">var</span> d = <span class="keyword">from</span> t <span class="keyword">in</span> dataMap</span><br><span class="line">                    <span class="keyword">where</span> t.Value.conditionEvent == events</span><br><span class="line">                    <span class="keyword">select</span> t.Key;</span><br><span class="line">            <span class="keyword">return</span> d.ToList();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\GuideSystem\GuideSystem.cs 新手指引系统 </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GuideSystem</span> : <span class="title">IEventManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 单例模式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> GuideSystem m_instance;</span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; _guideTimes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引导队列</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="keyword">int</span>&gt; m_guideQueue = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsOpen&#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment">// 是否有引导对话</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_isGuideDialog = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsGuideDialog</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_isGuideDialog;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            m_isGuideDialog = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; guideTimes</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">// SystemConfig.Instance.GuideTimes格式</span></span><br><span class="line">            <span class="comment">// Dictionary&lt;ulong, String&gt;()</span></span><br><span class="line">            <span class="keyword">if</span> (SystemConfig.Instance.GuideTimes.ContainsKey(MogoWorld.thePlayer.dbid))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将字典字符串转换为键类型与值类型都为整型的字典对象。</span></span><br><span class="line">                _guideTimes = Utils.ParseMapIntInt(SystemConfig.Instance.GuideTimes[MogoWorld.thePlayer.dbid], <span class="string">'!'</span>, <span class="string">'?'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                _guideTimes = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> _guideTimes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GuideSystem</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IsOpen = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuideSystem Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_instance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_instance = <span class="keyword">new</span> GuideSystem();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> m_instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> implement interface</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceUnLoaded, HandleLeaveInstance);</span><br><span class="line">        EventDispatcher.AddEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceLoaded, HandleEnterInstance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveListeners</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceUnLoaded, HandleLeaveInstance);</span><br><span class="line">        EventDispatcher.RemoveEventListener&lt;<span class="keyword">int</span>, <span class="keyword">bool</span>&gt;(Events.InstanceEvent.InstanceLoaded, HandleEnterInstance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">HandleEnterInstance</span>(<span class="params"><span class="keyword">int</span> sceneID, <span class="keyword">bool</span> isInstance</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        GuideSystem.Instance.TriggerEvent&lt;<span class="keyword">int</span>&gt;(GlobalEvents.EnterInstance, sceneID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">HandleLeaveInstance</span>(<span class="params"><span class="keyword">int</span> sceneID, <span class="keyword">bool</span> isInstance</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        GuideSystem.Instance.TriggerEvent&lt;<span class="keyword">int</span>&gt;(GlobalEvents.LeaveInstance, sceneID);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isInstance)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> level = MogoWorld.thePlayer.level;</span><br><span class="line">            <span class="keyword">if</span> (level &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                GuideSystem.Instance.TriggerEvent&lt;<span class="keyword">byte</span>&gt;(GlobalEvents.ChangeLevel, level);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span>(<span class="params"><span class="keyword">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        StoryManager.Instance.AddCommand(<span class="string">"StartGuideUI"</span>);</span><br><span class="line">        StoryManager.Instance.AddCommand(<span class="string">"Wait 8"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> index <span class="keyword">in</span> GuideXMLData.Links[GuideXMLData.dataMap.Get(id).<span class="keyword">group</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            ConvertToCommand(index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StoryManager.Instance.AddCommand(<span class="string">"UnlockQueue"</span>);</span><br><span class="line">        StoryManager.Instance.AddCommand(<span class="string">"End"</span>);</span><br><span class="line">        StoryManager.Instance.PrintCommandQueue();</span><br><span class="line">        StoryManager.Instance.SetCallBack(</span><br><span class="line">            () =&gt; </span><br><span class="line">            &#123;</span><br><span class="line">                LoggerHelper.Warning(<span class="string">"Guide Complete"</span> + id);</span><br><span class="line">                GuideSystem.Instance.IsGuideDialog = <span class="literal">false</span>;</span><br><span class="line">                SaveGuide(id);</span><br><span class="line">                dequeueGuide();</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        StoryManager.Instance.Execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Utils"><a href="#Utils" class="headerlink" title="Utils"></a>Utils</h1><blockquote>
<p>\client\Assets\Scripts\Utils\MogoUtils.cs 游戏逻辑相关通用工具类</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> System.Security;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Util</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 静态工具类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MogoUtils</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 传入x，z，获得在这个方向上Terrain层是否有物体</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用了out参数，一个函数可获得两个结果</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="x"&gt;</span>x位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="z"&gt;</span>z位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="point"&gt;</span>投射点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>这个位置的地面上是否有物体<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">GetPointInTerrain</span>(<span class="params"><span class="keyword">float</span> x, <span class="keyword">float</span> z, <span class="keyword">out</span> Vector3 point</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            RaycastHit hit;</span><br><span class="line">            <span class="comment">// 第四个参数是只投射此层，忽略其他层</span></span><br><span class="line">            <span class="keyword">var</span> flag = Physics.Linecast(<span class="keyword">new</span> Vector3(x, <span class="number">1000</span>, z), <span class="keyword">new</span> Vector3(x, <span class="number">-1000</span>, z), <span class="keyword">out</span> hit, (<span class="keyword">int</span>)LayerMask.NameToLayer(<span class="string">"Terrain"</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 有碰撞到东西</span></span><br><span class="line">            <span class="keyword">if</span>(flag)</span><br><span class="line">            &#123;</span><br><span class="line">                point = <span class="keyword">new</span> Vector3(hit.point.x, hit.point.y + <span class="number">0</span>,<span class="number">2f</span>, hit.point.z);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                point = <span class="keyword">new</span> Vector3(x, <span class="number">50</span>, z);</span><br><span class="line">                LoggerHelper.Warning(<span class="string">"hit noting:"</span> + x + <span class="string">","</span> + z);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 返回角色周围指定半径范围内的所有对象。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="t"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="radius"&gt;</span>半径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="layerMask"&gt;</span>只获得这些层，其他的忽略<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt; GetEntitiesInRange(<span class="keyword">this</span> Transform t, <span class="keyword">float</span> radius, <span class="keyword">float</span> offsetX = <span class="number">0</span>, <span class="keyword">float</span> offfsetY = <span class="number">0</span>, <span class="keyword">float</span> angleOffset = <span class="number">0</span>, LayerMask layerMask = LayerMask.Monster | LayerMask.Character | LayerMask.Trap)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> GetEntitiesInRange(t.localToWorldMatrix, t.rotation, t.forward, t.position, radius, offsetX, offsetY, angleOffset, layerMask);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt; GetEntitiesInRange(Vector3 position, <span class="keyword">float</span> radius, <span class="keyword">float</span> offsetX = <span class="number">0</span>, <span class="keyword">float</span> offsetY = <span class="number">0</span>, <span class="keyword">float</span> angleOffset = <span class="number">0</span>, LayerMask layerMask = LayerMask.Monster | LayerMask.Character | LayerMask.Trap)</span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt; list = <span class="keyword">new</span> List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt;();</span><br><span class="line">        List&lt;<span class="keyword">uint</span>&gt; listDummy = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line">        List&lt;<span class="keyword">uint</span>&gt; listMonster = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line">        List&lt;<span class="keyword">uint</span>&gt; listPlayer = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line">        List&lt;<span class="keyword">uint</span>&gt; listMercenary = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!MogoWorld.Entities.ContainsKey(MogoWorld.thePlayer.ID))</span><br><span class="line">        &#123;</span><br><span class="line">            MogoWorld.Entities.Add(MogoWorld.thePlayer.ID, MogoWorld.thePlayer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历entities</span></span><br><span class="line">        <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="keyword">uint</span>, Mogo.Game.EntityParent&gt; pair <span class="keyword">in</span> MogoWorld.Entities)</span><br><span class="line">        &#123;</span><br><span class="line">            EntityParent entity = pair.Value;</span><br><span class="line">            <span class="keyword">if</span> (!entity.Transform)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="number">1</span> &lt;&lt; entity.Transform.gameObject.layer &amp; (<span class="keyword">int</span>)layerMask) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> entityRadius = ((<span class="keyword">float</span>)entity.GetIntAttr(<span class="string">"scaleRadius"</span>)) / <span class="number">100f</span>;</span><br><span class="line">            <span class="keyword">if</span> ((position - entity.Transform.position).magnitude &gt; radius + entityRadius) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pair.Value <span class="keyword">is</span> EntityDummy)</span><br><span class="line">            &#123;</span><br><span class="line">                listDummy.Add(pair.Key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (pair.Value <span class="keyword">is</span> EntityMonster)</span><br><span class="line">            &#123;</span><br><span class="line">                listMonster.Add(pair.Key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (pair.Value <span class="keyword">is</span> EntityPlayer)</span><br><span class="line">            &#123;</span><br><span class="line">                listPlayer.Add(pair.Key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (pair.Value <span class="keyword">is</span> EntityMercenary)</span><br><span class="line">            &#123;</span><br><span class="line">                listMercenary.Add(pair.Key);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        MogoWorld.Entities.Remove(MogoWorld.thePlayer.ID);</span><br><span class="line">        list.Add(listDummy);</span><br><span class="line">        list.Add(listMonster);</span><br><span class="line">        list.Add(listPlayer);</span><br><span class="line">        list.Add(listMercenary);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> List&lt;Transform&gt; <span class="title">GetTransformsInSector</span>(<span class="params"><span class="keyword">this</span> Transform t, Dictionary&lt;Transform, <span class="keyword">float</span>&gt; transformDic, <span class="keyword">float</span> radius, <span class="keyword">float</span> angle = <span class="number">180f</span>, LayerMask layerMask = LayerMask.Trap</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        List&lt;Transform&gt; resultList = <span class="keyword">new</span> List&lt;Transform&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历entities</span></span><br><span class="line">        <span class="keyword">foreach</span> (KeyValuePair&lt;Transform, <span class="keyword">float</span>&gt; pair <span class="keyword">in</span> transformDic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="number">1</span> &lt;&lt; pair.Key.gameObject.layer &amp; (<span class="keyword">int</span>)layerMask) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> entityRadius = pair.Value;</span><br><span class="line">            <span class="keyword">if</span> ((t.position - pair.Key.position).magnitude &gt; radius + entityRadius) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 得到切线与（目标物体到人物线）的夹角a</span></span><br><span class="line">            <span class="keyword">float</span> a = Mathf.Asin(entityRadius / (pair.Key.position - t.position).magnitude);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 得到目标点与人物正前方的夹角b</span></span><br><span class="line">            <span class="keyword">float</span> b = Vector3.Angle((pair.Key.position - t.position), t.forward);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断b-a是否在angle/2内</span></span><br><span class="line">            <span class="keyword">if</span> ((b - a) &gt; angle / <span class="number">2</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            resultList.Add(pair.Key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="SkillManager"><a href="#SkillManager" class="headerlink" title="SkillManager"></a>SkillManager</h1><blockquote>
<p>\client\Assets\Scripts\GameLogic\Enum\Constants.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.AI;</span><br><span class="line"><span class="keyword">using</span> Mogo.AI.BT;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.Game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> TargetType</span><br><span class="line">    &#123;</span><br><span class="line">        Enemy = <span class="number">0</span>,          <span class="comment">// 敌人</span></span><br><span class="line">        Myself = <span class="number">1</span>,         <span class="comment">// 自己</span></span><br><span class="line">        TeamMember = <span class="number">2</span>,     <span class="comment">// 队友</span></span><br><span class="line">        Ally = <span class="number">3</span>            <span class="comment">// 友方</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> TargetRangeType</span><br><span class="line">    &#123;</span><br><span class="line">        LineRange = <span class="number">3</span>,</span><br><span class="line">        SectorRange = <span class="number">0</span>,</span><br><span class="line">        CircleRange = <span class="number">1</span>,</span><br><span class="line">        SingeTarget = <span class="number">2</span>,</span><br><span class="line">        WorldRange = <span class="number">6</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Resources\data\xml\SkillAction.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SkillAction</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>1001<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">action_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">duration_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">duration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nextHitTime_i</span>&gt;</span>500<span class="tag">&lt;/<span class="name">nextHitTime_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionBeginDuration_i</span>&gt;</span>120<span class="tag">&lt;/<span class="name">actionBeginDuration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionEndDuration_i</span>&gt;</span>380<span class="tag">&lt;/<span class="name">actionEndDuration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enableStick_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">enableStick_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">teleportDistance_f</span>&gt;</span>0<span class="tag">&lt;/<span class="name">teleportDistance_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageTriggerFrame_i</span>&gt;</span>10<span class="tag">&lt;/<span class="name">damageTriggerFrame_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitAction_l</span>&gt;</span>11<span class="tag">&lt;/<span class="name">hitAction_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">deadAction_l</span>&gt;</span>17<span class="tag">&lt;/<span class="name">deadAction_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitSfx_l</span>&gt;</span>1011111,0.3<span class="tag">&lt;/<span class="name">hitSfx_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitExtraSpeed_f</span>&gt;</span>3<span class="tag">&lt;/<span class="name">hitExtraSpeed_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitExtraSt_f</span>&gt;</span>0.12<span class="tag">&lt;/<span class="name">hitExtraSt_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitExtraSl_f</span>&gt;</span>0.1<span class="tag">&lt;/<span class="name">hitExtraSl_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sfx_m</span>&gt;</span>910118:0.15<span class="tag">&lt;/<span class="name">sfx_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">targetType_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">targetType_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">targetRangeType_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">targetRangeType_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">targetRangeParam_l</span>&gt;</span>400, 150<span class="tag">&lt;/<span class="name">targetRangeParam_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maxTargetCount_i</span>&gt;</span>20<span class="tag">&lt;/<span class="name">maxTargetCount_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageFlag_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">damageFlag_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageMul_f</span>&gt;</span>0.48<span class="tag">&lt;/<span class="name">damageMul_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageAdd_i</span>&gt;</span>2<span class="tag">&lt;/<span class="name">damageAdd_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">casterHeal_l</span>&gt;</span>0, 0<span class="tag">&lt;/<span class="name">casterHeal_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">casterAddBuff_l</span>&gt;</span>132<span class="tag">&lt;/<span class="name">casterAddBuff_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionDuration_i</span>&gt;</span>500<span class="tag">&lt;/<span class="name">actionDuration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">castPosType_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">castPosType_i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">SkillAction</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SkillAction</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id_i</span>&gt;</span>1002<span class="tag">&lt;/<span class="name">id_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">action_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">duration_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">duration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nextHitTime_i</span>&gt;</span>500<span class="tag">&lt;/<span class="name">nextHitTime_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionBeginDuration_i</span>&gt;</span>120<span class="tag">&lt;/<span class="name">actionBeginDuration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionEndDuration_i</span>&gt;</span>380<span class="tag">&lt;/<span class="name">actionEndDuration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enableStick_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">enableStick_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">teleportDistance_f</span>&gt;</span>0<span class="tag">&lt;/<span class="name">teleportDistance_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageTriggerFrame_i</span>&gt;</span>10<span class="tag">&lt;/<span class="name">damageTriggerFrame_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitAction_l</span>&gt;</span>11<span class="tag">&lt;/<span class="name">hitAction_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">deadAction_l</span>&gt;</span>17<span class="tag">&lt;/<span class="name">deadAction_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitSfx_l</span>&gt;</span>1011111,0.3<span class="tag">&lt;/<span class="name">hitSfx_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitExtraSpeed_f</span>&gt;</span>3<span class="tag">&lt;/<span class="name">hitExtraSpeed_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitExtraSt_f</span>&gt;</span>0.12<span class="tag">&lt;/<span class="name">hitExtraSt_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hitExtraSl_f</span>&gt;</span>0.1<span class="tag">&lt;/<span class="name">hitExtraSl_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sfx_m</span>&gt;</span>910118:0.15<span class="tag">&lt;/<span class="name">sfx_m</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">targetType_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">targetType_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">targetRangeType_i</span>&gt;</span>0<span class="tag">&lt;/<span class="name">targetRangeType_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">targetRangeParam_l</span>&gt;</span>400, 150<span class="tag">&lt;/<span class="name">targetRangeParam_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maxTargetCount_i</span>&gt;</span>20<span class="tag">&lt;/<span class="name">maxTargetCount_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageFlag_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">damageFlag_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageMul_f</span>&gt;</span>0.496<span class="tag">&lt;/<span class="name">damageMul_f</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">damageAdd_i</span>&gt;</span>4<span class="tag">&lt;/<span class="name">damageAdd_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">casterHeal_l</span>&gt;</span>0, 0<span class="tag">&lt;/<span class="name">casterHeal_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">casterAddBuff_l</span>&gt;</span>132<span class="tag">&lt;/<span class="name">casterAddBuff_l</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actionDuration_i</span>&gt;</span>500<span class="tag">&lt;/<span class="name">actionDuration_i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">castPosType_i</span>&gt;</span>1<span class="tag">&lt;/<span class="name">castPosType_i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">SkillAction</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\MogoSolution\GameData\SkillAction.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mogo.GameData</span></span><br><span class="line">&#123;</span><br><span class="line">    public class SkillAction : GameData&lt;SkillAction&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 客户端表现</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> cameraTweenId &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> cameraTweenST &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> cameraTweenSL &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> sound &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> soundST &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> soundHit &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> freeze &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> removeCollider &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> replication &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> action &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> duration &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> actionTime &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> nextHitTime &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> enableStick &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> extraSpeed &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> extraSt &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> extraSl &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> teleportDistance &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> damageTriggerFrame &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; hitAction &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; deadAction &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; hitSfx &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> hitExtraSpeed &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> hitExtraSt &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> hitExtraSl &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; hitHover &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; hitFly &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> stiff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">float</span>&gt; sfx &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; entitys &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; spawnPos &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 技能效果</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> hitXoffset &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> hitYoffset &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> angleOffset &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> targetType &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> targetRangeType &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">float</span>&gt; targetRangeParam &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125; <span class="comment">// xml以“,”分割的用List存储</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> maxTargetCount &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> activeBuffMode &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> activeBuff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> damageFlag &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> damageMul &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> damageAdd &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; heal &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; casterAddBuff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; casterDelBuff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; targetAddBuff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; targetDelBuff &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; casterHeal &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="keyword">int</span>&gt; targetHeal &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> actionDuration &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> castPosType &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> actionBeginDuration &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> actionEndDuration &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> triggerEvent &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> spawnPoint &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> fileName = <span class="string">"xml/SkillAction"</span>;</span><br><span class="line">        <span class="comment">//static public Dictionary&lt;int, SkillAction&gt; dataMap &#123; get; set; &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\client\Assets\Scripts\GameLogic\SkillSystem\SkillManager.cs 技能管理系统</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Mogo.Game;</span><br><span class="line"><span class="keyword">using</span> Mogo.GameData;</span><br><span class="line"><span class="keyword">using</span> Mogo.Util;</span><br><span class="line"><span class="keyword">using</span> Mogo.FSM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SkillManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> showSkillRange = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">protected</span> EntityParent theOwner;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SkillManager</span>(<span class="params">EntityParent owner</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        theOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clean</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 攻击</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="hitActionID"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="ltwm"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="rotation"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="forward"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="position"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AttackEffect</span>(<span class="params"><span class="keyword">int</span> hitActionID, Matrix4x4 ltwm, Quaternion rotation, Vector3 forward, Vector3 position</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 技能数据实体对象</span></span><br><span class="line">        SkillAction s = SkillAction.dataMap[hitActionID];</span><br><span class="line">        <span class="keyword">if</span> (s.damageFlag == <span class="number">0</span>) <span class="comment">// 等于1才有伤害</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// dummyList，MonsterList，PlayerList，MercenaryList</span></span><br><span class="line">        List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt; list = GetHitEntities(hitActionID, ltwm, rotation, forward, position);</span><br><span class="line"></span><br><span class="line">        List&lt;Transform&gt; hitContainers = GetHitContainers(hitActionID);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list.Count != <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据技能id， 获取到受攻击者列表。</span></span><br><span class="line">    <span class="comment">// 返回值是一个三元组。 分别是dummy list，monster list， player list</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="hitActionID"&gt;</span>技能id<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="ltwm"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="rotation"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="forward"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="position"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt; GetHitEntities(<span class="keyword">int</span> hitActionID, Matrix4x4 ltwm, Quaternion rotation, Vector3 forward, Vector3 position)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> skillData = SkillAction.dataMap[hitActionID];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 目标类型 0敌人，1自己，2队友，3友方</span></span><br><span class="line">        <span class="keyword">int</span> targetType = skillData.targetType;</span><br><span class="line">        <span class="comment">// 攻击范围类型。0扇形范围，1圆形范围，2单体，3直线范围，4前方范围</span></span><br><span class="line">        <span class="keyword">int</span> targetRangeType = skillData.targetRangeType;</span><br><span class="line">        <span class="comment">// 攻击范围参数。 针对不同类型，有不同意义。浮点数列表</span></span><br><span class="line">        List&lt;<span class="keyword">float</span>&gt; targetRangeParam = skillData.targetRangeParam;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> offsetX = skillData.hitXoffset;</span><br><span class="line">        <span class="keyword">float</span> offsetY = skillData.hitYoffset;</span><br><span class="line">        <span class="keyword">float</span> angleOffset = <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt; entities = <span class="keyword">new</span> List&lt;List&lt;<span class="keyword">uint</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (targetType == (<span class="keyword">int</span>)TargetType.Myself)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;<span class="keyword">uint</span>&gt; listDummy = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line">            List&lt;<span class="keyword">uint</span>&gt; listMonster = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line">            List&lt;<span class="keyword">uint</span>&gt; listPlayer = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line">            List&lt;<span class="keyword">uint</span>&gt; listMercenary = <span class="keyword">new</span> List&lt;<span class="keyword">uint</span>&gt;();</span><br><span class="line"></span><br><span class="line">            listPlayer.Add(theOwner.ID);</span><br><span class="line"></span><br><span class="line">            entities.Add(listDummy);</span><br><span class="line">            entities.Add(listMonster);</span><br><span class="line">            entities.Add(listPlayer);</span><br><span class="line">            entities.Add(listMercenary);</span><br><span class="line">            <span class="keyword">return</span> entities;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (theOwner.Transform == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> entities;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获得技能拥有者的信息</span></span><br><span class="line">        <span class="comment">// 将点从局部空间转换为世界空间的矩阵（只读）。</span></span><br><span class="line">        Matrix4x4 entityltwm = theOwner.Transform.localToWorldMatrix;</span><br><span class="line">        Quaternion entityrotation = theOwner.Transform.rotation;</span><br><span class="line">        Vector3 entityforward = theOwner.Transform.forward;</span><br><span class="line">        Vector3 entityposition = theOwner.Transform.position;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (skillData.castPosType == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            entityltwm = ltwm;</span><br><span class="line">            entityrotation = rotation;</span><br><span class="line">            entityforward = forward;</span><br><span class="line">            entityposition = position;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TargetRangeType rangeType = (TargetRangeType)targetRangeType;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据攻击范围，确定受击者的逻辑控制类</span></span><br><span class="line">        <span class="keyword">switch</span> (rangeType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> TargetRangeType.CircleRange: <span class="comment">// 400，50 猜测半径400</span></span><br><span class="line">                <span class="keyword">if</span> (targetRangeParam.Count &gt;= <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">float</span> radius = targetRangeParam[<span class="number">0</span>] * <span class="number">0.01f</span>; <span class="comment">// 半径 = 400 * 0.01</span></span><br><span class="line">                    <span class="comment">// 怪物在攻击</span></span><br><span class="line">                    <span class="keyword">if</span> (skillData.castPosType == <span class="number">2</span> &amp;&amp; theOwner <span class="keyword">is</span> EntityDummy)</span><br><span class="line">                    &#123;</span><br><span class="line">                        EntityParent e = theOwner.GetTargetEntity();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (e != <span class="literal">null</span>)</span><br><span class="line">                        &#123;   </span><br><span class="line">                            <span class="comment">// 角色周围指定半径范围内的所有对象。</span></span><br><span class="line">                            entities = MogoUtils.GetEntitiesInRange(e.Transform.position, radius, offsetX, offsetY, angleOffset);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        entities = MogoUtils.GetEntitiesInRange(entityltwm, entityrotation, entityforward, entityposition, radius, offsetX, offsetY, angleOffset);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="LuaTable"><a href="#LuaTable" class="headerlink" title="LuaTable"></a>LuaTable</h1><blockquote>
<p>\client\MogoSolution\LoaderLib\Utils\LuaTable.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 固定键值对为string与object的Lua table字典</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">public class LuaTable : IEnumerable&lt;KeyValuePair&lt;string, object&gt;&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt; m_dic;</span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">bool</span>&gt; m_keyIsStringDic;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">public static class StringExtension</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    public static void Foo(this string s)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        Console.WriteLine("Foo invoked for &#123;0&#125;", s);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">为什么这里会有一个this关键字，做什么用？其实这就是扩展方法！这个扩展方法在静态类中声明，定义一个静态方法，其中第一个参数定义扩展类型。Foo()方法扩展了String类，因为它的第一个参数定义了String类型，为了区分扩展方法和一般的静态方法，扩展方法还需要给第一个参数使用this关键字。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">现在就可以使用带string类型的Foo方法了：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">string s="Hello"; </span></span><br><span class="line"><span class="comment">s.Foo();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">结果在控制台上显示Foo invoked for Hello,因为Hello是传送给Foo方法的字符串。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">归纳：扩展方法可以写入最初没有提供该方法的类中。还可以把方法添加到实现某个接口的任何类中，这样多个类可以使用相同的实现代码。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DictionaryExtend</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 泛型扩展</span></span><br><span class="line">    <span class="comment">// default(T)可以得到该类型的默认值</span></span><br><span class="line">    <span class="comment">// 这两者相同：int myInt = default(int);int myInt = 0;</span></span><br><span class="line">    <span class="comment">// default(object) is null</span></span><br><span class="line">    <span class="comment">// default(T)在泛型编成中如果不限制T类型参数是值类型或引用类型的话，程序内部可能会出现错误，因为值类型不允许NULL。所以default用来获取一个类型的默认值，对于值类型得到new T()基本得到的都是0；对于引用类型会得到Null。或者你不使用Default关键词，自己通过反射得到T是指类型还是引用类型，然后设置默认值</span></span><br><span class="line">    <span class="comment">// 这边T没有设置范围，比如之前会写class,new()什么的，这儿没写，就只有通过default(T)才能判断是否等于null，直接T == null是要报错的。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 三个重写，分别是数组，List和Dictionary的Get()方法</span></span><br><span class="line">    <span class="comment">// 对任意对象增加Get方法的话是this T t</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T Get&lt;T&gt;(<span class="keyword">this</span> T[] array, <span class="keyword">int</span> index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (array == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Mogo.Util.LoggerHelper.Critical(<span class="string">"Array is null."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">default</span>(T) == <span class="literal">null</span> ? GetDefaultValue&lt;T&gt;() : <span class="keyword">default</span>(T);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (array.Length &lt;= index)</span><br><span class="line">        &#123;</span><br><span class="line">            Mogo.Util.LoggerHelper.Critical(String.Format(<span class="string">"Index '&#123;0&#125;' is out of range."</span>, index));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">default</span>(T) == <span class="literal">null</span> ? GetDefaultValue&lt;T&gt;() : <span class="keyword">default</span>(T);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> array[index];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// List的Get()方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T Get&lt;T&gt;(<span class="keyword">this</span> List&lt;T&gt; list, <span class="keyword">int</span> index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Mogo.Util.LoggerHelper.Critical(<span class="string">"List is null."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">default</span>(T) == <span class="literal">null</span> ? GetDefaultValue&lt;T&gt;() : <span class="keyword">default</span>(T);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (list.Count &lt;= index)</span><br><span class="line">        &#123;</span><br><span class="line">            Mogo.Util.LoggerHelper.Critical(String.Format(</span><br><span class="line">                <span class="string">"Index '&#123;0&#125;' is out of range."</span>, index));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">default</span>(T) == <span class="literal">null</span> ? GetDefaultValue&lt;T&gt;() : <span class="keyword">default</span>(T);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> list[index]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TValue Get&lt;TKey, TValue&gt;(<span class="keyword">this</span> IDictionary&lt;TKey, TValue&gt; dictionary, TKey key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dictionary == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Mogo.Util.LoggerHelper.Critical(<span class="string">"Dictionary is null."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">default</span>(TValue) == <span class="literal">null</span> ? GetDefaultValue&lt;TValue&gt;() : <span class="keyword">default</span>(TValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!dictionary.ContainsKey(key))</span><br><span class="line">        &#123;</span><br><span class="line">            Mogo.Util.LoggerHelper.Critical(String.Format(<span class="string">"Key '&#123;0&#125;' is not exist."</span>, key));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">default</span>(TValue) == <span class="literal">null</span> ? GetDefaultValue&lt;TValue&gt;() : <span class="keyword">default</span>(TValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dictionary[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T GetDefaultValue&lt;T&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 有一个无参构造函数或没有显示声明带参的构造函数</span></span><br><span class="line">        <span class="keyword">var</span> constructor = <span class="keyword">typeof</span>(T).GetConstructor(Type.EmptyTypes);</span><br><span class="line">        <span class="keyword">if</span> (constructor == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">default</span>(T);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> (T)constructor.Invoke(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TValue GetValueOrDefault&lt;TKey, TValue&gt;(<span class="keyword">this</span> IDictionary&lt;TKey, TValue&gt; dictionary, TKey key, TValue defaultValue)</span><br><span class="line">    &#123;</span><br><span class="line">        TValue <span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">return</span> dictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">value</span>) ? <span class="keyword">value</span> : defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TValue GetValueOrDefaultValueProvider&lt;TKey, TValue&gt;(<span class="keyword">this</span> IDictionary&lt;TKey, TValue&gt; dictionary, TKey key, Func&lt;TValue&gt; defaultValueProvider)</span><br><span class="line">    &#123;</span><br><span class="line">        TValue <span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">return</span> dictionary.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">value</span>) ? <span class="keyword">value</span> : defaultValueProvider();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/商业源码/" rel="tag"># 商业源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/03/俄罗斯方块/" rel="next" title="俄罗斯方块">
                <i class="fa fa-chevron-left"></i> 俄罗斯方块
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/12/降临者/" rel="prev" title="降临者">
                降临者 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Chebin">
            
              <p class="site-author-name" itemprop="name">Chebin</p>
              <div class="site-description motion-element" itemprop="description">记录自己的学习过程</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">444</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">67</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2020/05/17/Laravel-Event-事件系统的启动与运行源码分析/" title="Laravel Event-事件系统的启动与运行源码分析" target="_blank">Laravel Event-事件系统的启动与运行源码分析</a>
                  </li>
                
                  <li>
                    <a href="/2020/05/15/Laravel-Queue-消息队列任务处理器源码剖析/" title="Laravel Queue-消息队列任务处理器源码剖析" target="_blank">Laravel Queue-消息队列任务处理器源码剖析</a>
                  </li>
                
                  <li>
                    <a href="/2020/05/14/Laravel-Container-IoC服务容器/" title="Laravel Container-IoC服务容器" target="_blank">Laravel Container-IoC服务容器</a>
                  </li>
                
                  <li>
                    <a href="/2020/05/13/Laravel-HTTP-Pipeline中间件处理源码分析/" title="Laravel HTTP-Pipeline中间件处理源码分析" target="_blank">Laravel HTTP-Pipeline中间件处理源码分析</a>
                  </li>
                
                  <li>
                    <a href="/2020/05/11/Laravel-Queue-消息队列任务与分发源码剖析/" title="Laravel Queue-消息队列任务与分发源码剖析" target="_blank">Laravel Queue-消息队列任务与分发源码剖析</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#资源加载"><span class="nav-number">1.</span> <span class="nav-text">资源加载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#游戏初始化"><span class="nav-number">2.</span> <span class="nav-text">游戏初始化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置文件"><span class="nav-number">3.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#XML"><span class="nav-number">3.1.</span> <span class="nav-text">XML</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MogoSolution"><span class="nav-number">4.</span> <span class="nav-text">MogoSolution</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Actors"><span class="nav-number">5.</span> <span class="nav-text">Actors</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GUI"><span class="nav-number">6.</span> <span class="nav-text">GUI</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GameLogic"><span class="nav-number">7.</span> <span class="nav-text">GameLogic</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Gears"><span class="nav-number">8.</span> <span class="nav-text">Gears</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MogoWorld"><span class="nav-number">9.</span> <span class="nav-text">MogoWorld</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#EntityMyself"><span class="nav-number">10.</span> <span class="nav-text">EntityMyself</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#场景管理"><span class="nav-number">11.</span> <span class="nav-text">场景管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AssetCacheMgr"><span class="nav-number">12.</span> <span class="nav-text">AssetCacheMgr</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#任务与剧情"><span class="nav-number">13.</span> <span class="nav-text">任务与剧情</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CG"><span class="nav-number">14.</span> <span class="nav-text">CG</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NPC"><span class="nav-number">15.</span> <span class="nav-text">NPC</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PathPoint"><span class="nav-number">16.</span> <span class="nav-text">PathPoint</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#新手引导"><span class="nav-number">17.</span> <span class="nav-text">新手引导</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Utils"><span class="nav-number">18.</span> <span class="nav-text">Utils</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SkillManager"><span class="nav-number">19.</span> <span class="nav-text">SkillManager</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LuaTable"><span class="nav-number">20.</span> <span class="nav-text">LuaTable</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chebin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">4.6m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">69:26</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
