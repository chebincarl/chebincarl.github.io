<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  如何抽象技能？就像UI一样，把技能按各个方面分类。例如单体，区域。治疗，伤害。可以学，不可以学。 一个txt，一个实体对象a，一个配置读取b，一个管理器c负责调用b把读取到的txt赋值给a">
<meta name="keywords" content="商业源码">
<meta property="og:type" content="article">
<meta property="og:title" content="神启">
<meta property="og:url" content="http://chebincarl.github.io/2018/10/08/神启/index.html">
<meta property="og:site_name" content="车斌的博客">
<meta property="og:description" content="思考并回答以下问题：  如何抽象技能？就像UI一样，把技能按各个方面分类。例如单体，区域。治疗，伤害。可以学，不可以学。 一个txt，一个实体对象a，一个配置读取b，一个管理器c负责调用b把读取到的txt赋值给a">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-12-02T12:49:46.148Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="神启">
<meta name="twitter:description" content="思考并回答以下问题：  如何抽象技能？就像UI一样，把技能按各个方面分类。例如单体，区域。治疗，伤害。可以学，不可以学。 一个txt，一个实体对象a，一个配置读取b，一个管理器c负责调用b把读取到的txt赋值给a">






  <link rel="canonical" href="http://chebincarl.github.io/2018/10/08/神启/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>神启 | 车斌的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注，重复10遍</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chebincarl.github.io/2018/10/08/神启/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chebin">
      <meta itemprop="description" content="记录自己的学习过程">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">神启

              
            
          </h1>
        

        <div class="post-meta">

          
            <i class="fa fa-thumb-tack"></i>
            <font color="FF0000">置顶</font>
            <span class="post-meta-divider">|</span>
          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-08 09:09:11" itemprop="dateCreated datePublished" datetime="2018-10-08T09:09:11+08:00">2018-10-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-12-02 20:49:46" itemprop="dateModified" datetime="2019-12-02T20:49:46+08:00">2019-12-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">172k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2:36</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>如何抽象技能？就像UI一样，把技能按各个方面分类。例如单体，区域。治疗，伤害。可以学，不可以学。</li>
<li>一个txt，一个实体对象a，一个配置读取b，一个管理器c负责调用b把读取到的txt赋值给a</li>
</ul>
<a id="more"></a>
<h1 id="快速跳转"><a href="#快速跳转" class="headerlink" title="快速跳转"></a>快速跳转</h1><ul>
<li><a href="#jump">技能</a></li>
<li><a href="#Battle">Battle</a></li>
</ul>
<h1 id="开发规范"><a href="#开发规范" class="headerlink" title="开发规范"></a>开发规范</h1><p>公共规范:</p>
<ul>
<li>1.所有的类名和文件名以X开头，例如XLogicWorld.cs。</li>
<li>2.public成员变量以大写字母开头，其他成员变量以“m_”开头，public函数以大写字母开头，其他不做约束。</li>
<li>3.如非必要不要直接继承自MonoBehaviour这个脚本，以后几乎不会用到要直接继承自MonoBehaviour的功能。一来是功能上不必要这么做，二来是强烈不提倡脚本自己Start和Update；所有Start和Update的入口都在LogicApp中。</li>
<li>4.代码中不要出现大量的注释和Log日志（自己调试可以，提交版本之前请将代码中无用的地方删掉）。</li>
<li>5.不要直接调用Debug.Log()，统一使用Log.Write(…)，便于日志统一管理。</li>
<li>6.如非不可避免，代码不允许出现Warning。</li>
</ul>
<h1 id="LogicApp"><a href="#LogicApp" class="headerlink" title="LogicApp"></a>LogicApp</h1><blockquote>
<p>/LogicApp.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">LogicApp</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Camera MainCamera = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> Camera UICamera = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ApacheServer = <span class="string">"0.0.0.0:0"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> LoginServer = <span class="string">"0.0.0.0:0"</span>;</span><br><span class="line">    <span class="keyword">public</span> Define UserDefine = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> XWeUIRoot UIRoot;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LogicApp SP &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        LogicApp.SP = <span class="keyword">this</span>;</span><br><span class="line">        DontDestroyOnLoad(<span class="keyword">this</span>);</span><br><span class="line">        CoroutineManager.Init(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        CoroutineManager.StartCoroutine(StartDataInit());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">StartDataInit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Log.Write(<span class="string">"LogicApp StartDataInit Start"</span>);</span><br><span class="line">        </span><br><span class="line">        Input.imeCompositionMode = IMECompositionMode.On;</span><br><span class="line">        Application.runInBackground = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//Application.RegisterLogCallback(new Application.LogCallback(MyExpception.OnLogCallback));</span></span><br><span class="line">        MyExpception.NewErrorEvent += <span class="keyword">new</span> Action&lt;<span class="keyword">string</span>&gt;(Statistics.ReportBug);</span><br><span class="line">        Log.Write(DumpApplication());</span><br><span class="line"></span><br><span class="line">        XDownloadManager.Init(<span class="literal">true</span>);</span><br><span class="line">        InitGameMgr();</span><br><span class="line"></span><br><span class="line">        XUTFirstLogin.CurLoading    = AppLoader.SP;</span><br><span class="line">        <span class="function"><span class="keyword">yield</span> return <span class="title">StartCoroutine</span>(<span class="params">InitStartupParams(</span>))</span>;</span><br><span class="line">        <span class="function"><span class="keyword">yield</span> return <span class="title">StartCoroutine</span>(<span class="params">AppLoader.LoadConfig(</span>))</span>;</span><br><span class="line">        <span class="function"><span class="keyword">yield</span> return <span class="title">StartCoroutine</span>(<span class="params">AppLoader.LoadMaterial(</span>))</span>;</span><br><span class="line">        </span><br><span class="line">        Log.Write(<span class="string">"LogicApp StartDataInit End"</span>);</span><br><span class="line">    </span><br><span class="line">        XEventManager.SP.SendEvent(EEvent.UI_Show, EUIPanel.eLoginUI);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitGameMgr</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        XDBConfigManager.SP.Init();</span><br><span class="line">        <span class="comment">// 事件初始化</span></span><br><span class="line">        XEventManager.SP.Init();</span><br><span class="line">        <span class="comment">// UI相关初始化</span></span><br><span class="line">        XUIManager.SP.Init();</span><br><span class="line">        <span class="comment">// 逻辑初始化</span></span><br><span class="line">        XLogicWorld.SP.Init();</span><br><span class="line">        </span><br><span class="line">        XResourceManager.Init();</span><br><span class="line">        XNoticeManager.SP.Init();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 硬件消息初始化</span></span><br><span class="line">        XKeyEventGate.SP.Init();</span><br><span class="line">        XMouseEventGate.SP.Init();</span><br><span class="line">        FeatureDataUnLockMgr.SP.Init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">InitStartupParams</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ServiceInfo.SetDefault();</span><br><span class="line">        <span class="keyword">if</span> ((Application.platform != RuntimePlatform.WindowsWebPlayer) &amp;&amp; (Application.platform != RuntimePlatform.OSXWebPlayer))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Application.platform != RuntimePlatform.WindowsEditor)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Application.platform == RuntimePlatform.WindowsPlayer)</span><br><span class="line">                &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        XHardWareGate.SP.Breathe();</span><br><span class="line">        XLogicWorld.SP.Breathe();</span><br><span class="line">        XCameraLogic.SP.Breathe();</span><br><span class="line">        XDownloadManager.Update();</span><br><span class="line">        XUIManager.SP.Breathe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        XCameraLogic.SP.LateBreathe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        XCameraLogic.SP.OnRenderObject();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnApplicationQuit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//--4&gt;<span class="doctag">TODO:</span> 目前是单个场景, 离开直接退出</span></span><br><span class="line">        XLogicWorld.SP.OnDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnLevelWasLoaded</span>(<span class="params"><span class="keyword">int</span> level</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;       </span><br><span class="line">        <span class="keyword">int</span> levelId = XLogicWorld.SP.SceneManager.LoadedSceneId;</span><br><span class="line">        <span class="keyword">string</span> levelName = XLogicWorld.SP.SceneManager.LoadedSceneName;</span><br><span class="line">        ESceneType levelType = XLogicWorld.SP.SceneManager.LoadedSceneType;</span><br><span class="line">        XLogicWorld.SP.OnLevelLoaded(levelId, levelName, levelType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">DumpApplication</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        builder.AppendFormat(<span class="string">"DumpApplication\n"</span>, <span class="keyword">new</span> <span class="keyword">object</span>[<span class="number">0</span>]);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  isWebPlayer: &#123;0&#125;\n"</span>, Application.isWebPlayer);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  isPlaying: &#123;0&#125;\n"</span>, Application.isPlaying);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  isLoadingLevel: &#123;0&#125;\n"</span>, Application.isLoadingLevel);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  isEditor: &#123;0&#125;\n"</span>, Application.isEditor);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  platform: &#123;0&#125;\n"</span>, Application.platform);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  absoluteURL: &#123;0&#125;\n"</span>, Application.absoluteURL);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  dataPath: &#123;0&#125;\n"</span>, Application.dataPath);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  persistentDataPath: &#123;0&#125;\n"</span>, Application.persistentDataPath);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  temporaryCachePath: &#123;0&#125;\n"</span>, Application.temporaryCachePath);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  webSecurityHostUrl: &#123;0&#125;\n"</span>, Application.webSecurityHostUrl);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  webSecurityEnabled: &#123;0&#125;\n"</span>, Application.webSecurityEnabled);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  srcValue: &#123;0&#125;\n"</span>, Application.srcValue);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  targetFrameRate: &#123;0&#125;\n"</span>, Application.targetFrameRate);</span><br><span class="line">        builder.AppendFormat(<span class="string">"  unityVersion: &#123;0&#125;\n"</span>, Application.unityVersion);</span><br><span class="line">        <span class="keyword">return</span> builder.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><p>最开始，需要一个日志类，多项目通用的。</p>
<blockquote>
<p>System/Platform.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志级别枚举</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LogLevel</span><br><span class="line">&#123;</span><br><span class="line">    ERROR,</span><br><span class="line">    WARN,</span><br><span class="line">    INFO,</span><br><span class="line">    DEBUG,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态工具类，里面的成员全部是静态</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Log</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 自身维护的列表，私有</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; mNetLogs = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; mTempLog = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">object</span> _trace_lock = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 外界可定制这些参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> IsLogs = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_NET_LOGS = <span class="number">20480</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_TEMP_LOG = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ObjectToString</span>(<span class="params"><span class="keyword">object</span> obj</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> obj.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddNetLog</span>(<span class="params"><span class="keyword">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        str = DateTime.Now.ToLongTimeString() + <span class="string">" "</span> + str;</span><br><span class="line">        <span class="keyword">if</span> (IsLogs)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(str);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;<span class="keyword">string</span>&gt; list = mNetLogs;</span><br><span class="line">        <span class="keyword">lock</span> (list)</span><br><span class="line">        &#123;</span><br><span class="line">            mNetLogs.Add(str);</span><br><span class="line">            <span class="keyword">if</span> (mNetLogs.Count &gt; MAX_NET_LOGS)</span><br><span class="line">            &#123;</span><br><span class="line">                mNetLogs.RemoveAt(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ClearTempLog</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        mTempLog.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetNetLog</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">string</span>[] strArray = <span class="literal">null</span>;</span><br><span class="line">        List&lt;<span class="keyword">string</span>&gt; list = mNetLogs;</span><br><span class="line">        <span class="keyword">lock</span> (list)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ToArray方法将List集合转换为对应的数组</span></span><br><span class="line">            strArray = mNetLogs.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">string</span>.Join(<span class="string">"\r\n"</span>, strArray);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; <span class="title">GetTempLog</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> mTempLog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LogMsg</span>(<span class="params"><span class="keyword">string</span> msg</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">object</span> obj2 = _trace_lock;</span><br><span class="line">        <span class="keyword">lock</span> (obj2)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">"&#123;0&#125;: LOGMSG[&#123;1&#125;]: &#123;2&#125;"</span>, DateTime.Now.ToLongTimeString(), Thread.CurrentThread.ManagedThreadId, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LogMsg</span>(<span class="params"><span class="keyword">string</span> msg, <span class="keyword">int</span> i</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        LogMsg(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddTempLog</span>(<span class="params"><span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;   </span><br><span class="line">        <span class="comment">// Array.ConvertAll&lt;TInput, TOutput&gt; 方法</span></span><br><span class="line">        <span class="comment">// 将一种类型的数组转换为另一种类型的数组。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Converter&lt;TInput, TOutput&gt; 委托</span></span><br><span class="line">        <span class="comment">// 表示将对象从一种类型转换为另一种类型的方法。</span></span><br><span class="line">        <span class="keyword">string</span> item = <span class="keyword">string</span>.Join(<span class="string">","</span>, Array.ConvertAll&lt;<span class="keyword">object</span>, <span class="keyword">string</span>&gt;(args, <span class="keyword">new</span> Converter&lt;<span class="keyword">object</span>,<span class="keyword">string</span>&gt;(ObjectToString)));</span><br><span class="line">        mTempLog.Add(item);</span><br><span class="line">        <span class="keyword">if</span> (mTempLog.Count &gt; MAX_TEMP_LOG)</span><br><span class="line">        &#123;</span><br><span class="line">            mTempLog.RemoveAt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoLog</span>(<span class="params">LogLevel level, <span class="keyword">object</span> message</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (level)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> LogLevel.ERROR:</span><br><span class="line">                Debug.LogError(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LogLevel.WARN:</span><br><span class="line">                Debug.LogWarning(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LogLevel.INFO:</span><br><span class="line">                Debug.Log(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LogLevel.DEBUG:</span><br><span class="line">                Debug.Log(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对外提供的四个Write重载方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params"><span class="keyword">string</span> format, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        DoLog(LogLevel.DEBUG, <span class="keyword">string</span>.Format(format, args));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params">LogLevel level, <span class="keyword">string</span> format, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        DoLog(level, <span class="keyword">string</span>.Format(format, args));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params">LogLevel level, <span class="keyword">object</span> message</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        DoLog(level, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params"><span class="keyword">object</span> message</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        DoLog(LogLevel.DEBUG, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="对象管理"><a href="#对象管理" class="headerlink" title="对象管理"></a>对象管理</h1><p>XU3dEffect -&gt; XU3dDynObject -&gt; XU3dObject</p>
<blockquote>
<p>GameBehaviour/XU3dObject.cs 所有对象的基类，没有继承MonoBehavior</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XU3dObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> GameObject m_gameObject &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">private</span> Vector3 m_position;             <span class="comment">// 绝对坐标</span></span><br><span class="line">    <span class="keyword">protected</span> Vector3 m_rotation;           <span class="comment">// 绝对旋转</span></span><br><span class="line">    <span class="keyword">private</span> Vector3 m_scale;                <span class="comment">// 相对缩放</span></span><br><span class="line">    <span class="keyword">private</span> Transform m_parent;             <span class="comment">// 父节点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_layer;                    <span class="comment">// 所在层</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_bVisible;                <span class="comment">// 加个b表示是bool值，是否可见</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameObject&gt; m_children;    <span class="comment">// 子对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取/设置对象的可见性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> Visible</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">                m_bVisible = m_gameObject.activeSelf;</span><br><span class="line">            <span class="keyword">return</span> m_bVisible;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_bVisible = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject &amp;&amp; m_gameObject.activeSelf != m_bVisible) <span class="comment">// 已经可见就不要再设置成可见了</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_gameObject.SetActive(m_bVisible);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取/设置对象的全局位置</span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Position</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">                m_position = m_gameObject.transform.position;</span><br><span class="line">            <span class="keyword">return</span> position;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            m_position = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                m_gameObject.transform.position = m_position;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取/设置父节点的Transform</span></span><br><span class="line">    <span class="keyword">public</span> Transform Parent</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">                m_parent = m_gameObject.transform.parent;</span><br><span class="line">            <span class="keyword">return</span> m_parent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_parent = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                m_gameObject.transform.parent = m_parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取/设置相对于父节点的位置（相对位置）</span></span><br><span class="line">    <span class="keyword">public</span> Vector3 LocalPosition</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == Parent) <span class="comment">// Parent是Transform类型</span></span><br><span class="line">                <span class="keyword">return</span> Position;</span><br><span class="line">            <span class="keyword">return</span> Parent.InverseTransformPoint(Position);</span><br><span class="line"><span class="comment">/*TransformPoint是变换自身坐标到世界坐标</span></span><br><span class="line"><span class="comment">InverseTransformPoint是变换世界坐标到自身坐标</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">比如说物体a的坐标内有一个(3,3,3)的点，你想知道这个点在世界坐标的位置，就应该用TransformPoint。</span></span><br><span class="line"><span class="comment">反之在世界坐标下有一个点，你想知道这个点如果是在物体a的坐标下是一个什么位置，就应该用InverseTransformPoint。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">其实就是在编辑器里把物体拽到根目录下的位置和物体在某物体内的位置之间的一个转换</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == Parent)</span><br><span class="line">                Position = <span class="keyword">value</span>; <span class="comment">// 这个value是本地坐标</span></span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                Position = Parent.TransformPoint(<span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 Direction</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">                m_rotation = m_gameObject.transform.eulerAngles;</span><br><span class="line">            <span class="keyword">return</span> m_rotation;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_rotation = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                m_gameObject.transform.rotation = Quaternion.Euler(m_rotation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 LocalDirection</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == Parent)</span><br><span class="line">                <span class="keyword">return</span> Direction;</span><br><span class="line">            <span class="keyword">return</span> Direction - Parent.transform.eulerAngles;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == Parent)</span><br><span class="line">                Direction = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Direction = Parent.transform.eulerAngles + <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取/设置相对缩放，可以让子类重写覆盖当前规则</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Vector3 Scale</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">                m_scale = m_gameObject.transform.localScale;</span><br><span class="line">            <span class="keyword">return</span> m_scale;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_scale = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                m_gameObject.transform.localScale = m_scale;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取/设置对象所在层</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Layer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">                m_layer = m_gameObject.layer;</span><br><span class="line">            <span class="keyword">return</span> m_layer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_layer = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">            &#123;</span><br><span class="line">                XUtil.SetLayer(m_gameObject, m_layer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数初始化字段</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XU3dObject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_gameObject = <span class="literal">null</span>;</span><br><span class="line">        m_bVisible = <span class="literal">true</span>;</span><br><span class="line">        m_position = Vector3.zero;</span><br><span class="line">        m_position = Vector3.zero;</span><br><span class="line">        m_scale = Vector3.one;</span><br><span class="line">        m_parent = <span class="literal">null</span>;</span><br><span class="line">        m_children = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对外提供的接口</span></span><br><span class="line">    <span class="comment">// 创建一个新对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">NewGameObject</span>(<span class="params"><span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        restoreInfo();</span><br><span class="line">        detachAll(); </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_gameObject)</span><br><span class="line">            GameObject.Destroy(m_gameObject);</span><br><span class="line">        m_gameObject = <span class="keyword">new</span> GameObject(name);</span><br><span class="line">        resetGameObject();</span><br><span class="line">        reAttachAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对外提供的接口</span></span><br><span class="line">    <span class="comment">// 把对象设置</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AttachGameObject</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        AttachGameObject(go, Vector3.zero, Vector3.zero);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AttachGameObject</span>(<span class="params">GameObject go, Vector3 localPosition, Vector3 localRotation</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == go || <span class="literal">null</span> == m_gameObject) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        go.transform.parent = m_gameObject.transform;</span><br><span class="line">        go.transform.localPosition = localPosition;</span><br><span class="line">        go.transform.localRotation = Quaternion.Euler(localRotation);</span><br><span class="line">        m_children.Add(go);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AttachU3dObject</span>(<span class="params">XU3dObject u3dObject</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        AttachU3dObject(u3dObject, Vector3.zero, Vector3.zero);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AttachU3dObject</span>(<span class="params">XU3dObject u3dObject, Vector3 localPosition, Vector3 localRotation</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == u3dObject) <span class="keyword">return</span>;</span><br><span class="line">        AttachGameObject(u3dObject.m_gameObject, localPosition, localRotation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">restoreInfo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// #pragma warning 编号 </span></span><br><span class="line">        <span class="comment">// 可以启用或禁用特定警告。</span></span><br><span class="line">        <span class="comment">// 未指定警告编号时，disable 会禁用所有警告，restore 会启用所有警告。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> disable</span></span><br><span class="line">        <span class="keyword">bool</span> b = Visible;</span><br><span class="line">        Vector3 vec = Position;</span><br><span class="line">        vec = Direction;</span><br><span class="line">        Transform t = Parent;</span><br><span class="line">        vec = Scale;</span><br><span class="line">        <span class="keyword">int</span> n = Layer;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> restore</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 操作m_children列表</span></span><br><span class="line">    <span class="comment">// 拆卸所有子对象</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">detachAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_children.Count;)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject go = m_children[i];</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != go &amp;&amp; go.transform.parent == m_gameObject.transform)</span><br><span class="line">            &#123;</span><br><span class="line">                go.transform.parent = <span class="literal">null</span>;</span><br><span class="line">                i++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_children.RemoveAt(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 操作m_children列表</span></span><br><span class="line">    <span class="comment">// 绑定所有子对象</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reAttachAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_gameObject.Count;)</span><br><span class="line">        &#123;   </span><br><span class="line">            GameObject go = m_children[i];</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != go)</span><br><span class="line">            &#123;</span><br><span class="line">                go.transform.parent = m_gameObject.transform;</span><br><span class="line">                i++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_children.RemoveAt(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新设置 position / rotation / parent / layer / children</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetGameObject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_gameObject) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        m_gameObject.transform.parent = m_parent;</span><br><span class="line">        m_gameObject.transform.position = m_position;</span><br><span class="line">        m_gameObject.transform.rotation = Quaternion.Euler(m_rotation);</span><br><span class="line">        m_gameObject.transform.localScale = m_scale;</span><br><span class="line"></span><br><span class="line">        XUtil.SetLayer(m_gameObject, m_layer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_children.Count;)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject go = m_children[i];</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == go)</span><br><span class="line">            &#123;</span><br><span class="line">                m_children.RemoveAt(i);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            go.transform.parent = m_gameObject.transform;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!m_bVisible) m_gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">        Object.DontDestroyOnLoad(m_gameObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对外提供的，销毁对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Destroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Destroy(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数为是否销毁子对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Destroy</span>(<span class="params"><span class="keyword">bool</span> bDestroyAll</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_gameObject)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bDestroyAll)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_children.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                GameObject go = m_children[i];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != go &amp;&amp; go.transform.parent == m_gameObject.transform)</span><br><span class="line">                &#123;</span><br><span class="line">                    go.transform.parent = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        m_children.Clear();</span><br><span class="line">        GameObject.Destroy(m_gameObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameBehaviour/XU3dDynObject.cs 动态对象</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> resource;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">XU3dDynObject</span> : <span class="title">XU3dObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> m_nId;</span><br><span class="line">    <span class="keyword">protected</span> XResourceBase m_DynObject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XU3dDynObject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_nId = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~XU3dDynObject()</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">RefreshDynObject</span>(<span class="params"><span class="keyword">uint</span> id</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameBehaviour/XU3dEffect.cs </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XU3dEffect</span> : <span class="title">XU3dDynObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> bDone;         <span class="comment">// 标记特效是否加载完成</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> bPlayOver;     <span class="comment">// 标记特效是否播放结束</span></span><br><span class="line">    <span class="keyword">private</span> NcDestroyEvent m_DestroyEvt;</span><br><span class="line">    <span class="keyword">public</span> NcDestroyEvent.OnDestroyEvt onEffectPlayOver;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">OnEffectLoaded</span>(<span class="params">XU3dEffect self</span>)</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">uint</span> mRunNumber = <span class="number">0</span>;</span><br><span class="line">    OnEffectLoaded  mEffectLoaded;</span><br><span class="line">    <span class="keyword">private</span> GameObject mEffGO;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XU3dEffect</span>(<span class="params"><span class="keyword">uint</span> nId</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RefreshDynObject(nId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XU3dEffect</span>(<span class="params"><span class="keyword">uint</span> nId,OnEffectLoaded handle</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        mEffectLoaded   = handle;</span><br><span class="line">        RefreshDynObject(nId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">RefreshDynObject</span> (<span class="params"><span class="keyword">uint</span> id</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_nId == id) </span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        m_nId = id;</span><br><span class="line">        <span class="comment">//releaseDynObject();</span></span><br><span class="line">        doRefreshDynObject();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRefreshDynObject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        NewGameObject(<span class="string">"Effect_"</span> + m_nId + <span class="string">"_"</span> + mRunNumber);</span><br><span class="line">        mRunNumber++;</span><br><span class="line">        bDone = <span class="literal">false</span>;</span><br><span class="line">        bPlayOver = <span class="literal">false</span>;</span><br><span class="line">        onEffectPlayOver = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        m_DynObject = XResourceManager.GetResource(XResourceEffect.ResTypeName,m_nId);</span><br><span class="line">        <span class="keyword">if</span>(m_DynObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Log.Write(LogLevel.ERROR,<span class="string">"cant find Effect ID &#123;0&#125;"</span>,m_nId);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(m_DynObject.IsLoadDone())</span><br><span class="line">        &#123;</span><br><span class="line">            LoadCompleted(m_DynObject.MainAsset.DownLoad);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_DynObject != <span class="literal">null</span>)</span><br><span class="line">                m_DynObject.ResLoadEvent    -= LoadCompleted;</span><br><span class="line">            XResourceManager.StartLoadResource(XResourceEffect.ResTypeName,m_nId);</span><br><span class="line">            m_DynObject.ResLoadEvent    += <span class="keyword">new</span> XResourceBase.LoadCompletedDelegate(LoadCompleted);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadCompleted</span>(<span class="params">DownloadItem item</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> RES_DEBUG</span></span><br><span class="line">            GameObject go = item.go <span class="keyword">as</span> GameObject;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            GameObject go = item.ab.mainAsset <span class="keyword">as</span> GameObject;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        onEffectDone(m_nId,go);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onEffectDone</span>(<span class="params"><span class="keyword">uint</span> nEffectId, GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        bDone = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(!bPlayOver)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == go)</span><br><span class="line">            &#123;</span><br><span class="line">                Log.Write(LogLevel.WARN, <span class="string">"XU3dEffect, wrong resource: &#123;0&#125;"</span>, m_nId);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(mEffGO != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(m_gameObject == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            </span><br><span class="line">            mEffGO = XUtil.Instantiate(go, m_gameObject.transform, Vector3.zero, Vector3.zero);</span><br><span class="line">            Object.DontDestroyOnLoad(mEffGO);           </span><br><span class="line">            XUtil.SetLayer(mEffGO, Layer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> disable</span></span><br><span class="line">            mEffGO.SetActiveRecursively(<span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> restore</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(mEffectLoaded != <span class="literal">null</span>)</span><br><span class="line">                mEffectLoaded(<span class="keyword">this</span>);</span><br><span class="line">            </span><br><span class="line">            NcAutoDestruct autoDes = mEffGO.GetComponent&lt;NcAutoDestruct&gt;();</span><br><span class="line">            <span class="keyword">if</span>(autoDes == <span class="literal">null</span>)         </span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span>(autoDes.m_fLifeTime  == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">            autoDes.enabled = <span class="literal">true</span>; </span><br><span class="line">            <span class="keyword">if</span>(mEffGO)</span><br><span class="line">                mEffGO.AddComponent&lt;NcDestroyEvent&gt;().onDestroyEvt += onEffectDestroy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onEffectError</span>(<span class="params"><span class="keyword">int</span> nEffectId</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        bDone = <span class="literal">true</span>;</span><br><span class="line">        Log.Write(LogLevel.WARN, <span class="string">"XU3dEffect, wrong resource: &#123;0&#125;"</span>, m_nId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onEffectDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        bPlayOver = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != onEffectPlayOver)</span><br><span class="line">        &#123;</span><br><span class="line">            onEffectPlayOver();</span><br><span class="line">            onEffectPlayOver = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Destroy(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//releaseDynObject();</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//  private void releaseDynObject()</span></span><br><span class="line"><span class="comment">//  &#123;</span></span><br><span class="line"><span class="comment">//      if(null != m_DynObject)</span></span><br><span class="line"><span class="comment">//      &#123;</span></span><br><span class="line"><span class="comment">//          if(!bDone)</span></span><br><span class="line"><span class="comment">//          &#123;</span></span><br><span class="line"><span class="comment">//              m_DynObject.onDone -= onEffectDone;</span></span><br><span class="line"><span class="comment">//              m_DynObject.onError -= onEffectError;</span></span><br><span class="line"><span class="comment">//          &#125;</span></span><br><span class="line"><span class="comment">//          m_DynObject.refCount--;</span></span><br><span class="line"><span class="comment">//          m_DynObject = null;</span></span><br><span class="line"><span class="comment">//      &#125;       </span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Destroy</span> (<span class="params"><span class="keyword">bool</span> bDestroyAll</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//releaseDynObject();</span></span><br><span class="line">        <span class="keyword">base</span>.Destroy(bDestroyAll);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FlyFromTo</span>(<span class="params">Transform fromTran, Transform toTran,<span class="keyword">float</span> speed,<span class="keyword">float</span> HWRate</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == fromTran || <span class="literal">null</span> == toTran) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == m_gameObject) <span class="keyword">return</span>;</span><br><span class="line">        NcEffectFlying fly = m_gameObject.AddComponent&lt;NcEffectFlying&gt;();</span><br><span class="line">        fly.FromPos = fromTran.position;</span><br><span class="line">        fly.ToPos   = toTran.position;</span><br><span class="line">        fly.Speed   = speed;</span><br><span class="line">        fly.HWRate  = HWRate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FlyFromTo</span>(<span class="params">Vector3 fromPos, Vector3 toPos,<span class="keyword">float</span> speed,<span class="keyword">float</span> HWRate</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == m_gameObject) <span class="keyword">return</span>;</span><br><span class="line">        NcEffectFlying fly = m_gameObject.AddComponent&lt;NcEffectFlying&gt;();</span><br><span class="line">        fly.FromPos = fromPos;</span><br><span class="line">        fly.ToPos   = toPos;</span><br><span class="line">        fly.Speed   = speed;</span><br><span class="line">        fly.HWRate  = HWRate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameBehaviour/IBehaviourListener.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBehaviourListener</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnMouseDown</span>(<span class="params"><span class="keyword">int</span> mouseCode, Vector3 clickPoint</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnMouseUp</span>(<span class="params"><span class="keyword">int</span> mouseCode</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnMouseUpAsButton</span>(<span class="params"><span class="keyword">int</span> mouseCode</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnMouseEnter</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnMouseExit</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnControllerColliderHit</span>(<span class="params">ControllerColliderHit hit</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnCancelSelect</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameBehaviour/XObjectModel.cs </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EModelEvent</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// XGameObject</span></span><br><span class="line">    evtName,</span><br><span class="line">    evtHeadBoardType,</span><br><span class="line">    evtModelId,</span><br><span class="line">    evtPosition,</span><br><span class="line">    evtDirection,</span><br><span class="line">    evtVisible,</span><br><span class="line">    evtDestroy,</span><br><span class="line">    evtAttachGo,</span><br><span class="line">    evtScale,</span><br><span class="line">    evtHudVisible,</span><br><span class="line">    evtMatColor,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// XCharacter</span></span><br><span class="line">    evtTitle,</span><br><span class="line">    evtHp,</span><br><span class="line">    evtMaxHp,</span><br><span class="line">    evtWeaponId,</span><br><span class="line">    evtAnimation,</span><br><span class="line">    evtShowBlood,</span><br><span class="line">    evtFlyString,</span><br><span class="line">    evtFlyStringHalf,</span><br><span class="line">    evtNickName,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// XPlayer</span></span><br><span class="line">    evtUColor,</span><br><span class="line">    evtMountIndex,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// XNpc</span></span><br><span class="line">    evtNpcFuncHead,</span><br><span class="line">    </span><br><span class="line">    evtSelect,  </span><br><span class="line">    evtSetHeadVisiable,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// XMainPlayer,</span></span><br><span class="line">    evtAttachMainCamera,</span><br><span class="line">    evtFadeOut,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//头顶板子的类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EHeadBoard_Type</span><br><span class="line">&#123;</span><br><span class="line">    EHeadBoard_Type_None,</span><br><span class="line">    EHeadBoard_Type_Monster,</span><br><span class="line">    EHeadBoard_Type_Player,</span><br><span class="line">    EHeadBoard_Type_NPC,</span><br><span class="line">    EHeadBoard_Type_Num</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EMoveTarget_Type</span><br><span class="line">&#123;</span><br><span class="line">    EMoveTarget_Object,</span><br><span class="line">    EMoveTarget_Pos,</span><br><span class="line">    EMoveTarget_Num </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XObjectModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector3 CAMERA_DEFAULT_POS = <span class="keyword">new</span> Vector3 (<span class="number">0</span>, <span class="number">20</span>, <span class="number">-20</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">uint</span> FootEffectID = <span class="number">900038</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Transform m_ObjectManager = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> ObjectIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Transform ObjectParent &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectManager) &#123;</span><br><span class="line">                m_ObjectManager = <span class="keyword">new</span> GameObject (<span class="string">"ObjectManager"</span>).transform;</span><br><span class="line">                m_ObjectManager.parent = LogicApp.SP.transform;</span><br><span class="line">                m_ObjectManager.position = Vector3.zero;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> m_ObjectManager;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">LoadModelComplete</span> (<span class="params">XObjectModel model</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> LoadModelComplete mainModelLoaded;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> LoadModelComplete  LoadModelEvent;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">LoadMountModelComplete</span>(<span class="params">XU3dModel model</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> LoadMountModelComplete mountLoaded;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//private XGameObject m_xobj;</span></span><br><span class="line">    <span class="keyword">private</span> XU3dModel m_MainModel;</span><br><span class="line">    <span class="keyword">private</span> XU3dModel m_WeaponModel;</span><br><span class="line">    <span class="keyword">private</span> XU3dModel m_MountModel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> mountLoadFinish = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    EHeadBoard_Type mHeadBoardType  = EHeadBoard_Type.EHeadBoard_Type_None;</span><br><span class="line">    <span class="keyword">private</span> XObjectHead m_Head;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span>      m_Name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> XU3dEffect  mSelectEffect;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> XObjectHalf m_Half;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> XU3dModel mainModel &#123;</span><br><span class="line">        <span class="keyword">get</span>&#123; <span class="keyword">return</span> m_MainModel; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> XU3dModel mountModel &#123;</span><br><span class="line">        <span class="keyword">get</span>&#123; <span class="keyword">return</span> m_MountModel; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EAnimName[] m_mountIdleAnim = <span class="keyword">new</span> EAnimName[]&#123;EAnimName.Idle, EAnimName.RideIdle, EAnimName.FloatIdle&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EAnimName[] m_mountRunAnim = <span class="keyword">new</span> EAnimName[]&#123; EAnimName.Idle, EAnimName.RideRun, EAnimName.FloatRun &#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ESkeleton[] m_syncSkeleton = <span class="keyword">new</span> ESkeleton[] &#123; ESkeleton.eCapsuleBottom, ESkeleton.eCapsuleHalf, ESkeleton.eCapsuleTop &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 信息记录</span></span><br><span class="line">    <span class="keyword">private</span> EAnimName m_curAnim;        <span class="comment">// 切换动画时记录, 在上下坐骑的时候使用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_curAnimSpeed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_bIsVisible;          <span class="comment">// 记录是否可见, Head资源到时利用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_bShowBlood;          <span class="comment">// 记录血条是否可见, Head资源到时利用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_nHp;                  <span class="comment">// 记录血量, Head到时利用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_nMaxHp;               <span class="comment">// 记录最大血量, Head到时利用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> m_nNpcFuncName;      <span class="comment">// 记录npc头顶面板图片， 资源到时使用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> m_nNickName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> EMoveTarget_Type    mMoveTType;</span><br><span class="line">    <span class="keyword">private</span> GameObject  m_MoveTarget;</span><br><span class="line">    <span class="keyword">private</span> XU3dEffect  m_FootEffect;</span><br><span class="line">    <span class="keyword">private</span> Vector3     m_MoveTargetPos;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IModelListener</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnModelLoaded</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnWeaponLoaded</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddModelListener</span>(<span class="params">IModelListener pML</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        mListenerList.Add (pML);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    List&lt;IModelListener&gt; mListenerList = <span class="keyword">new</span> List&lt;IModelListener&gt; ();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XObjectModel</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_MainModel = <span class="literal">null</span>;</span><br><span class="line">        m_WeaponModel = <span class="literal">null</span>;</span><br><span class="line">        m_MountModel = <span class="literal">null</span>;</span><br><span class="line">        m_Head = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        m_bIsVisible = <span class="literal">true</span>;</span><br><span class="line">        m_bShowBlood = <span class="literal">false</span>;</span><br><span class="line">        m_nHp = <span class="number">0</span>;</span><br><span class="line">        m_nMaxHp = <span class="number">1</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HandleEvent</span>(<span class="params">EModelEvent evt, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (evt)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtName):</span><br><span class="line">            onName ((<span class="keyword">string</span>)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtModelId):</span><br><span class="line">            onModelId ((<span class="keyword">uint</span>)args [<span class="number">0</span>]);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtWeaponId):</span><br><span class="line">            onWeaponID ((<span class="keyword">uint</span>)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtPosition):</span><br><span class="line">            onPosition ((Vector3)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtDirection):</span><br><span class="line">            onDirection ((Vector3)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtMatColor):</span><br><span class="line">            onMatColor ((Color)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtVisible):</span><br><span class="line">            onVisible ((<span class="keyword">bool</span>)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtDestroy):</span><br><span class="line">            onDestroy ();</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;          </span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtAttachGo):</span><br><span class="line">            onAttachGo ((ESkeleton)args [<span class="number">0</span>], (GameObject)args [<span class="number">1</span>], (Vector3)args [<span class="number">2</span>], (Vector3)args [<span class="number">3</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtScale):</span><br><span class="line">            onScale ((<span class="keyword">float</span>)(args [<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtMountIndex):</span><br><span class="line">            onMountIndex ((<span class="keyword">ushort</span>)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtAttachMainCamera):</span><br><span class="line">            onAttachMainCamera ();</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtHp):</span><br><span class="line">            onHp ((<span class="keyword">int</span>)(args [<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtMaxHp):</span><br><span class="line">            onMaxHp ((<span class="keyword">int</span>)(args [<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtNpcFuncHead):</span><br><span class="line">            onNpcFuncPic ((<span class="keyword">string</span>)(args [<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtSetHeadVisiable):</span><br><span class="line">            onHeadVisiable ((<span class="keyword">bool</span>)(args [<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtAnimation):</span><br><span class="line">            onAnimation ((EAnimName)(args [<span class="number">0</span>]), (<span class="keyword">float</span>)(args [<span class="number">1</span>]), (<span class="keyword">bool</span>)(args [<span class="number">2</span>]));</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span>(EModelEvent.evtShowBlood):</span><br><span class="line">            onShowBlood ((<span class="keyword">bool</span>)(args [<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EModelEvent.evtFlyString:</span><br><span class="line">            onFlyString ((EFlyStrType)args [<span class="number">0</span>], (<span class="keyword">string</span>)args [<span class="number">1</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EModelEvent.evtFlyStringHalf:</span><br><span class="line">            onFlyStringHalf ((EObjectHalfHintType)args [<span class="number">0</span>], (<span class="keyword">string</span>)args [<span class="number">1</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EModelEvent.evtHudVisible :</span><br><span class="line">            onHudVisible ((<span class="keyword">bool</span>)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EModelEvent.evtFadeOut :</span><br><span class="line">            FadeOut ();</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EModelEvent.evtNickName:</span><br><span class="line">            onNickName ((<span class="keyword">string</span>)args [<span class="number">0</span>]);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EModelEvent.evtHeadBoardType:</span><br><span class="line">            onHeadBoardType((EHeadBoard_Type)args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EModelEvent.evtSelect:</span><br><span class="line">            onSelect((<span class="keyword">uint</span>)args[<span class="number">0</span>],(<span class="keyword">bool</span>)args[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetHeadPosInfo</span>(<span class="params"><span class="keyword">ref</span> Vector3 pos, <span class="keyword">ref</span> GameObject parent</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_Head)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        m_Head.GetHeadPosInfo (<span class="keyword">ref</span> pos, <span class="keyword">ref</span> parent);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onHudVisible</span>(<span class="params"><span class="keyword">bool</span> isVisible</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_Head == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        m_Head.SetVisible (isVisible);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onHeadBoardType</span>(<span class="params">EHeadBoard_Type type</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mHeadBoardType   == type)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        mHeadBoardType  = type; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSelect</span>(<span class="params"><span class="keyword">uint</span> effectID,<span class="keyword">bool</span> isSelect</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_MainModel == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(isSelect)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mSelectEffect == <span class="literal">null</span>)</span><br><span class="line">                mSelectEffect   = <span class="keyword">new</span> XU3dEffect(effectID);</span><br><span class="line">            </span><br><span class="line">            mSelectEffect.Visible   = <span class="literal">true</span>;</span><br><span class="line">            onAttachGo(ESkeleton.eMainObject,mSelectEffect.m_gameObject,Vector3.zero,Vector3.zero);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mSelectEffect == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            </span><br><span class="line">            mSelectEffect.Visible = <span class="literal">false</span>;</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onName</span>(<span class="params"><span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Name  = name;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_Head)</span><br><span class="line">            <span class="keyword">return</span>;     </span><br><span class="line">        m_Head.SetName (m_Name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNickName</span>(<span class="params"><span class="keyword">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_nNickName = str;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_Head)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        m_Head.SetNickName (m_nNickName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onModelId</span>(<span class="params"><span class="keyword">uint</span> modelId</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == modelId) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) </span><br><span class="line">            &#123;</span><br><span class="line">                m_MainModel.Destroy (<span class="literal">true</span>);</span><br><span class="line">                m_MainModel = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != m_Head) </span><br><span class="line">                &#123;</span><br><span class="line">                    Object.Destroy (m_Head.gameObject);</span><br><span class="line">                    m_Head = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != m_Half) </span><br><span class="line">                &#123;</span><br><span class="line">                    Object.Destroy (m_Half.gameObject);</span><br><span class="line">                    m_Half = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == m_MainModel) </span><br><span class="line">            &#123;</span><br><span class="line">                m_MainModel = <span class="keyword">new</span> XU3dModel(m_Name, modelId, ObjectParent, StartLoadHead);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_MainModel.RefreshDynObject(modelId);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> ( modelId == m_MainModel.m_nId &amp;&amp; <span class="literal">null</span> != mainModelLoaded )</span><br><span class="line">                    mainModelLoaded(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onWeaponID</span>(<span class="params"><span class="keyword">uint</span> weaponID</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_WeaponModel) &#123;</span><br><span class="line">            m_WeaponModel.Destroy ();</span><br><span class="line">            m_WeaponModel = <span class="literal">null</span>;</span><br><span class="line">        &#125;       </span><br><span class="line">        m_WeaponModel = <span class="keyword">new</span> XU3dModel (<span class="string">"role_weapon"</span>, weaponID,OnWeaponLoadDone);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnWeaponLoadDone</span>(<span class="params">XU3dModel self</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_WeaponModel = self;</span><br><span class="line">        </span><br><span class="line">        m_WeaponModel.Scale = m_MainModel.Scale;</span><br><span class="line">        m_MainModel.AttachU3dModel (ESkeleton.eWeapon, m_WeaponModel, ESkeleton.eMainObject);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span> (IModelListener ls <span class="keyword">in</span> mListenerList) &#123;</span><br><span class="line">            ls.OnWeaponLoaded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReAttachWeapon</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_WeaponModel == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        m_MainModel.AttachU3dModel (ESkeleton.eWeapon, m_WeaponModel, ESkeleton.eMainObject);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReAttachMount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m_MountModel == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        ESkeleton ske = ESkeleton.eMountZuo;</span><br><span class="line">        <span class="keyword">if</span> (XU3dModel.EMountModelType.eMountZhan == m_MountModel.m_mountModelType) </span><br><span class="line">        &#123;</span><br><span class="line">            ske = ESkeleton.eMountZhan;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (XU3dModel.EMountModelType.eMountFei == m_MountModel.m_mountModelType) </span><br><span class="line">        &#123;</span><br><span class="line">            ske = ESkeleton.eMountFei;</span><br><span class="line">        &#125;</span><br><span class="line">        m_MainModel.ModelDirection = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">180</span>, <span class="number">0</span>);</span><br><span class="line">        m_MountModel.AttachU3dModel(ESkeleton.eMount, m_MainModel, ske);</span><br><span class="line">        onAnimation(m_curAnim, m_curAnimSpeed, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onPosition</span>(<span class="params">Vector3 pos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel) &#123;</span><br><span class="line">            m_MountModel.Position = pos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) &#123;</span><br><span class="line">                m_MainModel.Position = pos;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onDirection</span>(<span class="params">Vector3 dir</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel) &#123;</span><br><span class="line">            m_MountModel.ModelDirection = dir;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) &#123;</span><br><span class="line">            m_MainModel.ModelDirection = dir;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onMatColor</span>(<span class="params">Color color</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_MainModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_MainModel.ChangeMatColor(color);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onVisible</span>(<span class="params"><span class="keyword">bool</span> b</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_bIsVisible = b;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel)</span><br><span class="line">            m_MountModel.Visible = b;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel)</span><br><span class="line">                m_MainModel.Visible = b;</span><br><span class="line">        <span class="comment">//if (null != m_Head)</span></span><br><span class="line">        <span class="comment">//  m_Head.SetVisible (b);</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head)</span><br><span class="line">        &#123;</span><br><span class="line">            m_Head.gameObject.SetActive(b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel) &#123;</span><br><span class="line">            m_MountModel.Destroy ();</span><br><span class="line">            m_MountModel = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) &#123;</span><br><span class="line">            m_MainModel.Destroy ();</span><br><span class="line">            m_MainModel = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head) &#123;</span><br><span class="line">            Object.Destroy (m_Head.gameObject);</span><br><span class="line">            m_Head = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Half) &#123;</span><br><span class="line">            Object.Destroy (m_Half.gameObject);</span><br><span class="line">            m_Half = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_WeaponModel) &#123;</span><br><span class="line">            m_WeaponModel.Destroy ();</span><br><span class="line">            m_WeaponModel = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAttachGo</span>(<span class="params">ESkeleton ske, GameObject go, Vector3 localPos, Vector3 localRot</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 如果有坐骑, 可能会绑定到坐骑上</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;m_syncSkeleton.Length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ske == m_syncSkeleton [i]) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel) &#123;</span><br><span class="line">                    m_MountModel.AttachGameObject (ske, go, localPos, localRot);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) &#123;</span><br><span class="line">                        m_MainModel.AttachGameObject (ske, go, localPos, localRot);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_MainModel) </span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        m_MainModel.AttachGameObject (ske, go, localPos, localRot);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onScale</span>(<span class="params"><span class="keyword">float</span> f</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel) &#123;</span><br><span class="line">            m_MountModel.Scale = Vector3.one * f;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) &#123;</span><br><span class="line">                m_MainModel.Scale = Vector3.one * f;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head) &#123;</span><br><span class="line">            m_Head.SetScale (<span class="number">1.0f</span> / f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Half) &#123;</span><br><span class="line">            m_Half.SetScale (<span class="number">1.0f</span> / f);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onHp</span>(<span class="params"><span class="keyword">int</span> nHp</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_nHp = nHp;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head) &#123;</span><br><span class="line">            m_Head.SetHp (m_nHp, m_nMaxHp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNpcFuncPic</span>(<span class="params"><span class="keyword">string</span> spriteName</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_nNpcFuncName = spriteName;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head) &#123;</span><br><span class="line">            m_Head.KinderIndex = index;</span><br><span class="line">            m_Head.SetNpcHead (spriteName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onHeadVisiable</span>(<span class="params"><span class="keyword">bool</span> bVisiable</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Head.SetVisible (bVisiable);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onMaxHp</span>(<span class="params"><span class="keyword">int</span> nMaxHp</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_nMaxHp = nMaxHp;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head) &#123;</span><br><span class="line">            m_Head.SetHp (m_nHp, m_nMaxHp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAnimation</span>(<span class="params">EAnimName anim, <span class="keyword">float</span> fSpeed, <span class="keyword">bool</span> bIsPush</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_curAnim = anim;</span><br><span class="line">        m_curAnimSpeed = fSpeed;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel) </span><br><span class="line">        &#123;</span><br><span class="line">            m_MountModel.PlayAnimation (anim, fSpeed, bIsPush);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (EAnimName.Idle == anim) </span><br><span class="line">                &#123;</span><br><span class="line">                    EAnimName mAnim = m_mountIdleAnim [(<span class="keyword">int</span>)m_MountModel.m_mountModelType - (<span class="keyword">int</span>)XU3dModel.EMountModelType.eMountZhan];</span><br><span class="line">                    m_MainModel.PlayAnimation (mAnim, fSpeed, bIsPush);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (EAnimName.Run == anim) </span><br><span class="line">                &#123;</span><br><span class="line">                    EAnimName mAnim = m_mountRunAnim [(<span class="keyword">int</span>)m_MountModel.m_mountModelType - (<span class="keyword">int</span>)XU3dModel.EMountModelType.eMountZhan];</span><br><span class="line">                    m_MainModel.PlayAnimation (mAnim, fSpeed, bIsPush);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) </span><br><span class="line">        &#123;</span><br><span class="line">            m_MainModel.PlayAnimation (anim, fSpeed, bIsPush);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onShowBlood</span>(<span class="params"><span class="keyword">bool</span> b</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_bShowBlood = b;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head) </span><br><span class="line">            m_Head.ShowBlood (b);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onFlyString</span>(<span class="params">EFlyStrType ft, <span class="keyword">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Head)</span><br><span class="line">            m_Head.FlyString (ft, str);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onFlyStringHalf</span>(<span class="params">EObjectHalfHintType ht, <span class="keyword">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_Half)</span><br><span class="line">            m_Half.FlyHalfHint (ht, str);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onMountIndex</span>(<span class="params"><span class="keyword">ushort</span> mountIndex</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 使用坐骑前，先销毁上个坐骑，避免坐骑与角色之间的父子关系紊乱</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel &amp;&amp; mountLoadFinish ) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel) </span><br><span class="line">            &#123;</span><br><span class="line">                m_MainModel.Parent = m_MountModel.Parent;</span><br><span class="line">                m_MainModel.ModelDirection = m_MountModel.ModelDirection;</span><br><span class="line">                m_MainModel.m_gameObject.transform.localRotation    = Quaternion.identity;</span><br><span class="line">                m_MainModel.Position = m_MountModel.Position;</span><br><span class="line">                    </span><br><span class="line">                m_MainModel.PlayAnimation (m_curAnim, m_curAnimSpeed, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;m_syncSkeleton.Length; i++)</span><br><span class="line">                    m_MainModel.SyncChildObject (m_MountModel, m_syncSkeleton [i], m_syncSkeleton [i]);</span><br><span class="line">                <span class="keyword">if</span> (m_MountModel.IsMainCameraAttach)</span><br><span class="line">                    m_MainModel.AttachMainCamera (ESkeleton.eCameraBind);</span><br><span class="line">            &#125;</span><br><span class="line">            m_MountModel.Destroy();</span><br><span class="line">            m_MountModel = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="literal">null</span> != m_MountModel &amp;&amp; !mountLoadFinish )</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        XCfgMount cfgMount = XCfgMountMgr.SP.GetConfig (mountIndex);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == cfgMount || <span class="number">0</span> == cfgMount.ModelId) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            mountLoadFinish = <span class="literal">false</span>;</span><br><span class="line">            Vector3 temp = <span class="keyword">new</span> Vector3(m_MainModel.Position.x, m_MainModel.Position.y, m_MainModel.Position.z);</span><br><span class="line">            m_MountModel = <span class="keyword">new</span> XU3dModel (<span class="string">"_mount_"</span> + cfgMount.MountName, cfgMount.ModelId, </span><br><span class="line">                (XU3dModel.EMountModelType)cfgMount.MountType, OnMountModelLoadDone);</span><br><span class="line">            m_MountModel.Position = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMountModelLoadDone</span>(<span class="params">XU3dModel self</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        mountLoadFinish = <span class="literal">true</span>;</span><br><span class="line">        ESkeleton ske = ESkeleton.eMountZuo;</span><br><span class="line">        <span class="keyword">if</span> (XU3dModel.EMountModelType.eMountZhan == self.m_mountModelType) </span><br><span class="line">        &#123;</span><br><span class="line">            ske = ESkeleton.eMountZhan;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (XU3dModel.EMountModelType.eMountFei == self.m_mountModelType) </span><br><span class="line">        &#123;</span><br><span class="line">            ske = ESkeleton.eMountFei;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        self.Parent = m_MainModel.Parent;</span><br><span class="line">        self.ModelDirection = m_MainModel.ModelDirection;</span><br><span class="line">                </span><br><span class="line">        self.AttachU3dModel (ESkeleton.eMount, m_MainModel, ske);</span><br><span class="line">        self.Scale = Vector3.one;</span><br><span class="line">        m_MainModel.Scale = Vector3.one;</span><br><span class="line">        </span><br><span class="line">        m_MainModel.ModelDirection = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">180</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;m_syncSkeleton.Length; i++) </span><br><span class="line">        &#123;</span><br><span class="line">            self.SyncSkeleton (m_MainModel, m_syncSkeleton [i]);</span><br><span class="line">            self.SyncChildObject (m_MainModel, m_syncSkeleton [i], m_syncSkeleton [i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (m_MainModel.IsMainCameraAttach)</span><br><span class="line">            self.AttachMainCamera (ESkeleton.eCameraBind);</span><br><span class="line">        </span><br><span class="line">        m_MountModel = self;</span><br><span class="line">        onAnimation (m_curAnim, m_curAnimSpeed, <span class="literal">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ( <span class="literal">null</span> != mountLoaded )</span><br><span class="line">            mountLoaded(self);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAttachMainCamera</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">bool</span> success = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel) </span><br><span class="line">        &#123;</span><br><span class="line">            success = m_MountModel.AttachMainCamera (ESkeleton.eCameraBind, CAMERA_DEFAULT_POS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel &amp;&amp; !success ) </span><br><span class="line">        &#123;</span><br><span class="line">            m_MainModel.AttachMainCamera (ESkeleton.eCameraBind, CAMERA_DEFAULT_POS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> _onObjectHeadReady(XObjectHead head)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_MainModel || !m_MainModel.isLoaded || <span class="literal">null</span> != m_Head)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>( m_MainModel != <span class="literal">null</span> &amp;&amp; m_MainModel.isLoaded )</span><br><span class="line">            &#123;</span><br><span class="line">                Transform top1 = m_MainModel.GetSkeleton (ESkeleton.eCapsuleTop);</span><br><span class="line">                UIFollowTarget uiFT1 = m_Head.GetComponent&lt;UIFollowTarget&gt; ();</span><br><span class="line">                uiFT1.target = top1;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>; </span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        </span><br><span class="line">        GameObject child = NGUITools.AddChild (HUDRoot.go, head.gameObject);</span><br><span class="line">        m_Head = child.GetComponentInChildren&lt;XObjectHead&gt; ();</span><br><span class="line">        m_Head.Init ();</span><br><span class="line">        m_Head.KinderIndex = index;</span><br><span class="line">        Transform top = m_MainModel.GetSkeleton (ESkeleton.eCapsuleTop);</span><br><span class="line">        UIFollowTarget uiFT = child.AddComponent&lt;UIFollowTarget&gt; ();</span><br><span class="line">        uiFT.target = top;</span><br><span class="line">        uiFT.SelfHead = m_Head;</span><br><span class="line">        <span class="keyword">if</span> (uiFT.target == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.Write (LogLevel.WARN, <span class="string">"null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        XUtil.SetLayer (m_Head.gameObject, GlobalU3dDefine.Layer_UI_2D);</span><br><span class="line">        m_Head.SetName (m_Name);</span><br><span class="line">        m_Head.SetHp (m_nHp, m_nMaxHp);</span><br><span class="line">        m_Head.SetVisible (m_bIsVisible);</span><br><span class="line">        m_Head.ShowBlood (m_bShowBlood);</span><br><span class="line">        m_Head.SetNpcHead (m_nNpcFuncName);</span><br><span class="line">        m_Head.SetNickName(m_nNickName);</span><br><span class="line">        </span><br><span class="line">        _ReFindHeadPos (m_MainModel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">StartLoadHead</span>(<span class="params">XU3dModel model</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_MainModel = model;</span><br><span class="line">        EUIPanel headType = EUIPanel.eCount;</span><br><span class="line">        <span class="keyword">switch</span> (mHeadBoardType) </span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span>(EHeadBoard_Type.EHeadBoard_Type_Player):</span><br><span class="line">            headType = EUIPanel.ePlayerHead;</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;          </span><br><span class="line">        <span class="keyword">case</span>(EHeadBoard_Type.EHeadBoard_Type_NPC):</span><br><span class="line">            headType = EUIPanel.eNpcHead;</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">break</span>;          </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            headType = EUIPanel.eMonsterHead;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (EUIPanel.eCount != headType) </span><br><span class="line">        &#123;</span><br><span class="line">            XEventManager.SP.SendEvent (EEvent.UI_ReqOriginal, headType, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        XEventManager.SP.SendEvent (EEvent.UI_ReqOriginal, EUIPanel.eObjectHalf, <span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ( <span class="literal">null</span> != mainModelLoaded )</span><br><span class="line">            mainModelLoaded(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> _ReFindHeadPos(XU3dModel model)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_Head == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        UIFollowTarget UIFT = m_Head.GetComponent&lt;UIFollowTarget&gt; ();</span><br><span class="line">        <span class="keyword">if</span> (UIFT == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        UIFT.target = model.GetSkeleton (ESkeleton.eCapsuleTop);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span> (IModelListener ls <span class="keyword">in</span> mListenerList) &#123;</span><br><span class="line">            ls.OnModelLoaded ();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (LoadModelEvent != <span class="literal">null</span>)</span><br><span class="line">            LoadModelEvent (<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> _onObjectHalfReady(XObjectHalf half)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_MainModel || <span class="literal">null</span> != m_Half)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        m_Half = XUtil.Instantiate&lt;XObjectHalf&gt; (half);</span><br><span class="line">        m_Half.Init ();</span><br><span class="line">        XUtil.SetLayer (m_Half.gameObject, m_MainModel.Layer);</span><br><span class="line">        m_MainModel.AttachGameObject (ESkeleton.eCapsuleHalf, m_Half.gameObject);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//  private EBehaviourType getBehaviourType()</span></span><br><span class="line"><span class="comment">//  &#123;</span></span><br><span class="line"><span class="comment">//      switch (m_xobj.ObjectType) &#123;</span></span><br><span class="line"><span class="comment">//          case(EObjectType.MainPlayer):</span></span><br><span class="line"><span class="comment">//              return EBehaviourType.e_BehaviourType_MainPlayer;</span></span><br><span class="line"><span class="comment">//          </span></span><br><span class="line"><span class="comment">//          case(EObjectType.OtherPlayer):</span></span><br><span class="line"><span class="comment">//              return EBehaviourType.e_BehaviourType_OtherPlayer;</span></span><br><span class="line"><span class="comment">//          </span></span><br><span class="line"><span class="comment">//          case(EObjectType.Monster):</span></span><br><span class="line"><span class="comment">//              return EBehaviourType.e_BehaviourType_Monster;</span></span><br><span class="line"><span class="comment">//          </span></span><br><span class="line"><span class="comment">//          case(EObjectType.Npc):</span></span><br><span class="line"><span class="comment">//              return EBehaviourType.e_BehaviourType_Npc;</span></span><br><span class="line"><span class="comment">//          </span></span><br><span class="line"><span class="comment">//          case(EObjectType.TransPoint):</span></span><br><span class="line"><span class="comment">//              return EBehaviourType.e_BehaviourType_TransPoint;</span></span><br><span class="line"><span class="comment">//          </span></span><br><span class="line"><span class="comment">//          case(EObjectType.GatherObject):</span></span><br><span class="line"><span class="comment">//              return EBehaviourType.e_BehaviourType_GatherObject;</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//      </span></span><br><span class="line"><span class="comment">//      return EBehaviourType.e_BehaviourType_Other;</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Transform _getSkeleton(ESkeleton ske)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_MainModel) </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> m_MainModel.GetSkeleton (ske);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> _animLength(EAnimName name)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_MainModel)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">return</span> m_MainModel.AnimLength (name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HoverIn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_MainModel != <span class="literal">null</span>)</span><br><span class="line">            m_MainModel.HoverIn ();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m_WeaponModel != <span class="literal">null</span>)</span><br><span class="line">            m_WeaponModel.HoverIn ();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m_MountModel != <span class="literal">null</span>)</span><br><span class="line">            m_MountModel.HoverIn ();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HoverOut</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_MainModel != <span class="literal">null</span>)</span><br><span class="line">            m_MainModel.HoverOut ();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m_WeaponModel != <span class="literal">null</span>)</span><br><span class="line">            m_WeaponModel.HoverOut ();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m_MountModel != <span class="literal">null</span>)</span><br><span class="line">            m_MountModel.HoverOut ();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FadeOut</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        CoroutineManager.StartCoroutine (UpdateAlpha ());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnumerator <span class="title">UpdateAlpha</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_MainModel != <span class="literal">null</span>)</span><br><span class="line">                m_MainModel.FadeOut (<span class="number">0.01f</span>);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">if</span> (m_WeaponModel != <span class="literal">null</span>)</span><br><span class="line">                m_WeaponModel.FadeOut (<span class="number">0.01f</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (m_MountModel != <span class="literal">null</span>)</span><br><span class="line">                m_MountModel.FadeOut (<span class="number">0.01f</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> _getRadius()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MountModel)</span><br><span class="line">            <span class="keyword">return</span> m_MountModel.Radius ();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_MainModel)</span><br><span class="line">            <span class="keyword">return</span> m_MainModel.Radius ();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> EXRayMatType XRayType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_MainModel == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> EXRayMatType.EXRayMatType_None;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> m_MainModel.XRayType;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_MainModel == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            </span><br><span class="line">            m_MainModel.XRayType    = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> EXRayMatType WeaponXRayType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_WeaponModel == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> EXRayMatType.EXRayMatType_None;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> m_WeaponModel.XRayType;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_WeaponModel == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            </span><br><span class="line">            m_WeaponModel.XRayType  = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddBehaviourListener</span>(<span class="params">EBehaviourType type,IBehaviourListener listener</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_MainModel == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        m_MainModel.AddBehaviourListener(type,listener);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetMoveTarget</span>(<span class="params">EMoveTarget_Type type,GameObject go ,Vector3 targetPos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        mMoveTType  = type;</span><br><span class="line">        <span class="keyword">if</span>(type == EMoveTarget_Type.EMoveTarget_Object)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(go == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            m_MoveTarget    = go;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_MoveTargetPos = targetPos;</span><br><span class="line">        &#125;       </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(m_FootEffect == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_FootEffect    = <span class="keyword">new</span> XU3dEffect(FootEffectID);</span><br><span class="line">            onAttachGo(ESkeleton.eMainObject,m_FootEffect.m_gameObject,Vector3.zero,Vector3.zero);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_FootEffect.m_gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject   <span class="title">GetCurMoveTarget</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_MoveTarget;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CancelMoveTarget</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_MoveTarget    = <span class="literal">null</span>;</span><br><span class="line">        m_MoveTargetPos = Vector3.zero;</span><br><span class="line">        <span class="keyword">if</span>(m_FootEffect != <span class="literal">null</span>)</span><br><span class="line">            m_FootEffect.m_gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Breathe</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;       </span><br><span class="line">        <span class="keyword">if</span>(m_FootEffect != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 targetPos = Vector3.zero;</span><br><span class="line">            <span class="keyword">if</span>(mMoveTType == EMoveTarget_Type.EMoveTarget_Object)</span><br><span class="line">            &#123;               </span><br><span class="line">                <span class="keyword">if</span>(m_MoveTarget != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    targetPos   = m_MoveTarget.transform.position;                  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                targetPos   = m_MoveTargetPos;</span><br><span class="line">            &#125;</span><br><span class="line">            XU3dModel model = m_MainModel;</span><br><span class="line">            <span class="keyword">if</span> ( mountModel != <span class="literal">null</span> )</span><br><span class="line">                model = mountModel;</span><br><span class="line">            Vector3 deltaPos = targetPos - model.Position;</span><br><span class="line">            deltaPos.Normalize();</span><br><span class="line">            <span class="keyword">float</span> deltaAngle = Mathf.Atan2(deltaPos.x,deltaPos.z);</span><br><span class="line">            m_FootEffect.Direction  = <span class="keyword">new</span> Vector3(<span class="number">0</span>,Mathf.Rad2Deg * deltaAngle,<span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="角色管理"><a href="#角色管理" class="headerlink" title="角色管理"></a>角色管理</h1><blockquote>
<p>GameObject/ObjectAttrs.cs 对象属性</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EObjectType</span><br><span class="line">&#123;</span><br><span class="line">    Begin = <span class="number">0</span>,</span><br><span class="line">    GameObject = <span class="number">0</span>,</span><br><span class="line">    Character,</span><br><span class="line">    Npc,</span><br><span class="line">    Monster,</span><br><span class="line">    Pet,</span><br><span class="line">    OtherPlayer,</span><br><span class="line">    MainPlayer,</span><br><span class="line">    Item,</span><br><span class="line">    TransPoint,</span><br><span class="line">    GatherObject,</span><br><span class="line">    End,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAttrGameObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> String Name = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ModelId = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> Vector3 Position = Vector3.zero;</span><br><span class="line">    <span class="keyword">internal</span> Vector3 Direction = Vector3.zero;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">float</span> Scale = <span class="number">1.0f</span>;</span><br><span class="line">    <span class="keyword">internal</span> Color MatColor = Color.white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 游戏角色的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAttrCharacter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">float</span> Speed = <span class="number">0f</span>;</span><br><span class="line">    <span class="keyword">internal</span> String Title = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">internal</span> String NickName = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">byte</span> Sex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">int</span> Hp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> ArmourItemID = <span class="number">0</span>; <span class="comment">// Armour 盔甲</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ShowFashion = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> FashionId = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> WeaponItemID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> WeaponModelID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> XDynamicAttrMgr DynamicAttrs = <span class="keyword">new</span> XDynamicAttrMgr ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAttrNpc</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAttrMonster</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宠物的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAttrPet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> Index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> PetID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ClassLevel = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> Race = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> UColor = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> Aptitude = <span class="number">0</span>; <span class="comment">// 天赋</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> Loyal = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> Exp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> BattlePos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> WuLiValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> LingQiaoValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> TiZhiValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ShuFaValue = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAttrPlayer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> UColor = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ClassLevel = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">ushort</span> MountIndex = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAttrMainPlayer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">long</span> GameMoney = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">long</span> RealMoney = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> Exp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> BagSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> BankSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> Power = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> FightRemain = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> WuLiValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> LingQiaoValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> TiZhiValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ShuFaValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> HealthBuyCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> VIPLevel = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> EatFoodCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ShengWangValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> TotalShengWangValue =<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> DayPeiYangCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> ShowFashion     = <span class="number">0</span>;   <span class="comment">// 0显示服装，1不显示服装</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">ulong</span> GuildId            = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">ulong</span> Recharge       = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> VipAward        = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 战场布局站位</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">uint</span> BattlePos = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameObject/DynamicAttrMgr.cs 动态属性管理</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">XDynamicAttrMgr</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Hashtable m_AllAttr = <span class="keyword">new</span> Hashtable(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">IList&lt;Msg_PairII&gt; lst</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (Msg_PairII info <span class="keyword">in</span> lst)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Set(info.First, info.Second);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Set</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m_AllAttr.Contains(id))</span><br><span class="line">        &#123;</span><br><span class="line">            m_AllAttr.Add(id, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_AllAttr[id] = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Get</span>(<span class="params">EShareAttr aIndex</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> id = (<span class="keyword">int</span>)aIndex;</span><br><span class="line">        <span class="keyword">if</span> (m_AllAttr.Contains(id))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>)m_AllAttr[id];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Has</span>(<span class="params">EShareAttr aIndex</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_AllAttr.Contains((<span class="keyword">int</span>)aIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameObject/XGameObject.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"><span class="keyword">using</span> Google.ProtocolBuffers;</span><br><span class="line"><span class="comment">/* 类名: XGameObject</span></span><br><span class="line"><span class="comment"> * 描述: 游戏中对象</span></span><br><span class="line"><span class="comment"> * 功能:</span></span><br><span class="line"><span class="comment"> *      1. 维护模型的创建.销毁.visible</span></span><br><span class="line"><span class="comment"> *      2. 维护GameObject基础属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">public class XGameObject : XObjectModel.IModelListener,IBehaviourListener</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">ulong</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> EObjectType ObjectType &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_bIsVisible;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsWaitAppearData;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_tmpScale = <span class="number">0.0f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsActive = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> XAttrPlayer m_AttrPlayer = <span class="keyword">new</span> XAttrPlayer(); </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XGameObject</span> (<span class="params"><span class="keyword">ulong</span> id</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ID = id;</span><br><span class="line">        ObjectType = EObjectType.GameObject;</span><br><span class="line">        Version = <span class="number">0</span>;</span><br><span class="line">        m_bIsVisible = <span class="literal">true</span>;</span><br><span class="line">        IsWaitAppearData = <span class="literal">false</span>;</span><br><span class="line">        IsEnableHover = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~XGameObject ()</span><br><span class="line">    &#123;</span><br><span class="line">        m_AttrGameObject = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Breathe</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0f</span> != m_tmpScale) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> b = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (m_tmpScale &lt; Scale) &#123;</span><br><span class="line">                m_tmpScale += <span class="number">0.08f</span>;</span><br><span class="line">                <span class="keyword">if</span> (m_tmpScale &gt;= Scale) &#123;</span><br><span class="line">                    m_tmpScale = Scale;</span><br><span class="line">                    b = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (m_tmpScale &gt; Scale) &#123;</span><br><span class="line">                    m_tmpScale -= <span class="number">0.08f</span>;</span><br><span class="line">                    <span class="keyword">if</span> (m_tmpScale &lt;= Scale) &#123;</span><br><span class="line">                        m_tmpScale = Scale;</span><br><span class="line">                        b = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">            SendModelEvent (EModelEvent.evtScale, m_tmpScale);</span><br><span class="line">            <span class="keyword">if</span> (b)</span><br><span class="line">                m_tmpScale = <span class="number">0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(m_ObjectModel != <span class="literal">null</span>)</span><br><span class="line">            m_ObjectModel.Breathe();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnBeginLoadLevel</span>(<span class="params"><span class="keyword">int</span> nLevelId, ESceneType sceneType</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;   <span class="comment">// 场景开始加载之前</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnLevelLoaded</span>(<span class="params"><span class="keyword">int</span> nLevelId, ESceneType sceneType</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;       <span class="comment">// 场景加载之后(逻辑地图完成, 静态对象已生成)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsAppear &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">null</span> != m_ObjectModel; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> DisAppearRockon &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> EHeadBoard_Type <span class="title">GetHeadBoardType</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> EHeadBoard_Type.EHeadBoard_Type_None; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 出现, 需要告诉模型当前的属性信息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Appear</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAppear)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        m_ObjectModel = <span class="keyword">new</span> XObjectModel();</span><br><span class="line">        m_ObjectModel.mainModelLoaded += loadMainModelFinish;</span><br><span class="line">        m_ObjectModel.AddModelListener (<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 通知MainPlayer出现了一个GameObject</span></span><br><span class="line">        XLogicWorld.SP.MainPlayer.OnObjectAppear (ObjectType, <span class="keyword">this</span>);</span><br><span class="line">        SendModelEvent (EModelEvent.evtVisible, m_bIsVisible);</span><br><span class="line">        SendModelEvent (EModelEvent.evtName, Name);</span><br><span class="line">        SendModelEvent (EModelEvent.evtHeadBoardType, GetHeadBoardType());</span><br><span class="line">        SendModelEvent (EModelEvent.evtModelId, ModelId);</span><br><span class="line">        SendModelEvent (EModelEvent.evtPosition, Position);</span><br><span class="line">        SendModelEvent (EModelEvent.evtDirection, Direction);</span><br><span class="line">        SendModelEvent (EModelEvent.evtScale, Scale);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadMainModelFinish</span>(<span class="params">XObjectModel model</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SendModelEvent(EModelEvent.evtMountIndex, m_AttrPlayer.MountIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetHeadPosInfo</span>(<span class="params"><span class="keyword">ref</span> Vector3 pos, <span class="keyword">ref</span> GameObject parent</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_ObjectModel.GetHeadPosInfo (<span class="keyword">ref</span> pos, <span class="keyword">ref</span> parent);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnModelLoaded</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnWeaponLoaded</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 消失</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DisAppear</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectModel)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line"><span class="comment">//      SendModelEvent (EModelEvent.evtMountIndex, 0u);</span></span><br><span class="line">        SendModelEvent (EModelEvent.evtDestroy);</span><br><span class="line">        m_ObjectModel = <span class="literal">null</span>;</span><br><span class="line">        DisAppearRockon = Time.time;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置属性</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetAppearData</span>(<span class="params"><span class="keyword">object</span> data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetHudVisible</span>(<span class="params"><span class="keyword">bool</span> isVisible</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SendModelEvent (EModelEvent.evtHudVisible, isVisible);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 模型</span></span><br><span class="line">    <span class="keyword">protected</span> XObjectModel m_ObjectModel = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> XObjectModel ObjectModel &#123;</span><br><span class="line">        <span class="keyword">get</span>&#123; <span class="keyword">return</span> m_ObjectModel; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendModelEvent</span>(<span class="params">EModelEvent evt, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectModel)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        m_ObjectModel.HandleEvent (evt, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置模型是否可见</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> Visible &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_bIsVisible; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_bIsVisible != <span class="keyword">value</span>) &#123;</span><br><span class="line">                m_bIsVisible = <span class="keyword">value</span>;</span><br><span class="line">                SendModelEvent (EModelEvent.evtVisible, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取模型插槽</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transform <span class="title">GetSkeleton</span>(<span class="params">ESkeleton ske</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectModel)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> m_ObjectModel._getSkeleton (ske);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取模型的一个动画时长</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">AnimLength</span>(<span class="params">EAnimName anim</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectModel)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">return</span> m_ObjectModel._animLength (anim);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取模型半径, 包围盒半径 * scale_x</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">Radius</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectModel)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">return</span> m_ObjectModel._getRadius ();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在模型头顶以特定样式飞一行字</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FlyString</span>(<span class="params">EFlyStrType ft, <span class="keyword">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectModel)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        m_ObjectModel.HandleEvent (EModelEvent.evtFlyString, ft, str);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在模型的腰部位置以特定样式飞一行字</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FlyStringHalf</span>(<span class="params">EObjectHalfHintType ht, <span class="keyword">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_ObjectModel)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        m_ObjectModel.HandleEvent (EModelEvent.evtFlyStringHalf, ht, str);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 绑定一个GameObject到特定骨骼上</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AttachGo</span>(<span class="params">ESkeleton ske, GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        AttachGo (ske, go, Vector3.zero, Vector3.zero);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绑定一个GameObject到特定骨骼上, 并设定相对位置</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AttachGo</span>(<span class="params">ESkeleton ske, GameObject go, Vector3 localPosition, Vector3 localRotation</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == go)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        SendModelEvent (EModelEvent.evtAttachGo, ske, go, localPosition, localRotation);</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">OnCancelSelect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SendModelEvent(EModelEvent.evtSelect,(<span class="keyword">uint</span>)<span class="number">0</span>,<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 属性</span></span><br><span class="line">    <span class="keyword">private</span> XAttrGameObject m_AttrGameObject = <span class="keyword">new</span> XAttrGameObject ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> Version &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123; <span class="keyword">return</span> m_AttrGameObject.Name; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrGameObject.Name == <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span>;         </span><br><span class="line">            m_AttrGameObject.Name = <span class="keyword">value</span>;</span><br><span class="line">            SendModelEvent (EModelEvent.evtName, <span class="keyword">value</span>);</span><br><span class="line">            XEventManager.SP.SendEvent (EEvent.Attr_Name, <span class="keyword">this</span>, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> ModelId </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrGameObject.ModelId; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrGameObject.ModelId == <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span>; </span><br><span class="line">            m_AttrGameObject.ModelId = <span class="keyword">value</span>;</span><br><span class="line">            SendModelEvent (EModelEvent.evtModelId, <span class="keyword">value</span>);</span><br><span class="line">            XEventManager.SP.SendEvent (EEvent.Attr_ModelId, <span class="keyword">this</span>, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Vector3 Position </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrGameObject.Position; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrGameObject.Position == <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            m_AttrGameObject.Position = <span class="keyword">value</span>;</span><br><span class="line">            SendModelEvent (EModelEvent.evtPosition, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Vector3 Direction </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrGameObject.Direction; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrGameObject.Direction == <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            m_AttrGameObject.Direction = <span class="keyword">value</span>;</span><br><span class="line">            SendModelEvent (EModelEvent.evtDirection, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Color MatColor </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrGameObject.MatColor; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrGameObject.MatColor == <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            m_AttrGameObject.MatColor = <span class="keyword">value</span>;</span><br><span class="line">            SendModelEvent (EModelEvent.evtMatColor, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 整体缩放(头顶面板, 坐骑模型, 本体模型等等一起缩放)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> Scale &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrGameObject.Scale; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0f</span> == Scale || m_AttrGameObject.Scale == <span class="keyword">value</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            m_tmpScale = Scale;</span><br><span class="line">            m_AttrGameObject.Scale = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsEnableHover &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> IBehaviourListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">float</span> <span class="title">GetClickDistance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span>(<span class="params"><span class="keyword">int</span> mouseCode, Vector3 clickPoint</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseUp</span>(<span class="params"><span class="keyword">int</span> mouseCode</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseUpAsButton</span>(<span class="params"><span class="keyword">int</span> mouseCode</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnControllerColliderHit</span>(<span class="params">ControllerColliderHit hit</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseEnter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsEnableHover || m_ObjectModel == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        </span><br><span class="line">        m_ObjectModel.HoverIn ();</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseExit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsEnableHover || m_ObjectModel == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        m_ObjectModel.HoverOut ();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameObject/XCharacter.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="comment">// 影响模型显示的元素</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EModelCtrlType</span><br><span class="line">&#123;</span><br><span class="line">    eModelCtrl_ByBuff,      <span class="comment">// buff影响模型</span></span><br><span class="line">    eModelCtrl_ByFashion,   <span class="comment">// 时装影响模型</span></span><br><span class="line">    eModelCtrl_ByArmour,    <span class="comment">// 装备影响模型</span></span><br><span class="line">    eModelCtrl_Original,    <span class="comment">// 原始模型</span></span><br><span class="line">    eModelCtrl_End,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 类名: XCharacter</span></span><br><span class="line"><span class="comment"> * 描述: 客户端所有角色对象的基类</span></span><br><span class="line"><span class="comment"> * 功能:</span></span><br><span class="line"><span class="comment"> *      1. 角色基础行为状态机: 待机/死亡/战斗/移动/跳跃/打坐</span></span><br><span class="line"><span class="comment"> *      2. 角色基础属性与动态属性</span></span><br><span class="line"><span class="comment"> *      3. 物品</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XCharacter</span> : <span class="title">XGameObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">float</span> DEFAULT_RUN_SPEED = <span class="number">5.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XCharacter</span> (<span class="params"><span class="keyword">ulong</span> id</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">id</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ObjectType = EObjectType.Character;</span><br><span class="line">        initBehaviourSM ();</span><br><span class="line">        initItemMgr ();</span><br><span class="line">        initBuffOper ();</span><br><span class="line">        Speed = DEFAULT_RUN_SPEED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~XCharacter ()</span><br><span class="line">    &#123;</span><br><span class="line">        m_BehaviourSM = <span class="literal">null</span>;</span><br><span class="line">        m_AttrCharacter = <span class="literal">null</span>;</span><br><span class="line">        ItemManager = <span class="literal">null</span>;</span><br><span class="line">        BuffOper = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Breathe</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Breathe ();</span><br><span class="line">        m_BehaviourSM.Breathe ();</span><br><span class="line">        BuffOper.Breathe ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将角色位置矫正到地面</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PushOnTerrain</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 posNow = Position;</span><br><span class="line">        XLogicWorld.SP.SceneManager.FixExactHeight (<span class="keyword">ref</span> posNow);</span><br><span class="line">        Position = posNow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnLevelLoaded</span>(<span class="params"><span class="keyword">int</span> nLevelId, ESceneType sceneType</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esLevelLoaded, nLevelId, sceneType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Appear</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAppear)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">base</span>.Appear ();</span><br><span class="line">        SendModelEvent (EModelEvent.evtTitle, Title);</span><br><span class="line">        SendModelEvent (EModelEvent.evtNickName, NickName);</span><br><span class="line">        SendModelEvent (EModelEvent.evtHp, Hp);</span><br><span class="line">        SendModelEvent (EModelEvent.evtMaxHp, MaxHp);</span><br><span class="line">        <span class="comment">//SendModelEvent(EModelEvent.evtWeaponId, WeaponModelId);</span></span><br><span class="line">        ((XCharStateBase)m_BehaviourSM.CurrentState).OnAppear ();</span><br><span class="line">        BuffOper.Appear ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DisAppear</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DisAppear ();</span><br><span class="line">        BuffOper.Disappear ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 角色基础行为状态机</span></span><br><span class="line">    <span class="keyword">protected</span> XStateMachince m_BehaviourSM;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">initBehaviourSM</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_BehaviourSM = <span class="keyword">new</span> XStateMachince (<span class="keyword">new</span> XCharStateIdle (<span class="keyword">this</span>));</span><br><span class="line">        m_BehaviourSM.RegState (<span class="keyword">new</span> XCharStateSit (<span class="keyword">this</span>));</span><br><span class="line">        m_BehaviourSM.RegState (<span class="keyword">new</span> XCharStateDead (<span class="keyword">this</span>));</span><br><span class="line">        m_BehaviourSM.RegState (<span class="keyword">new</span> XCharStateFight (<span class="keyword">this</span>));</span><br><span class="line">        m_BehaviourSM.RegState (<span class="keyword">new</span> XCharStateMove (<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线段移动</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SegmentMoveTo</span>(<span class="params">Vector3 toPos, <span class="keyword">float</span> speed, XCharStateMove.OnMoveDone cb, EAnimName anim</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esMoveTo, EProtoMoveType.eMoveType_Segment, toPos, speed, cb, anim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Rotato</span>(<span class="params">Vector3 toPos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esRotateTo, toPos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 滑行</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SlideMoveTo</span>(<span class="params">Vector3 toPos, <span class="keyword">float</span> dir, <span class="keyword">float</span> speed, XCharStateMove.OnMoveDone cb</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esMoveTo, EProtoMoveType.eMoveType_Slide, toPos, dir, speed, cb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原地踏步</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">StepMove</span>(<span class="params"><span class="keyword">float</span> speed, <span class="keyword">float</span> dir</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esMoveTo, EProtoMoveType.eMoveType_Step, speed, dir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止移动(XZ)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">StopMove</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esStopMove);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从当前点起跳, 处理整个跳跃过程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Jump</span>(<span class="params">XCharStateMove.OnJumpDone cb</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> Jump (Position.x, Position.z, <span class="number">0f</span>, cb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 起跳(给起跳点和跳跃时间, 忽略time之前的跳跃过程)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Jump</span>(<span class="params"><span class="keyword">float</span> x, <span class="keyword">float</span> z, <span class="keyword">float</span> time, XCharStateMove.OnJumpDone cb</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esJump, x, z, time, cb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">JumpOver</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esJumpOver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Idle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_BehaviourSM.TranslateToState((<span class="keyword">int</span>)EStateId.esIdle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ForceSetPosition</span>(<span class="params">Vector3 pos, Vector3 dir</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Position = pos;</span><br><span class="line">        Direction = dir;</span><br><span class="line">        m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esStopMove);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnEnterSit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnExitSit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入生产, 高32位: 采集or制造, 低32位: 采集物ID or 配方ID</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">StartProduct</span>(<span class="params">Int64 data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == data)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        EProductCareerType pType = (EProductCareerType)(data &gt;&gt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> nId = (<span class="keyword">int</span>)data;</span><br><span class="line">        <span class="keyword">switch</span> (pType) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> EProductCareerType.eProductCareerType_Gather:</span><br><span class="line">                &#123;</span><br><span class="line">                    XCfgGatherObject cfgGO = XCfgGatherObjectMgr.SP.GetConfig (nId);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">null</span> == cfgGO)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    XCfgProductCareer cfgPC = XCfgProductCareerMgr.SP.GetConfig (cfgGO.NeedCareer, <span class="number">1</span>);</span><br><span class="line">                    StartProduct ((EAnimName)cfgPC.AnimName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> EProductCareerType.eProductCareerType_Produce:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> StartProduct (EAnimName.Idle);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入生产, 参数1: 生产动画 (生产状态嵌入在Idle里面)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">StartProduct</span>(<span class="params">EAnimName anim</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esStartProduct, anim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退出生产</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">QuitProduct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esQuitProduct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入战斗</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">StartFight</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_BehaviourSM.OnEvent((<span class="keyword">int</span>)EStateEvent.esStartFight))</span><br><span class="line">        &#123;</span><br><span class="line">            SendModelEvent(EModelEvent.evtShowBlood, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退出战斗</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">QuitFight</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esQuitFight)) &#123;</span><br><span class="line">            SendModelEvent (EModelEvent.evtShowBlood, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 播放动画</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">PlayAnimation</span>(<span class="params">EAnimName anim</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> PlayAnimation (anim, <span class="number">1.0f</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">PlayAnimation</span>(<span class="params">EAnimName anim, <span class="keyword">float</span> fSpeed</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> PlayAnimation (anim, fSpeed, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">PushAnimation</span>(<span class="params">EAnimName anim</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> PlayAnimation (anim, <span class="number">1.0f</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">PushAnimation</span>(<span class="params">EAnimName anim, <span class="keyword">float</span> fSpeed</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> PlayAnimation (anim, fSpeed, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">PlayAnimation</span>(<span class="params">EAnimName anim, <span class="keyword">float</span> fSpeed, <span class="keyword">bool</span> bIsPush</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esAnimation, anim, fSpeed, bIsPush);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接播放动画, 这个接口非原创者不要调用 by WuZhenqiang</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> _playAnimation(EAnimName anim, <span class="keyword">float</span> fSpeed, <span class="keyword">bool</span> bIsPush)</span><br><span class="line">    &#123;</span><br><span class="line">        SendModelEvent (EModelEvent.evtAnimation, anim, fSpeed, bIsPush);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 物品=============================================================================================================================</span></span><br><span class="line">    <span class="keyword">public</span> XItemManager ItemManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initItemMgr</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ItemManager = <span class="keyword">new</span> XItemManager (<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">CanSellItem</span>(<span class="params"><span class="keyword">uint</span> boxType, <span class="keyword">short</span> pos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> ItemManager.CanSellItem(boxType, pos);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetItmeCount</span>(<span class="params"><span class="keyword">uint</span> itemId</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> ItemManager.GetItemByDataID(itemId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> Buff</span></span><br><span class="line">    <span class="keyword">public</span> XBuffOper BuffOper &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBuffOper</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        BuffOper = <span class="keyword">new</span> XBuffOper (<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 角色属性</span></span><br><span class="line">    <span class="keyword">protected</span> XAttrCharacter m_AttrCharacter = <span class="keyword">new</span> XAttrCharacter ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> Speed &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.Speed; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrCharacter.Speed != <span class="keyword">value</span>) &#123;</span><br><span class="line">                <span class="keyword">float</span> oldSpeed = Speed;</span><br><span class="line">                m_AttrCharacter.Speed = <span class="keyword">value</span>;</span><br><span class="line">                m_BehaviourSM.OnEvent ((<span class="keyword">int</span>)EStateEvent.esSpeed, Speed, oldSpeed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Title &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.Title; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrCharacter.Title != <span class="keyword">value</span>) &#123;</span><br><span class="line">                m_AttrCharacter.Title = <span class="keyword">value</span>;</span><br><span class="line">                SendModelEvent (EModelEvent.evtTitle, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">string</span> NickName &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.NickName; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrCharacter.NickName != <span class="keyword">value</span>) &#123;</span><br><span class="line">                m_AttrCharacter.NickName = <span class="keyword">value</span>;</span><br><span class="line">                SendModelEvent (EModelEvent.evtNickName, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span> Sex &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.Sex; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrCharacter.Sex != <span class="keyword">value</span>) &#123;</span><br><span class="line">                m_AttrCharacter.Sex = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Hp &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.Hp; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_AttrCharacter.Hp != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">value</span> &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_AttrCharacter.Hp = <span class="number">0</span>;</span><br><span class="line">                    BuffOper.OnDead();</span><br><span class="line">                    <span class="keyword">this</span>.OnDead();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">value</span> &gt; MaxHp)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_AttrCharacter.Hp = MaxHp;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    m_AttrCharacter.Hp = <span class="keyword">value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                SendModelEvent(EModelEvent.evtHp, m_AttrCharacter.Hp);</span><br><span class="line">                <span class="comment">//m_BehaviourSM.OnEvent((int)EStateEvent.esHp, m_AttrCharacter.Hp);</span></span><br><span class="line">                XEventManager.SP.SendEvent(EEvent.Attr_Hp, <span class="keyword">this</span>, m_AttrCharacter.Hp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> MaxHp </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> DynGet (EShareAttr.esa_MaxHp); &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (MaxHp != <span class="keyword">value</span>) &#123;</span><br><span class="line">                DynSet (EShareAttr.esa_MaxHp, <span class="keyword">value</span>);</span><br><span class="line">                SendModelEvent (EModelEvent.evtMaxHp, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">int</span> Level &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> DynGet (EShareAttr.esa_Level); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Level != <span class="keyword">value</span>) &#123;</span><br><span class="line">                DynSet (EShareAttr.esa_Level, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">uint</span> ArmourItemID </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">return</span> m_AttrCharacter.ArmourItemID; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrCharacter.ArmourItemID != <span class="keyword">value</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrCharacter.ArmourItemID = <span class="keyword">value</span>;</span><br><span class="line">                XCfgItem cfgItem = XCfgItemMgr.SP.GetConfig (ArmourItemID);</span><br><span class="line">                <span class="keyword">uint</span> id = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (cfgItem != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">                    cfgItem.ItemType == (<span class="keyword">ushort</span>)EItem_Type.EITEM_TYPE_ARMOR &amp;&amp; </span><br><span class="line">                    cfgItem.EquipPos == (<span class="keyword">int</span>)EQUIP_SLOT_TYPE.EQUIP_SLOT_ARMOUR) </span><br><span class="line">                &#123;</span><br><span class="line">                    id = cfgItem.ArmourID;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( m_AttrCharacter.ShowFashion == <span class="number">1</span> ||</span><br><span class="line">                    m_AttrCharacter.FashionId == <span class="number">0</span> )</span><br><span class="line">                    SetModel (EModelCtrlType.eModelCtrl_ByArmour, id);</span><br><span class="line">                XEventManager.SP.SendEvent (EEvent.Attr_ArmourItemID, <span class="keyword">this</span>, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">uint</span> FashionId </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">return</span> m_AttrCharacter.FashionId; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_AttrCharacter.FashionId != <span class="keyword">value</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrCharacter.FashionId = <span class="keyword">value</span>;</span><br><span class="line">                XCfgItem cfgItem = XCfgItemMgr.SP.GetConfig(FashionId);</span><br><span class="line">                <span class="keyword">uint</span> id = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (cfgItem != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">                    cfgItem.ItemType == (<span class="keyword">ushort</span>)EItem_Type.EITEM_TYPE_ARMOR &amp;&amp; </span><br><span class="line">                    cfgItem.EquipPos == (<span class="keyword">int</span>)EQUIP_SLOT_TYPE.EQUIP_SLOP_FASHION) </span><br><span class="line">                &#123;</span><br><span class="line">                    id = cfgItem.ArmourID;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( XLogicWorld.SP.MainPlayer.ShowFashion == <span class="number">0</span> &amp;&amp; id &gt; <span class="number">0</span> )</span><br><span class="line">                    SetModel (EModelCtrlType.eModelCtrl_ByFashion, id);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ArmourItemID = ArmourItemID;</span><br><span class="line">                </span><br><span class="line">                XEventManager.SP.SendEvent(EEvent.Attr_ArmourItemID, <span class="keyword">this</span>, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> WeaponModelId</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.WeaponModelID; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_AttrCharacter.WeaponModelID != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrCharacter.WeaponModelID   = <span class="keyword">value</span>;</span><br><span class="line">                SendModelEvent(EModelEvent.evtWeaponId, <span class="keyword">value</span>);</span><br><span class="line">                XEventManager.SP.SendEvent(EEvent.Attr_WeaponItemID, <span class="keyword">this</span>, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnDead</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">DynGet</span>(<span class="params">EShareAttr aIndex</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_AttrCharacter.DynamicAttrs.Get (aIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DynSet</span>(<span class="params">EShareAttr aIndex, <span class="keyword">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (DynGet (aIndex) != <span class="keyword">value</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            m_AttrCharacter.DynamicAttrs.Set ((<span class="keyword">int</span>)aIndex, <span class="keyword">value</span>);</span><br><span class="line">            XEventManager.SP.SendEvent (EEvent.Attr_Dynamic, <span class="keyword">this</span>, aIndex, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateDynAttrs</span>(<span class="params">IList&lt;Msg_PairII&gt; lst</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (Msg_PairII info <span class="keyword">in</span> lst) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.DynSet ((EShareAttr)info.First, info.Second);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsDead &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> Hp &lt;= <span class="number">0</span>; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角色模型显示</span></span><br><span class="line">    <span class="keyword">private</span> EModelCtrlType m_eCurModelType = EModelCtrlType.eModelCtrl_Original;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">uint</span>[] m_ModelIdArr = <span class="keyword">new</span> <span class="keyword">uint</span>[(<span class="keyword">int</span>)EModelCtrlType.eModelCtrl_End];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetModel</span>(<span class="params">EModelCtrlType ct, <span class="keyword">uint</span> modelId</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ct &gt;= EModelCtrlType.eModelCtrl_End</span><br><span class="line">            || m_ModelIdArr [(<span class="keyword">int</span>)ct] == modelId)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        m_ModelIdArr [(<span class="keyword">int</span>)ct] = modelId;</span><br><span class="line">        <span class="keyword">if</span> (ct &lt; m_eCurModelType) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (modelId &gt; <span class="number">0</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                ModelId = modelId;</span><br><span class="line">                m_eCurModelType = ct;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ct == m_eCurModelType) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (modelId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ModelId = modelId;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (EModelCtrlType i = m_eCurModelType + <span class="number">1</span>; i &lt; EModelCtrlType.eModelCtrl_End; i++) </span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">uint</span> id = m_ModelIdArr [(<span class="keyword">int</span>)i];</span><br><span class="line">                    <span class="keyword">if</span> (id &gt; <span class="number">0</span>) </span><br><span class="line">                    &#123;</span><br><span class="line">                        ModelId = id;</span><br><span class="line">                        m_eCurModelType = i;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameObject/XPlayer.cs </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"><span class="keyword">using</span> Google.ProtocolBuffers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 类名: XPlayer</span></span><br><span class="line"><span class="comment"> * 描述: 客户端所有玩家对象的基类</span></span><br><span class="line"><span class="comment"> * 功能:</span></span><br><span class="line"><span class="comment"> *      1. 维护玩家基础属性</span></span><br><span class="line"><span class="comment"> *      2. 响应服务器过来的消息 开始移动.停止移动.跳跃.坐下</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XPlayer</span> : <span class="title">XCharacter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XPlayer</span>(<span class="params"><span class="keyword">ulong</span> id</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">id</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ObjectType = EObjectType.OtherPlayer;</span><br><span class="line">        IsEnableHover   = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~XPlayer()</span><br><span class="line">    &#123;</span><br><span class="line">        m_AttrPlayer = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Appear</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Appear();      </span><br><span class="line">        SendModelEvent(EModelEvent.evtWeaponId, WeaponModelId);</span><br><span class="line">        SendModelEvent(EModelEvent.evtUColor, UColor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DisAppear</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DisAppear ();</span><br><span class="line">        XEventManager.SP.SendEvent(EEvent.UI_Hide,EUIPanel.eTargetInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelLoaded</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnModelLoaded();</span><br><span class="line">        </span><br><span class="line">        m_ObjectModel.ReAttachMount();</span><br><span class="line">        m_ObjectModel.AddBehaviourListener(EBehaviourType.e_BehaviourType_OtherPlayer,<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> EHeadBoard_Type <span class="title">GetHeadBoardType</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> EHeadBoard_Type.EHeadBoard_Type_Player; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetAppearData</span> (<span class="params"><span class="keyword">object</span> data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SC_PlayerAppearData msg = data <span class="keyword">as</span> SC_PlayerAppearData;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == msg)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//--4&gt;<span class="doctag">TODO:</span> 考虑同步数据进行分类, 使用公用结构, 给子类调用</span></span><br><span class="line">        Vector3 pos = Position;</span><br><span class="line">        Version = msg.Version;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasName) Name = msg.Name;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasTitle) Title = msg.Title;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasPosX) pos.x = msg.PosX;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasPosZ) pos.z = msg.PosZ;</span><br><span class="line">        Position = pos;</span><br><span class="line">        PushOnTerrain();</span><br><span class="line">        <span class="keyword">if</span> (msg.HasDirection) Direction = <span class="keyword">new</span> Vector3(<span class="number">0</span>, msg.Direction, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.HasModel) SetModel(EModelCtrlType.eModelCtrl_Original, msg.Model);</span><br><span class="line">        <span class="keyword">if</span> (msg.HasColor) UColor = msg.Color;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasSex) Sex = (<span class="keyword">byte</span>)msg.Sex;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasClass) DynSet(EShareAttr.esa_Class, (<span class="keyword">byte</span>)msg.Class);</span><br><span class="line">        <span class="keyword">if</span> (msg.HasClassLevel) ClassLevel = msg.ClassLevel;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasLevel) Level = (<span class="keyword">int</span>)msg.Level;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasRunSpeed) Speed = msg.RunSpeed;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasMountIndex) m_AttrPlayer.MountIndex = (<span class="keyword">ushort</span>)msg.MountIndex;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasArmourItemID) </span><br><span class="line">            ArmourItemID = msg.ArmourItemID;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ArmourItemID = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (msg.HasWeaponItemID) </span><br><span class="line">            WeaponItemID = msg.WeaponItemID;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            WeaponItemID = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasShowFashion) ShowFashion = msg.ShowFashion;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasFashionId) FashionId = msg.FashionId;</span><br><span class="line">        <span class="keyword">if</span> (msg.HasNickNameID)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(msg.NickNameID !=<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                XCfgNickName infodata = XCfgNickNameMgr.SP.GetConfig(msg.NickNameID);</span><br><span class="line">                <span class="keyword">if</span>(infodata!= <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">string</span> colorname = XGameColorDefine.Quality_Color[infodata.ColorID];</span><br><span class="line">                        <span class="keyword">this</span>.NickName =<span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125;&#123;1&#125;"</span>,colorname,infodata.NickName);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Log.Write(LogLevel.ERROR,<span class="string">"Xplayer, the index is out of Quality_Color num"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.NickName = <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// xz移动状态</span></span><br><span class="line">        <span class="keyword">if</span>(msg.HasMoveType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span>((EProtoMoveType)msg.MoveType)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span>(EProtoMoveType.eMoveType_Stand):</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span>(EProtoMoveType.eMoveType_Segment):</span><br><span class="line">                SegmentMoveTo(<span class="keyword">new</span> Vector3(msg.TargetX, <span class="number">0.0f</span>, msg.TargetZ), Speed, <span class="literal">null</span>,EAnimName.Run);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span>(EProtoMoveType.eMoveType_Slide):</span><br><span class="line">                SlideMoveTo(<span class="keyword">new</span> Vector3(msg.TargetX, <span class="number">0.0f</span>, msg.TargetZ), Direction.y, Speed, <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span>(EProtoMoveType.eMoveType_Step):</span><br><span class="line">                StepMove(Speed, Direction.y);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 跳跃状态</span></span><br><span class="line">        <span class="keyword">if</span>(msg.HasJumpTime &amp;&amp; msg.JumpTime &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Jump(msg.JumpX, msg.JumpZ, msg.JumpTime / <span class="number">1000f</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// DynAttr</span></span><br><span class="line">        <span class="keyword">foreach</span>(Int64 dynAttr <span class="keyword">in</span> msg.DynAttrList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> key = (<span class="keyword">int</span>)(dynAttr &gt;&gt; <span class="number">32</span>);</span><br><span class="line">            <span class="keyword">int</span> val = (<span class="keyword">int</span>)(dynAttr);</span><br><span class="line">            DynSet((EShareAttr)key, val);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// buff</span></span><br><span class="line">        <span class="keyword">if</span>(msg.BuffArrList.Count &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BuffOper.Clear();</span><br><span class="line">            <span class="keyword">foreach</span>(UInt64 buff64 <span class="keyword">in</span> msg.BuffArrList)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">uint</span> nBuffId = (<span class="keyword">uint</span>)(buff64 &gt;&gt; <span class="number">32</span>);</span><br><span class="line">                <span class="keyword">byte</span> btBuffLevel = (<span class="keyword">byte</span>)(buff64);</span><br><span class="line">                BuffOper.AddBuff(nBuffId, btBuffLevel, <span class="number">0</span>, <span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// product</span></span><br><span class="line">        <span class="keyword">if</span>(msg.HasProduct) </span><br><span class="line">            StartProduct(msg.Product);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这个函数用来校准其他玩家的真实位置和客户端的显示位置</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">correctPosition</span>(<span class="params">Vector3 pos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 如果误差大于1米, 需要矫正一下</span></span><br><span class="line">        <span class="keyword">if</span>(XUtil.CalcDistanceXZ(Position, pos) &gt; <span class="number">1.0f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Position = pos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnterSit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnExitSit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartSit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_BehaviourSM.OnEvent((<span class="keyword">int</span>)EStateEvent.esSit);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">EndSit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_BehaviourSM.OnEvent((<span class="keyword">int</span>)EStateEvent.esCancelSit);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">On_SC_StartMove</span>(<span class="params">SC_StartMove msg</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 fromPos = <span class="keyword">new</span> Vector3(msg.FromX, <span class="number">0f</span>, msg.FromZ);</span><br><span class="line">        correctPosition(fromPos);</span><br><span class="line">        <span class="keyword">switch</span>((EProtoMoveType)msg.MoveType)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span>(EProtoMoveType.eMoveType_Stand):</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span>(EProtoMoveType.eMoveType_Segment):</span><br><span class="line">            SegmentMoveTo(<span class="keyword">new</span> Vector3(msg.ToX, <span class="number">0.0f</span>, msg.ToZ), Speed, <span class="literal">null</span>,EAnimName.Run);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span>(EProtoMoveType.eMoveType_Slide):</span><br><span class="line">            SlideMoveTo(<span class="keyword">new</span> Vector3(msg.ToX, <span class="number">0.0f</span>, msg.ToZ), msg.Dir, Speed, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span>(EProtoMoveType.eMoveType_Step):</span><br><span class="line">            StepMove(Speed, msg.Dir);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">On_SC_StopMove</span>(<span class="params">SC_StopMove msg</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 pos = <span class="keyword">new</span> Vector3(msg.PosX, <span class="number">0f</span>, msg.PosZ);</span><br><span class="line">        correctPosition(pos);</span><br><span class="line">        StopMove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">On_SC_Jump</span>(<span class="params">SC_Jump msg</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 pos = <span class="keyword">new</span> Vector3(msg.PosX, <span class="number">0f</span>, msg.PosZ);</span><br><span class="line">        correctPosition(pos);</span><br><span class="line">        Jump(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">On_SC_JumpOver</span>(<span class="params">SC_JumpOver msg</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 pos = <span class="keyword">new</span> Vector3(msg.PosX, <span class="number">0f</span>, msg.PosZ);</span><br><span class="line">        correctPosition(pos);</span><br><span class="line">        JumpOver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">On_SC_Sit</span>(<span class="params">SC_Sit msg</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">       <span class="comment">// Vector3 pos = new Vector3(msg.PosX, msg.PosY, msg.PosZ);</span></span><br><span class="line">    <span class="comment">//  correctPosition(pos);</span></span><br><span class="line">        StartSit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">On_SC_StopSit</span>(<span class="params">SC_StopSit msg</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EndSit();</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 属性</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">int</span> Class    <span class="comment">// 职业</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> DynGet(EShareAttr.esa_Class); &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(Class != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                DynSet(EShareAttr.esa_Class, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">float</span> Grow</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> DynGet(EShareAttr.esa_Grow) / Define.CONFIG_RATE_BASE; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(Grow != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                DynSet(EShareAttr.esa_Grow, (<span class="keyword">int</span>)(<span class="keyword">value</span> * Define.CONFIG_RATE_BASE));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> UColor</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrPlayer.UColor; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_AttrPlayer.UColor != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrPlayer.UColor = <span class="keyword">value</span>;</span><br><span class="line">                SendModelEvent(EModelEvent.evtUColor, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> ClassLevel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrPlayer.ClassLevel; &#125;</span><br><span class="line">        <span class="keyword">set</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_AttrPlayer.ClassLevel != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrPlayer.ClassLevel = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">ushort</span> MountIndex</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrPlayer.MountIndex; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_AttrPlayer.MountIndex != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrPlayer.MountIndex = <span class="keyword">value</span>;</span><br><span class="line">                SendModelEvent(EModelEvent.evtMountIndex, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">uint</span> ArmourItemID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//--4&gt;: 直接刷新模型, 因为下线再上线时逻辑数据是一致的, 而模型必须重置</span></span><br><span class="line">            <span class="comment">//if (m_AttrCharacter.ArmourItemID != value)</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrCharacter.ArmourItemID = <span class="keyword">value</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//临时显示自己的强化显示效果</span></span><br><span class="line">                <span class="comment">//--------------------------------------------------</span></span><br><span class="line">                <span class="keyword">byte</span>    strengthenLevel = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">uint</span>    colorLevel = <span class="number">0</span>;     </span><br><span class="line">                 XCfgItem cfgItem = XCfgItemMgr.SP.GetConfig(<span class="keyword">value</span>);</span><br><span class="line">                XItem item = ItemManager.GetItem((<span class="keyword">uint</span>)EItemBoxType.Equip,(<span class="keyword">short</span>)EQUIP_POS.EQUIP_POS_ARMOUR);</span><br><span class="line">                <span class="keyword">if</span>(item != <span class="literal">null</span> &amp;&amp; cfgItem != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    strengthenLevel = (<span class="keyword">byte</span>)item.mEquipAttr.mStrengthenLevel;</span><br><span class="line">                    <span class="keyword">if</span>(cfgItem.IsRandom &gt; <span class="number">0</span>)</span><br><span class="line">                        colorLevel      = (<span class="keyword">uint</span>)item.mEquipAttr.mColor;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        colorLevel      = cfgItem.QualityLevel;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//----------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 刷新显示模型(铠甲模型或者角色裸模)</span></span><br><span class="line">               </span><br><span class="line">                <span class="keyword">int</span> JobClass = DynGet(EShareAttr.esa_Class);</span><br><span class="line">                <span class="keyword">if</span> (cfgItem != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">                    cfgItem.ItemType == (<span class="keyword">ushort</span>)EItem_Type.EITEM_TYPE_ARMOR &amp;&amp; </span><br><span class="line">                    cfgItem.EquipPos == (<span class="keyword">int</span>)EQUIP_SLOT_TYPE.EQUIP_SLOT_ARMOUR &amp;&amp;</span><br><span class="line">                    (m_AttrCharacter.ShowFashion == <span class="number">1</span> || FashionId == <span class="number">0</span>) )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//临时显示自己的强化显示效果</span></span><br><span class="line">                    <span class="comment">//--------------------------------------------------</span></span><br><span class="line">                    <span class="keyword">int</span> appearLevel = <span class="number">0</span>;</span><br><span class="line">                    </span><br><span class="line">                    XCfgStrengthen cfgStrengthen = XItemManager.GetStrengthenCfg(colorLevel,strengthenLevel);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span>(cfgStrengthen == <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Log.Write(LogLevel.ERROR,<span class="string">"cant find strengthen cfg"</span>);</span><br><span class="line">                        <span class="keyword">return</span> ;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span>(cfgStrengthen != <span class="literal">null</span>)</span><br><span class="line">                        appearLevel = cfgStrengthen.AppearLevel;</span><br><span class="line">                    <span class="comment">//--------------------------------------------------                    </span></span><br><span class="line">                    <span class="keyword">uint</span> tempModelID = XItemManager.GetArmourID(cfgItem.ArmourID,appearLevel,Sex,JobClass);</span><br><span class="line">                    <span class="keyword">if</span>(tempModelID != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Log.Write(LogLevel.DEBUG,<span class="string">"Cur Player Model ID is &#123;0&#125;"</span>,tempModelID);</span><br><span class="line">                        ModelId = tempModelID;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( m_AttrCharacter.ShowFashion == <span class="number">0</span> &amp;&amp; FashionId &gt; <span class="number">0</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        FashionId = FashionId;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">uint</span> md = <span class="number">0</span>;        </span><br><span class="line">                        XCfgPlayerBase playerBase = XCfgPlayerBaseMgr.SP.GetConfig((<span class="keyword">byte</span>)JobClass);</span><br><span class="line">                        <span class="keyword">if</span>(playerBase != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (Sex == (<span class="keyword">byte</span>)EShareSex.eshSex_Male)</span><br><span class="line">                            &#123;</span><br><span class="line">                                md = playerBase.MaleModel;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (Sex == (<span class="keyword">byte</span>)EShareSex.eshSex_Female)</span><br><span class="line">                            &#123;</span><br><span class="line">                                md = playerBase.FemaleModel;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (md &gt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Log.Write(LogLevel.DEBUG,<span class="string">"Cur Player Model ID is &#123;0&#125;"</span>,md);</span><br><span class="line">                            ModelId = md;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">uint</span> FashionId</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_AttrCharacter.FashionId = <span class="keyword">value</span>;</span><br><span class="line">                </span><br><span class="line">            XCfgItem cfgItem = XCfgItemMgr.SP.GetConfig(<span class="keyword">value</span>);</span><br><span class="line">            <span class="keyword">int</span> JobClass = DynGet(EShareAttr.esa_Class);</span><br><span class="line">            <span class="keyword">if</span> (cfgItem != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">                cfgItem.ItemType == (<span class="keyword">ushort</span>)EItem_Type.EITEM_TYPE_ARMOR &amp;&amp; </span><br><span class="line">                cfgItem.EquipPos == (<span class="keyword">int</span>)EQUIP_SLOT_TYPE.EQUIP_SLOP_FASHION &amp;&amp;</span><br><span class="line">                m_AttrCharacter.ShowFashion == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> appearLevel = <span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">uint</span> tempModelID = XItemManager.GetArmourID(cfgItem.ArmourID, appearLevel, Sex, JobClass);</span><br><span class="line">                <span class="keyword">if</span>(tempModelID != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Log.Write(LogLevel.DEBUG,<span class="string">"Cur Player Model ID is &#123;0&#125;"</span>,tempModelID);</span><br><span class="line">                    ModelId = tempModelID;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ArmourItemID = ArmourItemID;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> ShowFashion</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.ShowFashion;&#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_AttrCharacter.ShowFashion != <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrCharacter.ShowFashion = <span class="keyword">value</span>;</span><br><span class="line">                <span class="keyword">if</span> ( <span class="number">0</span> == <span class="keyword">value</span> &amp;&amp; FashionId &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    FashionId = FashionId;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    ArmourItemID = ArmourItemID;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//  public uint WeaponModelId</span></span><br><span class="line"><span class="comment">//  &#123;</span></span><br><span class="line"><span class="comment">//      get &#123; return m_AttrCharacter.WeaponModelID; &#125;</span></span><br><span class="line"><span class="comment">//      set</span></span><br><span class="line"><span class="comment">//      &#123;</span></span><br><span class="line"><span class="comment">//          if(m_AttrCharacter.WeaponModelID != value)</span></span><br><span class="line"><span class="comment">//          &#123;</span></span><br><span class="line"><span class="comment">//              m_AttrCharacter.WeaponModelID   = value;</span></span><br><span class="line"><span class="comment">//              SendModelEvent(EModelEvent.evtWeaponId, value);</span></span><br><span class="line"><span class="comment">//              XEventManager.SP.SendEvent(EEvent.Attr_WeaponItemID, this, value);</span></span><br><span class="line"><span class="comment">//          &#125;</span></span><br><span class="line"><span class="comment">//          </span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> WeaponItemID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AttrCharacter.WeaponItemID; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//if(m_AttrCharacter.WeaponItemID != value)</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_AttrCharacter.WeaponItemID = <span class="keyword">value</span>;               </span><br><span class="line"></span><br><span class="line">                XCfgItem cfgItem = XCfgItemMgr.SP.GetConfig(m_AttrCharacter.WeaponItemID);</span><br><span class="line">            </span><br><span class="line">                <span class="comment">//临时显示自己的强化显示效果</span></span><br><span class="line">                <span class="comment">//--------------------------------------------------</span></span><br><span class="line">                <span class="keyword">byte</span> strengthenLevel = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">uint</span> colorLevel = <span class="number">0</span>;</span><br><span class="line">                XItem item = ItemManager.GetItem((<span class="keyword">uint</span>)EItemBoxType.Equip,(<span class="keyword">short</span>)EQUIP_POS.EQUIP_POS_WEAPON);</span><br><span class="line">                <span class="keyword">if</span>(item != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    strengthenLevel = (<span class="keyword">byte</span>)item.mEquipAttr.mStrengthenLevel;</span><br><span class="line">                    colorLevel      = (<span class="keyword">uint</span>)item.mEquipAttr.mColor;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//----------------------------------------------------</span></span><br><span class="line">                <span class="keyword">int</span> JobClass = DynGet(EShareAttr.esa_Class);</span><br><span class="line">                <span class="keyword">if</span> (cfgItem != <span class="literal">null</span> &amp;&amp; cfgItem.ItemType == (<span class="keyword">ushort</span>)EItem_Type.EITEM_TYPE_WEAPON &amp;&amp; cfgItem.EquipPos == (<span class="keyword">int</span>)EQUIP_SLOT_TYPE.EQUIP_SLOT_WEAPON)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//临时显示自己的强化显示效果</span></span><br><span class="line">                    <span class="comment">//--------------------------------------------------</span></span><br><span class="line">                    <span class="keyword">int</span> appearLevel = <span class="number">0</span>;</span><br><span class="line">                    XCfgStrengthen cfgStrengthen = XItemManager.GetStrengthenCfg(colorLevel,strengthenLevel);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span>(cfgStrengthen == <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Log.Write(LogLevel.ERROR,<span class="string">"cant find strengthen cfg"</span>);</span><br><span class="line">                        <span class="keyword">return</span> ;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span>(cfgStrengthen != <span class="literal">null</span>)</span><br><span class="line">                        appearLevel = cfgStrengthen.AppearLevel;</span><br><span class="line">                    <span class="comment">//--------------------------------------------------</span></span><br><span class="line">                    <span class="keyword">uint</span> tempModelID = XItemManager.GetArmourID(cfgItem.ModelId,appearLevel,Sex,JobClass);</span><br><span class="line">                    WeaponModelId = tempModelID;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;                       </span><br><span class="line">                    XCfgPlayerBase playerBase = XCfgPlayerBaseMgr.SP.GetConfig((<span class="keyword">byte</span>)JobClass);</span><br><span class="line">                    <span class="keyword">if</span>(playerBase != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        WeaponModelId   = playerBase.DefaultWeapon;</span><br><span class="line">                    &#125;                   </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span>(<span class="params"><span class="keyword">int</span> mouseCode, Vector3 clickPoint</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        XEventManager.SP.SendEvent(EEvent.ObjSel_SetData,Name,Level,ID);</span><br><span class="line">        XEventManager.SP.SendEvent(EEvent.UI_Show,EUIPanel.eTargetInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Audio"><a href="#Audio" class="headerlink" title="Audio"></a>Audio</h1><blockquote>
<p>GameBehaviour/XU3dAudio.cs 没有继承MonoBehavior</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XU3dAudio</span> : <span class="title">XU3dDynObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 加载完成后执行的回调函数</span></span><br><span class="line">    <span class="comment">// 这个委托需要外界调用的来写具体的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">OnAudioLoadDone</span>(<span class="params">XU3dAudio self</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OnAudioLoadDone m_loadDoneCallBack = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AudioClip m_AudioClip = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> ID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_nId; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AudioClip audioClip</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_AudioClip; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XU3dAudio</span>(<span class="params"><span class="keyword">uint</span> nId</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RefreshDynObject(nId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XU3dAudio</span>(<span class="params"><span class="keyword">uint</span> nId, OnAudioLoadDone loadDoneFunction</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_loadDoneCallBack = loadDoneFunction;</span><br><span class="line">        <span class="comment">// 加载音效</span></span><br><span class="line">        RefreshDynObject(nId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">RefreshDynObject</span>(<span class="params"><span class="keyword">uint</span> id</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_nId == id)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        m_nId = id;</span><br><span class="line">        doRefreshDynObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRefreshDynObject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        NewGameObject(<span class="string">"Audio_"</span> + m_nId);</span><br><span class="line">        m_DynObject = XResourceManager.GetResource(XResourceAudio.ResTypeName, m_nId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_DynObject)</span><br><span class="line">        &#123;</span><br><span class="line">            Log.Write(LogLevel.Warn, <span class="string">"XU3dAudio, not found resource: &#123;0&#125;"</span>, m_nId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(m_DynObject.IsLoadDone())</span><br><span class="line">        &#123;</span><br><span class="line">            LoadCompleted(m_DynObject.MainAsset.DownLoad);</span><br><span class="line">        &#125; <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_DynObject != <span class="literal">null</span>)</span><br><span class="line">                m_DynObject.ResLoadEvent -= LoadCompleted;</span><br><span class="line"></span><br><span class="line">            XResourceManager.StartLoadResource(XResourceAudio.ResTypeName, m_nId);</span><br><span class="line">            m_DynObject.ResLoadEvent += <span class="keyword">new</span> XResourceBase.LoadCompletedDelegate(LoadCompleted);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadCompleted</span>(<span class="params"> DownLoadItem itemLoad</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">if</span> RES_DEBUG</span></span><br><span class="line">            AudioClip go = itemLoad.go <span class="keyword">as</span> AudioClip;</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            AudioClip go = itemLoad.ab.mainAsset <span class="keyword">as</span> AudioClip;</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">endif</span> </span></span><br><span class="line"></span><br><span class="line">            onAudioDone(go);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAudioDone</span>(<span class="params">AudioClip audio</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == audio)</span><br><span class="line">            &#123;</span><br><span class="line">                Log.Write(LogLevel.Warn, <span class="string">"XU3dAudio, wrong resource: &#123;0&#125;"</span>, m_nId);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            m_AudioClip = Object.Instantiate(audio) <span class="keyword">as</span> AudioClip;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_loadDoneCallBack)</span><br><span class="line">            &#123;</span><br><span class="line">                m_loadDoneCallBack(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GameBehaviour/XAudio.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XAudio</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// 外界传入</span></span><br><span class="line">    <span class="comment">// AudioClip的id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> m_iAudioID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 外界传入</span></span><br><span class="line">    <span class="comment">// 音乐是否循环可以设置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> m_bLoop = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> XU3dAudio m_u3dAudio = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_u3dAudio = <span class="keyword">new</span> XU3dAudio((<span class="keyword">uint</span>)m_iAudioID, onAudioLoaded);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加完后音效后执行</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAudioLoaded</span>(<span class="params">XU3dAudio audio</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        AudioSource audioSource = gameObject.AddComponent&lt;AudioSource&gt;();</span><br><span class="line"></span><br><span class="line">        audioSource.loop = m_bLoop;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给AudioSource组件设置音效clip</span></span><br><span class="line">        audioSource.clip = audio.audioClip;</span><br><span class="line">        audioSource.Play();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="资源加载"><a href="#资源加载" class="headerlink" title="资源加载"></a>资源加载</h1><blockquote>
<p>Resource/XDownloadItem.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">resource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">    <span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> RES_DEBUG</span></span><br><span class="line">    <span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DownLoadItem</span> : <span class="title">IDisposable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 路径这些都设置为私有</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">string</span> _back_server_path = <span class="string">"http://localhost/WebPlayer/"</span>; <span class="comment">// 备份路径</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">string</span> _original_src_path = <span class="string">"http://localhost/WebPlayer/"</span>; <span class="comment">// 原始路径</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _time_start; <span class="comment">// 下载开始时间</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _use_cache; <span class="comment">// 使用使用缓存</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> ServerRejectPostRequest = <span class="literal">true</span>; <span class="comment">// 服务器是否拒绝post请求</span></span><br><span class="line">        <span class="comment">// end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> AssetBundle ab;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> act_url = <span class="keyword">string</span>.Empty; <span class="comment">// 最后的执行路径</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">object</span> data;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> error; <span class="comment">// 错误的信息</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> hasError; <span class="comment">// 是否有错误</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsDone; <span class="comment">// 是否完成</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> priority; <span class="comment">// 优先级</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> retryTimes; <span class="comment">// 重试时间</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> size; <span class="comment">// 文件大小</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> url; <span class="comment">// 地址</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> version; <span class="comment">// 版本</span></span><br><span class="line">        <span class="keyword">public</span> WWW www;</span><br><span class="line">        <span class="keyword">public</span> UnityEngine.Object go;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载完成事件，只有自己可以调用</span></span><br><span class="line">        <span class="comment">// LoadCompletedDelegate是事件类型</span></span><br><span class="line">        <span class="comment">// LoadCompletedEvent是事件类型的变量</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">LoadCompletedDelegate</span>(<span class="params">DownloadItem item</span>)</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">event</span> LoadCompletedDelegate LoadCompletedEvent;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsAddDelegate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造函数</span></span><br><span class="line">        <span class="comment">// 初始化字段</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DownloadItem</span>(<span class="params"><span class="keyword">string</span> url, <span class="keyword">int</span> version, <span class="keyword">int</span> size, <span class="keyword">int</span> priority, <span class="keyword">int</span> tryTimes</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.url = url;</span><br><span class="line">            <span class="keyword">this</span>.version = version;</span><br><span class="line">            <span class="keyword">this</span>.size = size;</span><br><span class="line">            <span class="keyword">this</span>.priority = priority;</span><br><span class="line">            <span class="keyword">this</span>.IsDone = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.retryTimes = tryTimes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给外界</span></span><br><span class="line">        <span class="comment">// 触发加载完成事件</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> _FireLoadCompleted()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.LoadCompletedEvent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.LoadCompletedEvent(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">this</span>.LoadCompletedEvent = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给外界调用，是否完成</span></span><br><span class="line">        <span class="comment">// 判断是否完成，不是判断是否正确加载</span></span><br><span class="line">        <span class="comment">// 完成之后也可能有错误</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">CheckIsDone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.www != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.www.isDone)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 有错误</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(<span class="keyword">this</span>.www.error))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.www.error.Contains(<span class="string">"rewind wasn't possible"</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.Log(<span class="string">"http resonse error, change POST to GET. error:"</span> + <span class="keyword">this</span>.www.error);</span><br><span class="line">                            ServerRejectPostRequest = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">string</span> error = <span class="keyword">this</span>.www.error;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.Retry())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">this</span>.hasError = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">this</span>.error = error;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 不使用缓存或者www.assetBundle为空成立一个的话就进行第2个判断</span></span><br><span class="line">                    <span class="comment">// 第2个判断是www请求返回有值</span></span><br><span class="line">                    <span class="keyword">if</span> ((!<span class="keyword">this</span>._use_cache || (<span class="keyword">this</span>.www.assetBundle == <span class="literal">null</span>)) &amp;&amp; !<span class="keyword">string</span>.IsNullOrEmpty(<span class="keyword">this</span>.www.text))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// Mathf.Min 返回两个或更多值中最小的值。</span></span><br><span class="line">                        <span class="keyword">string</span> str2 = <span class="keyword">this</span>.www.text.Substring(<span class="number">0</span>, Mathf.Min(<span class="keyword">this</span>.www.text.Length, <span class="number">300</span>));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (str2.ToLower().Contains(<span class="string">"&lt;html"</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.Log(<span class="string">"http resonse error:"</span> + str2);</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">this</span>.Retry())</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">this</span>.hasError = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">this</span>.error = <span class="string">"Download Error! "</span> + <span class="keyword">this</span>.www.url + <span class="string">"\n"</span> + <span class="keyword">this</span>.www.text;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">this</span>.www.progress != <span class="number">0f</span>) || ((Time.time - <span class="keyword">this</span>._time_start) &lt;= <span class="number">10f</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.Retry())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 超时记录日志</span></span><br><span class="line">                <span class="keyword">this</span>.hasError = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">this</span>.error = <span class="keyword">string</span>.Format(<span class="string">"Timeout, start:&#123;0&#125;, now:&#123;1&#125;, pass:&#123;2&#125;"</span>, <span class="keyword">this</span>._time_start, Time.time, Time.time - <span class="keyword">this</span>._time_start);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否可以重试</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">Retry</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Debug.LogWarning(<span class="keyword">string</span>.Format(<span class="string">"DownloadItem.Retry, retryTimes:&#123;0&#125;, url:&#123;1&#125;"</span>, <span class="keyword">this</span>.retryTimes, <span class="keyword">this</span>.url));</span><br><span class="line">            <span class="comment">// 清除之前的www</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.www != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.www.Dispose();</span><br><span class="line">                <span class="keyword">this</span>.www = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重试时间用完了</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.retryTimes &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.retryTimes--;</span><br><span class="line">            <span class="keyword">this</span>.version++;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.retryTimes &lt;= <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.Start(<span class="keyword">this</span>._use_cache, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.Start(<span class="keyword">this</span>._use_cache);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"><span class="keyword">bool</span> useCache</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Start(useCache, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给_use_cache，act_url，www，_time_start等字段赋值</span></span><br><span class="line">        <span class="comment">// 然后开始加载</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"><span class="keyword">bool</span> useCache, <span class="keyword">bool</span> use_back_server</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> RES_DEBUG</span></span><br><span class="line">            go = AssetDatabase.LoadMainAssetAtPath(<span class="string">"Assets/"</span> + <span class="keyword">this</span>.url);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.www != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>._use_cache = useCache;</span><br><span class="line">            <span class="keyword">if</span> (useCache)</span><br><span class="line">            &#123;   </span><br><span class="line">                <span class="comment">// 不使用备份路径</span></span><br><span class="line">                <span class="keyword">if</span> (!use_back_server)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">string</span> str;</span><br><span class="line">                    <span class="comment">// 加上版本号</span></span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">this</span>.version == <span class="number">0</span>)</span><br><span class="line">                        str = <span class="keyword">this</span>.url;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        str = !<span class="keyword">this</span>.url.StartsWith(<span class="string">"http://"</span>) ? <span class="keyword">this</span>.url : (<span class="keyword">this</span>.url + <span class="string">"_"</span> + <span class="keyword">this</span>.version + <span class="string">".asset"</span>);</span><br><span class="line">                    <span class="comment">// 记录日志</span></span><br><span class="line">                    <span class="keyword">object</span>[] args = <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; <span class="keyword">string</span>.Format(<span class="string">"LoadFromCacheOrDownload, url:&#123;0&#125;, version:&#123;1&#125;"</span>, str, <span class="keyword">this</span>.version) &#125;;</span><br><span class="line">                    Log.AddTempLog(args);</span><br><span class="line">                    <span class="comment">// 前期准备做完，给字段赋值</span></span><br><span class="line">                    <span class="keyword">this</span>.act_url = str;</span><br><span class="line">                    <span class="comment">// version Version of the AssetBundle.</span></span><br><span class="line">                    <span class="keyword">this</span>.www = WWW.LoadFromCacheOrDownload(str, <span class="keyword">this</span>.version);</span><br><span class="line">                &#125;<span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.DownloadByBackupServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (!use_back_server)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ((Config.LANG == <span class="string">"cn"</span>) &amp;&amp; !ServerRejectPostRequest) <span class="comment">// 可以使用post请求</span></span><br><span class="line">                &#123;</span><br><span class="line">                    WWWForm form = <span class="keyword">new</span> WWWForm();</span><br><span class="line">                    form.AddField(<span class="string">"ver"</span>, <span class="keyword">this</span>.version);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">string</span> str2 = !<span class="keyword">this</span>.url.StartsWith(<span class="string">"http://"</span>) ? <span class="keyword">this</span>.url : (<span class="keyword">this</span>.url + <span class="string">"_"</span> + <span class="keyword">this</span>.version + <span class="string">".asset"</span>);</span><br><span class="line">                    <span class="comment">// 更改act_url实际执行字段</span></span><br><span class="line">                    <span class="keyword">this</span>.act_url = str2;</span><br><span class="line">                    <span class="keyword">this</span>.www = <span class="keyword">new</span> WWW(<span class="keyword">this</span>.url, form);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="comment">// get请求</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">string</span> url;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">this</span>.version == <span class="number">0</span>)</span><br><span class="line">                        url = <span class="keyword">this</span>.url;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        url = !<span class="keyword">this</span>.url.StartsWith(<span class="string">"http://"</span>) ? <span class="keyword">this</span>.url : (<span class="keyword">this</span>.url + <span class="string">"_"</span> + <span class="keyword">this</span>.version + <span class="string">".asset"</span>);</span><br><span class="line">                    <span class="keyword">this</span>.act_url = url;</span><br><span class="line">                    <span class="keyword">this</span>.www = <span class="keyword">new</span> WWW(url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.DownloadByBackupServer();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>._time_start = Time.time;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用备份路径</span></span><br><span class="line">        <span class="comment">// 给act_url和www字段赋值</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DownloadByBackupServer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 不是http请求就不要加版本信息ver参数</span></span><br><span class="line">            <span class="keyword">string</span> url = !<span class="keyword">this</span>.url.StartsWith(<span class="string">"http://"</span>) ? <span class="keyword">this</span>.url : (<span class="keyword">this</span>.url + <span class="string">"?ver="</span> + <span class="keyword">this</span>.version);</span><br><span class="line">            <span class="keyword">this</span>.act_url = <span class="keyword">this</span>.GetBackServerUrl(url);</span><br><span class="line">            <span class="keyword">this</span>.www = <span class="keyword">new</span> WWW(<span class="keyword">this</span>.act_url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回备份路径</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetBackServerUrl</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (url.Contains(<span class="keyword">this</span>._original_src_path))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">"Download From backup server "</span> + url);</span><br><span class="line">                <span class="keyword">return</span> url.Replace(<span class="keyword">this</span>._original_src_path, <span class="keyword">this</span>._back_server_path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给外界调用</span></span><br><span class="line">        <span class="comment">// 是否全部加载完</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsAllDone</span>(<span class="params">IEnumerable&lt;DownloadItem&gt; list</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 得到枚举器</span></span><br><span class="line">            IEnumerator&lt;DownloadItem&gt; enumerator = list.GetEnumerator();</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (enumerator.MoveNext())</span><br><span class="line">                &#123;</span><br><span class="line">                    DownloadItem current = enumerator.Current;</span><br><span class="line">                    <span class="keyword">if</span> (!current.IsDone)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (enumerator == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                enumerator.Dispose();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给外界调用</span></span><br><span class="line">        <span class="comment">// 获取现在加载了多少</span></span><br><span class="line">        <span class="comment">// 一个可枚举类型作为参数</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">GetLoadingProgress</span>(<span class="params">IEnumerable&lt;DownloadItem&gt; list</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> num;</span><br><span class="line">            <span class="keyword">int</span> num2;</span><br><span class="line">            <span class="keyword">float</span> num3;</span><br><span class="line">            GetLoadingProgress(list, <span class="keyword">out</span> num, <span class="keyword">out</span> num2, <span class="keyword">out</span> num3);</span><br><span class="line">            <span class="keyword">return</span> num3;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 得到加载进度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="list"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="bytesLoaded"&gt;</span>已经加载的byte<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="bytesTotal"&gt;</span>总量<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="prog"&gt;</span>进度，需要算出来<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetLoadingProgress</span>(<span class="params">IEnumerable&lt;DownloadItem&gt; list, <span class="keyword">out</span> <span class="keyword">int</span> bytesLoaded, <span class="keyword">out</span> <span class="keyword">int</span> bytesTotal, <span class="keyword">out</span> <span class="keyword">float</span> prog</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> num2 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">            IEnumerator&lt;DownloadItem&gt; enumerator = list.GetEnumerator();</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (enumerator.MoveNext())</span><br><span class="line">                &#123;</span><br><span class="line">                    DownloadItem current = enumerator.Current;</span><br><span class="line">                    <span class="keyword">if</span> (current.size &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        num2 += current.size;</span><br><span class="line">                        <span class="keyword">if</span> (current.www != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            num += !current.IsDone ? ((<span class="keyword">int</span>)(current.size * current.www.progress)) : current.size;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    flag = flag &amp;&amp; current.IsDone;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (enumerator == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                enumerator.Dispose();</span><br><span class="line">            &#125;</span><br><span class="line">            bytesLoaded = num;</span><br><span class="line">            bytesTotal = num2;</span><br><span class="line">            prog = !flag ? ((num2 != <span class="number">0</span>) ? (((<span class="keyword">float</span>)bytesLoaded) / ((<span class="keyword">float</span>)bytesTotal)) : <span class="number">0f</span>) : <span class="number">1f</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在.NET的对象中实际上有两个用于释放资源的函数：Dispose和Finalize。Finalize的目的是用于释放非托管的资源，而Dispose是用于释放所有资源，包括托管的和非托管的。</span></span><br><span class="line">        <span class="comment">// 释放对象资源的接口是IDisposable</span></span><br><span class="line">        <span class="comment">// 继承这个接口需要的实现如下</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Dispose(<span class="literal">true</span>);</span><br><span class="line">            GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="keyword">bool</span> disposing</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.www != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (disposing)</span><br><span class="line">                &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                AssetBundleDestroyer.Add(<span class="keyword">this</span>.ab);</span><br><span class="line">                <span class="keyword">this</span>.www.Dispose();</span><br><span class="line">                <span class="keyword">this</span>.www = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ~DownloadItem()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Dispose(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Resource/XDownloadManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">resource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.Collections;</span><br><span class="line">    <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">    <span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line">    <span class="keyword">using</span> UnityEngine;</span><br><span class="line">    <span class="keyword">using</span> System.Net;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 静态工具类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">XDownloadManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, WeakReference&gt; cache = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, WeakReference&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">CompareDownloadItem</span>(<span class="params">DownloadItem left, DownloadItem right</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> left.priority - right.priority;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> CacheAuthorized = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> hasError = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> hasItemDone = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> LastErrorMsg = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> LastErrorUrl = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;DownloadItem&gt; loading = <span class="keyword">new</span> List&lt;DownloadItem&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> maxLoading = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> needSort;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> sizeLoaded = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;DownloadItem&gt; tmpList = <span class="keyword">new</span> List&lt;DownloadItem&gt;();</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> totalLoaded = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;DownloadItem&gt; waiting = <span class="keyword">new</span> List&lt;DownloadItem&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CachingAuthorize</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">string</span> domain, <span class="keyword">long</span> size, <span class="keyword">int</span> expiration, <span class="keyword">string</span> signature</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CacheAuthorized = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> CacheAuthorized;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Cancel</span>(<span class="params">DownloadItem item</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            waiting.Remove(item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CancelAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            waiting.Clear();</span><br><span class="line">            List&lt;DownloadItem&gt; list = DebugGetAllDownloads();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (DownloadItem item <span class="keyword">in</span> list)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (item.www != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    item.www.Dispose();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            list.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;DownloadItem&gt; <span class="title">DebugGetAllDownloads</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            List&lt;DownloadItem&gt; list = <span class="keyword">new</span> List&lt;DownloadItem&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="keyword">string</span>, WeakReference&gt; pair <span class="keyword">in</span> cache)</span><br><span class="line">            &#123;</span><br><span class="line">                DownloadItem target = pair.Value.Target <span class="keyword">as</span> DownloadItem;</span><br><span class="line">                <span class="keyword">if</span> (target != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    list.Add(target);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DebugGetDownloadInfo</span>(<span class="params"><span class="keyword">out</span> <span class="keyword">int</span> numItems, <span class="keyword">out</span> <span class="keyword">int</span> numLoading, <span class="keyword">out</span> <span class="keyword">int</span> numWaiting</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="keyword">string</span>, WeakReference&gt; pair <span class="keyword">in</span> cache)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pair.Value.Target <span class="keyword">is</span> DownloadItem)</span><br><span class="line">                &#123;</span><br><span class="line">                    num++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            numItems = num;</span><br><span class="line">            numLoading = loading.Count;</span><br><span class="line">            numWaiting = waiting.Count;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetDomainFromUrl</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Match match = Regex.Match(url, <span class="string">@"(?&lt;=://)[a-zA-Z\.0-9]+(?=\/)"</span>);</span><br><span class="line">            <span class="keyword">return</span> ((match == <span class="literal">null</span>) ? <span class="literal">null</span> : match.Value.ToString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DownloadItem <span class="title">GetDownload</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetDownload(url, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DownloadItem <span class="title">GetDownload</span>(<span class="params"><span class="keyword">string</span> url, <span class="keyword">int</span> version, <span class="keyword">int</span> size, <span class="keyword">int</span> priority</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> key = url;</span><br><span class="line">            <span class="keyword">string</span> realResName = key + <span class="string">'_'</span> + version.ToString();</span><br><span class="line">            DownloadItem target = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (cache.ContainsKey(realResName))</span><br><span class="line">            &#123;</span><br><span class="line">                WeakReference reference = cache[realResName];</span><br><span class="line">                target = reference.Target <span class="keyword">as</span> DownloadItem;</span><br><span class="line">                <span class="keyword">if</span> (target != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((!target.IsDone &amp;&amp; !loading.Contains(target)) &amp;&amp; !waiting.Contains(target))</span><br><span class="line">                    &#123;</span><br><span class="line">                        waiting.Add(target);</span><br><span class="line">                        needSort = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> target;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> tryTimes = !IsImportant(url) ? <span class="number">5</span> : <span class="number">5</span>;</span><br><span class="line">            target = <span class="keyword">new</span> DownloadItem(url, version, size, priority, tryTimes);</span><br><span class="line">            waiting.Insert(<span class="number">0</span>, target);</span><br><span class="line">            needSort = <span class="literal">true</span>;</span><br><span class="line">            cache[realResName] = <span class="keyword">new</span> WeakReference(target);</span><br><span class="line">            <span class="keyword">return</span> target;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这个url是否是重要的</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsImportant</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            url = url.ToLower();</span><br><span class="line">            <span class="keyword">if</span> (url.Contains(<span class="string">"?"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span>[] separator = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'?'</span> &#125;;</span><br><span class="line">                url = url.Split(separator)[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (((url.EndsWith(<span class="string">".scene"</span>) || url.EndsWith(<span class="string">".config"</span>)) || url.EndsWith(<span class="string">".shield"</span>)) || url.EndsWith(<span class="string">".csv.gz"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetIpsFromUrl</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!url.StartsWith(<span class="string">"http://"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">string</span> str = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">string</span> domainFromUrl = GetDomainFromUrl(url);</span><br><span class="line">            <span class="keyword">if</span> (domainFromUrl == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> str;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                IPAddress[] hostAddresses = Dns.GetHostAddresses(domainFromUrl);</span><br><span class="line">                <span class="keyword">if</span> (hostAddresses.Length &lt;= <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> str;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception exception)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> exception.ToString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetLoadErrorDetail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> (!hasError ? <span class="keyword">string</span>.Empty : <span class="keyword">string</span>.Format(<span class="string">"Load Error, url:&#123;0&#125;\nmsg:&#123;1&#125;"</span>, LastErrorUrl, LastErrorMsg));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="keyword">bool</span> bAutoUpdate</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;   </span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">            <span class="keyword">if</span> (bAutoUpdate)</span><br><span class="line">            &#123;</span><br><span class="line">                CoroutineManager.StartCoroutine(Loop());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsAssetBundle</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            url = url.ToLower();</span><br><span class="line">            <span class="keyword">if</span> (url.Contains(<span class="string">"?"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span>[] separator = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'?'</span> &#125;;</span><br><span class="line">                url = url.Split(separator)[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ((((url.EndsWith(<span class="string">".ab"</span>) || url.EndsWith(<span class="string">".asset"</span>)) || (url.EndsWith(<span class="string">".scene"</span>) || url.EndsWith(<span class="string">".lightmap"</span>))) || url.EndsWith(<span class="string">".aio"</span>)) || url.EndsWith(<span class="string">".config"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Resource/XResourceBase.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">resource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.Collections;</span><br><span class="line">    <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">    <span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SingleDependAsset</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span>     AssetID;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span>     Version;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span>     Size;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span>   ResPath;</span><br><span class="line">        <span class="keyword">public</span> DownloadItem DownLoad;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 资源下载完成的通知，只应该有1次，不应该出现多次加载资源的请求。</span></span><br><span class="line">        <span class="comment">// 对于请求一个正在加载的资源，靠外部的Resource类来处理这种问题</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">SDALoadCompletedDelegate</span>(<span class="params">DownloadItem item</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> SDALoadCompletedDelegate LoadCompletedEvent;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对外提供的方法</span></span><br><span class="line">        <span class="comment">// 调用这个函数就是在调用委托</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadCompleted</span>(<span class="params">DownloadItem item</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span>(LoadCompletedEvent != <span class="literal">null</span>)</span><br><span class="line">                LoadCompletedEvent(item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造函数</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SingleDependAsset</span>(<span class="params"><span class="keyword">uint</span> id, <span class="keyword">uint</span> version, <span class="keyword">uint</span> size</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            AssetID = id;</span><br><span class="line">            Version = version;</span><br><span class="line">            Size    = size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsLoadDone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span>(DownLoad == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> DownLoad.IsDone;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Load</span>(<span class="params"><span class="keyword">string</span> path</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            DownLoad = XDownloadManager.GetDownload(path + AssetID.ToString(),(<span class="keyword">int</span>)Version,(<span class="keyword">int</span>)(Size),<span class="number">0</span>);</span><br><span class="line">            DownLoad.LoadCompletedEvent += LoadCompleted;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Resource/XResourceManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="特效"><a href="#特效" class="headerlink" title="特效"></a>特效</h1><blockquote>
<p>FxMaker/NcEffect/NcDestroyEvent.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于捕捉特效的销毁时机</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NcDestroyEvent</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">OnDestroyEvt</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OnDestroyEvt onDestroyEvt = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != onDestroyEvt)</span><br><span class="line">        &#123;</span><br><span class="line">            onDestroyEvt();</span><br><span class="line">            onDestroyEvt = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>System/XUtil.cs 工具类</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">XUtil</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">char</span>[] CONFIG_VECTOR3_SEPARATOR = <span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="string">';'</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">String2Vector3</span>(<span class="params"><span class="keyword">string</span> strPoint</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 pt = <span class="keyword">new</span> Vector3();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(strPoint) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span>[] sepStr = strPoint.Split(CONFIG_VECTOR3_SEPARATOR);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                pt.x = sepStr.Length &gt; <span class="number">0</span> ? <span class="keyword">float</span>.Parse(sepStr[<span class="number">0</span>]) : <span class="number">0f</span>;</span><br><span class="line">                pt.y = sepStr.Length &gt; <span class="number">1</span> ? <span class="keyword">float</span>.Parse(sepStr[<span class="number">1</span>]) : <span class="number">0f</span>;</span><br><span class="line">                pt.z = sepStr.Length &gt; <span class="number">2</span> ? <span class="keyword">float</span>.Parse(sepStr[<span class="number">2</span>]) : <span class="number">0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Log.Write(LogLevel.WARN, <span class="string">"String2Vector3 for &#123;0&#125;: &#123;1&#125;"</span>, strPoint, ex.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">CalcDistanceXZ</span>(<span class="params">Vector3 pos1, Vector3 pos2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Vector3(pos1.x - pos2.x, <span class="number">0</span>, pos1.z - pos2.z).magnitude;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> IsInRange&lt;T&gt;(T <span class="keyword">value</span>, T vBegin, T vEnd) <span class="keyword">where</span> T : IComparable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">value</span>.CompareTo(vBegin) &gt;= <span class="number">0</span> &amp;&amp; <span class="keyword">value</span>.CompareTo(vEnd) &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> NotInRange&lt;T&gt;(T <span class="keyword">value</span>, T vBegin, T vEnd) <span class="keyword">where</span> T : IComparable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> !IsInRange&lt;T&gt;(<span class="keyword">value</span>, vBegin, vEnd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">float</span> DEFAULT_TRIGGER_DISTANCE = <span class="number">3.0f</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsTrigger</span>(<span class="params">Vector3 pos1, Vector3 pos2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> IsTrigger(pos1, pos2, DEFAULT_TRIGGER_DISTANCE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsTrigger</span>(<span class="params">Vector3 posTarget</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> IsTrigger(posTarget, DEFAULT_TRIGGER_DISTANCE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsTrigger</span>(<span class="params">Vector3 posTarget, <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (XLogicWorld.SP.MainPlayer == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> IsTrigger(posTarget, XLogicWorld.SP.MainPlayer.Position, dist);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsTrigger</span>(<span class="params">Vector3 pos1, Vector3 pos2, <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> CalcDistanceXZ(pos1, pos2) &lt;= dist;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T Instantiate&lt;T&gt;(T original) <span class="keyword">where</span> T : MonoBehaviour</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == original) </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        GameObject go = Instantiate(original.gameObject);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == go)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> go.GetComponent&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameObject <span class="title">Instantiate</span>(<span class="params">GameObject original, Transform parent, Vector3 localPosition, Vector3 localRocation</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == original) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        GameObject go = GameObject.Instantiate(original) <span class="keyword">as</span> GameObject;</span><br><span class="line">        go.name = original.name;</span><br><span class="line">        go.transform.parent = parent;</span><br><span class="line">        go.transform.localPosition = localPosition;</span><br><span class="line">        go.transform.localRotation = Quaternion.Euler(localRocation);</span><br><span class="line">        <span class="keyword">return</span> go;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameObject <span class="title">Instantiate</span>(<span class="params">GameObject original, Transform parent</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> Instantiate(original, parent, Vector3.zero, Vector3.zero);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameObject <span class="title">Instantiate</span>(<span class="params">GameObject original</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        GameObject go = Instantiate(original, original.transform.parent, original.transform.localPosition, original.transform.localRotation.eulerAngles);</span><br><span class="line">        go.transform.localScale = original.transform.localScale;</span><br><span class="line">        <span class="keyword">return</span> go;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 给一个对象设置layer</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GetComponentsInChildren包括自身</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="go"&gt;</span>要设置的对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="go"&gt;</span>要设置的层<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetLayer</span>(<span class="params">GameObject go, <span class="keyword">int</span> go</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Transform[] trans = go.GetComponentsInChildren&lt;Transform&gt;(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; trans.Length; i++)</span><br><span class="line">            trans[i].gameObject.layer = layer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 给总秒数, 返回时间描述字符串, n为单位个数(用来忽略尾数)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetTimeStrByInt</span>(<span class="params"><span class="keyword">int</span> val, <span class="keyword">int</span> n</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> s = val % <span class="number">60</span>; val /= <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">int</span> m = val % <span class="number">60</span>; val /= <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">int</span> h = val % <span class="number">24</span>; val /= <span class="number">24</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> tn = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">string</span> str = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">bool</span> bd = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(val &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            str += val + XStringManager.SP.GetString(<span class="number">1003</span>);</span><br><span class="line">            bd = <span class="literal">true</span>; tn++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> &lt; n &amp;&amp; tn &gt;= n) <span class="keyword">return</span> str;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">bool</span> bh = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(bd || h &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            str += h + XStringManager.SP.GetString(<span class="number">1004</span>);</span><br><span class="line">            bh = <span class="literal">true</span>; tn++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> &lt; n &amp;&amp; tn &gt;= n) <span class="keyword">return</span> str;</span><br><span class="line">        <span class="keyword">if</span>(bh || m &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            str += m + XStringManager.SP.GetString(<span class="number">1005</span>);</span><br><span class="line">            tn++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> &lt; n &amp;&amp; tn &gt;= n) <span class="keyword">return</span> str;</span><br><span class="line">        </span><br><span class="line">        str += s + XStringManager.SP.GetString(<span class="number">1006</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给总秒数, 返回时间描述字符串, n为单位个数(用来忽略尾数)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetTimeStrByInt</span>(<span class="params"><span class="keyword">int</span> val, <span class="keyword">int</span> n</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> s = val % <span class="number">60</span>; val /= <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">int</span> m = val % <span class="number">60</span>; val /= <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">int</span> h = val % <span class="number">24</span>; val /= <span class="number">24</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> tn = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">string</span> str = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">bool</span> bd = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(val &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            str += val + XStringManager.SP.GetString(<span class="number">1003</span>);</span><br><span class="line">            bd = <span class="literal">true</span>; tn++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> &lt; n &amp;&amp; tn &gt;= n) <span class="keyword">return</span> str;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">bool</span> bh = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(bd || h &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            str += h + XStringManager.SP.GetString(<span class="number">1004</span>);</span><br><span class="line">            bh = <span class="literal">true</span>; tn++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> &lt; n &amp;&amp; tn &gt;= n) <span class="keyword">return</span> str;</span><br><span class="line">        <span class="keyword">if</span>(bh || m &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            str += m + XStringManager.SP.GetString(<span class="number">1005</span>);</span><br><span class="line">            tn++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> &lt; n &amp;&amp; tn &gt;= n) <span class="keyword">return</span> str;</span><br><span class="line">        </span><br><span class="line">        str += s + XStringManager.SP.GetString(<span class="number">1006</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>XEventDefine.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EEvent</span><br><span class="line">&#123;</span><br><span class="line">    Begin,</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 常用事件</span></span><br><span class="line">    MainPlayer_EnterGame,           <span class="comment">// 主角进入游戏</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> Packet Message</span></span><br><span class="line">    Msg_Server_Return,              <span class="comment">// 服务器返回消息</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    </span><br><span class="line">    End,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Event/XEventManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Base.Pattern;</span><br><span class="line"></span><br><span class="line">public class XEventManager : XSingleton&lt;XEventManager&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">XGlobalEventHandler</span>(<span class="params">EEvent evt, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HashSet&lt;T&gt;中的值不能重复且没有顺序。</span></span><br><span class="line">    <span class="comment">// HashSet&lt;T&gt;的容量会按需自动添加。</span></span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;XGlobalEventHandler&gt;[] m_AllGlobalHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XEventManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AllGlobalHandler = <span class="keyword">new</span> HashSet&lt;XGlobalEventHandler&gt;[(<span class="keyword">int</span>)EEvent.End];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_AllGlobalHandler.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            m_AllGlobalHandler[i] = <span class="keyword">new</span> HashSet&lt;XGlobalEventHandler&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddHandler</span>(<span class="params">XGlobalEventHandler handler, <span class="keyword">params</span> EEvent[] events</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(EEvent e <span class="keyword">in</span> events)</span><br><span class="line">        &#123;</span><br><span class="line">            m_AllGlobalHandler[(<span class="keyword">int</span>)e].Add(handler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DelHandler</span>(<span class="params">EEvent e, XGlobalEventHandler handler</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AllGlobalHandler[(<span class="keyword">int</span>)e].Remove(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearHandler</span>(<span class="params">EEvent e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AllGlobalHandler[(<span class="keyword">int</span>)e].Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearAllHandler</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;m_AllGlobalHandler.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.ClearHandler((EEvent)i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendEvent</span>(<span class="params">EEvent e, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (XGlobalEventHandler handler <span class="keyword">in</span> m_AllGlobalHandler[(<span class="keyword">int</span>)e])</span><br><span class="line">        &#123;</span><br><span class="line">            handler(e, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="技能-lt-span-gt"><a href="#技能-lt-span-gt" class="headerlink" title="技能&lt;/span&gt;"></a><span style="color:#339AFF;"><span id="jump">技能</span>&lt;/span&gt;</span></h1><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a><span style="color:#00ACC1;">配置文件</span></h2><p>配置文件放在Assets/Other/Config/Skill文件夹下，总共有三个配置文件，分别是SkillBase.txt，SkillLevel.txt，SkillOper.txt。都是策划使用Excel配置，然后通过工具转换成txt和生成类。</p>
<blockquote>
<p>SkillBase.txt</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SkillID Name    FuncType    LevelLimit  Class   AttackTarget    UseWay  SkillTime   AttackAnim  AttackAnimSpeed AttackEffectDelay   AttackEffectID  AttackEffectBind    IsFollowBone    AttackEffectNum AttackEffectLife    TranslateDelay  UseObject   BulletID    BulletSrcBind   BulletTgtBind   BulletRate  BulletVelocity  BulletFlyTrack  RegionEffectID  DefeatDelay HitEffectID HitEffectBind   HitEffectNum    AttackShockID   AttackShockDelay    HitShockID  ShowCutSceneAnimation</span><br><span class="line">11001   神力  0   10  1   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0</span><br><span class="line">11002   巧劲  0   10  1   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>SkillLevel.txt</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SkillID SkillEffectType SkillLevel  LearnLevel  Kill    UseRegion   TextLearn   TextEffect  TextUpgrade ReviveRate  SuckBloodRate   SummonID    MoraleValue CRIRate CRIHPRate   AttackCount AttackTime_3_0  AttackEffect_3_0    AttackDamageRate_3_0    AttackEffectBind_3_0    AttackTime_3_1  AttackEffect_3_1    AttackDamageRate_3_1    AttackEffectBind_3_1    AttackTime_3_2  AttackEffect_3_2    AttackDamageRate_3_2    AttackEffectBind_3_2</span><br><span class="line">1   1   1   1   0   0   学习技能1-1 基础攻击力100%效果 基础攻击力100%效果+20点附加伤害 0.3 0.3 990 30  5000    9000    1   0.1 100 3000    0   0.3 200 3000    0   0.3 300 4000    0</span><br><span class="line">1   1   2   1   0   0   学习技能1-1 基础攻击力100%效果+20点附加伤害 基础攻击力100%效果+40点附加伤害 0.3 0.3 990 30  5000    9000    1   0.1 100 3000    0   0.3 200 3000    0   0.3 300 4000    0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>SkillOper.txt</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class   SkillID SkillLevel  PreID   PreLevel    PosX    PosY    ClassLevel  SkillPoint  FieldID StarSprite  NotActiveSprite</span><br><span class="line">1   10001   1   0   0   12.7    86.8    1   1   1   1003.11320004   11100166</span><br><span class="line">1   10001   2   0   0   12.7    86.8    1   2   1   1003.11320004   11100166</span><br></pre></td></tr></table></figure>
<h2 id="读取配置"><a href="#读取配置" class="headerlink" title="读取配置"></a>读取配置</h2><p>txt横排的，读取不容易，肯定需要专门的类。</p>
<blockquote>
<p>\GameConfig\XCfgSkillBase.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//============================================</span></span><br><span class="line"><span class="comment">//--4&gt;:</span></span><br><span class="line"><span class="comment">//    Exported by ExcelConfigExport</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    此代码为工具根据配置自动生成, 建议不要修改</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//============================================</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">partial class XCfgSkillBaseMgr : CCfg1KeyMgrTemplate&lt;XCfgSkillBaseMgr, ushort, XCfgSkillBase&gt; &#123; &#125;;</span><br><span class="line"></span><br><span class="line">partial class XCfgSkillBase : ITabItemWith1Key&lt;ushort&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_SkillID = <span class="string">"SkillID"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_Name = <span class="string">"Name"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_FuncType = <span class="string">"FuncType"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_LevelLimit = <span class="string">"LevelLimit"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_Class = <span class="string">"Class"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackTarget = <span class="string">"AttackTarget"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_UseWay = <span class="string">"UseWay"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_SkillTime = <span class="string">"SkillTime"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackAnim = <span class="string">"AttackAnim"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackAnimSpeed = <span class="string">"AttackAnimSpeed"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackEffectDelay = <span class="string">"AttackEffectDelay"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackEffectID = <span class="string">"AttackEffectID"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackEffectBind = <span class="string">"AttackEffectBind"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_IsFollowBone = <span class="string">"IsFollowBone"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackEffectNum = <span class="string">"AttackEffectNum"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackEffectLife = <span class="string">"AttackEffectLife"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_TranslateDelay = <span class="string">"TranslateDelay"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_UseObject = <span class="string">"UseObject"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_BulletID = <span class="string">"BulletID"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_BulletSrcBind = <span class="string">"BulletSrcBind"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_BulletTgtBind = <span class="string">"BulletTgtBind"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_BulletRate = <span class="string">"BulletRate"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_BulletVelocity = <span class="string">"BulletVelocity"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_BulletFlyTrack = <span class="string">"BulletFlyTrack"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_RegionEffectID = <span class="string">"RegionEffectID"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_DefeatDelay = <span class="string">"DefeatDelay"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_HitEffectID = <span class="string">"HitEffectID"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_HitEffectBind = <span class="string">"HitEffectBind"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_HitEffectNum = <span class="string">"HitEffectNum"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackShockID = <span class="string">"AttackShockID"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_AttackShockDelay = <span class="string">"AttackShockDelay"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_HitShockID = <span class="string">"HitShockID"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _KEY_ShowCutSceneAnimation = <span class="string">"ShowCutSceneAnimation"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">ushort</span> SkillID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 技能ID</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 技能名称</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> FuncType &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 技能功能类型</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> LevelLimit &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 等级上限</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">byte</span> Class &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 职业许可</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> AttackTarget &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击目标</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> UseWay &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 作用方式</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> SkillTime &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 技能时间</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> AttackAnim &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 施展动画</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> AttackAnimSpeed &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 施展动画速率</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> AttackEffectDelay &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击特效延时(1.0s)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> AttackEffectID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击特效ID</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> AttackEffectBind &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击特效绑点</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> IsFollowBone &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 特效是否跟随骨骼运动</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> AttackEffectNum &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击特效数量</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> AttackEffectLife &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击特效生存时长</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> TranslateDelay &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 技能传递延时(s)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> UseObject &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 作用对象</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> BulletID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 子弹ID</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> BulletSrcBind &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 子弹发射源绑定点</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> BulletTgtBind &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 子弹发射目标绑定点</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> BulletRate &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 子弹缩放比率</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> BulletVelocity &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 子弹飞行速度</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> BulletFlyTrack &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 子弹的飞行轨迹(H/W)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> RegionEffectID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 区域特效ID</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> DefeatDelay &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 生效延时(1.0s)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> HitEffectID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 命中特效ID</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> HitEffectBind &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 命中特效绑点</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> HitEffectNum &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 命中特效数量</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> AttackShockID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击时震屏特效索引</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> AttackShockDelay &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 攻击震屏特效延时</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> HitShockID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 被击时震屏特效索引</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> ShowCutSceneAnimation &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;				<span class="comment">// 播放特殊场景动画</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">XCfgSkillBase</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">ushort</span> <span class="title">GetKey1</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> SkillID; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">ReadItem</span>(<span class="params">TabFile tf</span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		SkillID = tf.Get&lt;<span class="keyword">ushort</span>&gt;(_KEY_SkillID);</span><br><span class="line">		Name = tf.Get&lt;<span class="keyword">string</span>&gt;(_KEY_Name);</span><br><span class="line">		FuncType = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_FuncType);</span><br><span class="line">		LevelLimit = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_LevelLimit);</span><br><span class="line">		Class = tf.Get&lt;<span class="keyword">byte</span>&gt;(_KEY_Class);</span><br><span class="line">		AttackTarget = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_AttackTarget);</span><br><span class="line">		UseWay = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_UseWay);</span><br><span class="line">		SkillTime = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_SkillTime);</span><br><span class="line">		AttackAnim = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_AttackAnim);</span><br><span class="line">		AttackAnimSpeed = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_AttackAnimSpeed);</span><br><span class="line">		AttackEffectDelay = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_AttackEffectDelay);</span><br><span class="line">		AttackEffectID = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_AttackEffectID);</span><br><span class="line">		AttackEffectBind = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_AttackEffectBind);</span><br><span class="line">		IsFollowBone = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_IsFollowBone);</span><br><span class="line">		AttackEffectNum = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_AttackEffectNum);</span><br><span class="line">		AttackEffectLife = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_AttackEffectLife);</span><br><span class="line">		TranslateDelay = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_TranslateDelay);</span><br><span class="line">		UseObject = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_UseObject);</span><br><span class="line">		BulletID = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_BulletID);</span><br><span class="line">		BulletSrcBind = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_BulletSrcBind);</span><br><span class="line">		BulletTgtBind = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_BulletTgtBind);</span><br><span class="line">		BulletRate = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_BulletRate);</span><br><span class="line">		BulletVelocity = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_BulletVelocity);</span><br><span class="line">		BulletFlyTrack = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_BulletFlyTrack);</span><br><span class="line">		RegionEffectID = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_RegionEffectID);</span><br><span class="line">		DefeatDelay = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_DefeatDelay);</span><br><span class="line">		HitEffectID = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_HitEffectID);</span><br><span class="line">		HitEffectBind = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_HitEffectBind);</span><br><span class="line">		HitEffectNum = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_HitEffectNum);</span><br><span class="line">		AttackShockID = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_AttackShockID);</span><br><span class="line">		AttackShockDelay = tf.Get&lt;<span class="keyword">float</span>&gt;(_KEY_AttackShockDelay);</span><br><span class="line">		HitShockID = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_HitShockID);</span><br><span class="line">		ShowCutSceneAnimation = tf.Get&lt;<span class="keyword">int</span>&gt;(_KEY_ShowCutSceneAnimation);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="数据实体"><a href="#数据实体" class="headerlink" title="数据实体"></a>数据实体</h2><p>Skill文件夹下有SkillManager、XSkill、XSkillDefine三个脚本文件。</p>
<blockquote>
<p>XSkillDefine.cs 技能，技能等级，技能操作数据实体文件，定义了三个类，定义对应的字段存储从txt读取出来的数据。</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ESkillUseObject <span class="comment">// 技能作用对象</span></span><br><span class="line">&#123;</span><br><span class="line">    eSuseObject_Single = <span class="number">0</span>; <span class="comment">// 单体</span></span><br><span class="line">    eSuseObject_Region,     <span class="comment">// 区域</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EBattleSkillType</span><br><span class="line">&#123;</span><br><span class="line">    Battle_Skill_Normal,  <span class="comment">// 普攻</span></span><br><span class="line">    Battle_Skill_Treat,   <span class="comment">// 治疗</span></span><br><span class="line">    Battle_Skill_Special, <span class="comment">// 绝招</span></span><br><span class="line">    Battle_Skill_Num <span class="comment">// Battle_Skill_Num用于计数，最后一个肯定是前面的总和</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSkillLevelDefine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 文本</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> TextLearn;        <span class="comment">// 学习文本</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> TextEffect;       <span class="comment">// 效果文本</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> TextUpgrade;      <span class="comment">// 升级文本</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span> Level;                  <span class="comment">// 技能等级</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> LearnLevel;             <span class="comment">// 技能学习等级</span></span><br><span class="line">    <span class="keyword">public</span> ESkillUseRegion useRegion;   <span class="comment">// 作用区域</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> AnglerValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> AttackCount;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span>[] AttackTime = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">public</span> ESkeleton[] HitEffectBind = <span class="keyword">new</span> ESkeleton[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] HitEffectID = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSkillDefine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name;                         <span class="comment">// 技能名称</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">ushort</span> ID;                           <span class="comment">// 技能ID </span></span><br><span class="line">    <span class="keyword">public</span> ESkillFuncType FuncType;             <span class="comment">// 技能功能类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> LevelLimit;                      <span class="comment">// 技能等级上限</span></span><br><span class="line">    <span class="keyword">public</span> ESkillAttackTarget AttackTargetType; <span class="comment">//攻击目标类型（1前排2后排3自身）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 条件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span> Class; <span class="comment">// 学习职业</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 攻击</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> SkillTime;             <span class="comment">// 技能时间</span></span><br><span class="line">    <span class="keyword">public</span> ESkillUseWay UseWay;         <span class="comment">// 技能作用方式</span></span><br><span class="line">    <span class="keyword">public</span> EAnimName AttackAnim;        <span class="comment">// 施展动画</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> AttackAnimSpeed;       <span class="comment">// 施展动画速率</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> AttackEffectDelay;     <span class="comment">// 起手特效释放时间点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> AttackEffectID;          <span class="comment">// 起手特效ID</span></span><br><span class="line">    <span class="keyword">public</span> ESkeleton AttackEffectBind;  <span class="comment">// 起手特效绑定点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> IsFollowBone;           <span class="comment">// 是否跟随骨骼运动</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> AttackEffectNum;         <span class="comment">// 起手特效数量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> AttackEffectLife;      <span class="comment">// 起手特效生存周期</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> TranslateDelay;        <span class="comment">// 技能效果开始传递延时</span></span><br><span class="line">    <span class="keyword">public</span> ESkillUseObject UseObject;   <span class="comment">// 技能作用对象</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> BulletID;                <span class="comment">// 子弹ID</span></span><br><span class="line">    <span class="keyword">public</span> ESkeleton BulletSrcBind;     <span class="comment">// 子弹发射源绑定点</span></span><br><span class="line">    <span class="keyword">public</span> ESkeleton BulletTgtBind;     <span class="comment">// 子弹发射目标绑定点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> BulletRate;            <span class="comment">// 子弹缩放比例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> BulletVelocity;        <span class="comment">// 子弹飞行速率</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> BulletFlyTrack;        <span class="comment">// 子弹飞行轨迹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> RegionEffectID;          <span class="comment">// 区域特效ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> DefeatDelay;           <span class="comment">// 生效延时</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> HitEffectID;             <span class="comment">// 被击特效ID</span></span><br><span class="line">    <span class="keyword">public</span> ESkeleton HitEffectBind;     <span class="comment">// 被击特效绑定点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> HitEffectNum;            <span class="comment">// 被击特效数量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> AttackShockID;           <span class="comment">// 攻击时震屏特效索引</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> AttackShockDelay;      <span class="comment">// 攻击震屏特效延时</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> HitShockID;              <span class="comment">// 被击时震屏特效索引</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// SortedList 类代表了一系列按照键来排序的键/值对</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    SortedList sList = new SortedList();</span></span><br><span class="line"><span class="comment">    sList.Add(1,"d");</span></span><br><span class="line"><span class="comment">    sList.Add(2,"c");</span></span><br><span class="line"><span class="comment">    sList.Add(3,"b");</span></span><br><span class="line"><span class="comment">    sList.Add(4,"a");</span></span><br><span class="line"><span class="comment">    //结果为d c b a,所以可知是按键排序，而非值排序</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// 给SkillManager调用，填充</span></span><br><span class="line">    <span class="comment">// 等级对应一个等级类</span></span><br><span class="line">    <span class="keyword">public</span> SortedList&lt;<span class="keyword">byte</span>, XSkillLevelDefine&gt; Levels = <span class="keyword">new</span> SortedList&lt;<span class="keyword">byte</span>, XSkillLevelDefine&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此技能可不可以学取决于角色等级</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">CanLearn</span>(<span class="params"><span class="keyword">byte</span> byteLevel</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == XLogicWorld.SP.MainPlayer)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Levels.ContainsKey(byteLevel))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 职业不对不能学</span></span><br><span class="line">        <span class="comment">// if (Class &gt; 0 &amp;&amp; XLogicWorld.SP.MainPlayer.DynGet(EShareAttr.esa_Class) != Class)</span></span><br><span class="line">            <span class="comment">// return -1;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据等级得到等级类</span></span><br><span class="line">        XSkillLevelDefine level = Levels[byteLevel];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == level)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (level.LearnLevel &gt; XLogicWorld.SP.MainPlayer.Levels)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">uint</span> <span class="title">GetAnger</span>(<span class="params"><span class="keyword">byte</span> level</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == XLogicWorld.SP.MainPlayer) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!Levels.ContainsKey(level)) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        XSkillLevelDefine levelDefine = Levels[level];</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == levelDefine)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> levelDefine.AnglerValue;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">uint</span> <span class="title">GetLearnLevel</span>(<span class="params"><span class="keyword">byte</span> level</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == XLogicWorld.SP.MainPlayer) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!Levels.ContainsKey(level)) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        XSkillLevelDefine levelDefine = Levels[level];</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == levelDefine)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> levelDefine.LearnLevel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSkillOper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">ushort</span> ID;           <span class="comment">// 技能ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span> Level;          <span class="comment">// 技能等级</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span> Class;          <span class="comment">// 职业</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">ushort</span> PreID;        <span class="comment">// 前置技能ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span> PreLevel;       <span class="comment">// 前置技能等级</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> PosX;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> PosY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> ClassLevel;     <span class="comment">// 学习阶段</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> SkillPoint;     <span class="comment">// 技能点消耗</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span> FieldID;        <span class="comment">// 技能栏ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> AtlasID;        <span class="comment">// 图集ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SpriteName;   <span class="comment">// 精灵名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> NotLearnSpriteName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">CanLearn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == XLogicWorld.SP.MainPlayer) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(SkillManager.SP.m_uSkillPoint &lt; SkillPoint)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(SkillManager.SP.GetActiveSkill(PreID) &lt; PreLevel)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(XLogicWorld.SP.MainPlayer.DynGet(EShareAttr.esa_Class) != Class)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">        XSkillDefine SkillDef  = SkillManager.SP.GetSkillDefine((<span class="keyword">ushort</span>)ID);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == SkillDef)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        XSkillLevelDefine SkillLevel = SkillDef.Levels[Level];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == SkillLevel)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(SkillLevel.LearnLevel &gt; XLogicWorld.SP.MainPlayer.Level)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h2><p>读取配置然后给实体类赋值。</p>
<blockquote>
<p>SkillManager.cs </p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>\Skill\XSkill.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 运行中技能, 只用于技能表现，修改的时候，要保证能不依赖其他，能单独使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSkill</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">bool</span> isLucky &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">bool</span> IsMultiAttack = <span class="literal">false</span>; </span><br><span class="line">	<span class="keyword">private</span> XSkillDefine m_SkillDef = <span class="literal">null</span>; <span class="comment">// 技能数据实体类</span></span><br><span class="line">	<span class="keyword">private</span> XSkillLevelDefine m_SkillLevel = <span class="literal">null</span>; <span class="comment">// 技能等级数据实体类</span></span><br><span class="line">	<span class="keyword">private</span> XCharacter Attacker &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125; <span class="comment">// 攻击者</span></span><br><span class="line">	<span class="keyword">private</span> XCharacter MainTarget &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125; <span class="comment">// 主要目标</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;XCharacter&gt; mTargetList = <span class="keyword">new</span> List&lt;XCharacter&gt;(); <span class="comment">// 攻击列表</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> mCurRunTime; <span class="comment">// 目前运行时间</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">uint</span> mSKillID; <span class="comment">// 技能ID</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">uint</span> mSkillLevel; <span class="comment">// 技能等级</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">bool</span> mIsActive; <span class="comment">// 是否激活</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> SkillTotalTime &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125; <span class="comment">// 技能总时间</span></span><br><span class="line">	<span class="keyword">public</span> XBattlePosition TargetBattlePos	&#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125; <span class="comment">// 目标战斗位置</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 表现列表</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;SkillDisplay_Base&gt; mDisplayList = <span class="keyword">new</span> List&lt;SkillDisplay_Base&gt;();</span><br><span class="line">	<span class="comment">// 伤害列表</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;SkillDisplay_Base&gt;	mDamageList = <span class="keyword">new</span> List&lt;SkillDisplay_Base&gt;();</span><br><span class="line">	<span class="comment">// buff效果综合</span></span><br><span class="line">	<span class="keyword">public</span> XBuffDisplayMulti m_BuffDisplayMulti = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">XSkill</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		Attacker = <span class="literal">null</span>;</span><br><span class="line">		mCurRunTime = <span class="number">0</span>;</span><br><span class="line">		mSKillID = <span class="number">0</span>;</span><br><span class="line">		mSkillLevel = <span class="number">0</span>;</span><br><span class="line">		mIsActive = <span class="literal">false</span>;</span><br><span class="line">		SkillTotalTime = <span class="number">0.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	LParam 的低十六位是鼠标的x坐标，高十六位是y坐标</span></span><br><span class="line"><span class="comment">	(int)m.LParam &amp; 0xFFFF 意思是取得LParam的低十六位</span></span><br><span class="line"><span class="comment">	(int)m.LParam &gt;&gt; 16 &amp; 0xFFFF 意思是将LParam右移十六位，再取得低十六位，即取了原来LParam的高十六位</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="comment">// 高16位为技能ID, 低16位是技能等级</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">uint</span> SkillID</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mSKillID;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">value</span> &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				mSKillID = <span class="keyword">value</span> &gt;&gt;<span class="number">16</span>;</span><br><span class="line">				mSkillLevel = <span class="keyword">value</span> &amp; <span class="number">0xffff</span>;</span><br><span class="line">				m_SkillDef = SkillManager.SP.GetSkillDefine((<span class="keyword">ushort</span>)mSKillID);</span><br><span class="line">				m_SkillLevel = m_SkillDef.Levels[(<span class="keyword">byte</span>)mSkillLevel];</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (m_SkillLevel == <span class="literal">null</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					Log.Write(LogLevel.ERROR, <span class="string">"skill Level = null"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 得到技能ID</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">uint</span> SkillLevelID</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mSkillLevel;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> 得到特效位置</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> 给XU3dEffect的对象属性赋值</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="effect"&gt;</span>特效<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="rot"&gt;</span>向量<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetEffectPos</span>(<span class="params">XU3dEffect effect, Vector3 rot</span>)</span></span><br><span class="line"><span class="function"></span>	&#123;	</span><br><span class="line">		<span class="keyword">if</span> (m_SkillLevel.useRegion == ESkillUseRegion.eSUseRegion_Total)</span><br><span class="line">		&#123;</span><br><span class="line">			Vector3 pos = BattleDisplayMgr.GetFighterPos(TargetBattlePos.Group, <span class="number">5</span>);</span><br><span class="line">			effect.Position = pos;</span><br><span class="line">			effect.Direction = Quaternion.Euler(rot).eulerAngles;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化技能表现</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InitSkillDisplay</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_SkillDef == <span class="literal">null</span>)</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		SkillTotalTime = m_SkillDef.SkillTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Battle/SkillDisplay.cs 技能表现</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 技能表现事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SkillDisplay_Event</span><br><span class="line">&#123;</span><br><span class="line">    SkillDisplay_Event_None,  </span><br><span class="line">    SkillDisplay_Event_Effect,</span><br><span class="line">    SkillDisplay_Event_Bullet,</span><br><span class="line">    SkillDisplay_Event_Sound,</span><br><span class="line">    SkillDisplay_Event_ID,</span><br><span class="line">    SkillDisplay_Event_Shake,</span><br><span class="line">    SkillDisplay_Event_Num,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 技能表现基类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SkillDisplay_Base</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> SkillDisplay_Event SelfType &#123;<span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> DoTime&#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XSkill CurSkill &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">bool</span> IsPlayed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SkillDisplay_Base</span>(<span class="params">XSkill skill</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        CurSkill = skill;</span><br><span class="line">        SelfType = SkillDisplay_Event.SkillDisplay_Event_None;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CreateSkillDisplay</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DestroySkillDisplay</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateSkillDisplay</span>(<span class="params"><span class="keyword">float</span> runTime, <span class="keyword">float</span> deltaTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsPlayed)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> nowTime = runTime + deltaTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runTime &lt;= DoTime &amp;&amp; nowTime &gt; DoTime)</span><br><span class="line">            CreateSkillDisplay();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="外观模式"><a href="#外观模式" class="headerlink" title="外观模式"></a>外观模式</h1><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"><span class="keyword">using</span> Google.ProtocolBuffers;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">XLogicWorld</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> XLogicWorld m_this = <span class="keyword">new</span> XLogicWorld();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> XLogicWorld SP &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_this; &#125; &#125; </span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> Propertys</span></span><br><span class="line">    <span class="keyword">public</span> Login LoginProc &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XNetworkManager NetManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XObjectManager ObjectManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XSceneManager SceneManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XSubSceneManager SubSceneManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> SkillManager SkillManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XQuestManager QuestManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XPetManager PetManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XAuctionManager AuctionManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XMainPlayer MainPlayer &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XMailManager MailManager &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> XShanHTManager ShanHT &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">XLogicWorld</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_this = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        LoginProc           = <span class="keyword">new</span> Login();</span><br><span class="line">        NetManager          = <span class="keyword">new</span> XNetworkManager();</span><br><span class="line">        ObjectManager       = <span class="keyword">new</span> XObjectManager();</span><br><span class="line">        SceneManager        = <span class="keyword">new</span> XSceneManager();</span><br><span class="line">        SubSceneManager     = <span class="keyword">new</span> XSubSceneManager();</span><br><span class="line">        SkillManager        = <span class="keyword">new</span> SkillManager();</span><br><span class="line">        QuestManager        = <span class="keyword">new</span> XQuestManager();</span><br><span class="line">        PetManager          = <span class="keyword">new</span> XPetManager();</span><br><span class="line">        AuctionManager      = <span class="keyword">new</span> XAuctionManager();</span><br><span class="line">        MainPlayer          = <span class="keyword">new</span> XMainPlayer(<span class="number">0</span>);</span><br><span class="line">        MailManager         = <span class="keyword">new</span> XMailManager();</span><br><span class="line">        </span><br><span class="line">        ShanHT = <span class="keyword">new</span> XShanHTManager();</span><br><span class="line">        </span><br><span class="line">        SceneManager.Init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~XLogicWorld()</span><br><span class="line">    &#123;</span><br><span class="line">        OnDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Battle"><a href="#Battle" class="headerlink" title="Battle"></a><span id="Battle">Battle</span></h1><blockquote>
<p>Battle/XBattleDefine.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> EBattleObjecType</span><br><span class="line">&#123;</span><br><span class="line">    ebot_Begin = <span class="number">0</span>,</span><br><span class="line">    ebot_Player = ebot_Begin,   <span class="comment">// 玩家</span></span><br><span class="line">    ebot_Monster,               <span class="comment">// 怪物</span></span><br><span class="line">    ebot_Magic,                 <span class="comment">// 法宝</span></span><br><span class="line">    ebot_Pet,                   <span class="comment">// 宠物</span></span><br><span class="line">    ebot_End,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XBattleDefine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> BATTLE_MAGIC_POS = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> BATTLE_POS_COUNT = (<span class="number">9</span>+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XBattlePosition</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> EBattleGroupType Group &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> Position &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">uint</span> <span class="title">ToUInt</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> (((<span class="keyword">uint</span>)Group) &lt;&lt; <span class="number">5</span>) | Position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsValid</span>(<span class="params">EBattleGroupType e, <span class="keyword">uint</span> pos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (e &lt; EBattleGroupType.eBattleGroup_Begin || e &gt;= EBattleGroupType.eBattleGroup_End)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= XBattleDefine.BATTLE_POS_COUNT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">ToString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">string</span>.Format(<span class="string">"BattlePosition &#123;0&#125;-&#123;1&#125;"</span>, Group, Position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">XBattlePosition</span>(<span class="params">EBattleGroupType e, <span class="keyword">uint</span> pos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Group = e;</span><br><span class="line">        Position = pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> XBattlePosition <span class="title">Create</span>(<span class="params">EBattleGroupType e, <span class="keyword">uint</span> pos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (XBattlePosition.IsValid(e, pos))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> XBattlePosition(e, pos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> XBattlePosition <span class="title">Create</span>(<span class="params"><span class="keyword">uint</span> netPos</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">uint</span> nGroup = netPos &gt;&gt; <span class="number">5</span>;</span><br><span class="line">        <span class="comment">// 网络包位置信息保存8位, 1-5 保存位置信息, 6-8 保存分组信息</span></span><br><span class="line">        <span class="keyword">uint</span> pos = netPos &amp; <span class="number">0x1F</span>;</span><br><span class="line">        <span class="keyword">return</span> Create((EBattleGroupType)nGroup, pos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Battle/XBattleObject.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 战斗场景中的一个对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XBattleObject</span> : <span class="title">XPlayer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> XBattlePosition m_curBattlePos = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> m_bIsSummon = <span class="literal">false</span>; <span class="comment">// summon 召唤</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> XBattlePosition curBattlePos</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>&#123; <span class="keyword">return</span> m_curBattlePos; &#125;</span><br><span class="line">        <span class="keyword">set</span>&#123; m_curBattlePos = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XBattleObject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params"><span class="number">0</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDead</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span> == m_bIsSummon)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        BattleDisplayerMgr.SP.DeadSoul( <span class="keyword">this</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Morale 士气</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsFullMorale &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XBattlePlayer</span> : <span class="title">XBattleObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">uint</span> m_uiSoulValue = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span> SoulValue</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_uiSoulValue; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_uiSoulValue = <span class="keyword">value</span>;</span><br><span class="line">            m_uiSoulValue = Math.Min(m_uiSoulValue,<span class="number">12</span> );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XBattlePlayer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ObjectType = EObjectType.OtherPlayer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XBattleMonster</span> : <span class="title">XBattleObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XBattleMonster</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ObjectType = EObjectType.Monster;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XBattlePet</span> : <span class="title">XBattleObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XBattlePet</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ObjectType = EObjectType.Pet;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Battle/BattleDisplayerMgr.cs 代表一场战斗的表现</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Base.Pattern;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">public class BattleDisplayerMgr : XSingleton&lt;BattleDisplayerMgr&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">float</span> BATTLE_UNIT_SIZE = <span class="number">3.5f</span>;      <span class="comment">// 战斗单位间距</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">float</span> BATTLE_ROUND_INTERVAL = <span class="number">1.0f</span>;  <span class="comment">// 回合之间相距2s</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">float</span> BATTLE_GROUP_OFFSET = <span class="number">4.0f</span>;   <span class="comment">// 左右战斗群体距离中心点的距离</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">uint</span> GRID_EFFECT_ID = <span class="number">900026</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 战斗摄像机相对于中心点的偏移</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector3 BATTLE_CAMERA_OFFSET = <span class="keyword">new</span> Vector3(<span class="number">26.06129f</span>, <span class="number">24.24784f</span>, <span class="number">-30.4854f</span>);</span><br><span class="line">    <span class="comment">// 视角FOV是指镜头所能覆盖的范围，物体超过这个角就不会被收在镜头里，一个摄像机镜头能涵盖多大范围的景物，通常以角度来表示，这个角度就叫镜头的视角FOV。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">float</span> BATTLE_CAMERA_FOV = <span class="number">20.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> PlaySpeed &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsDirectOver = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> XBattlePosition m_MainPlayerPos = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> XBattlePosition MainPlayerPos</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>&#123; <span class="keyword">return</span> m_MainPlayerPos; &#125;</span><br><span class="line">        <span class="keyword">set</span>&#123; m_MainPlayerPos = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BattleDisplayerMgr</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        XEventManager.SP.AddHandler(FightSubBlood, EEvent.FightHead_Show_Sub_Blood);</span><br><span class="line">        XEventManager.SP.AddHandler(ResetMaxFightBlood, EEvent.FightHead_Show_ReSet_Max_Blood);</span><br><span class="line">        </span><br><span class="line">        XEventManager.SP.AddHandler(FightAnimStart, EEvent.Fight_Anim_Start );</span><br><span class="line">        XEventManager.SP.AddHandler(FightAnimEnd, EEvent.Fight_Anim_End );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> LeftBloodValue &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> RightBloodValue &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> LeftBattleValue &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> RightBattleValue &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CurLeftBloodValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CurRightBloodValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> XU3dEffect[] mEffectList = <span class="keyword">new</span> XU3dEffect[XBattleDefine.BATTLE_POS_COUNT * (<span class="keyword">int</span>)EBattleGroupType.eBattleGroup_End];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetBloodValue</span>(<span class="params"><span class="keyword">uint</span> left, <span class="keyword">uint</span> right</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        LeftBloodValue  = (<span class="keyword">int</span>)left;</span><br><span class="line">        RightBloodValue = (<span class="keyword">int</span>)right;</span><br><span class="line">        </span><br><span class="line">        CurLeftBloodValue   = LeftBloodValue;</span><br><span class="line">        CurRightBloodValue  = RightBloodValue;      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>\Client\Assets\Scripts\Battle\XBattleManager.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Packets;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Base.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EBattleState</span><br><span class="line">&#123;</span><br><span class="line">    Invalid,    <span class="comment">// 无效</span></span><br><span class="line">    Loading,    <span class="comment">// 加载中</span></span><br><span class="line">    Fighting,   <span class="comment">// 战斗中</span></span><br><span class="line">    Leaving,    <span class="comment">// 离开</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//该对象本身，只做接收消息，设置数据，具体表现都交由BattleDisplayerMgr来处理</span></span><br><span class="line"><span class="comment">//将一场战斗的表现完全与逻辑独立开来，方便录像，以及引擎调用</span></span><br></pre></td></tr></table></figure>
<h1 id="Camera"><a href="#Camera" class="headerlink" title="Camera"></a>Camera</h1><blockquote>
<p>GameLogic/XCameraLogic.cs</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> XGame.Client.Base.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主摄像机逻辑</span></span><br><span class="line">public class XCameraLogic : XSingleton&lt;XCameraLogic&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Camera mainCamera &#123; <span class="keyword">get</span>;<span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">private</span> Transform m_MotherTransform = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Vector3 m_MotherPos = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主摄像机在一个矩形平面内运动，以下保存着摄像机相对矩形信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_LocalY = <span class="number">0f</span>; <span class="comment">// Attach的时候的Y轴相对坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_LocalDis = <span class="number">0f</span>; <span class="comment">// Attach的时候的X，Z平面相对距离</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 m_relaPosition = Vector3.zero;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_fWheelDelta = <span class="number">0f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_fWaitWD = <span class="number">0f</span>;</span><br><span class="line">    <span class="keyword">private</span> GameObject m_CamDemo = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 m_v3CamPosTarget = Vector3.zero;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsEnableCameraCollide = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XCameraLogic</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        mainCamera = Camera.main;</span><br><span class="line">        m_CamDemo = <span class="keyword">new</span> GameObject(<span class="string">"camera temp"</span>);</span><br><span class="line">        m_CamDemo.transform.parent = mainCamera.transform.parent;</span><br><span class="line">        m_CamDemo.transform.position = mainCamera.transform.position;</span><br><span class="line">        m_CamDemo.transform.rotation = mainCamera.transform.rotation;</span><br><span class="line">        </span><br><span class="line">        Object.DontDestroyOnLoad(mainCamera);</span><br><span class="line">        Object.DontDestroyOnLoad(m_CamDemo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 relaPosition</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span>&#123; m_relaPosition = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> WheelDelta</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>&#123; <span class="keyword">return</span> m_fWheelDelta; &#125;</span><br><span class="line">        <span class="keyword">set</span>&#123; m_fWheelDelta = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Breathe</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0f</span> != m_fWaitWD)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> w = m_fWaitWD &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">float</span> fd = Time.deltaTime * LogicApp.SP.UserDefine.mainCameraCurveSpeed;</span><br><span class="line">            <span class="keyword">if</span> (!w) fd *= <span class="number">-1</span>;</span><br><span class="line">            m_fWaitWD -= fd;</span><br><span class="line">            <span class="keyword">if</span> (w != (m_fWaitWD &gt; <span class="number">0</span>) || !scroll(fd))</span><br><span class="line">                m_fWaitWD = <span class="number">0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="CoroutineManager"><a href="#CoroutineManager" class="headerlink" title="CoroutineManager"></a>CoroutineManager</h1><blockquote>
<p>CoroutineManager/CoroutineManager.cs 协程管理器</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineBehaviour</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">CoroutineManager</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title">CoroutineInfo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> desc;</span><br><span class="line">        <span class="keyword">public</span> WeakReference obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MonoBehaviour mMain;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CoroutineBehaviour   mPrivate;   </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;CoroutineInfo&gt;  routines = <span class="keyword">new</span> List&lt;CoroutineInfo&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 函数以Debug开头表示调试用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">DebugGetCoroutineCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> routines.Count;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">DumpCoroutines</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        builder.AppendFormat(<span class="string">"DumpCoroutines\n"</span>, <span class="keyword">new</span> <span class="keyword">object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (CoroutineInfo info <span class="keyword">in</span> routines)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (info.obj.IsAlive)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">object</span> target = info.obj.Target;</span><br><span class="line">                num++;</span><br><span class="line">                builder.AppendFormat(<span class="string">" &#123;0&#125;: &#123;1&#125;\n"</span>, target, info.desc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        builder.AppendFormat(<span class="string">"  count: &#123;0&#125;\n"</span>, num);</span><br><span class="line">        <span class="keyword">return</span> builder.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">MonoBehaviour main</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        mMain = main;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果定义了编译符号，那么编译器会包含所有调用这个方法的代码，这和普通方法没有什么区别</span></span><br><span class="line">    <span class="comment">// 如果没有定义编译符号，那么编译器会忽略代码中这个方法的所有调用</span></span><br><span class="line">    [<span class="meta">Conditional(<span class="meta-string">"ENABLE_TRACE"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MiniszieRoutineList</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (num &lt; routines.Count)</span><br><span class="line">        &#123;</span><br><span class="line">            CoroutineInfo item = routines[num];</span><br><span class="line">            <span class="keyword">if</span> (!item.obj.IsAlive)</span><br><span class="line">            &#123;</span><br><span class="line">                routines.Remove(item);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                num++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Coroutine <span class="title">StartCoroutine</span>(<span class="params">IEnumerator routine</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> StartCoroutine(routine, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Coroutine <span class="title">StartCoroutine</span>(<span class="params">IEnumerator routine, <span class="keyword">bool</span> bDestroyWhenLoadLevel</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!bDestroyWhenLoadLevel)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mMain.StartCoroutine(routine);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mPrivate == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mPrivate = <span class="keyword">new</span> GameObject(<span class="string">"CoroutineManager"</span>).AddComponent&lt;CoroutineBehaviour&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mPrivate.StartCoroutine(routine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/商业源码/" rel="tag"># 商业源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/04/UI模块封装/" rel="next" title="UI模块封装">
                <i class="fa fa-chevron-left"></i> UI模块封装
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/03/俄罗斯方块/" rel="prev" title="俄罗斯方块">
                俄罗斯方块 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Chebin">
            
              <p class="site-author-name" itemprop="name">Chebin</p>
              <div class="site-description motion-element" itemprop="description">记录自己的学习过程</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">398</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">64</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2020/04/12/Laravel-Macroable/" title="Laravel-Macroable" target="_blank">Laravel-Macroable</a>
                  </li>
                
                  <li>
                    <a href="/2020/04/12/Laravel-Cache/" title="Laravel-Cache" target="_blank">Laravel-Cache</a>
                  </li>
                
                  <li>
                    <a href="/2020/04/12/Laravel-Collection/" title="Laravel-Collection" target="_blank">Laravel-Collection</a>
                  </li>
                
                  <li>
                    <a href="/2020/04/10/Laravel-tap/" title="Laravel-tap" target="_blank">Laravel-tap</a>
                  </li>
                
                  <li>
                    <a href="/2020/04/10/Laravel-Funnel/" title="Laravel-Funnel" target="_blank">Laravel-Funnel</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#快速跳转"><span class="nav-number">1.</span> <span class="nav-text">快速跳转</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开发规范"><span class="nav-number">2.</span> <span class="nav-text">开发规范</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LogicApp"><span class="nav-number">3.</span> <span class="nav-text">LogicApp</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#日志"><span class="nav-number">4.</span> <span class="nav-text">日志</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#对象管理"><span class="nav-number">5.</span> <span class="nav-text">对象管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#角色管理"><span class="nav-number">6.</span> <span class="nav-text">角色管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Audio"><span class="nav-number">7.</span> <span class="nav-text">Audio</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#资源加载"><span class="nav-number">8.</span> <span class="nav-text">资源加载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#特效"><span class="nav-number">9.</span> <span class="nav-text">特效</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#技能-lt-span-gt"><span class="nav-number">10.</span> <span class="nav-text">技能&lt;/span&gt;</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件"><span class="nav-number">10.1.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#读取配置"><span class="nav-number">10.2.</span> <span class="nav-text">读取配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据实体"><span class="nav-number">10.3.</span> <span class="nav-text">数据实体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理"><span class="nav-number">10.4.</span> <span class="nav-text">管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#外观模式"><span class="nav-number">11.</span> <span class="nav-text">外观模式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Battle"><span class="nav-number">12.</span> <span class="nav-text">Battle</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Camera"><span class="nav-number">13.</span> <span class="nav-text">Camera</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CoroutineManager"><span class="nav-number">14.</span> <span class="nav-text">CoroutineManager</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chebin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">4.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">63:46</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
