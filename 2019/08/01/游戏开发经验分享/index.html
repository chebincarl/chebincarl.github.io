<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta name="keywords" content="Unity 3D实战核心技术详解">
<meta property="og:type" content="article">
<meta property="og:title" content="游戏开发经验分享">
<meta property="og:url" content="http://chebincarl.github.io/2019/08/01/游戏开发经验分享/index.html">
<meta property="og:site_name" content="车斌的博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-08-05T13:36:55.990Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="游戏开发经验分享">
<meta name="twitter:description" content="思考并回答以下问题：">






  <link rel="canonical" href="http://chebincarl.github.io/2019/08/01/游戏开发经验分享/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>游戏开发经验分享 | 车斌的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注，重复10遍</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chebincarl.github.io/2019/08/01/游戏开发经验分享/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chebin">
      <meta itemprop="description" content="记录自己的学习过程">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">游戏开发经验分享

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-01 19:50:43" itemprop="dateCreated datePublished" datetime="2019-08-01T19:50:43+08:00">2019-08-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-05 21:36:55" itemprop="dateModified" datetime="2019-08-05T21:36:55+08:00">2019-08-05</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">34k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">31 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<a id="more"></a>
<p>本章涵盖：</p>
<ul>
<li>消息类型定义和封装</li>
</ul>
<p>关于游戏开发经验，网上资料很多，在这里总结的是我在实际项目开发中遇到的问题以及在开发中使用的一些核心技术，学习编程首先要从程序调试开始，不会调试的程序员永远学不好编程，只要是人为的因素都会有Bug出现，程序员只有通过调试才能解决这些Bug，下面先从调试开始讲起。</p>
<h1 id="关于调试经验分享"><a href="#关于调试经验分享" class="headerlink" title="关于调试经验分享"></a>关于调试经验分享</h1><p>不论开发什么样的程序，首要的是开发者必须会调试，这也是作为程序开发者必备的技能，不会调试的程序员，就不是一个好程序员。任何人写程序都会出现Bug，遇到问题要学会解决问题。在使用Unity开发程序时，经常会遇到在PC端运行程序没有问题，但是将程序打包成Android包安装在手机上时出现各种莫名其妙的Bug，为了解决移动端的Bug，开发者也要知道如何在移动端调试程序。在使用mono编辑器或者Visual Studio编辑器调试移动端程序时，需要在手机端安装一个Unity官方提供的软件Unity Remote，在手机端安装好了后，在编译Unity的Android包时要进行如图14-1所示的设置。</p>
<p>图14-1　Unity移动端调试设置界面</p>
<p>这样编译的apk包在安装到手机端时，运行手机端程序可以在mono编辑器中查看到硬件的名字，如图14-2所示。</p>
<p>图14-2　编辑器与移动端硬件绑定界面</p>
<p>设置好了以上信息后，运行手机端的程序，就可以在mono编辑器或者Visual Studio编辑器中断点调试了。也可以连接Profiler调试工具，查看程序内存分配和CPU的占用情况，操作界面如图14-3所示，它可以查看手机运行的情况，这是一种在移动端调试的方式。</p>
<p>图14-3　Profiler调试界面</p>
<p>第二种调试方式，Android SDK的调试。它可以通过Eclipse编辑器的DDMS查看手机运行的报错问题，在Eclipse开发工具的右上角可以轻松查看到DDMS。大家可以自行下载Eclipse体验一下，它可以查看到游戏运行时的空对象错误，非常实用。</p>
<p>第三种调试方式是通过adb logcat命令行查看Unity的日志信息，打开“运行”，在其中输入“cmd”打开dos的操作界面，然后输入adb logcat-s Unity命令，操作方式如图14-4所示。</p>
<p>图14-4　命令行调试</p>
<p>如果不知道如何使用，可以通过命令查看帮助说明，如果要把日志信息保存到手机卡上，可以输入命令adb logcat-f/sdcard/log.txt，这样log.txt就被保存到手机卡上了，可以查看或者导出，当然也可以保存到电脑上。掌握了以上三种调试方式，就可以解决任何在移动端运行无法解决的问题，接下来介绍移动端游戏防破解技术。</p>
<h1 id="移动端游戏防破解技术"><a href="#移动端游戏防破解技术" class="headerlink" title="移动端游戏防破解技术"></a>移动端游戏防破解技术</h1><p>现在用Unity引擎开发的游戏产品越来越多，很多上线的游戏被破解了。游戏被破解的方式分两种：一种是游戏代码的破解，另一种是游戏计费文件的破解。关于代码的破解网上有很多相关的资料，这里就不一一介绍了。防代码破解一般采用的技术是代码混淆的方式。其实对于游戏公司来说最重要的是关于游戏数据的修改，以及关于计费文件的修改，这二者关乎公司的直接利益。游戏的基础数据通常都会放到本地，这样就会被一些玩家通过修改本地文件的方式去改写数据，防止本地数据文件的修改，采用的是服务器验证的方式，服务器数据库只保存变化的数据，如果一定要放在本地需要将本地的数据文件进行加密处理。通常采用的是SHA512算法或者是MD5加密方式。本节的加密方式是对项目的基础数据文件采用SHA512算法加密方式处理的，核心代码如下所示。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//加密算法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetSHA512Password</span>(<span class="params"><span class="keyword">string</span> password</span>)</span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="keyword">byte</span>[] bytes = Encoding.UTF7.GetBytes(password);  </span><br><span class="line">        <span class="keyword">byte</span>[] result;  </span><br><span class="line">        SHA512 shaM = <span class="keyword">new</span> SHA512Managed();  </span><br><span class="line">        result = shaM.ComputeHash(bytes);  </span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();  </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">byte</span> num <span class="keyword">in</span> result)  </span><br><span class="line">        &#123;  </span><br><span class="line">                sb.AppendFormat(<span class="string">"&#123;0:x2&#125;"</span>, num);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> sb.ToString();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>函数的参数是开发者自己定义的数据串，经过函数的处理后被称为加密的密码，然后将生成的密码字符串作为输入文本文件zip压缩的密码，压缩zip文件函数代码如下所示。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">SaveConfigXMLToZip</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> (ZipFile zipFile = <span class="keyword">new</span> ZipFile(Encoding.UTF8))</span><br><span class="line">    &#123;</span><br><span class="line">        zipFile.Password = configurationZipPwd;</span><br><span class="line">        zipFile.AddEntry(configurationFile, configuration.bytes);</span><br><span class="line">        zipFile.AddEntry(localizationFile, localization.bytes);</span><br><span class="line">        stringzipPath=Path.Combine(Application.persistentDataPath, configurationZipFile);</span><br><span class="line">        LogTool.Log(<span class="string">"Saving configuration in \""</span> + zipPath + <span class="string">"\""</span>);</span><br><span class="line">        zipFile.Save(zipPath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序的压缩是在PC端的编译模式下运行时压缩的，压缩完成后可以将其上传到资源服务器，程序运行时下载该文件然后读取其压缩格式，压缩文件的格式是xml文本文件格式。所以核心代码里面有对XML文件的解释，如果你使用的是Json文件可以更改成Json文件的解析函数，函数如下所示。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">TryLoadingXMLsFromZip</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span> zipPath = Path.Combine(Application.persistentDataPath, configurationZipFile);</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(zipPath))</span><br><span class="line">    &#123;</span><br><span class="line">        LogTool.Log(<span class="string">"Configuration not found!"</span>);</span><br><span class="line">        <span class="keyword">this</span>.ParseConfigXML(configuration.text, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.ParseLocalizationXML(localization.text, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (ZipFile zipFile = <span class="keyword">new</span> ZipFile(zipPath, Encoding.UTF8))</span><br><span class="line">    &#123;</span><br><span class="line">        zipFile.Password = configurationZipPwd;</span><br><span class="line"></span><br><span class="line">        ZipEntry xmlConfEntry   = zipFile[configurationFile],</span><br><span class="line">                 xmlLocaleEntry = zipFile[localizationFile];</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == xmlConfEntry || <span class="literal">null</span> == xmlLocaleEntry)</span><br><span class="line">        &#123;</span><br><span class="line">            LogTool.Log(<span class="string">"Downloaded configuration INVALID!"</span>);</span><br><span class="line">            <span class="keyword">this</span>.ParseConfigXML(configuration.text, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">this</span>.ParseLocalizationXML(localization.text, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (MemoryStream ms = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            xmlConfEntry.Extract(ms);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> xmlText = Encoding.UTF8.GetString(ms.GetBuffer(), <span class="number">0</span>, ms.GetBuffer().Length);</span><br><span class="line">            <span class="keyword">this</span>.ParseConfigXML(xmlText, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            ms.Seek(<span class="number">0</span>, SeekOrigin.Begin);</span><br><span class="line">            xmlLocaleEntry.Extract(ms);</span><br><span class="line"></span><br><span class="line">            xmlText = Encoding.UTF8.GetString(ms.GetBuffer(), <span class="number">0</span>, ms.GetBuffer().Length);</span><br><span class="line">            <span class="keyword">this</span>.ParseLocalizationXML(xmlText, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上是关于文件的加密方式，需要在Unity中加入zip压缩库。下面介绍关于计费文件的破解，原理就是绕过计费文件，屏蔽计费，这样的破解对公司造成的损失是很大的。为了预防此类方式的破解，很多知名IT公司给开发者提供了防破解软件，常用的有360防破解、腾讯防破解以及爱游戏防破解等。这些防破解软件就是把Android包用该软件进行加固处理，这样不论什么软件都无法修改计费文件，效果如图14-5所示。</p>
<p>图14-5　360防破解软件界面</p>
<p>经过该软件处理的包，极大的预防了游戏包体的破解。该软件还有签名功能，使用它能有效地防止计费文件被破解。下面介绍另一个让程序员头疼的问题——减小包体的大小。</p>
<p>14.3　减小包体的大小<br>游戏包体的大小一直是影响游戏玩家体验的重要因素。不论做什么类型的游戏，首要的任务就是把包体大小缩减到一定范围内，对于玩家来说40M是一道坎，游戏都要朝着这个目标努力。包体的大小主要包括美术资源和代码，代码占用量非常小，可以忽略。美术资源的大小直接决定了包体的大小，所以要减小包体必须从美术资源入手。美术资源主要包含两部分：模型和材质贴图，模型的面数要适当控制，这取决于美术的品质要求。</p>
<p>下面介绍一下如何减小贴图的大小。减小贴图的大小常用的处理方式是将不带Alpha通道的贴图存为jpg格式，而将带有Alpha通道的贴图存成png格式。针对UI和3D场景美术建立通用的材质库，这样可以规范和节省美术资源。由于Unity打包图集固有的缺陷，可以采用Texture Packer工具打包解决其带来的问题。Unity图集打包存在主要的问题是，如果定义好了图集大小，那么这个图集不论是否满了，其在内存中占有的大小都是4M。Texture Packer工具会根据贴图的数量自动打成适当大小的图集供程序使用，从而避免这个问题。</p>
<p>另一个辅助检查图片大小的工具是BuildReport，在程序编译成Android的apk包时，要进行设置，效果如图14-6所示。通过图14-6可以看到包体的总量大小以及哪些资源占用量比较大。可以针对性的修改，帮助我们压缩图片的大小。</p>
<p>图14-6　BuildReport工具运行界面</p>
<p>BuildReport资源分布的运行效果如图14-7所示。</p>
<p>图14-7　BuildReport资源分布的运行界面</p>
<p>减小包体需要程序和美术的共同努力，找到问题所在。这就要求在游戏开发初期定义好规范，这样在程序优化后期可以减少很多麻烦。对于使用的库文件dll，可以在Assets目录下建一个link.xml文件，减少不需要的dll文件也可以减小包体，link文件内容样例如下所示。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">linker</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">fullname</span>=<span class="string">"System.Web.Services"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.Web.Services.Protocols.SoapTypeStubInfo"</span> <span class="attr">preserve</span>=<span class="string">"all"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.Web.Services.Configuration.WebServicesConfigurationSectionHandler"</span> <span class="attr">preserve</span>=<span class="string">"all"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">fullname</span>=<span class="string">"System"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.Net.Configuration.WebRequestModuleHandler"</span> <span class="attr">preserve</span>=<span class="string">"all"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.Net.HttpRequestCreator"</span> <span class="attr">preserve</span>=<span class="string">"all"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.Net.FileWebRequestCreator"</span> <span class="attr">preserve</span>=<span class="string">"all"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">fullname</span>=<span class="string">"mscorlib"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.AppDomain"</span> <span class="attr">preserve</span>=<span class="string">"fields"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.InvalidOperationException"</span> <span class="attr">preserve</span>=<span class="string">"fields"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">"System.Void .ctor()"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"System.Object"</span> <span class="attr">preserve</span>=<span class="string">"nothing"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>=<span class="string">"Finalize"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">linker</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>其中，参数all表示保留所有类型与该库相关的库，fields仅保留该类型相关的库，nothing仅保留该类型库，这个可根据需求对不需要的dll进行设置。</p>
<p>总之，优化的方式很多，比如对资源本身的优化，包括顶点数量和材质数量。开发项目时需要对项目进行优化，这个优化包括很多方面，在这里给大家介绍一下：首先要考虑的问题是资源的优化，资源优化包括模型的顶点数量、材质数量、NGUI使用的图集大小、粒子特效数量。这些决定了包的大小，这是要优先要考虑的。其次要考虑的问题是程序的编写是否合理，资源是不是及时的删除或者清空，Shader渲染的运用是不是对于显卡要求比较高。优化程序伴随着游戏开发的始终。代码方面的优化建议开发者读一读《代码重构》一书。</p>
<p>14.4　动态对象资源的优化<br>不论手游开发还是端游开发，优化自始至终伴随着游戏产品的开发。Unity引擎对于资源优化处理的并不是很好，引擎内部只处理了静态对象的优化，对于动态对象并没有去处理，这需要开发者通过编程去实现动态优化的处理。程序优化主要涉及程序运行的效率，游戏运行出现卡顿以及内存溢出，编写代码要注意内存是否及时的释放掉了，影响游戏内存的因素很多，比如代码中打印的Log是否过多，是否有死循环的代码，以及程序切换场景时是否及时释放内存等。</p>
<p>优化的事情并不只是程序的任务，也需要美术协助。例如，遇到游戏运行出现卡帧现象时，借助Unity的Profiler工具查看内存占用情况，如图14-8所示。单击CPU Usage内存中的曲线可以帮助判断程序出现卡帧，下方的Camera.Render目录下对应的是Unity代码中的具体函数，从而帮助开发者非常方便地找到问题的所在，然后根据找到的问题检查程序逻辑是否有问题。单击Memory可以查看资源在内存中的占用情况，可以针对性的对资源进行处理，如图14-9所示。首先要检查美术资源包括面片数量、材质大小，最后检查一下运用在物体上的Shader，是否有比较好的Shader运用，比如后处理效果Bloom、Blur等。下面主要是针对游戏中使用的资源进行的优化，同时结合案例讲解如何降低DrawCall的数量，达到优化的目的。程序方面要具体问题具体分析，在这里就不一一列举了。</p>
<p>图14-8　查看CPU函数运行界面</p>
<p>图14-9　查看内存占用界面</p>
<p>由于策划需求，美术经常会在游戏场景中摆放一些具有骨骼动画的物件道具用于场景装饰，如果这些场景物件多了，DrawCall会增长的很快，严重影响程序运行效率。不论你是动态实例化生成还是直接拖放到场景中，DrawCall都会增长。面对这样的需求该如何处理呢？因为Unity只提供了静态对象的优化，我们可以直接勾选Static选项，而对动态对象的优化只能自己想办法解决，读者可以先做个实验，只在场景中放一个具有骨骼动画的物体，观察一下它的DrawCall和FPS运行帧率各是多少。场景中是一艘带有骨骼动画的船，程序运行时的DrawCall是10，FPS是76.8，如图14-10所示。</p>
<p>接下来增加两艘同样的船，如图14-11所示，此时，DrawCall是25，FPS是76.8，虽然DrawCall不是成倍增长，但是明显增加了一倍多。通过这个案例可以想象如果这些装饰物过多，对程序还是有影响的。面对这种类型的问题，先说一下解决问题的思路，首先分析一下：这些物体的共同点是带有相同的骨骼动画，而且材质也是一样的。</p>
<p>图14-10　单个带有骨骼动画的物体展示</p>
<p>图14-11　多个带有骨骼动画的物体展示</p>
<p>说一下解决问题的思路，如果把这些船的Mesh和Skeleton合并成一个物体，会出现什么情况呢？对于合并成的物体需要自己创建一个新的Mesh，然后对Mesh进行填充。下面先把代码分享一下，后面会给大家讲案例，完整的优化代码如下所示。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CombineDrawCall</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">        CombineToOne(<span class="keyword">this</span>.gameObject);<span class="comment">//调用函数接口</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//合并网格和动作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CombineToOne</span>(<span class="params">GameObject _go</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SkinnedMeshRenderer[] _smr = _go.GetComponentsInChildren&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line">        List&lt;CombineInstance&gt; lcom = <span class="keyword">new</span> List&lt;CombineInstance&gt;();</span><br><span class="line"></span><br><span class="line">        List&lt;Material&gt; lmat = <span class="keyword">new</span> List&lt;Material&gt;();</span><br><span class="line">        List&lt;Transform&gt; ltra = <span class="keyword">new</span> List&lt;Transform&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; _smr.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            lmat.AddRange(_smr[i].materials);</span><br><span class="line">            ltra.AddRange(_smr[i].bones);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> sub = <span class="number">0</span>; sub &lt; _smr[i].sharedMesh.subMeshCount; sub++)</span><br><span class="line">            &#123;</span><br><span class="line">                CombineInstance ci = <span class="keyword">new</span> CombineInstance();</span><br><span class="line">                ci.mesh = _smr[i].sharedMesh;</span><br><span class="line">                ci.subMeshIndex = sub;</span><br><span class="line">                lcom.Add(ci);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Destroy(_smr[i].gameObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SkinnedMeshRenderer _r = _go.GetComponent&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line">        <span class="keyword">if</span> (_r == <span class="literal">null</span>)</span><br><span class="line">            _r = _go.AddComponent&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line"></span><br><span class="line">        _r.sharedMesh = <span class="keyword">new</span> Mesh();</span><br><span class="line">        _r.bones = ltra.ToArray();</span><br><span class="line">        _r.materials = <span class="keyword">new</span> Material[] &#123; lmat[<span class="number">0</span>] &#125;;</span><br><span class="line">        _r.rootBone = _go.transform;</span><br><span class="line"></span><br><span class="line">        _r.sharedMesh.CombineMeshes(lcom.ToArray(), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码实现了动态对象的优化处理，在使用代码时，首先要建立一个空对象作为父类，把要优化的动态对象放到父类下面作为子类，当然你也可以用一个动态对象作为父类，其他动态对象挂到它的下面。优化的动态对象需要带有自己的骨骼动画，材质最好只有一张贴图，当然多张也是可以的。优化的对象是同一个对象，这一般适用于装饰场景的物件，有的人可能将其应用到游戏中动态生成的怪物，这是不可以的，因为优化的本质是将所有要优化的动态对象组合成一个大的对象，所以不适合怪物的生成。下面将其应用到Unity中给大家展示一下运行效果。直接在场景中放了五艘船，同时把上面写好的代码CombineDrawCall.cs直接挂到GameObject对象上，如图14-12所示。</p>
<p>图14-12　优化代码挂接</p>
<p>它的运行效果如图14-13所示，DrawCall和FPS都有所优化，DrawCall是13，与放置一个物体的DrawCall结果类似，FPS是81.6略有提高，达到了优化的目的。</p>
<p>图14-13　优化运行效果</p>
<h1 id="多线程资源下载技术"><a href="#多线程资源下载技术" class="headerlink" title="多线程资源下载技术"></a>多线程资源下载技术</h1><p>在游戏开发中经常会使用多线程去处理，比如在3D游戏开发中，对于大地形的加载，通常是使用分块的方式。用于加载魔兽世界地图场景的3D游戏引擎使用的技术就是多线程加载，在内存里放置9块地形，在缓存里面放置16块地形用于与内存进行地形块的交换。以前开发过端游，主线程负责地形的加载，单独开一个线程用于地形的卸载。在开发中，Unity只有一个主线程运行，也就是单线程，但是可以在Unity中使用多线程加载资源。当我们同时要处理很多事情并且与Unity的对象没有交互时，可以用thread多线程，否则只能使用协成coroutine。在多处理器的计算机上可以做到多个线程的真正同步，在Unity中，你仅能从主线程中访问Unity的组件对象和Unity系统调用，任何企图访问这些对象的第二个线程都将失败并引发错误，这是一个需要我们重视的限制。下面介绍一下实现多线程的思路，以及对资源的断点续传。</p>
<p>本节使用的多线程是用于处理游戏资源的下载，意思是在程序运行时，在用户不知情的情况下在后台开启一个线程下载游戏资源。首先将需要下载的资源打包用zip压缩，主要目的是减少资源包体的大小，然后借助工具生成md5的加密文件，名字为VersionMD5.xml，如果游戏资源有所改变，要重新命名生成的加密文件为VersionMD5_1.0.xml，并将其放到FTP资源服务器上。</p>
<p>游戏启动时，首先判断是否已连接WiFi。如果已开启，则自动启动资源下载。程序会在游戏后台打开线程去下载资源，先从服务器上下载版本控制文件VersionMD5_1.0.xml通过文件名和版本号，对比本地文件的VersionMD5.xml，确定是否需要更新资源，如有不同，则加入下载列表。如果没有打开WiFi，要保证游戏在一定时间内能正常运行，等运行到游戏需要加载的服务器资源时，如果本地无资源加载，就开启数据流量使用提醒强制下载，下载结束后游戏就可以继续运行了。多线程断点续传下载流程如图14-14所示。</p>
<p>图14-14　多线程断点续传下载流程</p>
<p>根据上面的流程图，我们把完整的代码展示一下。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ResUpdate</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ResUpdate Instance;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">string</span> MAIN_VERSION_FILE = <span class="string">"VersionMd5.xml"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">string</span> SERVER_RES_URL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">string</span> LOCAL_RES_OUT_PATH = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> LOCAL_DECOMPRESS_RES = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span> , ResReference&gt; LocalResOutVersion = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span> , ResReference&gt;();<span class="comment">//本地包外资源</span></span><br><span class="line">        <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span> , <span class="keyword">int</span>&gt; ServerResVersion = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span> , <span class="keyword">int</span>&gt;();<span class="comment">//服务器资源版本号</span></span><br><span class="line">        <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; NeedDownFiles = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//本地资源包信息</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> ResReference &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">bool</span> isFinish;<span class="comment">//是否存在包外</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">bool</span> isUnZip;<span class="comment">//是否解压DownFile</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">int</span> version;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="title">ResReference</span> (<span class="params"><span class="keyword">bool</span> isFinish , <span class="keyword">int</span> version , <span class="keyword">bool</span> isUnZip</span>)</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.isFinish = isFinish;</span><br><span class="line">                        <span class="keyword">this</span>.version = version;</span><br><span class="line">                        <span class="keyword">this</span>.isUnZip = isUnZip;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> updatedNum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> totalNeedUpdateNum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">long</span> curFileTotalNum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">long</span> curFileNum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> Thread downloadThread;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="title">ResUpdate</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">                Instance = <span class="keyword">new</span> ResUpdate();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_ANDROID</span></span><br><span class="line"> SERVER_RES_URL=<span class="string">"http://127.0.0.1/AssetBundle/Android/"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> UNITY_IPHONE</span></span><br><span class="line"> SERVER_RES_URL=<span class="string">"http://127.0.0.1/AssetBundle/IOS/"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> UNITY_EDITOR || UNITY_STANDALONE_WIN</span></span><br><span class="line"> SERVER_RES_URL=<span class="string">"http://127.0.0.1/AssetBundle/Windows32/"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        System.Net.ServicePointManager.DefaultConnectionLimit = <span class="number">512</span>;<span class="comment">//</span></span><br><span class="line">                LOCAL_RES_OUT_PATH = Application.persistentDataPath + <span class="string">"/AssetBundle/"</span>;</span><br><span class="line">                LOCAL_DECOMPRESS_RES = LOCAL_RES_OUT_PATH + <span class="string">"/DeCompress/"</span>;</span><br><span class="line">                SERVER_RES_URL += SGConstant.mSTR_CURVERSION + <span class="string">"/"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> isDownload = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 启动下载程序</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="isAuto"&gt;</span>是否自动（自动只允许Wi-Fi下载）<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StartDownLoad</span> (<span class="params"><span class="keyword">bool</span> isAuto = <span class="literal">true</span></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( isAuto ) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( AndroidSDKTool.GetNetWorkType() == NetworkType.WIFI ) &#123;</span><br><span class="line">                                Debug.Log(<span class="string">"start download resource"</span>);</span><br><span class="line">                                <span class="keyword">if</span> ( !isDownload ) &#123;</span><br><span class="line">                                        CoroutineManager.DoCoroutine(Instance.LoadVersion());</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                Debug.Log(<span class="string">"no wifi"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( !isDownload ) &#123;</span><br><span class="line">                                CoroutineManager.DoCoroutine(Instance.LoadVersion());</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//加载版本文件</span></span><br><span class="line">        <span class="function">IEnumerator <span class="title">LoadVersion</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">                isDownload = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//清空变量</span></span><br><span class="line">                <span class="comment">//LocalResOutVersion.Clear();</span></span><br><span class="line">                ServerResVersion.Clear();</span><br><span class="line">                NeedDownFiles.Clear();</span><br><span class="line">                <span class="keyword">string</span> serverMainVersion = <span class="string">""</span>;</span><br><span class="line">                <span class="comment">//读取本地配置文件</span></span><br><span class="line">                <span class="keyword">string</span> localVersion = System.IO.Path.Combine(LOCAL_RES_OUT_PATH , MAIN_VERSION_FILE);</span><br><span class="line">                <span class="keyword">if</span> ( File.Exists(localVersion) )</span><br><span class="line">                        Instance.ParseLocalVersionFile(localVersion , LocalResOutVersion);</span><br><span class="line">                <span class="comment">//取得服务器版本</span></span><br><span class="line">                <span class="keyword">string</span> versionUrl = SERVER_RES_URL + <span class="string">"VersionMd5_1.0/"</span> + MAIN_VERSION_FILE;</span><br><span class="line">                WWW sw = <span class="keyword">new</span> WWW(versionUrl);</span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">return</span> sw;</span><br><span class="line">                <span class="keyword">if</span> ( !<span class="keyword">string</span>.IsNullOrEmpty(sw.error) )</span><br><span class="line">                        Debug.LogError(<span class="string">"Server Version ..."</span> + sw.error);</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                        serverMainVersion = sw.text;</span><br><span class="line">                        Debug.Log(serverMainVersion);</span><br><span class="line">                        ParseVersionFile(serverMainVersion , ServerResVersion);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ( <span class="keyword">string</span>.IsNullOrEmpty(sw.text) ) &#123;</span><br><span class="line">                        Debug.LogError(<span class="string">"无法连接服务器"</span>);</span><br><span class="line">                        <span class="comment">//加载下一个场景</span></span><br><span class="line">                &#125; <span class="keyword">else</span><span class="comment">//可以连接服务器</span></span><br><span class="line">        &#123;</span><br><span class="line">                        <span class="comment">//对比本地和服务器的配置</span></span><br><span class="line">                        CompareServerVersion();</span><br><span class="line">                        <span class="comment">//开启下载</span></span><br><span class="line">                        DownLoadResByThread();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">HandleFinishDownload</span> (<span class="params">WWW www</span>)</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//在多线程环境中只要我们用下面的方式实例化HashTable就可以了</span></span><br><span class="line">        Hashtable ht = Hashtable.Synchronized(<span class="keyword">new</span> Hashtable());</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DownLoadResByThread</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">                downloadThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(DownFile));</span><br><span class="line">                downloadThread.Start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新本地的version配置</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateLocalVersionFile</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">                XmlDocument xmldoc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">                XmlElement xmlelem;</span><br><span class="line">                <span class="comment">//加入一个根元素</span></span><br><span class="line">                xmlelem = xmldoc.CreateElement(<span class="string">""</span> , <span class="string">"VersionNum"</span> , <span class="string">""</span>);</span><br><span class="line">                xmldoc.AppendChild(xmlelem);</span><br><span class="line">                <span class="keyword">foreach</span> ( KeyValuePair&lt;<span class="keyword">string</span> , ResReference&gt; kvp <span class="keyword">in</span> LocalResOutVersion ) &#123;</span><br><span class="line">                        XmlElement xe1 = xmldoc.CreateElement(<span class="string">"File"</span>);<span class="comment">//创建一个&lt;Node&gt;节点</span></span><br><span class="line">                        xe1.SetAttribute(<span class="string">"FileName"</span> , kvp.Key);<span class="comment">//设置该节点FileName属性</span></span><br><span class="line">                        xe1.SetAttribute(<span class="string">"Num"</span> , kvp.Value.version.ToString());<span class="comment">//设置该节点Num属性</span></span><br><span class="line">                        xe1.SetAttribute(<span class="string">"isFinish"</span> , kvp.Value.isFinish.ToString());<span class="comment">//设置该节点isFinish属性</span></span><br><span class="line">                        xe1.SetAttribute(<span class="string">"isUnZip"</span> , kvp.Value.isUnZip.ToString());<span class="comment">//设置该节点isUnZip属性</span></span><br><span class="line">                        xmlelem.AppendChild(xe1);<span class="comment">//添加到&lt;Employees&gt;节点中</span></span><br><span class="line">                &#125;</span><br><span class="line">                xmldoc.Save(LOCAL_RES_OUT_PATH + MAIN_VERSION_FILE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//与服务器版本比较</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CompareServerVersion</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">foreach</span> ( <span class="keyword">var</span> version <span class="keyword">in</span> ServerResVersion ) &#123;</span><br><span class="line">                        <span class="comment">//Debug.Log(version.Key);</span></span><br><span class="line">                        <span class="keyword">string</span> fileName = version.Key;</span><br><span class="line">                        <span class="keyword">int</span> serverVersion = version.Value;</span><br><span class="line">                        <span class="comment">//if ( IsResOut(fileName) ) &#123;</span></span><br><span class="line">                        <span class="comment">//如果本地配置表中无资源、版本号不匹配，或者未下载完，就下载</span></span><br><span class="line">                        <span class="keyword">if</span> ( ( LocalResOutVersion.ContainsKey(fileName) &amp;&amp; LocalResOutVersion[fileName].version != ServerResVersion[fileName] ) || </span><br><span class="line">                        !LocalResOutVersion.ContainsKey(fileName) || ( LocalResOutVersion.ContainsKey(fileName) &amp;&amp;</span><br><span class="line">                        LocalResOutVersion[fileName].version == ServerResVersion[fileName] &amp;&amp; !LocalResOutVersion[fileName].isFinish ) ) &#123;</span><br><span class="line">                                NeedDownFiles.Add(fileName);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//AllResDic.Add(fileName , new ResReference(true , serverVersion));</span></span><br><span class="line">                &#125;</span><br><span class="line">                totalNeedUpdateNum = NeedDownFiles.Count;</span><br><span class="line">                updatedNum = <span class="number">0</span>;</span><br><span class="line">                Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"需下载资源数量：&#123;0&#125;"</span> , totalNeedUpdateNum));</span><br><span class="line">                <span class="comment">//删除旧资源</span></span><br><span class="line">                <span class="keyword">foreach</span> ( <span class="keyword">string</span> fileName <span class="keyword">in</span> NeedDownFiles ) &#123;</span><br><span class="line">                        <span class="keyword">string</span> localPath = LOCAL_RES_OUT_PATH + fileName;<span class="comment">//下载文件</span></span><br><span class="line">                        <span class="keyword">string</span> localUnZipPath = <span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125;&#123;1&#125;.&#123;2&#125;"</span> , LOCAL_DECOMPRESS_RES , fileName.Substring(<span class="number">0</span> , fileName.IndexOf(<span class="string">"."</span>)) , <span class="string">"assetbundle"</span>);<span class="comment">//解压文件</span></span><br><span class="line">                        <span class="keyword">if</span> ( File.Exists(localPath) )</span><br><span class="line">                                File.Delete(localPath);</span><br><span class="line">                        <span class="keyword">if</span> ( File.Exists(localUnZipPath) )</span><br><span class="line">                                File.Delete(localUnZipPath);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 检查包外资源是否比包内资源新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将xml版本号转换为字典数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="content"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dict"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ParseVersionFile</span> (<span class="params"><span class="keyword">string</span> content , Dictionary&lt;<span class="keyword">string</span> , <span class="keyword">int</span>&gt; dict</span>)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( content == <span class="literal">null</span> || content.Length == <span class="number">0</span> ) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                XmlDocument doc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">                doc.LoadXml(content);</span><br><span class="line">                XmlNodeList nodes = doc.GetElementsByTagName(<span class="string">"File"</span>);</span><br><span class="line">                <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; nodes.Count ; i++ ) &#123;</span><br><span class="line">                        XmlAttribute att = nodes[i].Attributes[<span class="string">"FileName"</span>];</span><br><span class="line">                        <span class="keyword">if</span> ( !dict.ContainsKey(att.Value) ) &#123;</span><br><span class="line">                                dict.Add(att.Value , <span class="keyword">int</span>.Parse(nodes[i].Attributes[<span class="string">"Num"</span>].Value));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                Debug.Log(<span class="string">"Dict has same key -----&gt;"</span> + att.Value);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将xml版本号转换为字典数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="filename"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dict"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ParseLocalVersionFile</span> (<span class="params"><span class="keyword">string</span> filename , Dictionary&lt;<span class="keyword">string</span> , ResReference&gt; dict</span>)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( filename == <span class="literal">null</span> || filename.Length == <span class="number">0</span> ) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                XmlDocument doc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">                doc.Load(filename);</span><br><span class="line">                XmlNodeList nodes = doc.GetElementsByTagName(<span class="string">"File"</span>);</span><br><span class="line">                <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; nodes.Count ; i++ ) &#123;</span><br><span class="line">                        XmlAttribute att = nodes[i].Attributes[<span class="string">"FileName"</span>];</span><br><span class="line">                        <span class="keyword">if</span> ( !dict.ContainsKey(att.Value) ) &#123;</span><br><span class="line">                                dict.Add(att.Value , <span class="keyword">new</span> ResReference(<span class="keyword">bool</span>.Parse(nodes[i].Attributes[<span class="string">"isFinish"</span>].Value) , <span class="keyword">int</span>.Parse(nodes[i].Attributes[<span class="string">"Num"</span>].Value) , <span class="keyword">bool</span>.Parse(nodes[i].Attributes[<span class="string">"isUnZip"</span>].Value)));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                Debug.Log(<span class="string">"Dict has same key -----&gt;"</span> + att.Value);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//支持断点续传的下载</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DownFile</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( updatedNum &gt;= NeedDownFiles.Count ) &#123;</span><br><span class="line">                        UpdateLocalVersionFile();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">string</span> fileName = NeedDownFiles[updatedNum];</span><br><span class="line">                <span class="keyword">string</span> serverPath = SERVER_RES_URL + fileName;</span><br><span class="line">                <span class="comment">//判断目录</span></span><br><span class="line">                <span class="keyword">string</span>[] fileNameArr = fileName.Split(<span class="string">'/'</span>);</span><br><span class="line">                <span class="keyword">string</span> filePath = <span class="string">""</span>;</span><br><span class="line">                <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; fileNameArr.Length - <span class="number">1</span> ; i++ ) &#123;</span><br><span class="line">                        filePath += fileNameArr[i] + <span class="string">"/"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                filePath = LOCAL_RES_OUT_PATH + filePath;<span class="comment">//下载文件目录</span></span><br><span class="line">                <span class="keyword">string</span> localPath = LOCAL_RES_OUT_PATH + fileName;<span class="comment">//下载文件</span></span><br><span class="line">                <span class="keyword">string</span> localUnZipPath = <span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125;&#123;1&#125;.&#123;2&#125;"</span> , LOCAL_DECOMPRESS_RES , fileName.Substring(<span class="number">0</span> , fileName.IndexOf(<span class="string">"."</span>)) , <span class="string">"assetbundle"</span>);<span class="comment">//解压文件</span></span><br><span class="line">                <span class="keyword">if</span> ( !Directory.Exists(filePath) )</span><br><span class="line">                        Directory.CreateDirectory(filePath);</span><br><span class="line">                <span class="keyword">if</span> ( !Directory.Exists(LOCAL_DECOMPRESS_RES) )</span><br><span class="line">                        Directory.CreateDirectory(LOCAL_DECOMPRESS_RES);</span><br><span class="line">                <span class="keyword">bool</span> isRight = <span class="literal">false</span>;<span class="comment">//是否下载好</span></span><br><span class="line">                <span class="comment">//上个版本先删除（并删除解压好的文件）</span></span><br><span class="line">                <span class="keyword">if</span>(LocalResOutVersion.ContainsKey(fileName)&amp;&amp; ( LocalResOutVersion[fileName].version &lt; ServerResVersion[fileName] ) ) &#123;</span><br><span class="line">                        File.Delete(localPath);</span><br><span class="line">                        File.Delete(localUnZipPath);</span><br><span class="line">                &#125;</span><br><span class="line">                FileStream fs = <span class="literal">null</span>;</span><br><span class="line">                HttpWebRequest requestGetCount = <span class="literal">null</span>;</span><br><span class="line">                HttpWebResponse responseGetCount = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                        requestGetCount = (System.Net.HttpWebRequest)System.Net.HttpWebRequest.Create(serverPath);</span><br><span class="line">                        responseGetCount = (HttpWebResponse)requestGetCount.GetResponse();</span><br><span class="line">                        curFileTotalNum = responseGetCount.ContentLength;</span><br><span class="line">                        <span class="keyword">if</span> ( File.Exists(localPath) ) &#123;</span><br><span class="line">                                fs = File.OpenWrite(localPath);<span class="comment">//打开流</span></span><br><span class="line">                                curFileNum = fs.Length;<span class="comment">//通过字节流的长度确定当前的下载位置</span></span><br><span class="line">                                <span class="keyword">if</span> ( curFileTotalNum - curFileNum &lt;= <span class="number">0</span> ) &#123;</span><br><span class="line">                                        isRight = <span class="literal">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                fs.Seek(curFileNum , SeekOrigin.Current); <span class="comment">//移动文件流中的当前指针</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                fs = <span class="keyword">new</span> FileStream(localPath , FileMode.CreateNew);</span><br><span class="line">                                curFileNum = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> ( Exception ex ) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( fs != <span class="literal">null</span> )</span><br><span class="line">                                fs.Close();</span><br><span class="line">                        UpdateLocalVersionTemp(fileName , <span class="literal">false</span> , <span class="literal">false</span>);</span><br><span class="line">                        UpdateLocalVersionFile();</span><br><span class="line">                        isRight = <span class="literal">false</span>;</span><br><span class="line">                        Debug.Log(ex.ToString());</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( responseGetCount != <span class="literal">null</span> ) &#123;</span><br><span class="line">                                responseGetCount.Close();</span><br><span class="line">                                responseGetCount = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ( requestGetCount != <span class="literal">null</span> ) &#123;</span><br><span class="line">                                requestGetCount.Abort();</span><br><span class="line">                                requestGetCount = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                HttpWebRequest request = <span class="literal">null</span>;</span><br><span class="line">                HttpWebResponse response = <span class="literal">null</span>;</span><br><span class="line">                Stream ns = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">string</span> test = <span class="string">""</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//本地未下载完成</span></span><br><span class="line">                        <span class="keyword">if</span> ( !isRight ) &#123;</span><br><span class="line">                                request = (HttpWebRequest)HttpWebRequest.Create(serverPath);</span><br><span class="line">                                <span class="keyword">if</span> ( curFileNum &gt; <span class="number">0</span> )</span><br><span class="line">                                        request.AddRange((<span class="keyword">int</span>)curFileNum); <span class="comment">//设置Range值</span></span><br><span class="line">                                response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">                                <span class="comment">//向服务器请求，获得服务器回应数据流</span></span><br><span class="line">                                ns = response.GetResponseStream();</span><br><span class="line">                                <span class="keyword">byte</span>[] nbytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                                <span class="keyword">int</span> nReadSize = <span class="number">0</span>;</span><br><span class="line">                                nReadSize = ns.Read(nbytes , <span class="number">0</span> , <span class="number">1024</span>);</span><br><span class="line">                                <span class="keyword">while</span> ( nReadSize &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                                        fs.Write(nbytes , <span class="number">0</span> , nReadSize);</span><br><span class="line">                                        nReadSize = ns.Read(nbytes , <span class="number">0</span> , <span class="number">1024</span>);</span><br><span class="line">                                        curFileNum += nReadSize;</span><br><span class="line">                                        <span class="comment">//Debug.Log(DownloadByte);</span></span><br><span class="line">                                &#125;</span><br><span class="line">                                isRight = <span class="literal">true</span>;</span><br><span class="line">                                fs.Flush();</span><br><span class="line">                                fs.Close();</span><br><span class="line">                                ns.Close();</span><br><span class="line">                                request.Abort();</span><br><span class="line">                        &#125;</span><br><span class="line">                        UpdateLocalVersionTemp(fileName , <span class="literal">true</span> , <span class="literal">false</span>);</span><br><span class="line">                        <span class="comment">//解压(防止更新下载不全，解压报错的文件占坑)</span></span><br><span class="line">                        <span class="keyword">if</span> ( File.Exists(localUnZipPath) ) &#123;</span><br><span class="line">                                File.Delete(localUnZipPath);</span><br><span class="line">                        &#125;</span><br><span class="line">                        CompressUtil.DeCompress(localPath , localUnZipPath , <span class="literal">null</span>);</span><br><span class="line">                        UpdateLocalVersionTemp(fileName , <span class="literal">true</span> , <span class="literal">true</span>);</span><br><span class="line">                        updatedNum++;</span><br><span class="line">                        Debug.Log(<span class="string">"down "</span> + updatedNum + <span class="string">"/"</span> + totalNeedUpdateNum + <span class="string">","</span> + fileName + <span class="string">"Loading complete"</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> ( Exception ex ) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( fs != <span class="literal">null</span> )</span><br><span class="line">                                fs.Close();</span><br><span class="line">                        UpdateLocalVersionTemp(fileName , <span class="literal">false</span> , <span class="literal">false</span>);</span><br><span class="line">                        isRight = <span class="literal">false</span>;</span><br><span class="line">                        Debug.Log(ex.ToString());</span><br><span class="line">                        <span class="comment">//解压出错，删除下载文件</span></span><br><span class="line">                        <span class="keyword">if</span> ( File.Exists(localPath) ) &#123;</span><br><span class="line">                                File.Delete(localPath);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//StartDownLoad();</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( ns != <span class="literal">null</span> ) &#123;</span><br><span class="line">                                ns.Close();</span><br><span class="line">                                ns = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ( response != <span class="literal">null</span> ) &#123;</span><br><span class="line">                                response.Close();</span><br><span class="line">                                response = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ( request != <span class="literal">null</span> ) &#123;</span><br><span class="line">                                request.Abort();</span><br><span class="line">                                request = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//下载下一个</span></span><br><span class="line">                        <span class="comment">//if ( isRight ) &#123;</span></span><br><span class="line">                        DownFile();</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//下载结束</span></span><br><span class="line">                isDownload = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">UrlNoCache</span> (<span class="params"><span class="keyword">string</span> url</span>)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> url + <span class="string">"?date="</span> + DateTime.Now.Ticks;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateLocalVersionTemp</span> (<span class="params"><span class="keyword">string</span> fileName , <span class="keyword">bool</span> isFinish , <span class="keyword">bool</span> isUnZip</span>)</span> &#123;</span><br><span class="line">                <span class="comment">//下载更新版本号</span></span><br><span class="line">                <span class="keyword">if</span> ( LocalResOutVersion.ContainsKey(fileName) ) &#123;</span><br><span class="line">                        LocalResOutVersion[fileName] = <span class="keyword">new</span> ResReference(isFinish , ServerResVersion[fileName] , isUnZip);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LocalResOutVersion.Add(fileName,newResReference(isFinish , ServerResVersion[fileName] , isUnZip));</span><br><span class="line">                &#125;</span><br><span class="line">                UpdateLocalVersionFile();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面介绍一下代码，在该代码中首先声明两个变量，用于存储包体外的资源和服务器资源，包体外的资源主要是考虑到从服务器下载的资源不可能加载到包体里面，只能放到指定的文件夹下面，声明的变量是用字典Dictionary存放的。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span> , ResReference&gt; LocalResOutVersion = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span> , ResReference&gt;();<span class="comment">//本地保外资源</span></span><br><span class="line"><span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span> , <span class="keyword">int</span>&gt; ServerResVersion = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span> , <span class="keyword">int</span>&gt;();<span class="comment">//服务器资源版本号</span></span><br></pre></td></tr></table></figure></p>
<p>在声明的变量中有ResReference，它表示的是资源信息，在这里用结构体定义本地资源包信息，结构体表示如下。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//本地资源包信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> ResReference &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> isFinish;<span class="comment">//是否存在包外</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> isUnZip;<span class="comment">//是否解压DownFile</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResReference</span> (<span class="params"><span class="keyword">bool</span> isFinish , <span class="keyword">int</span> version , <span class="keyword">bool</span> isUnZip</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.isFinish = isFinish;</span><br><span class="line">            <span class="keyword">this</span>.version = version;</span><br><span class="line">            <span class="keyword">this</span>.isUnZip = isUnZip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>前期准备工作完成后，开始进入资源下载阶段，使用函数StartDownLoad开始启动资源下载。首先下载配置文件，本地的配置文件会与服务器的配置文件做对比决定下载哪个资源文件，在该函数中调用了函数LoadVersion，处理版本配置文件。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IEnumerator <span class="title">LoadVersion</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">	isDownload = <span class="literal">true</span>;</span><br><span class="line">	<span class="comment">//清空变量</span></span><br><span class="line">	<span class="comment">//LocalResOutVersion.Clear();</span></span><br><span class="line">	ServerResVersion.Clear();</span><br><span class="line">	NeedDownFiles.Clear();</span><br><span class="line">	<span class="keyword">string</span> serverMainVersion = <span class="string">""</span>;</span><br><span class="line">	<span class="comment">//读取本地配置文件</span></span><br><span class="line">	<span class="keyword">string</span> localVersion = System.IO.Path.Combine(LOCAL_RES_OUT_PATH , MAIN_VERSION_FILE);</span><br><span class="line">	<span class="keyword">if</span> ( File.Exists(localVersion) )</span><br><span class="line">	    Instance.ParseLocalVersionFile(localVersion , LocalResOutVersion);</span><br><span class="line">	<span class="comment">//取得服务器版本</span></span><br><span class="line">	<span class="keyword">string</span> versionUrl = SERVER_RES_URL + <span class="string">"VersionNum/"</span> + MAIN_VERSION_FILE;</span><br><span class="line">	WWW sw = <span class="keyword">new</span> WWW(versionUrl);</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">return</span> sw;</span><br><span class="line">	<span class="keyword">if</span> ( !<span class="keyword">string</span>.IsNullOrEmpty(sw.error) )</span><br><span class="line">	    Debug.LogError(<span class="string">"Server Version ..."</span> + sw.error);</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	    serverMainVersion = sw.text;</span><br><span class="line">	    Debug.Log(serverMainVersion);</span><br><span class="line">	    <span class="comment">//serverVersionByte = sw.bytes;</span></span><br><span class="line">	    ParseVersionFile(serverMainVersion , ServerResVersion);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( <span class="keyword">string</span>.IsNullOrEmpty(sw.text) ) &#123;</span><br><span class="line">	    Debug.LogError(<span class="string">"无法连接服务器"</span>);</span><br><span class="line">	    <span class="comment">//CompareLoacalVersion();</span></span><br><span class="line">	    <span class="comment">//加载下一个场景</span></span><br><span class="line">	&#125; <span class="keyword">else</span><span class="comment">//可以连接服务器</span></span><br><span class="line">	&#123;</span><br><span class="line">	    <span class="comment">//对比本地和服务器的配置</span></span><br><span class="line">	    CompareServerVersion();</span><br><span class="line">	    <span class="comment">//开启下载</span></span><br><span class="line">	    <span class="comment">//CoroutineManager.DoCoroutine(DownLoadResByWWW());</span></span><br><span class="line">	    DownLoadResByThread();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置文件对比完成后，确定开始启动线程下载资源，调用函数DownLoadResByThread下载，代码如下所示。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DownLoadResByThread</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">        downloadThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(DownFile));</span><br><span class="line">        downloadThread.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数起动了一个线程，在这个线程里面调用函数DownFile去下载资源并且它具有断点续传功能，函数中都有注释，读者可以自行查看。下面把断点续传内容的重点解释一下：它的HttpWebRequest和HttpWebResponse作为资源请求来使用，获取到服务器请求后，可以拿到资源流，根据流的大小判断是否下载完整，如果不完整可以做个记录，继续下载，在最后又调用了一次函数DownFile（），函数迭代进行直到资源下载完成，以下是处理断点续传的代码。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">HttpWebRequest request = <span class="literal">null</span>;</span><br><span class="line">HttpWebResponse response = <span class="literal">null</span>;</span><br><span class="line">Stream ns = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">string</span> test = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//本地未下载完成</span></span><br><span class="line">        <span class="keyword">if</span> ( !isRight ) &#123;</span><br><span class="line">            request = (HttpWebRequest)HttpWebRequest.Create(serverPath);</span><br><span class="line">            <span class="keyword">if</span> ( curFileNum &gt; <span class="number">0</span> )</span><br><span class="line">                    request.AddRange((<span class="keyword">int</span>)curFileNum); <span class="comment">//设置Range值</span></span><br><span class="line">            response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">            <span class="comment">//向服务器请求，获得服务器回应数据流</span></span><br><span class="line">            ns = response.GetResponseStream();</span><br><span class="line">            <span class="keyword">byte</span>[] nbytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> nReadSize = <span class="number">0</span>;</span><br><span class="line">            nReadSize = ns.Read(nbytes , <span class="number">0</span> , <span class="number">1024</span>);</span><br><span class="line">            <span class="keyword">while</span> ( nReadSize &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                    fs.Write(nbytes , <span class="number">0</span> , nReadSize);</span><br><span class="line">                    nReadSize = ns.Read(nbytes , <span class="number">0</span> , <span class="number">1024</span>);</span><br><span class="line">                    curFileNum += nReadSize;</span><br><span class="line">                    <span class="comment">//Debug.Log(DownloadByte);</span></span><br><span class="line">            &#125;</span><br><span class="line">            isRight = <span class="literal">true</span>;</span><br><span class="line">            fs.Flush();</span><br><span class="line">            fs.Close();</span><br><span class="line">            ns.Close();</span><br><span class="line">            request.Abort();</span><br><span class="line">        &#125;</span><br><span class="line">        UpdateLocalVersionTemp(fileName , <span class="literal">true</span> , <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//解压（防止更新下载不全，解压报错的文件占坑）</span></span><br><span class="line">        <span class="keyword">if</span> ( File.Exists(localUnZipPath) ) &#123;</span><br><span class="line">        	File.Delete(localUnZipPath);</span><br><span class="line">        &#125;</span><br><span class="line">        CompressUtil.DeCompress(localPath , localUnZipPath , <span class="literal">null</span>);</span><br><span class="line">        UpdateLocalVersionTemp(fileName , <span class="literal">true</span> , <span class="literal">true</span>);</span><br><span class="line">        updatedNum++;</span><br><span class="line">        Debug.Log(<span class="string">"down "</span> + updatedNum + <span class="string">"/"</span> + totalNeedUpdateNum + <span class="string">","</span> + fileName + <span class="string">"Loading complete"</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> ( Exception ex ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( fs != <span class="literal">null</span> )</span><br><span class="line">            fs.Close();</span><br><span class="line">    UpdateLocalVersionTemp(fileName , <span class="literal">false</span> , <span class="literal">false</span>);</span><br><span class="line">    isRight = <span class="literal">false</span>;</span><br><span class="line">    Debug.Log(ex.ToString());</span><br><span class="line">    <span class="comment">//解压出错，删除下载文件</span></span><br><span class="line">    <span class="keyword">if</span> ( File.Exists(localPath) ) &#123;</span><br><span class="line">            File.Delete(localPath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//StartDownLoad();</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ns != <span class="literal">null</span> ) &#123;</span><br><span class="line">            ns.Close();</span><br><span class="line">            ns = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( response != <span class="literal">null</span> ) &#123;</span><br><span class="line">            response.Close();</span><br><span class="line">            response = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( request != <span class="literal">null</span> ) &#123;</span><br><span class="line">            request.Abort();</span><br><span class="line">            request = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DownFile();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该代码脚本可以直接挂到对象上，完成资源的断点续传，断点续传主要是用于减小包体的，可以在玩家玩游戏的过程中，在后台开启一个线程来完成后续资源的下载。采用了断点续传技术也可以避免在下载的过程中由于网络不好，出现资源下载不完整的情况，在玩家不知情的情况下就完成了游戏资源的下载。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Unity-3D实战核心技术详解/" rel="tag"># Unity 3D实战核心技术详解</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/01/Unity的C-知识点之Default的三种常用法实例/" rel="next" title="Unity的C#知识点之Default的三种常用法实例">
                <i class="fa fa-chevron-left"></i> Unity的C#知识点之Default的三种常用法实例
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/01/FSM有限状态机在游戏中的运用/" rel="prev" title="FSM有限状态机在游戏中的运用">
                FSM有限状态机在游戏中的运用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Chebin">
            
              <p class="site-author-name" itemprop="name">Chebin</p>
              <div class="site-description motion-element" itemprop="description">记录自己的学习过程</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">470</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">68</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2020/06/02/第10章-K最近邻算法/" title="第10章 K最近邻算法" target="_blank">第10章 K最近邻算法</a>
                  </li>
                
                  <li>
                    <a href="/2020/06/02/第9章-动态规划/" title="第9章 动态规划" target="_blank">第9章 动态规划</a>
                  </li>
                
                  <li>
                    <a href="/2020/06/02/第11章-接下来如何做/" title="第11章 接下来如何做" target="_blank">第11章 接下来如何做</a>
                  </li>
                
                  <li>
                    <a href="/2020/06/02/第8章-贪婪算法/" title="第8章 贪婪算法" target="_blank">第8章 贪婪算法</a>
                  </li>
                
                  <li>
                    <a href="/2020/06/01/第7章-狄克斯特拉算法/" title="第7章 狄克斯特拉算法" target="_blank">第7章 狄克斯特拉算法</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#关于调试经验分享"><span class="nav-number">1.</span> <span class="nav-text">关于调试经验分享</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#移动端游戏防破解技术"><span class="nav-number">2.</span> <span class="nav-text">移动端游戏防破解技术</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#多线程资源下载技术"><span class="nav-number">3.</span> <span class="nav-text">多线程资源下载技术</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chebin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">4.9m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">74:54</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
