<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  观察者模式的官方定义是什么？背下来。 观察者模式的关键词是“一对多”怎么理解？ 观察者模式为什么属于行为型模式？ 理解行为型设计模式的关键是通信怎么理解？ “事件发生”与“功能执行”之间不要有太多的依赖性，所以在客户端控制怎么理解？ 动手画观察者模式设计图。 观察者模式需要list、foreach怎么理解？ 主题通知观察者的是主题自身的状态。不是一个单纯的触发flag让观察">
<meta name="keywords" content="设计模式与游戏完美开发">
<meta property="og:type" content="article">
<meta property="og:title" content="成就系统--观察者模式">
<meta property="og:url" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/index.html">
<meta property="og:site_name" content="车斌的博客">
<meta property="og:description" content="思考并回答以下问题：  观察者模式的官方定义是什么？背下来。 观察者模式的关键词是“一对多”怎么理解？ 观察者模式为什么属于行为型模式？ 理解行为型设计模式的关键是通信怎么理解？ “事件发生”与“功能执行”之间不要有太多的依赖性，所以在客户端控制怎么理解？ 动手画观察者模式设计图。 观察者模式需要list、foreach怎么理解？ 主题通知观察者的是主题自身的状态。不是一个单纯的触发flag让观察">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/1.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/2.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/3.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/4.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/5.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/6.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/7.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/8.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/9.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/10.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/11.png">
<meta property="og:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/12.png">
<meta property="og:updated_time" content="2019-09-01T03:06:21.457Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="成就系统--观察者模式">
<meta name="twitter:description" content="思考并回答以下问题：  观察者模式的官方定义是什么？背下来。 观察者模式的关键词是“一对多”怎么理解？ 观察者模式为什么属于行为型模式？ 理解行为型设计模式的关键是通信怎么理解？ “事件发生”与“功能执行”之间不要有太多的依赖性，所以在客户端控制怎么理解？ 动手画观察者模式设计图。 观察者模式需要list、foreach怎么理解？ 主题通知观察者的是主题自身的状态。不是一个单纯的触发flag让观察">
<meta name="twitter:image" content="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/1.png">






  <link rel="canonical" href="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>成就系统--观察者模式 | 车斌的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注，重复10遍</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chebincarl.github.io/2019/08/18/成就系统-观察者模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chebin">
      <meta itemprop="description" content="记录自己的学习过程">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">成就系统--观察者模式

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-18 23:17:20" itemprop="dateCreated datePublished" datetime="2019-08-18T23:17:20+08:00">2019-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-09-01 11:06:21" itemprop="dateModified" datetime="2019-09-01T11:06:21+08:00">2019-09-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">33k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">30 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>观察者模式的官方定义是什么？背下来。</li>
<li>观察者模式的关键词是“一对多”怎么理解？</li>
<li>观察者模式为什么属于行为型模式？</li>
<li>理解行为型设计模式的关键是通信怎么理解？</li>
<li>“事件发生”与“功能执行”之间不要有太多的依赖性，所以在客户端控制怎么理解？</li>
<li>动手画观察者模式设计图。</li>
<li>观察者模式需要list、foreach怎么理解？</li>
<li>主题通知观察者的是主题自身的状态。不是一个单纯的触发flag让观察者去执行观察者的方法。报纸订阅例子中报社（主题）告诉订阅者的是报纸上的信息。怎么理解？</li>
<li>旧版的问题在哪里？新版如何优化？每个游戏都要有游戏事件系统吗？</li>
<li>只允许客户端改动代码，处理关系，其他地方只准扩展，怎么理解？想增删订阅者怎么办？</li>
<li>全部都在PBaseDefenseGame里处理怎么理解？</li>
<li>比原架构多加一个观察者接口是构建观察者模式最重要的一步。使用设计模式时就要新建接口，比如工厂模式，观察者模式等，一听到使用设计模式，第一反应应该是新建接口。怎么理解？</li>
<li>如果给你一个旧的架构，让你改成观察者模式，第一件事要做什么？</li>
<li>主题接口管理观察者，主题的内容及更新由具体主题实现。也可以省略主题接口，但是观察者接口不能省略。怎么理解？</li>
<li>信息的推与拉有什么区别？各有什么优点和缺点？</li>
</ul>
<a id="more"></a>

<p>本章涵盖：</p>
<ul>
<li>成就系统</li>
<li>观察者模式<ul>
<li>观察者模式的定义</li>
<li>观察者模式的说明</li>
<li>使用观察者模式的优点</li>
<li>观察者模式的实现范例</li>
</ul>
</li>
<li>使用观察者模式实现成就系统<ul>
<li>成就系统的新架构</li>
<li>实现说明</li>
<li>使用观察者模式的优点</li>
<li>实现观察者模式时的注意事项</li>
</ul>
</li>
<li>观察者模式面对变化时</li>
<li>结论</li>
</ul>
<h1 id="成就系统"><a href="#成就系统" class="headerlink" title="成就系统"></a><span style="color:#339AFF;">成就系统</span></h1><p>成就系统（AchievementSystem），是早期单机游戏就出现的一种系统，例如：收集到多少颗星星就能开启特定关卡、全装备收集完成就能额外获得另一组套装等等。这些收集的项目并不会影响游戏主线的进行，也不与游戏主要的玩法相关。但增加这些成就项目，有助于游戏的可玩性，并提升玩家对游戏的挑战和目标的追求。</p>
<p>成就系统中的项目，都会和游戏本身有关，并且在玩家游玩的过程中，就能顺便收集，或是反复进行某项操作就能实现目标。<span style="color:red">一般可以先将成就项目分门别类</span>，例如属于<span style="color:red">总数类</span>的可能有累积击杀敌方角色达100次、训练我方单位达100个等；也有的是<span style="color:red">目标完成</span>的项目，如完成训练一个等级3的玩家角色、成功打倒一个Boss等。所以，在实现成就系统之前，需要企划单位先将需要的成就事件列出来，并在项目完成到某个段落之后，才开始加入实现开发中。实现上，会先定义“游戏事件”（ENUM_GameEvent），如敌方角色阵亡、玩家角色阵亡、玩家角色升级等。当游戏进行过程中，有任何“游戏事件”被触发时，系统就要通知对应的“成就项目”，进行累积或条件判断，如果达到，则完成“成就项目”并通知玩家或直接给予奖励，如图1所示。</p>
<blockquote>
<p>图1 成就系统与玩家奖励</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/1.png">

<p>一个简单的设计方式是，我们可以把通知成就系统的程序代码加入到“成就事件触发”的方法中。例如，击杀敌方角色，实现时就可以加在敌方角色阵亡的地方：</p>
<blockquote>
<p>Listing1 Enemy角色接口</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">IEnemy</span> : <span class="title">ICharacter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 被武器攻击</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UnderAttack</span>(<span class="params">ICharacter Attacker</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 计算伤害值</span></span><br><span class="line">        m_Attribute.CalDmgValue(Attacker);</span><br><span class="line"></span><br><span class="line">        DoPlayHitSound(); <span class="comment">// 音效</span></span><br><span class="line">        DoShowHitEffect(); <span class="comment">// 特效</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否阵亡</span></span><br><span class="line">        <span class="keyword">if</span> (m_Attribute.GetNowHP() &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;   </span><br><span class="line">            Killed();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通知成就系统</span></span><br><span class="line">            AchievementSystem.NotifyGameEvent(ENUM_GameEvent.EnemyKilled, <span class="keyword">this</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事件触发后，调用成就系统（AchievementSystem）中的NotifyGameEvent方法，并将触发的游戏事件及触发时的敌方角色传入。上述范例中，<span style="color:red">使用枚举（ENUM）的方式来定义“游戏事件”</span>，并将事件从参数行传入，而不是针对每一个游戏事件定义特定的调用方法，这样做可以避免成就系统定义过多的接口方法。而成就系统的NotifyGameEvent方法，可根据参数传入的“游戏事件”参数，来决定后续的处理流程：</p>
<blockquote>
<p>Listing2 成就系统</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AchievementSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 记录的成就项目</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_EnemyKilledCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_SoldierKilledCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_StageLv =  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_KillOgreEquipRocket=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知游戏事件发生</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">NotifyGameEvent</span>(<span class="params">ENUM_GameEvent emGameEvent, System.Object Param1, System.Object Param2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 按照游戏事件</span></span><br><span class="line">        <span class="keyword">switch</span>( emGameEvent )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.EnemyKilled:  <span class="comment">// 敌方单位阵亡</span></span><br><span class="line">                Notify_EnemyKilled(Param1 <span class="keyword">as</span> IEnemy );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.SoldierKilled:  <span class="comment">// 玩家单位阵亡</span></span><br><span class="line">                Notify_SoldierKilled( Param1 <span class="keyword">as</span> ISoldier );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.SoldierUpgrade:  <span class="comment">// 玩家单位升级</span></span><br><span class="line">                Notify_SoldierUpgrade( Param1 <span class="keyword">as</span> ISoldier );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.NewStage:       <span class="comment">// 新关卡</span></span><br><span class="line">                Notify_NewStage((<span class="keyword">int</span>)Param1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为“游戏事件”非常多，所以在NotifyGameEvent方法中先判断emGameEvent的参数属性，再分别调用对应的私有成员方法，而每个私有成员方法，再按照企划的需求，累积计算属性或判断单次成就是否实现。</p>
<blockquote>
<p>Listing3 成就系统</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AchievementSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 敌方单位阵亡</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Notify_EnemyKilled</span>(<span class="params">IEnemy theEnemy </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 阵亡数增加</span></span><br><span class="line">        m_EnemyKilledCount++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 击倒装备Rocket的Ogre</span></span><br><span class="line">        <span class="keyword">if</span>( theEnemy.GetEnemyType() == ENUM_Enemy.Ogre &amp;&amp; theEnemy.GetWeapon().GetWeaponType() == ENUM_Weapon.Rocket)</span><br><span class="line">            m_KillOgreEquipRocket = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 玩家单位阵亡</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Notify_SoldierKilled</span>(<span class="params"> ISoldier theSoldier</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 玩家单位升级</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Notify_SoldierUpgrade</span>(<span class="params"> ISoldier theSoldier</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新关卡</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Notify_NewStage</span>(<span class="params"> <span class="keyword">int</span> StageLv</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果让成就系统（AchievementSystem）负责每一个游戏事件的方法，并针对每一个单独的游戏事件，去进行“成就项目的累积或判断”，<span style="color:red">会让成就系统的扩充被限制在每个游戏事件处理方法中</span>。当以后需要针对某一个游戏事件增加成就项目时，就必须通过修改原有“游戏事件处理方法”中的程序代码才能达成。例如，想再增加一个成就项目“杀死装备武器为Rocket以上的敌人数”，那么就只能修改Notify_EnemyKilled方法，在其中追加程序代码来实现修改的目标。</p>
<p>此外，“游戏事件”发生时可能不是只有成就系统会被影响，其他系统也可能需要追踪相关的游戏事件。因此，如果都是在“游戏事件”的触发点进行每个系统调用的话，那么触发点的程序代码将会变得非常复杂：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Enemy角色接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">IEnemy</span> : <span class="title">ICharacter</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 被武器攻击</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UnderAttack</span>(<span class="params">ICharacter Attacker</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 是否阵亡</span></span><br><span class="line">        <span class="keyword">if</span>(m_Attribute.GetNowHP() &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Killed();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通知成就系统</span></span><br><span class="line">            AchievementSystem.NotifyGameEvent(ENUM_GameEvent.EnemyKilled, <span class="keyword">this</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通知B系统</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 通知C系统</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 通知D系统</span></span><br><span class="line">            ...</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以要将“游戏事件”与“成就系统”分开，<span style="color:red">让成就系统仅关注于某些游戏事件的发生；而游戏事件的发生，也不是只提供给成就系统使用</span>（可以在客户端随意组装）。这样的设计才是适当的设计。</p>
<p>要如何完成这样的设计呢？如果能<span style="color:red"><strong>将“游戏事件的产生与通知”独立成为一个系统</strong></span>，并且让其他系统能通过“订阅”或“关注”的方式，来追踪游戏事件系统发生的事。也就是，<span style="color:red">当游戏事件系统发生事件时，会负责去通知所有“订阅”了游戏事件的系统，此时被通知的系统，再根据自己的系统逻辑自行决定后续的处理操作</span>。如果能按照上述流程来进行设计，就是一个极为适当的设计。上述的流程，其实就是观察者模式所要表达的内容，如图2所示。</p>
<blockquote>
<p>图2 由事件触发其他相关的系统</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/2.png">

<h1 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a><span style="color:#339AFF;">观察者模式</span></h1><p>观察者模式与命令模式（Command）是很相似的模式，两者都是希望<span style="color:red">“事件发生”与“功能执行”之间不要有太多的依赖性</span>，不过，还是可以按照系统的使用需求，分析出应该运用哪个模式。命令模式（Command）已经在<a href="/2019/08/16/兵营训练单位-命令模式/" title="兵营训练单位-命令模式">兵营训练单位-命令模式</a>中详细说明过了，接下来将说明观察者模式，另外，在<a href="#jump">实现观察者模式时的注意事项</a>一节中也将说明，如何根据系统的需要在这两个模式中，选择合适的模式进行实现。</p>
<h2 id="观察者模式的定义"><a href="#观察者模式的定义" class="headerlink" title="观察者模式的定义"></a><span style="color:#00ACC1;">观察者模式的定义</span></h2><p>GoF对观察者模式的定义为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在对象之间定义一个一对多的连接方法，当一个对象变换状态时，其他关联的对象都会自动收到通知。</span><br></pre></td></tr></table></figure>

<p>社交网站就是最佳的观察者模式实现范例。当我们在社交网站上，与另一位用户成为好友、加入一个粉丝团或关注另一位用户的状态，那么当这些好友、粉丝团、用户有任何的新的动态或状态变动时，就会在我们动态页面上“主动”看到这些对象更新的情况，而不必到每一位好友或粉丝团中查看，如图3所示。</p>
<blockquote>
<p>图3 社交网站上的关注对象的更新</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/3.png">

<p>在早期社交网站还没广泛流行之前，说明观察者模式常以“报社-订户”来做说明：多位订户向报社“订阅（Subscribe）”了一份报纸，而报社针对昨天的新闻整理编辑之后，在今天一早进行“发布（Publish）”的工作，接着送报生会主动按照订阅的信息，将每份报纸送到订户手上，如图4所示。</p>
<blockquote>
<p>图4 向报社订阅后，报纸每日会送达到指定的订户手上</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/4.png">

<p>在上面的案例中，都存在“主题目标”与其他“订阅者/关注者”之间的关系（一对多），当主题有变化时，就会通过之前建立的“关系”，将<span style="color:red">更新的信息</span>（报纸有内容）传送给“订阅者/关注者”。因此，实现上可分为以下几点：</p>
<ul>
<li>主题者、订阅者的角色；</li>
<li>如何建立订阅者与主题者的关系；</li>
<li>主题者发布信息时，如何通知所有订阅者。</li>
</ul>
<h2 id="观察者模式的说明"><a href="#观察者模式的说明" class="headerlink" title="观察者模式的说明"></a><span style="color:#00ACC1;">观察者模式的说明</span></h2><p>GoF定义的观察者模式的类结构图如图5所示。</p>
<blockquote>
<p>图5 GOF定义的观察者模式的类结构图</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/5.png">

<p>GoF参与者的说明如下：</p>
<ul>
<li>Subject（主题接口）<ul>
<li>定义主题的接口。</li>
<li>让观察者通过接口方法，来订阅、解除订阅主题。这些观察者在主题内部可使用泛型容器加以管理。</li>
<li>在主题更新时，通知所有观察者。</li>
</ul>
</li>
<li>ConcreteSubject（主题实现）<ul>
<li>实现主题接口。</li>
<li>设置主题的内容及更新，当主题变化时，使用父类的通知方法告知所有的观察者。</li>
</ul>
</li>
<li>Observer（观察者接口）<ul>
<li>定义观察者的接口。</li>
<li>提供更新通知方法，让主题可以通知更新。</li>
</ul>
</li>
<li>ConcreteObserver（观察者实现）<ul>
<li>实现观察者接口。</li>
<li>针对主题的更新，按需求向主题获取更新状态。</li>
</ul>
</li>
</ul>
<h2 id="观察者模式的实现范例"><a href="#观察者模式的实现范例" class="headerlink" title="观察者模式的实现范例"></a><span style="color:#00ACC1;">观察者模式的实现范例</span></h2><p>实现观察者模式，首先定义Subject（主题接口）：</p>
<blockquote>
<p>Listing4 主题接口（Observer.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Subject</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;Observer&gt; m_Observers = <span class="keyword">new</span> List&lt;Observer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加入观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Attach</span>(<span class="params">Observer theObserver</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Observers.Add( theObserver );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Detach</span>(<span class="params">Observer theObserver</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Observers.Remove( theObserver );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知所有观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Notify</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>( Observer theObserver  <span class="keyword">in</span> m_Observers)</span><br><span class="line">            theObserver.Update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在类定义中，使用了一个C#的List泛型容器（m_Observers）来管理所有的Observer（观察者），并实现了3个与Observer（观察者）相关的方法。当某一个Observer，对Subject（主题）感兴趣时，就利用Attach方法将自己加入主题的管理器中，通过这样的方式，Observer就能主动与Subject建立关系。当Subject被更改而需要通知Observer时，只要遍历m_Observers就能通知每一个在容器内的Observer现在有Subject发生了更改。</p>
<p>以下程序范例实现了一个主题：</p>
<blockquote>
<p>Listing5 主题实现（Observer.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConcreteSubject</span> : <span class="title">Subject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">string</span> m_SubjectState;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetState</span>(<span class="params"><span class="keyword">string</span> State</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_SubjectState = State;</span><br><span class="line">        Notify();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetState</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_SubjectState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用一个字符串m_SubjectState来表示主题的状态，并提供方法（SetState）让客户端（Program.cs）可以设置主题，而当主题一旦变动时，即调用父类的通知（Notify）方法来通知所有的Observer（观察者）。</p>
<p>Observer（观察者）的接口定义如下：</p>
<blockquote>
<p>Listing6 观察者接口（Observer.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Observer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口内定义了一个更新（Update）方法，在主题通知更新时就会调用。范例内分别有两个子类实现了观察者接口：</p>
<blockquote>
<p>Listing7 实现两个Observer（Observer.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现的Observer1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConcreteObserver1</span> : <span class="title">Observer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">string</span> m_ObjectState;</span><br><span class="line"></span><br><span class="line">    ConcreteSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteObserver1</span>(<span class="params"> ConcreteSubject theSubject</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = theSubject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log (<span class="string">"ConcreteObserver1.Update"</span>);</span><br><span class="line">        <span class="comment">// 获取Subject状态</span></span><br><span class="line">        m_ObjectState = m_Subject.GetState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ShowState</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log (<span class="string">"ConcreteObserver1:Subject当前的主题:"</span>+m_ObjectState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现的Observer2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConcreteObserver2</span> : <span class="title">Observer</span></span><br><span class="line">&#123;           </span><br><span class="line">    ConcreteSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteObserver2</span>(<span class="params"> ConcreteSubject theSubject</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = theSubject;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log (<span class="string">"ConcreteObserver2.Update"</span>);</span><br><span class="line">        <span class="comment">// 获取Subject状态</span></span><br><span class="line">        Debug.Log (<span class="string">"ConcreteObserver2:Subject当前的主题:"</span>+m_Subject.GetState());</span><br><span class="line">    &#125;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个类在接收到通知之后的处理方式不太一样：ConcreteObserver1类先将信息保存之后，等待必要时刻（ShowState）才提示；而ConcreteObserver2类则是在收到主题的更新后，马上将更新的信息显示出来。两个类相同的地方在于，构造时都必须提供Subject（主题）的对象引用，让Observer（观察者）能够保存下来，这样做的主要原因是，因为上面范例实现的观察者模式属于“拉（pull）”模式，所以观察者类必须自己去向Subject（主题）获取信息（保存了主题的引用）。</p>
<p>在测试程序代码中，产生了主题（theSubject）之后，再分别将两个观察者（Observer）加入主题中，表示有两个观察者对主题感兴趣，<span style="color:red">此时可以增删订阅者，控制权完全在客户端这个本来就可以修改的文件这边</span>：</p>
<blockquote>
<p>Listing8 测试观察者模式（ObserverTest.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnitTest</span> (<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 主题</span></span><br><span class="line">    ConcreteSubject theSubject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加入观察者</span></span><br><span class="line">    ConcreteObserver1 theObserver1 = <span class="keyword">new</span> ConcreteObserver1(theSubject);</span><br><span class="line">    theSubject.Attach( theObserver1 );</span><br><span class="line">    theSubject.Attach( <span class="keyword">new</span> ConcreteObserver2(theSubject) );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置Subject</span></span><br><span class="line">    theSubject.SetState(<span class="string">"Subject状态1"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示状态</span></span><br><span class="line">    theObserver1.ShowState();   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试程序代码的后半段，对主题（theSubject）进行设置（SetState）：“Subject状态1”，信息栏上即可看到两个观察者被通知发生了更新：</p>
<blockquote>
<p>执行结果</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ConcreteObserver1.Update</span><br><span class="line">ConcreteObserver2.Update</span><br></pre></td></tr></table></figure>

<p>ConcreteObserver2在收到通知后会立即将信息显示出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConcreteObserver2:Subject当前的主题:Subject状态1</span><br></pre></td></tr></table></figure>

<p>而ConcreteObserver1则是在调用ShowState方法时，才将保留下来的主题状态显示出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConcreteObserver1:Subject当前的主题:Subject状态1</span><br></pre></td></tr></table></figure>

<p><font size="3"><strong>信息的推与拉</strong></font></p>
<p>主题（Subject）改变时，改变的内容要如何让观察者（Observer）得知，运行方式可分为推（Push）信息与拉（Pull）信息两种模式：</p>
<ul>
<li>推信息：主题将变动的内容主动“推”给观察者。一般会在调用观察者的通知（Update）方法时，同时将更新的内容当成参数传给观察者（Update方法里传参），例如传统的报社、杂志社的模式，每一次的发行都会将所有的内容一次发送给订阅者，所有的订阅者接到的信息都是一致的，然后订阅者再从中获取需要的信息来进行处理：<ul>
<li>优点：所有的内容都一次传送给观察者，省去观察者再向主题查询的操作，主题类也不需要定义太多的查询方式供观察者来查询。</li>
<li>缺点：如果推送的内容过多，容易使观察者收到不必要的信息或造成查询上的困难，不当的信息设置也可能造成系统性能的降低。</li>
</ul>
</li>
<li>拉信息：主题内容变动时，只是先通知观察者当前内容有变动，而观察者则是按照系统需求，再向主题查询（拉）所需的信息。<ul>
<li>优点：主题只通知当前内容有更新，再由观察者自己去获取所需的信息，因为观察者自己更知道需要哪些信息，所以不太会去获取不必要的信息。</li>
<li>缺点：因为观察者需要向主题查询更新的内容，所以主题必须提供查询方式，这样一来，就容易造成主题类的接口方法过多。</li>
</ul>
</li>
</ul>
<p>而在实现设计上，必须根据系统所需要的最佳情况来判断，是要使用“推信息”还是“拉信息”的方式。</p>
<h1 id="使用观察者模式实现成就系统"><a href="#使用观察者模式实现成就系统" class="headerlink" title="使用观察者模式实现成就系统"></a><span style="color:#339AFF;">使用观察者模式实现成就系统</span></h1><p>重构成就系统，可按照下面的步骤来进行：</p>
<ul>
<li>1.实现游戏事件系统（GameEventSystem）；</li>
<li>2.完成各个游戏事件的主题及其观察者；</li>
<li>3.实现成就系统（AchievementSystem）及订阅游戏事件；</li>
<li>4.重构游戏事件触发点。</li>
</ul>
<h2 id="成就系统的新架构"><a href="#成就系统的新架构" class="headerlink" title="成就系统的新架构"></a><span style="color:#00ACC1;">成就系统的新架构</span></h2><p>对于解决《P级阵地》成就系统的需求，<span style="color:red">首先应该完成的是游戏事件系统（GameEventSystem）</span>。在游戏事件系统中，会将每个游戏事件当成主题（Subject），让其他系统可针对感兴趣的游戏事件进行“订阅（Subscribe）”。当游戏事件被触发（Publish）时，游戏事件系统会去通知所有的系统，再让各个系统针对所需要的信息进行查询。</p>
<p>而成就系统将是游戏事件系统的一个订阅者/观察者。它将针对成就项目所需要的游戏事件进行订阅的操作，等到游戏事件系统发布游戏事件时，成就系统再去获取所需的信息来累积成就项目或判断成就项目是否达到。</p>
<p>图6显示了《P级阵地》中的游戏事件系统。</p>
<blockquote>
<p>图6 游戏事件系统</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/6.png">

<p>参与者的说明如下：</p>
<ul>
<li>GameEventSystem：游戏事件系统，用来管理游戏中发生的事件，针对每一个游戏事件产生一个“游戏事件主题（Subject）”，并提供接口方法让其他系统能订阅指定的游戏事件。</li>
<li>IGameEventSubject：游戏事件主题接口，负责定义《P级阵地》中“游戏事件”内容的接口，并延伸出下列的游戏事件主题：<ul>
<li>EnemyKilledSubject：敌方角色阵亡；</li>
<li>SoldierKilledSubject：玩家角色阵亡；</li>
<li>SoldierUpgradeSubject：玩家角色升级；</li>
<li>NewStageSubject：新关卡。</li>
</ul>
</li>
<li>IGameEventObserver：游戏事件观察者接口，负责《P级阵地》中游戏事件触发时被通知的操作接口。</li>
<li>EnemyKilledObserver 观察者们：订阅“敌方角色阵亡”主题（EnemyKilledSubject）的观察者类，共有：<ul>
<li>EnemyKilledObserverUI：将敌方角色阵亡信息显示在界面上。</li>
<li>EnemyKilledObserverStageScore：将敌方角色阵亡信息提供给关卡系统（StageSystem）。</li>
<li>EnemyKilledObserverAchievement：将敌方角色提供给成就系统（AchievementSystem）。</li>
</ul>
</li>
</ul>
<p><span style="color:red">同一个游戏事件可以提供给不同的系统一起订阅，并能同时接收到更新信息。</span></p>
<h2 id="实现说明"><a href="#实现说明" class="headerlink" title="实现说明"></a><span style="color:#00ACC1;">实现说明</span></h2><p>接下来，按结构图和实现流程来完成成就系统的重构：</p>
<p><font size="3"><strong>实现游戏事件系统</strong></font></p>
<p>游戏事件系统（GameEventSystem）用来管理游戏当中发生的事件，并针对每一个游戏事件，产生一个“游戏事件主题（Subject）”：</p>
<blockquote>
<p>Listing9 游戏事件系统的实现（GameEventSystem.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ENUM_GameEvent</span><br><span class="line">&#123;</span><br><span class="line">    Null           = <span class="number">0</span>,</span><br><span class="line">    EnemyKilled    = <span class="number">1</span>, <span class="comment">// 敌方单位阵亡</span></span><br><span class="line">    SoldierKilled  = <span class="number">2</span>, <span class="comment">// 玩家单位阵亡</span></span><br><span class="line">    SoldierUpgrade = <span class="number">3</span>, <span class="comment">// 玩家单位升级</span></span><br><span class="line">    NewStage       = <span class="number">4</span>, <span class="comment">// 新关卡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 游戏事件系统</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameEventSystem</span> : <span class="title">IGameSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 使用字典缓存对应的事件和主题</span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;ENUM_GameEvent, IGameEventSubject&gt; m_GameEvents = <span class="keyword">new</span> Dictionary&lt;ENUM_GameEvent, IGameEventSubject&gt;(); </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameEventSystem</span>(<span class="params">PBaseDefenseGame PBDGame</span>) : <span class="title">base</span>(<span class="params">PBDGame</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Initialize();</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 释放</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Release</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_GameEvents.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 为某一主题注册一个观察者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过事件得到主题，然后调用主题Attach方法注册观察者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 观察者持有主题的一个引用用于向主题查询信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="emGameEvent"&gt;</span>事件枚举<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="Observer"&gt;</span>要监听该事件的观察者类<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterObserver</span>(<span class="params">ENUM_GameEvent emGameEvent, IGameEventObserver Observer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 获取事件</span></span><br><span class="line">        IGameEventSubject Subject = GetGameEventSubject( emGameEvent );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( Subject != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Subject.Attach( Observer );</span><br><span class="line">            Observer.SetSubject( Subject );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据事件返回对应的具体主题类实例</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 使用字典进行缓存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="emGameEvent"&gt;</span>事件枚举<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>具体主题类实例<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IGameEventSubject <span class="title">GetGameEventSubject</span>(<span class="params"> ENUM_GameEvent emGameEvent </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 是否已经存在</span></span><br><span class="line">        <span class="keyword">if</span>( m_GameEvents.ContainsKey( emGameEvent ))</span><br><span class="line">            <span class="keyword">return</span> m_GameEvents[emGameEvent];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 产生对应的GameEvent</span></span><br><span class="line">        IGameEventSubject pSujbect= <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>( emGameEvent )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.EnemyKilled:</span><br><span class="line">                pSujbect = <span class="keyword">new</span> EnemyKilledSubject();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.SoldierKilled:</span><br><span class="line">                pSujbect = <span class="keyword">new</span> SoldierKilledSubject();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.SoldierUpgrade:</span><br><span class="line">                pSujbect = <span class="keyword">new</span> SoldierUpgradeSubject();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ENUM_GameEvent.NewStage:</span><br><span class="line">                pSujbect = <span class="keyword">new</span> NewStageSubject();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Debug.LogWarning(<span class="string">"还没有针对["</span>+emGameEvent+<span class="string">"]指定要产生的Subject类"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加入后并返回</span></span><br><span class="line">        m_GameEvents.Add (emGameEvent, pSujbect );</span><br><span class="line">        <span class="keyword">return</span> pSujbect;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置发生事件时，主题想传给观察者的参数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="emGameEvent"&gt;</span>事件枚举<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="Param"&gt;</span>要传递给观察者的数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">NotifySubject</span>(<span class="params"> ENUM_GameEvent emGameEvent, System.Object Param</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 是否存在</span></span><br><span class="line">        <span class="keyword">if</span>( m_GameEvents.ContainsKey( emGameEvent ) == <span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.Log("SubjectAddCount["+emGameEvent+"]");</span></span><br><span class="line">        m_GameEvents[emGameEvent].SetParam( Param );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类中使用了Dictionary泛型容器来管理所有的游戏事件主题，私有方法GetGameEventSubject负责管理这个Dictionary泛型容器。新增时，针对每一个游戏事件产生对应的主题（Subject）后加入容器内，并且<span style="color:red">保证一个游戏事件只存在一个主题对象</span>。</p>
<p>注册观察者（RegisterObserver）方法用于其他系统向游戏事件系统（GameEventSystem）订阅主题，调用时传入指定的游戏事件及观察者类对象。当某游戏事件触发时，通过通知主题更新（NotifySubject）方法，就能通知所有订阅该游戏事件主题的观察者类。</p>
<p>游戏事件主题（IGameEventSubject）负责定义《P级阵地》中“游戏事件”内容的接口：</p>
<blockquote>
<p>Listing10 游戏事件主题（IGameEventSubject.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IGameEventSubject</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;IGameEventObserver&gt; m_Observers = <span class="keyword">new</span> List&lt;IGameEventObserver&gt;(); <span class="comment">// 观察者</span></span><br><span class="line">    <span class="keyword">private</span> System.Object m_Param = <span class="literal">null</span>;   <span class="comment">// 发生事件时附加的参数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加入</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Attach</span>(<span class="params">IGameEventObserver theObserver</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Observers.Add( theObserver );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Detach</span>(<span class="params">IGameEventObserver theObserver</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Observers.Remove( theObserver );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Notify</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>( IGameEventObserver theObserver  <span class="keyword">in</span> m_Observers)</span><br><span class="line">            theObserver.Update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置参数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetParam</span>(<span class="params"> System.Object Param </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Param = Param;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类中定义了一个List泛型容器m_Observers，用来管理订阅主题的观察者，类提供了基本的新增、取消及通知方法来管理订阅者，并提供设置参数（SetParam）方法来设置每一个游戏事件所需提供的内容。</p>
<p><font size="3"><strong>完成各个游戏事件主题及其观察者</strong></font></p>
<p>以下是4个《P级阵地》定义的游戏事件主题。</p>
<p><strong>①敌人角色阵亡</strong></p>
<p>敌人角色阵亡时会发出通知，并将阵亡的敌人角色IEnemy使用SetParam方法传入，传入后再增加内部的计数器，提供给观察者查询：</p>
<blockquote>
<p>Listing11 敌人单位阵亡（EnemyKilledSubject.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyKilledSubject</span> : <span class="title">IGameEventSubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_KilledCount = <span class="number">0</span>; <span class="comment">//  当前敌人单位阵亡数</span></span><br><span class="line">    <span class="keyword">private</span> IEnemy m_Enemy = <span class="literal">null</span>; <span class="comment">// 敌人角色</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnemyKilledSubject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnemy <span class="title">GetEnemy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_Enemy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前敌人单位阵亡数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetKilledCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_KilledCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知敌人单位阵亡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetParam</span>(<span class="params"> System.Object Param </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.SetParam( Param);</span><br><span class="line">        m_Enemy = Param <span class="keyword">as</span> IEnemy;</span><br><span class="line">        m_KilledCount ++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知</span></span><br><span class="line">        Notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>②玩家角色阵亡</strong></p>
<p>玩家角色阵亡时会发出通知，并将阵亡的玩家角色ISoldier使用SetParam方法传入，传入后再增加内部的计数器，提供给观察者查询：</p>
<blockquote>
<p>Listing12 Soldier单位阵亡（SoldierKilledSubject.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierKilledSubject</span> : <span class="title">IGameEventSubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_KilledCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> ISoldier m_Soldier = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldierKilledSubject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ISoldier <span class="title">GetSoldier</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_Soldier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前我方单位阵亡数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetKilledCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_KilledCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知我方单位阵亡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetParam</span>(<span class="params"> System.Object Param </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.SetParam( Param);</span><br><span class="line">        m_Soldier = Param <span class="keyword">as</span> ISoldier;</span><br><span class="line">        m_KilledCount ++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知</span></span><br><span class="line">        Notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>③玩家角色升级</strong></p>
<p>玩家角色升级时会发出通知，升级的玩家角色ISoldier会使用SetParam方法传入，传入后再增加内部的计数器，提供给观察者查询：</p>
<blockquote>
<p>Listing13 Soldier升级（SoldierUpgradeSubject.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierUpgradeSubject</span> : <span class="title">IGameEventSubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_UpgradeCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> ISoldier m_Soldier = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldierUpgradeSubject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前升级次数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetUpgradeCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_UpgradeCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知Soldier单位升级</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetParam</span>(<span class="params"> System.Object Param </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.SetParam( Param);</span><br><span class="line">        m_Soldier = Param <span class="keyword">as</span> ISoldier;</span><br><span class="line">        m_UpgradeCount++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知</span></span><br><span class="line">        Notify();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ISoldier <span class="title">GetSoldier</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_Soldier;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>④进入新关卡</strong></p>
<p>玩家完成一个新关卡往下一个关卡推进时会收到通知，当前的关卡编号会使用SetParam方法传入，传入后再存储至内部成员中，提供给观察者查询：</p>
<blockquote>
<p>Listing14 新的关卡（NewStageSubject.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewStageSubject</span> : <span class="title">IGameEventSubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_StageCount = <span class="number">1</span>; <span class="comment">// 当前关卡数</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewStageSubject</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前关卡数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetStageCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_StageCount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetParam</span>(<span class="params"> System.Object Param </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.SetParam( Param);</span><br><span class="line">        m_StageCount = (<span class="keyword">int</span>)Param;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通知</span></span><br><span class="line">        Notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的4个主题分别都有对应的订阅者:</p>
<p><strong>①“敌方角色阵亡”主题的观察者</strong></p>
<p>“敌方角色阵亡”主题的观察者共有3个，而这些观察者最后都会将信息返回给注册它们的系统中，如图7所示。</p>
<blockquote>
<p>图7 “敌方角色阵亡”主题的3个观察者</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/7.png">

<blockquote>
<p>Listing15 实现Enemy阵亡事件的观察者</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UI观察Enemey阵亡事件（EnemyKilledObserverUI.cs）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyKilledObserverUI</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> EnemyKilledSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> PBaseDefenseGame m_PBDGame = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnemyKilledObserverUI</span>(<span class="params"> PBaseDefenseGame PBDGame </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_PBDGame = PBDGame;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> EnemyKilledSubject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log("EnemyKilledObserverUI.Update: Count["+ m_Subject.GetKilledCount() +"]");</span></span><br><span class="line">        <span class="keyword">if</span>(m_PBDGame != <span class="literal">null</span>)</span><br><span class="line">            m_PBDGame.ShowGameMsg(<span class="string">"敌方单位阵亡"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成就观察Enemey阵亡事件（EnemyKilledObserverAchievement.cs）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyKilledObserverAchievement</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> EnemyKilledSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> AchievementSystem m_AchievementSystem = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnemyKilledObserverAchievement</span>(<span class="params">AchievementSystem  AchievementSystem</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AchievementSystem = AchievementSystem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> EnemyKilledSubject;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log("EnemyKilledObserverAchievement.Update: Count["+ m_Subject.GetKilledCount() +"]");</span></span><br><span class="line">        m_AchievementSystem.AddEnemyKilledCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关卡分数观察Enemey阵亡事件（EnemyKilledObserverStageScore.cs）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyKilledObserverStageScore</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> EnemyKilledSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> StageSystem m_StageSystem = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnemyKilledObserverStageScore</span>(<span class="params"> StageSystem theStageSystem </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_StageSystem = theStageSystem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> EnemyKilledSubject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log("EnemyKilledObserverUI.Update: Count["+ m_Subject.GetKilledCount() +"]");</span></span><br><span class="line">        m_StageSystem.SetEnemyKilledCount( m_Subject.GetKilledCount() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 兵营观察Enemy阵亡事件（EnemyKilledObserverCaptiveCamp.cs）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyKilledObserverCaptiveCamp</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> EnemyKilledSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> CampSystem m_CampSystem = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnemyKilledObserverCaptiveCamp</span>(<span class="params">CampSystem  theCampSystem</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_CampSystem = theCampSystem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> EnemyKilledSubject;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 累计阵亡10以上是即展示俘兵营</span></span><br><span class="line">        <span class="keyword">if</span>( m_Subject.GetKilledCount() &gt; <span class="number">10</span> ) </span><br><span class="line">            m_CampSystem.ShowCaptiveCamp();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而原本关卡系统对于敌方阵亡次数的获取，也因为新增了游戏事件系统（GameEventSystem），而改由观察者EnemyKilledObserverStageScore进行设置。</p>
<p><strong>②“玩家角色阵亡”主题的观察者</strong></p>
<p>“玩家角色阵亡”主题的观察者，最后会将信息反馈给成就系统（AchievementSystem）和玩家角色信息接口，如图8所示。</p>
<blockquote>
<p>图8 “玩家角色阵亡”主题的两个观察者</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/8.png">

<blockquote>
<p>Listing16 实现Soldier阵亡事件的观察者</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 成就观察Soldier阵亡事件（SoldierKilledObserverAchievement.cs）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierKilledObserverAchievement</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> SoldierKilledSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> AchievementSystem m_AchievementSystem = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldierKilledObserverAchievement</span>(<span class="params">AchievementSystem  AchievementSystem</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AchievementSystem = AchievementSystem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> SoldierKilledSubject;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AchievementSystem.AddSoldierKilledCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UI观察Soldier阵亡事件（SoldierKilledObserverUI.cs）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierKilledObserverUI</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> SoldierKilledSubject m_Subject = <span class="literal">null</span>; <span class="comment">// 主题</span></span><br><span class="line">    <span class="keyword">private</span> SoldierInfoUI m_InfoUI = <span class="literal">null</span>;  <span class="comment">//  要通知的界面</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldierKilledObserverUI</span>(<span class="params"> SoldierInfoUI InfoUI  </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_InfoUI = InfoUI;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> SoldierKilledSubject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 通知界面更新</span></span><br><span class="line">        m_InfoUI.RefreshSoldier( m_Subject.GetSoldier() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>③“玩家角色升级”主题的观察者</strong></p>
<p>“玩家角色升级”主题的观察者，也会通知玩家角色信息接口，如图9所示。</p>
<blockquote>
<p>图9 “玩家角色升级”主题的观察者</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/9.png">

<blockquote>
<p>Listing17 实现UI观察Soldier升级事件（SoldierUpgradeObserverUI.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierUpgradeObserverUI</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> SoldierUpgradeSubject m_Subject = <span class="literal">null</span>; <span class="comment">// 主题</span></span><br><span class="line">    <span class="keyword">private</span> SoldierInfoUI m_InfoUI = <span class="literal">null</span>;  <span class="comment">//  要通知的界面</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldierUpgradeObserverUI</span>(<span class="params"> SoldierInfoUI InfoUI  </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_InfoUI = InfoUI;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> SoldierUpgradeSubject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 通知界面更新</span></span><br><span class="line">        m_InfoUI.RefreshSoldier( m_Subject.GetSoldier() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>④“进入新关卡”主题的观察者</strong></p>
<p>“进入新关卡主题”的观察者，最后也是通知成就系统（AchievementSystem），如图10所示。</p>
<blockquote>
<p>图10 “进入新关卡主题”的观察者</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/10.png">

<blockquote>
<p>Listing18 成就观察新关卡（NewStageObserverAchievement.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewStageObserverAchievement</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> NewStageSubject m_Subject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> AchievementSystem m_AchievementSystem = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewStageObserverAchievement</span>(<span class="params">AchievementSystem  AchievementSystem</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AchievementSystem = AchievementSystem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject Subject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Subject = Subject <span class="keyword">as</span> NewStageSubject;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 被通知Subject的更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_AchievementSystem.SetNowStageLevel( m_Subject.GetStageCount() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到了这个阶段，游戏事件系统（GameEventSystem）算是构建完成，让我们再回到本章开始时讨论的成就系统，配合游戏事件系统的订阅机制，新的成就系统被重构为：只记录相关的成就事项，并提供相关的接口方法，让与成就事项相关的观察者们使用。其结构图如图11所示。</p>
<blockquote>
<p>图11 重构后的新成就系统（AchievementSystem）</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/11.png">

<p><font size="3"><strong>实现成就系统及订阅游戏事件</strong></font></p>
<p>上图中，有许多的观察者们，这些观察者们在成就系统初始化时就会被加入到游戏事件系统中，而重构后的类也较为简单、清楚：</p>
<p>首先在PBaseDefenseGame中封装相关方法：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PBaseDefenseGame</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 注册游戏事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterGameEvent</span>(<span class="params"> ENUM_GameEvent emGameEvent, IGameEventObserver Observer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_GameEventSystem.RegisterObserver( emGameEvent , Observer );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知游戏事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">NotifyGameEvent</span>(<span class="params"> ENUM_GameEvent emGameEvent, System.Object Param </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_GameEventSystem.NotifySubject( emGameEvent, Param);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Listing19 成就系统（AchievementSystem.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AchievementSystem</span> : <span class="title">IGameSystem</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 记录的成就项目</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_EnemyKilledCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_SoldierKilledCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_StageLv =  <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AchievementSystem</span>(<span class="params">PBaseDefenseGame PBDGame</span>):<span class="title">base</span>(<span class="params">PBDGame</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Initialize</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Initialize ();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册相关观察者</span></span><br><span class="line">        m_PBDGame.RegisterGameEvent( ENUM_GameEvent.EnemyKilled  , <span class="keyword">new</span> EnemyKilledObserverAchievement(<span class="keyword">this</span>));</span><br><span class="line">        m_PBDGame.RegisterGameEvent( ENUM_GameEvent.SoldierKilled, <span class="keyword">new</span> SoldierKilledObserverAchievement(<span class="keyword">this</span>));</span><br><span class="line">        m_PBDGame.RegisterGameEvent( ENUM_GameEvent.NewStage     , <span class="keyword">new</span> NewStageObserverAchievement(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加Enemy阵亡数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddEnemyKilledCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log ("AddEnemyKilledCount");</span></span><br><span class="line">        m_EnemyKilledCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加Soldier阵亡数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddSoldierKilledCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log ("AddSoldierKilledCount");</span></span><br><span class="line">        m_SoldierKilledCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前关卡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetNowStageLevel</span>(<span class="params"> <span class="keyword">int</span> NowStageLevel </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log ("SetNowStageLevel");</span></span><br><span class="line">        m_StageLv = NowStageLevel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font size="3"><strong>重构游戏事件触发点</strong></font></p>
<p>对于重构完的游戏事件系统及成就系统来说，当游戏事件触发时，只要调用游戏事件系统中的信息通知（NotifySubject）方法，就能通过其中的观察者模式将信息广播给所有的相关系统：</p>
<blockquote>
<p>Listing20 管理产生出来的角色（CharacterSystem.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CharacterSystem</span> : <span class="title">IGameSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 删除角色</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveCharacter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 删除可以删除的角色</span></span><br><span class="line">        RemoveCharacter( m_Soldiers, m_Enemys, ENUM_GameEvent.SoldierKilled );</span><br><span class="line">        RemoveCharacter( m_Enemys, m_Soldiers, ENUM_GameEvent.EnemyKilled);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除角色</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveCharacter</span>(<span class="params">List&lt;ICharacter&gt; Characters, List&lt;ICharacter&gt; Opponents, ENUM_GameEvent emEvent</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 分別获取可以删除及存活的角色</span></span><br><span class="line">        List&lt;ICharacter&gt; CanRemoves = <span class="keyword">new</span> List&lt;ICharacter&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>( ICharacter Character <span class="keyword">in</span> Characters)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 是否阵亡</span></span><br><span class="line">            <span class="keyword">if</span>( Character.IsKilled() == <span class="literal">false</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  是否确认过阵亡事件</span></span><br><span class="line">            <span class="keyword">if</span>( Character.CheckKilledEvent()==<span class="literal">false</span>)            </span><br><span class="line">                m_PBDGame.NotifyGameEvent( emEvent,Character );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否可以删除</span></span><br><span class="line">            <span class="keyword">if</span>( Character.CanRemove())</span><br><span class="line">                CanRemoves.Add (Character);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随着游戏事件系统的完成，相关的游戏事件也从原有的调用点，重构到合适的地点进行调用。通过图12的流程图，就能了解类对象之间的互动情况。</p>
<blockquote>
<p>图12 成就系统及其相关系统的流程图</p>
</blockquote>
<img src="/2019/08/18/成就系统-观察者模式/12.png">

<h2 id="使用观察者模式的优点"><a href="#使用观察者模式的优点" class="headerlink" title="使用观察者模式的优点"></a><span style="color:#00ACC1;">使用观察者模式的优点</span></h2><p>成就系统以“游戏事件”为基础，记录每个游戏事件发生的次数及时间点，作为成就项目的判断依据。但是当同一个游戏事件被触发后，可能不只是只有一个成就系统会被触发，系统中也可能存在着其他系统需要使用同一个游戏事件。因此，加入了以观察者模式为基础的游戏事件系统，就可以有效地解除“游戏事件的发生”与有关的“系统功能调用”之间的绑定。这样在游戏事件发生时，不必理会后续的处理工作，而是交给游戏事件主题负责调用观察者/订阅者。此外，也能同时调用多个系统同时处理这个事件引发的后续操作。</p>
<h2 id="实现观察者模式时的注意事项"><a href="#实现观察者模式时的注意事项" class="headerlink" title="实现观察者模式时的注意事项"></a><span style="color:#00ACC1;"><span id="jump">实现观察者模式时的注意事项</span></span></h2><p><font size="3"><strong>双向与单向信息通知</strong></font></p>
<p>社交网页上的“粉丝团”比较像是观察者模式：当粉丝团上发布了一则新的动态后，所有订阅的用户都可以看到新增的动态，而用户与用户之间则是同时扮演“主题”与“观察者”的角色，除了同时收到其他好友的动态信息，当自己有任何的动态消息时，也会同时广播给好友们（观察者）。</p>
<p><font size="3"><strong>类过多的问题</strong></font></p>
<p>“游戏事件”“游戏事件主题（IGameEventSubject）”会随着项目的开发不断地增加，与此同时，这些主题的观察者的数量也会随之上升。从当前的《P级阵地》内容来看，已经产生了7个游戏事件观察者类（IGameEventObserver），所以不难想象，在大型项目可能会产生非常多的观察者类。当然，在某些情况下类过多，反而是个缺点。因此，<span style="color:red">如果想要减少类的产生，可以考虑向游戏的主题注册时，不要使用“类对象”而是使用“回调函数”，之后再将功能相似的“回调函数”以同一个类来管理，就能减少过多类的问题</span>。这一部分的解决方式与<a href="/2019/08/16/兵营训练单位-命令模式/" title="兵营训练单位-命令模式">兵营训练单位-命令模式</a>解决大量请求命令时的想法是一样的，读者可以回顾相关的内容。</p>
<p><font size="3"><strong>比较命令模式（Command）与观察者模式</strong></font></p>
<p>这两个模式都是着重在于将“发生”与“执行”这两个操作消除耦合（或减少依赖性）的模式。当观察者模式中的主题只存在一个观察者时，就非常像是命令模式的基本架构，但还是有一些差异可以分辨出两个模式应用的时机：</p>
<ul>
<li>命令模式：该模式的另一个重点是“命令的管理”，应用的系统对于发出的命令有新增、删除、记录、排序、撤销等等的需求。</li>
<li>观察者模式：对于“观察者/订阅者”可进行管理，意思是观察者可以在系统运行时间决定订阅或退订等操作，让“执行者（观察者/订阅者）”可以被管理。</li>
</ul>
<p>所以，两者在应用上还是有明确的目标。当然，如果有需要将两个模式整合应用并非不可能，像是让命令模式的执行者可以动态新增、删除；或是让观察者模式的“每一次发布”都可以被管理等等。而这也是本书所要呈现的重点——模式之间的交互合作，会产生出更大的效果。</p>
<h1 id="观察者模式面对变化时"><a href="#观察者模式面对变化时" class="headerlink" title="观察者模式面对变化时"></a><span style="color:#339AFF;">观察者模式面对变化时</span></h1><p>企划：“小程，我们想要在游戏过程中，增加兵营升级的诱因，让玩家认为高级单位有高生命值的好处，所以…”<br>小程：“所以想要加什么系统吗？”<br>企划：“可以记录当前连续成功击退敌人的数量吗？就是Combo。”<br>小程：“可以再定义清楚一些吗？”<br>企划：“就是玩家角色在没有阵亡的情况下，连续击退敌方角色的数量，但如果有我方单位阵亡的话，那么就从头开始计数。”<br>小程：“嗯…复杂了点，我试试看。”</p>
<p>小程分析，这一项记录连续击退（Combo Count）的功能，需要同时接收“玩家角色阵亡事件”以及“敌方角色阵亡事件”，若是新增一个游戏事件观察者（IGameEventObserver），而这个观察者可以同时订阅两个游戏事件主题，内部再加上主题判断的话，应该是可行的：</p>
<blockquote>
<p>Listing21 我方连续击退事件（ComboObserver.cs）</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComboObserver</span> : <span class="title">IGameEventObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> SoldierKilledSubject m_SoldierKilledSubject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> EnemyKilledSubject m_EnemyKilledSubject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> PBaseDefenseGame m_PBDGame = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_EnemyComboCount =<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_SoldierKilledCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_EnemyKilledCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ComboObserver</span>(<span class="params">PBaseDefenseGame  PBDGame</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_PBDGame = PBDGame;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置观察的主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetSubject</span>(<span class="params"> IGameEventSubject theSubject </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>( theSubject <span class="keyword">is</span> SoldierKilledSubject )</span><br><span class="line">            m_SoldierKilledSubject = theSubject <span class="keyword">as</span> SoldierKilledSubject;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( theSubject <span class="keyword">is</span> EnemyKilledSubject)</span><br><span class="line">            m_EnemyKilledSubject = theSubject <span class="keyword">as</span> EnemyKilledSubject;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知Subject被更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> NowSoldierKilledCount = m_SoldierKilledSubject.GetKilledCount();</span><br><span class="line">        <span class="keyword">int</span> NowEnemyKilledCount = m_EnemyKilledSubject.GetKilledCount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 玩家单位阵亡，重置计数器</span></span><br><span class="line">        <span class="keyword">if</span>( NowSoldierKilledCount &gt; m_SoldierKilledCount)</span><br><span class="line">            m_EnemyComboCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 增加计数器</span></span><br><span class="line">        <span class="keyword">if</span>( NowEnemyKilledCount &gt; m_EnemyKilledCount)</span><br><span class="line">            m_EnemyComboCount ++;</span><br><span class="line"></span><br><span class="line">        m_SoldierKilledCount = NowSoldierKilledCount;</span><br><span class="line">        m_EnemyKilledCount = NowEnemyKilledCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知</span></span><br><span class="line">        m_PBDGame.ShowGameMsg(<span class="string">"连续击退敌人数:"</span>+m_EnemyComboCount.ToString());</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为要订阅两个游戏事件主题，所以SetSubject方法会被调用两次，每次调用时都先判断是由哪个主题调用的，然后分别记录在类的成员之中。而这两个主题对象也会在更新（Update）方法中，作为后续判断连续击退时，获取计数的来源。</p>
<p>最后，再将ComboObserver于系统开始时订阅这两个主题：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PBaseDefenseGame</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 注册游戏事件系统</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ResigerGameEvent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 事件注册</span></span><br><span class="line">        m_GameEventSystem.RegisterObserver( ENUM_GameEvent.EnemyKilled, <span class="keyword">new</span> EnemyKilledObserverUI(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Combo</span></span><br><span class="line">        ComboObserver theComboObserver = <span class="keyword">new</span> ComboObserver(<span class="keyword">this</span>);</span><br><span class="line">        m_GameEventSystem.RegisterObserver( ENUM_GameEvent.EnemyKilled, theComboObserver);</span><br><span class="line">        m_GameEventSystem.RegisterObserver( ENUM_GameEvent.SoldierKilled, theComboObserver);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一次对于功能的增加，是利用现有游戏事件主题来实现的，所以只增加了一个ComboObserver类来完成功能。并且只修改了PBaseDefenseGame.cs来增加必要的订阅主题功能，对于系统的修改程度来说，并不算大。由此可以证明运用观察者模式有助于系统的开发和维护。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a><span style="color:#339AFF;">结论</span></h1><p>观察者模式的设计原理是，先设置一个主题（Subject），让这个主题发布时可同时通知关心这个主题的观察者/订阅者，并且主题不必理会观察者/订阅者接下来会执行那些操作。观察者模式的主要功能和优点，就是将“主题发生”与“功能执行”这两个操作解除绑定——即消除依赖性，而且对于“执行者（观察者/订阅者）”来说，还是可以动态决定是否要执行后续的功能。</p>
<p>观察者模式的缺点是可能造成过多的观察者类。不过利用注册“回调函数”来取代“注册类对象”可有效减少类的产生。</p>
<p><font size="3"><strong>其他应用方式</strong></font></p>
<p>在游戏场景中，设计者通常会摆放一些所谓的“事件触发点”，这些事件触发点会在玩家角色进入时，触发对应的游戏功能，例如突然会出现一群怪物NPC来攻击玩家角色；或是进入剧情模式演出一段游戏故事剧情等等。而且游戏通常不会限制一个事件触发点只能执行一个操作，因此实现时可以将每一个事件触发点当成一个“主题”，而每一个要执行的功能，都成为“观察者”，当事件被触动发布时，所有的观察者都能立即反应。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/设计模式与游戏完美开发/" rel="tag"># 设计模式与游戏完美开发</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/17/关卡设计-责任链模式/" rel="next" title="关卡设计--责任链模式">
                <i class="fa fa-chevron-left"></i> 关卡设计--责任链模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/19/存盘功能-备忘录模式/" rel="prev" title="存盘功能--备忘录模式">
                存盘功能--备忘录模式 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Chebin">
            
              <p class="site-author-name" itemprop="name">Chebin</p>
              <div class="site-description motion-element" itemprop="description">记录自己的学习过程</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">399</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2019/09/05/有智慧的敌人/" title="有智慧的敌人" target="_blank">有智慧的敌人</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/04/迭代器与Unity协程/" title="迭代器与Unity协程" target="_blank">迭代器与Unity协程</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/04/枚举器和迭代器/" title="枚举器和迭代器" target="_blank">枚举器和迭代器</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/03/访问者模式/" title="访问者模式" target="_blank">访问者模式</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/03/中介者模式/" title="中介者模式" target="_blank">中介者模式</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#成就系统"><span class="nav-number">1.</span> <span class="nav-text">成就系统</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#观察者模式"><span class="nav-number">2.</span> <span class="nav-text">观察者模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#观察者模式的定义"><span class="nav-number">2.1.</span> <span class="nav-text">观察者模式的定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#观察者模式的说明"><span class="nav-number">2.2.</span> <span class="nav-text">观察者模式的说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#观察者模式的实现范例"><span class="nav-number">2.3.</span> <span class="nav-text">观察者模式的实现范例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用观察者模式实现成就系统"><span class="nav-number">3.</span> <span class="nav-text">使用观察者模式实现成就系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#成就系统的新架构"><span class="nav-number">3.1.</span> <span class="nav-text">成就系统的新架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现说明"><span class="nav-number">3.2.</span> <span class="nav-text">实现说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用观察者模式的优点"><span class="nav-number">3.3.</span> <span class="nav-text">使用观察者模式的优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现观察者模式时的注意事项"><span class="nav-number">3.4.</span> <span class="nav-text">实现观察者模式时的注意事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#观察者模式面对变化时"><span class="nav-number">4.</span> <span class="nav-text">观察者模式面对变化时</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结论"><span class="nav-number">5.</span> <span class="nav-text">结论</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chebin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">2.4m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">36:49</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
