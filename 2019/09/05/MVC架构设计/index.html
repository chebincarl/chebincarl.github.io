<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta name="keywords" content="Unity 3D实战核心技术详解">
<meta property="og:type" content="article">
<meta property="og:title" content="MVC架构设计">
<meta property="og:url" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/index.html">
<meta property="og:site_name" content="车斌的博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/1.webp">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/2.webp">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/3.webp">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/4.webp">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/5.webp">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/6.webp">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/1.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/2.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/3.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/4.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/5.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/6.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/7.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/8.jpg">
<meta property="og:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/9.jpg">
<meta property="og:updated_time" content="2019-09-05T15:48:00.771Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MVC架构设计">
<meta name="twitter:description" content="思考并回答以下问题：">
<meta name="twitter:image" content="http://chebincarl.github.io/2019/09/05/MVC架构设计/1.webp">






  <link rel="canonical" href="http://chebincarl.github.io/2019/09/05/MVC架构设计/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MVC架构设计 | 车斌的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注，重复10遍</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chebincarl.github.io/2019/09/05/MVC架构设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chebin">
      <meta itemprop="description" content="记录自己的学习过程">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MVC架构设计

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-05 09:13:55 / 修改时间：23:48:00" itemprop="dateCreated datePublished" datetime="2019-09-05T09:13:55+08:00">2019-09-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">56k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">51 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<a id="more"></a>


<p>本章涵盖：</p>
<ul>
<li>MVC代码模块设计</li>
<li>事件代码实现案例</li>
<li>窗体基类的实现案例</li>
<li>窗体子类代码实现案例</li>
<li>控制类实现案例</li>
<li>状态类设计实现</li>
<li>窗体管理类实现案例</li>
<li>MVC案例分享</li>
<li>小结</li>
</ul>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><span style="color:#339AFF;">前言</span></h1><p><strong>分工协作</strong></p>
<p>因为程序的逻辑是与美术直接打交道的，这就要求程序给美术制定一定的规范，比如命名规范，资源大小规范包括材质和模型以及动作数量等。模型资源上的脚本要采用动态加载的方式，这样美术调整好资源可以直接运行查看其效果。特别强调命名规范是非常重要的。</p>
<p><strong>框架</strong></p>
<p>框架的设计主要是分为两部分：一部分是针对UI的框架设计，一部分是针对游戏场景中的设计。UI设计框架我们采用的是MVC设计模式，架构如下所示：</p>
<img src="/2019/09/05/MVC架构设计/1.webp">
<img src="/2019/09/05/MVC架构设计/2.webp">
<img src="/2019/09/05/MVC架构设计/3.webp">

<p>对于窗口之间的切换采用的是状态机模式，这样开发扩展只需要针对具体的逻辑编写就可以了，状态的变换都是按照同样的逻辑，扩展起来非常方便，这里面要注意一个问题，UI上的脚本都是动态绑定的。</p>
<p>接下来是游戏玩法架构：</p>
<p>游戏玩法架构采用的是模块化开发，把通用的模块抽离出来，对于一些APRG游戏角色会有战斗也是游戏的核心玩法，该架构采用的是有限状态机设计也就是FSM设计。有限状态机主要是根据动作状态的改变而设计的，这样策划配置不同的动作或者技能组合，FSM架构如下图所示：</p>
<img src="/2019/09/05/MVC架构设计/4.webp">

<p>其他模块的设计可以采用工厂模式的设计理念，比如技能系统的设计架构：</p>
<img src="/2019/09/05/MVC架构设计/5.webp">

<p>其他系统的设计跟这个类似，就不一一列举了。对于一些通用的在游戏编程必可少的，直接以模块化封装：</p>
<img src="/2019/09/05/MVC架构设计/6.webp">

<p>它们可以重用到其他项目开发中。</p>
<p>我们公司对代码都有自己的代码库，开发游戏的时候去随意组装就可以了，非常方便。我们的游戏对象除了一些不变化的脚本可以直接挂上去，其他的都要采用动态挂接的方式，动态挂接的方式主要目的是对美术和程序做一个分离，二者互不干涉，程序只需要事先对美术的命名规范要做一定的要求，美术必须严格执行这样的操作，特别是针对用户逻辑的资源，这样做可以极大的提升开发效率。我们团队利用该架构设计开发了两款游戏，开发游戏速度非常快。<br>当然任何东西都不是绝对的，开发适用于自己的框架才是最好的框架。</p>
<p><strong>热更新</strong></p>
<p>首先要明白热更新的含义，好多人以为只更新资源就属于热更新，其实不然，热更新的含义是在不改变原有包的基础上做出的既包括资源也包括逻辑代码的更新。大家以前玩端游的时候，经常在游戏启动时提示你需要更新，有加载进度条，其实它们就是做的热更新。移动端做热更新通常采用的方式是采用ulua做热更新，网上有这方面的资料。平台的SDK经常需要更新，出现这种情况就需要客户端强制更新，或者是出现大版本更新，也需要对客户端进行强制更新。</p>
<p><strong>包体优化</strong></p>
<p>开发包体优化主要是从代码方面，资源方面进行的。代码方面主要是从这几方面考虑：一是资源的清理，比如在加载进度条时把以前加载的资源释放掉，二是可以对资源进行预加载，增加游戏运行的流畅度，避免动态加载的时候出现卡顿情况，类似对象池的概念。<br>影响包体大小的主要是模型和贴图，模型的面数要适当的减少，材质要有自己的游戏材质库，这样一旦美术风格定下后，相应的材质库也要建立，这样避免美术不断的增加材质。贴图的格式采用的是，RGB格式采用的是jpg格式，RGBA采用的是png格式。</p>
<p><strong>防破解、文本文件加密</strong></p>
<p>现在很多破解软件，可以绕过计费系统或者屏蔽计费，把包体变成白包，面对这种问题，可以使用类似360加固这样的软件，避免计费文件被修改，这种是针对不破解包体就可以屏蔽计费的。还有一种是修改配置文件的，一般对于基础数据都是放到本地的，保护本地文件采用的方法是对其进行二进制加密，也可以对其文本文件进行SHA1算法压缩加密，然后在程序中对其进行解压读取。当然后一种方式只能防君子不能防小人。</p>
<p><strong>移动端调试</strong></p>
<p>在开发中经常会遇到在PC端没有任何问题，但是在移动端会出现各种问题，比如崩掉，卡顿，显示不全等。这就需要程序能够直接使用移动端调试，必须要学会在移动端调试，调试的方式有很多种：比如：eclipse的DDMS，可以查看其错误的位置；还有一个是手机端下载 Unity Remote.apk，然后通过mono编辑器或者是vs编辑器加断点调试，二者都可以通过profiler查看其内存占用情况。还有一种方式可以打印出log，用adb命令，在cmd中输入adblogcat后面加一些参数再加一个log.txt可以把log文件打印出来。</p>
<p><strong>多语言</strong></p>
<p>多语言版本这个也是开发游戏常用的，我们的多语言版本是把UI上的除了有限的图标外，所有的文字信息都放在一个文本文件中，把所有的语言都放进去，文件读取的时候一次性加入，程序根据UI的命名赋值给对应的UI，判断哪个国家的语言，可以通过读取系统语言获取，然后对应着加载不同的配置文件内容。</p>
<p><strong>一键打包</strong></p>
<p>一键打包通常运用在多渠道发行的时候，不同的渠道要求不同，对于只修改后缀的可以批量打成jar包将其对应的资源拷贝到Plugins对应的Android文件夹下面，这可以编写一个小工具实现文件的拷贝和编译，这些在Unity中都有接口，对于加品宣的需要单独处理。</p>
<p><strong>MVC</strong></p>
<p>MVC在游戏架构设计时经常用到，这也是作为开发者必须要掌握的技能，MVC全称是Model View Controller，中文含义是模型、视窗、控制器。它是非常经典的设计模式，已经在游戏设计中广泛运用，尤其是在UI界面架构设计中。MVC在游戏开发中的解释分别是：Model称为模型，它的作用是针对数据变化的，比如在网络游戏中，角色等级升级了，角色的经验值增加了，技能等级提升了等都涉及数据更新，这些都需要用到Model。View，顾名思义是视窗，也就是窗口显示，在游戏的UI中表示的是UI界面的显示。Controller是控制器，控制界面的显示以及数据的更新，比如玩家单击某个按钮的响应操作。MVC架构设计图如图1所示。</p>
<blockquote>
<p>图1 MVC架构设计图</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/1.jpg">

<p>Controller模块可以与网络进行对接，用于控制数据Model在View上显示的数据，Controller也可以直接控制与View之间的切换。</p>
<h1 id="MVC代码模块设计"><a href="#MVC代码模块设计" class="headerlink" title="MVC代码模块设计"></a><span style="color:#339AFF;">MVC代码模块设计</span></h1><p>在游戏开发中拿到策划需求后，不要急于编写代码，要先通过模块化架构设计理顺思路。开发者需要拿出时间仔细思考如何去做架构设计，如果只是简单的实现功能它不是产品开发，游戏产品中程序也是一个团队开发公用的，做的框架需要给其他程序员编写逻辑使用，所以前期考虑问题一定要全面。做架构设计时可以把UI架构和游戏玩法架构分别做架构设计，本节主要针对UI做架构设计，运用MVC思想设计UI架构。首先对View模块进行架构设计。众所周知，游戏中UI窗口很多，每个窗口都有一些独特的属性，但是它们也有一些共性。把共性抽离出来可以作为所有窗体的父类使用，后面的窗体逻辑继承于父类即可。View的架构设计如图2所示。</p>
<blockquote>
<p>图2 窗体模块架构</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/2.jpg">

<p>以上架构只列举了几个窗体，对于游戏的窗体来说远远不够，但是游戏的窗体的实现原理是一样的。接下来继续在架构上做文章，初步的架构已经设计完成了，但是对于这么多窗体，我们是否还需要一个管理类来对它们进行统一管理呢？答案是肯定的。否则的话，每次编写代码调用每个具体的窗体操作是很麻烦的事情，一旦出现问题查找起来也是比较麻烦的，因此需要设计一个管理类对这些窗体进行统一管理。接下来在图2架构的基础上继续完善，增加窗体的管理类，架构如图3所示。</p>
<blockquote>
<p>图3 窗体管理类架构</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/3.jpg">

<p>有读者可能会问，架构设计是否完成了？还没有完成，图3架构设计的只是关于窗体的模块，还没有将它们联系起来，我们要考虑一个问题就是模块之间的耦合性。降低模块之间的耦合性是很重要的，在游戏开发中经常遇到的问题就是解决模块之间的耦合性，关于解耦合可通过事件机制去处理，接下来先给大家介绍事件代码设计。</p>
<h1 id="事件代码实现案例"><a href="#事件代码实现案例" class="headerlink" title="事件代码实现案例"></a><span style="color:#339AFF;">事件代码实现案例</span></h1><p>事件机制主要用于模块之间解耦合，关于事件的封装在前面有过介绍，在本节封装的是改进版，只用一个文件实现所有事件功能。事件机制将各个模块联系在一起，并且它们之间的耦合性非常低，特别适用于游戏产品的模块化开发。事件的类型可以通过枚举或者字符串的形式表示，本节使用的是枚举。事件机制的实现原理是将表示不同事件的枚举与其对应的回调函数通过AddListener函数加到定义好的表中，触发回调函数通过Broadcast函数对已定义的事件枚举进行分类分发，从而触发已加载到内存的事件回调函数。如果不需要监听事件可通过RemoveListener函数移除监听事件。事件机制实现的完整代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Game;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">EventCenter</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> disable 0414</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> restore 0414</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> Dictionary&lt;EGameEvent, Delegate&gt; mEventTable = <span class="keyword">new</span> Dictionary&lt;EGameEvent, Delegate&gt;();</span><br><span class="line">    <span class="comment">//消息处理程序不应该被移除</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> List&lt; EGameEvent &gt; mPermanentMessages = <span class="keyword">new</span> List&lt; EGameEvent &gt; ();</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//做一个永久性标记</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MarkAsPermanent</span>(<span class="params">EGameEvent eventType</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LOG_ALL_MESSAGES</span></span><br><span class="line">        Debug.Log(<span class="string">"Messenger MarkAsPermanent \t\""</span> + eventType + <span class="string">"\""</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        mPermanentMessages.Add( eventType );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Cleanup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LOG_ALL_MESSAGES</span></span><br><span class="line">        Debug.Log(<span class="string">"MESSENGER Cleanup. Make sure that none of necessary listeners are removed."</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        List&lt; EGameEvent &gt; messagesToRemove = <span class="keyword">new</span> List&lt;EGameEvent&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (KeyValuePair&lt;EGameEvent, Delegate&gt; pair <span class="keyword">in</span> mEventTable) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> wasFound = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (EGameEvent message <span class="keyword">in</span> mPermanentMessages) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pair.Key == message) </span><br><span class="line">                &#123;</span><br><span class="line">                    wasFound = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!wasFound)</span><br><span class="line">                    messagesToRemove.Add( pair.Key );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (EGameEvent message <span class="keyword">in</span> messagesToRemove) </span><br><span class="line">        &#123;</span><br><span class="line">            mEventTable.Remove( message );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrEGameEventEventTable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">foreach</span> (KeyValuePair&lt;EGameEvent, Delegate&gt; pair <span class="keyword">in</span> mEventTable) </span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">"\t\t\t"</span> + pair.Key + <span class="string">"\t\t"</span> + pair.Value);</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnListenerAdding</span>(<span class="params">EGameEvent eventType, Delegate listenerBeingAdded</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mEventTable.ContainsKey(eventType)) </span><br><span class="line">        &#123;</span><br><span class="line">            mEventTable.Add(eventType, <span class="literal">null</span> );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Delegate d = mEventTable[eventType];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (d != <span class="literal">null</span> &amp;&amp; d.GetType() != listenerBeingAdded.GetType()) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ListenerException(<span class="keyword">string</span>.Format(<span class="string">"Attempting to add listener with inconsistent signature for event type &#123;0&#125;. Current listeners have type &#123;1&#125; and listener being added has type &#123;2&#125;"</span>, eventType, d.GetType().Name, listenerBeingAdded.GetType().Name));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnListenerRemoving</span>(<span class="params">EGameEvent eventType, Delegate listenerBeingRemoved</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEventTable.ContainsKey(eventType)) </span><br><span class="line">        &#123;</span><br><span class="line">            Delegate d = mEventTable[eventType];</span><br><span class="line">            <span class="keyword">if</span> (d == <span class="literal">null</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ListenerException(<span class="keyword">string</span>.Format(<span class="string">"Attempting to remove listener with for event type \"&#123;0&#125;\" but current listener is null."</span>, eventType));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (d.GetType() != listenerBeingRemoved.GetType()) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ListenerException(<span class="keyword">string</span>.Format(<span class="string">"Attempting to remove listener with inconsistent signature for event type &#123;0&#125;. Current listeners have type &#123;1&#125; and listener being removed has type &#123;2&#125;"</span>, eventType, d.GetType().Name, listenerBeingRemoved.GetType().Name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ListenerException(<span class="keyword">string</span>.Format(<span class="string">"Attempting to remove listener for type \"&#123;0&#125;\" but Messenger doesn't know about this event type."</span>, eventType));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnListenerRemoved</span>(<span class="params">EGameEvent eventType</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEventTable[eventType] == <span class="literal">null</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            mEventTable.Remove(eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnBroadcasting</span>(<span class="params">EGameEvent eventType</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> REQUIRE_LISTENER</span></span><br><span class="line">        <span class="keyword">if</span> (!mEventTable.ContainsKey(eventType)) </span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> BroadcastException <span class="title">CreateBroadcastSignatureException</span>(<span class="params">EGameEvent eventType</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BroadcastException(<span class="keyword">string</span>.Format(<span class="string">"Broadcasting message \"&#123;0&#125;\" but listeners have a different signature than the broadcaster."</span>, eventType));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BroadcastException</span> : <span class="title">Exception</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BroadcastException</span>(<span class="params"><span class="keyword">string</span> msg</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">msg</span>) </span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ListenerException</span> : <span class="title">Exception</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ListenerException</span>(<span class="params"><span class="keyword">string</span> msg</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">msg</span>) </span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无参数增加监听</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddListener</span>(<span class="params">EGameEvent eventType, Callback handler</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        OnListenerAdding(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback)mEventTable[eventType] + handler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//单个参数增加监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T&gt;(EGameEvent eventType, Callback&lt;T&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T&gt;)mEventTable[eventType] + handler;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//两个参数增加监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T, U&gt;(EGameEvent eventType, Callback&lt;T, U&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T, U&gt;)mEventTable[eventType] + handler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//三个参数增加监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T, U, V&gt;(EGameEvent eventType, Callback&lt;T, U, V&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T, U, V&gt;)mEventTable[eventType] + handler;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//四个参数增加监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T, U, V, X&gt;(EGameEvent eventType, Callback&lt;T, U, V, X&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerAdding(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T, U, V, X&gt;)mEventTable[eventType] + handler;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//无参数移除监听</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveListener</span>(<span class="params">EGameEvent eventType, Callback handler</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, handler);   </span><br><span class="line">        mEventTable[eventType] = (Callback)mEventTable[eventType] - handler;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//单个参数移除监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T&gt;(EGameEvent eventType, Callback&lt;T&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T&gt;)mEventTable[eventType] - handler;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//两个参数移除监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T, U&gt;(EGameEvent eventType, Callback&lt;T, U&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T, U&gt;)mEventTable[eventType] - handler;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//三个参数移除监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T, U, V&gt;(EGameEvent eventType, Callback&lt;T, U, V&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T, U, V&gt;)mEventTable[eventType] - handler;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//四个参数移除事件监听</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T, U, V, X&gt;(EGameEvent eventType, Callback&lt;T, U, V, X&gt; handler) </span><br><span class="line">    &#123;</span><br><span class="line">        OnListenerRemoving(eventType, handler);</span><br><span class="line">        mEventTable[eventType] = (Callback&lt;T, U, V, X&gt;)mEventTable[eventType] - handler;</span><br><span class="line">        OnListenerRemoved(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//无参数分发</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Broadcast</span>(<span class="params">EGameEvent eventType</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        OnBroadcasting(eventType);</span><br><span class="line">        Delegate d;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) </span><br><span class="line">        &#123;</span><br><span class="line">            Callback callback = d <span class="keyword">as</span> Callback;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                callback();</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendEvent</span>(<span class="params">CEvent evt</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Broadcast&lt;CEvent&gt;(evt.GetEventId(), evt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//单个参数分发</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T&gt;(EGameEvent eventType, T arg1) </span><br><span class="line">    &#123;</span><br><span class="line">        OnBroadcasting(eventType);</span><br><span class="line">        Delegate d;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) </span><br><span class="line">        &#123;</span><br><span class="line">            Callback&lt;T&gt; callback = d <span class="keyword">as</span> Callback&lt;T&gt;;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                callback(arg1);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="comment">//两个参数分发</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T, U&gt;(EGameEvent eventType, T arg1, U arg2) </span><br><span class="line">    &#123;</span><br><span class="line">        OnBroadcasting(eventType);</span><br><span class="line">        Delegate d;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) </span><br><span class="line">        &#123;</span><br><span class="line">            Callback&lt;T, U&gt; callback = d <span class="keyword">as</span> Callback&lt;T, U&gt;;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                callback(arg1, arg2);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//三个参数分发</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T, U, V&gt;(EGameEvent eventType, T arg1, U arg2, V arg3) </span><br><span class="line">    &#123;</span><br><span class="line">        OnBroadcasting(eventType);</span><br><span class="line">        Delegate d;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) </span><br><span class="line">        &#123;</span><br><span class="line">            Callback&lt;T, U, V&gt; callback = d <span class="keyword">as</span> Callback&lt;T, U, V&gt;;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                callback(arg1, arg2, arg3);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//四个参数分发</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T, U, V, X&gt;(EGameEvent eventType, T arg1, U arg2, V arg3, X arg4) </span><br><span class="line">    &#123;</span><br><span class="line">        OnBroadcasting(eventType);</span><br><span class="line">        Delegate d;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) </span><br><span class="line">        &#123;</span><br><span class="line">            Callback&lt;T, U, V, X&gt; callback = d <span class="keyword">as</span> Callback&lt;T, U, V, X&gt;;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                callback(arg1, arg2, arg3, arg4);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个事件代码已完成，再给大家解释一下代码中的常用接口部分，下面的代码是需要经常调用的监听函数，从无参数的监听函数到有四个参数的监听函数的实现，函数代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无参数的监听函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddListener</span>(<span class="params">EGameEvent eventType, Callback handler</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OnListenerAdding(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback)mEventTable[eventType] + handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一个参数的监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T&gt;(EGameEvent eventType, Callback&lt;T&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerAdding(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T&gt;)mEventTable[eventType] + handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//二个参数的监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T, U&gt;(EGameEvent eventType, Callback&lt;T, U&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerAdding(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T, U&gt;)mEventTable[eventType] + handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//三个参数的监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T, U, V&gt;(EGameEvent eventType, Callback&lt;T, U, V&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerAdding(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T, U, V&gt;)mEventTable[eventType] + handler;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//四个参数的监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> AddListener&lt;T, U, V, X&gt;(EGameEvent eventType, Callback&lt;T, U, V, X&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerAdding(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T, U, V, X&gt;)mEventTable[eventType] + handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以根据自己的实际情况调用不同的监听函数，下面的代码是移除监听，移除代码的作用是如果事件已经监听完成，且不再需要监听，那么可以通过函数RemoveListener将其移除，它与Addlistener函数是一一对应的，调用函数接口如下。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无参数的移除监听函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveListener</span>(<span class="params">EGameEvent eventType, Callback handler</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OnListenerRemoving(eventType, handler);   </span><br><span class="line">    mEventTable[eventType] = (Callback)mEventTable[eventType] - handler;</span><br><span class="line">    OnListenerRemoved(eventType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//单个参数的移除监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T&gt;(EGameEvent eventType, Callback&lt;T&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerRemoving(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T&gt;)mEventTable[eventType] - handler;</span><br><span class="line">    OnListenerRemoved(eventType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//两个参数的移除监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T, U&gt;(EGameEvent eventType, Callback&lt;T, U&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerRemoving(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T, U&gt;)mEventTable[eventType] - handler;</span><br><span class="line">    OnListenerRemoved(eventType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//三个参数的移除监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T, U, V&gt;(EGameEvent eventType, Callback&lt;T, U, V&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerRemoving(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T, U, V&gt;)mEventTable[eventType] - handler;</span><br><span class="line">    OnListenerRemoved(eventType);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//四个参数的移除监听函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> RemoveListener&lt;T, U, V, X&gt;(EGameEvent eventType, Callback&lt;T, U, V, X&gt; handler) </span><br><span class="line">&#123;</span><br><span class="line">    OnListenerRemoving(eventType, handler);</span><br><span class="line">    mEventTable[eventType] = (Callback&lt;T, U, V, X&gt;)mEventTable[eventType] - handler;</span><br><span class="line">    OnListenerRemoved(eventType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后是关于事件的消息分发，也就是触发监听事件的回调函数，先调用监听函数AddListener后，才可以使用Broadcast对事件消息进行分发操作。二者有前后关系，函数代码如下。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无参数的消息事件广播函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Broadcast</span>(<span class="params">EGameEvent eventType</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OnBroadcasting(eventType);</span><br><span class="line"></span><br><span class="line">    Delegate d;</span><br><span class="line">    <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) &#123;</span><br><span class="line">        Callback callback = d <span class="keyword">as</span> Callback;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送事件</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendEvent</span>(<span class="params">CEvent evt</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Broadcast&lt;CEvent&gt;(evt.GetEventId(), evt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单个参数的消息事件广播函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T&gt;(EGameEvent eventType, T arg1) &#123;</span><br><span class="line">    OnBroadcasting(eventType);</span><br><span class="line"></span><br><span class="line">    Delegate d;</span><br><span class="line">    <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) &#123;</span><br><span class="line">        Callback&lt;T&gt; callback = d <span class="keyword">as</span> Callback&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback(arg1);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//两个参数的消息事件广播函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T, U&gt;(EGameEvent eventType, T arg1, U arg2) </span><br><span class="line">&#123;</span><br><span class="line">    OnBroadcasting(eventType);</span><br><span class="line"></span><br><span class="line">    Delegate d;</span><br><span class="line">    <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) &#123;</span><br><span class="line">        Callback&lt;T, U&gt; callback = d <span class="keyword">as</span> Callback&lt;T, U&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback(arg1, arg2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 三个参数的消息事件广播函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T, U, V&gt;(EGameEvent eventType, T arg1, U arg2, V arg3) </span><br><span class="line">&#123;</span><br><span class="line">    OnBroadcasting(eventType);</span><br><span class="line"></span><br><span class="line">    Delegate d;</span><br><span class="line">    <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) &#123;</span><br><span class="line">        Callback&lt;T, U, V&gt; callback = d <span class="keyword">as</span> Callback&lt;T, U, V&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback(arg1, arg2, arg3);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">//四个参数的消息事件广播函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> Broadcast&lt;T, U, V, X&gt;(EGameEvent eventType, T arg1, U arg2, V arg3, X arg4) &#123;</span><br><span class="line">    OnBroadcasting(eventType);</span><br><span class="line"></span><br><span class="line">    Delegate d;</span><br><span class="line">    <span class="keyword">if</span> (mEventTable.TryGetValue(eventType, <span class="keyword">out</span> d)) &#123;</span><br><span class="line">        Callback&lt;T, U, V, X&gt; callback = d <span class="keyword">as</span> Callback&lt;T, U, V, X&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback(arg1, arg2, arg3, arg4);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> CreateBroadcastSignatureException(eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在分发消息的函数中增加了static public void SendEvent（CEvent evt）函数用于消息的发送，它内部是调用BroadCast函数，所以其实现方式与BroadCast原理是一样的，接下来介绍窗体基类的实现案例。</p>
<h1 id="窗体基类的实现案例"><a href="#窗体基类的实现案例" class="headerlink" title="窗体基类的实现案例"></a><span style="color:#339AFF;">窗体基类的实现案例</span></h1><p>对于游戏中的窗体，从它们身上可以看到很多共性，最基本的功能是窗体的初始化、窗体显示、窗体隐藏，这些功能对于所有窗体都是需要的，因此可以将它们抽离出来，单独放到一个类里面作为窗体的父类，游戏中所有的窗体都继承这个父类。窗体父类实现的是所有窗口的共性方法或者属性，子类只负责实现自己独有的方法，共性的方法直接继成父类即可，基类的完整代码如下。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Game;</span><br><span class="line"><span class="keyword">using</span> GameDefine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.View</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseWindow</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">protected</span> Transform mRoot;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> EScenesType mScenesType;      <span class="comment">//场景类型</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">string</span> mResName;                      <span class="comment">//资源名</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">bool</span> mResident;                       <span class="comment">//是否常驻</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">bool</span> mVisible = <span class="literal">false</span>;        <span class="comment">//是否可见</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//类对象初始化</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//类对象释放</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Realse</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//窗口控制初始化</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">InitWidget</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//窗口控件释放</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">RealseWidget</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//游戏事件注册</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">OnAddListener</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//游戏事件注销</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">OnRemoveListener</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//显示初始化</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//隐藏处理</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//每帧更新</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="keyword">float</span> deltaTime</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取得所有场景类型</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> EScenesType <span class="title">GetScenseType</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> mScenesType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否已打开</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsVisible</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> mVisible;  &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否常驻</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsResident</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> mResident; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//显示</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRoot == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Create())</span><br><span class="line">                &#123;</span><br><span class="line">                    InitWidget();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mRoot &amp;&amp; mRoot.gameObject.activeSelf == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mRoot.gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                mVisible = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                 OnEnable();</span><br><span class="line"></span><br><span class="line">                OnAddListener();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//隐藏</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Hide</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRoot &amp;&amp; mRoot.gameObject.activeSelf == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                OnRemoveListener();</span><br><span class="line">                OnDisable();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mResident)</span><br><span class="line">                &#123;</span><br><span class="line">                    mRoot.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    RealseWidget();</span><br><span class="line">                    Destroy();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mVisible = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//预加载</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PreLoad</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRoot == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Create())</span><br><span class="line">                &#123;</span><br><span class="line">                    InitWidget();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//延时删除</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DelayDestory</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRoot)</span><br><span class="line">            &#123;</span><br><span class="line">                RealseWidget();</span><br><span class="line">                Destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建窗体</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">Create</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRoot)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"Window Create Error Exist!"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mResName == <span class="literal">null</span> || mResName == <span class="string">""</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"Window Create Error ResName is empty!"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (GameMethod.GetUiCamera.transform== <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"Window Create Error GetUiCamera is empty! WindowName = "</span> + mResName);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            GameObject obj = LoadUiResource.LoadRes(GameMethod.GetUiCamera.transform, mResName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (obj == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"Window Create Error LoadRes WindowName = "</span> + mResName);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mRoot = obj.transform;</span><br><span class="line"></span><br><span class="line">            mRoot.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//销毁窗体</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Destroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRoot)</span><br><span class="line">            &#123;</span><br><span class="line">                LoadUiResource.DestroyLoad(mRoot.gameObject);</span><br><span class="line">                mRoot = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取得根节点</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Transform <span class="title">GetRoot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> mRoot;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在窗体封装的父类代码中，显示函数Show、隐藏函数Hide对于任何窗体都是通用的。因此可以在父类中将其方法实现出来，子类继承该方法可以直接调用，子类无须重新写。当然还有一些公用的函数定义是需要子类自己实现的，父类使用了一些抽象的函数声明，这些抽象函数是针对子类的。先介绍通用函数Show，其作用就是将窗体先创建出来，并对窗体中的控件进行初始化操作，同时增加了消息监听函数的接口。函数代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//显示</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mRoot == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Create())</span><br><span class="line">        &#123;</span><br><span class="line">            InitWidget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mRoot &amp;&amp; mRoot.gameObject.activeSelf == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mRoot.gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        mVisible = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">         OnEnable();</span><br><span class="line"></span><br><span class="line">        OnAddListener();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上文的函数中调用Create函数，用于资源的加载创建，同时将创建的窗体设为不可见，这种处理方式跟预加载机制非常像。该函数实现代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建窗体</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">Create</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mRoot)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">"Window Create Error Exist!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mResName == <span class="literal">null</span> || mResName == <span class="string">""</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">"Window Create Error ResName is empty!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (GameMethod.GetUiCamera.transform== <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">"Window Create Error GetUiCamera is empty! WindowName = "</span> + mResName);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GameObject obj = LoadUiResource.LoadRes(GameMethod.GetUiCamera.transform, mResName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">"Window Create Error LoadRes WindowName = "</span> + mResName);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mRoot = obj.transform;</span><br><span class="line"></span><br><span class="line">    mRoot.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面介绍一下UI界面的隐藏。隐藏分为两种，一种是将其破坏掉，另一种是将其真正隐藏起来。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//隐藏</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Hide</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mRoot &amp;&amp; mRoot.gameObject.activeSelf == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        OnRemoveListener();</span><br><span class="line">        OnDisable();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mResident)</span><br><span class="line">        &#123;</span><br><span class="line">            mRoot.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            RealseWidget();</span><br><span class="line">            Destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mVisible = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了方便开发者调用，实现了一个预加载函数，对于一些资源，如果要预先加载到内存里可以调用该函数，函数代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//预加载</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PreLoad</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mRoot == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Create())</span><br><span class="line">        &#123;</span><br><span class="line">            InitWidget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是关于窗体父类核心函数的讲解，窗体父类设计完成，接下来继续窗体子类代码讲解。</p>
<h1 id="窗体子类代码实现案例"><a href="#窗体子类代码实现案例" class="headerlink" title="窗体子类代码实现案例"></a><span style="color:#339AFF;">窗体子类代码实现案例</span></h1><p>为了加深印象，在这里重复一遍父类和子类的关系：“父类窗体实现了所有窗体的共性，子类的实现就需要继承父类，子类自己独有的方法或者属性在其子类中实现”。在写子类之前大家可以思考两个问题，子类的窗体需要有哪些信息？如何去编写子类的代码？这两个问题是架构设计时必须要解决的。</p>
<p>下面分析一下子类的编写，首先子类窗体是一个assetbundle资源或者说是实例化的物体，这样是为了便于程序动态的加载。资源加载完成后，这个资源是否可以常驻内存，可以为此加个标记，因为有的界面要经常使用，对于这样的界面设计时就要考虑不要将其卸载掉。接下来运用已经封装好的事件系统，以及用于窗体的显示和隐藏接口。另外子类中需要窗体的初始化操作，以及单击按钮时的回调触发函数，因为脚本不继承mono，所以它不会绑定到对象上，这么做的目的是为了做到资源和代码的分离，思路分析完了，现在把完整的代码展示给读者。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> GameDefine;</span><br><span class="line"><span class="keyword">using</span> UICommon;</span><br><span class="line"><span class="keyword">using</span> Game;</span><br><span class="line"><span class="keyword">using</span> Game.GameData;</span><br><span class="line"><span class="keyword">using</span> Game.Network;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Game.Ctrl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.View</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoginWindow</span> : <span class="title">BaseWindow</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoginWindow</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            mScenesType = EScenesType.EST_Login;</span><br><span class="line">            mResName = GameConstDefine.LoadGameLoginUI;</span><br><span class="line">            mResident = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/继承接口<span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/</span></span><br><span class="line">        <span class="comment">//类对象初始化</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventCenter.AddListener(EGameEvent.eGameEvent_LoginEnter, Show);</span><br><span class="line">            EventCenter.AddListener(EGameEvent.eGameEvent_LoginExit, Hide);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//类对象释放</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Realse</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventCenter.RemoveListener(EGameEvent.eGameEvent_LoginEnter, Show);</span><br><span class="line">            EventCenter.RemoveListener(EGameEvent.eGameEvent_LoginExit, Hide);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//窗口控件初始化</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">InitWidget</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            mLoginParent = mRoot.FindChild(<span class="string">"Server_Choose"</span>);</span><br><span class="line">            mLoginInput = mRoot.FindChild(<span class="string">"Server_Choose/Loginer"</span>);</span><br><span class="line">            mLoginSubmit = mRoot.FindChild(<span class="string">"Server_Choose/Button"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            mPlayParent = mRoot.Find(<span class="string">"LoginBG"</span>);</span><br><span class="line">            mPlaySubmitBtn = mRoot.Find(<span class="string">"LoginBG/LoginBtn"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            UIEventListener.Get(mPlaySubmitBtn.gameObject).onClick += OnPlaySubmit;</span><br><span class="line">            UIEventListener.Get(mPlayServerBtn.gameObject).onClick += OnPlayServer;</span><br><span class="line"></span><br><span class="line">            UIEventListener.Get(mReLoginSubmit.gameObject).onClick += OnReLoginSubmit;</span><br><span class="line"></span><br><span class="line">            UIEventListener.Get(mLoginSubmit.gameObject).onClick += OnLoginSubmit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//窗口控件释放</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">RealseWidget</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//游戏事件注册</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnAddListener</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventCenter.AddListener(EGameEvent.eGameEvent_LoginSuccess, LoginSuceess);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//游戏事件注销</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnRemoveListener</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            EventCenter.RemoveListener(EGameEvent.eGameEvent_LoginSuccess, LoginSuceess);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//显示</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//隐藏</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>//UI事件响应<span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnPlaySubmit</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            mWaitingParent.gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line">            UIEventListener.Get(mPlaySubmitBtn.gameObject).onClick -= OnPlaySubmit;</span><br><span class="line"></span><br><span class="line">            LoginCtrl.Instance.GamePlay();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnPlayServer</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ShowServer(LOGINUI.SelectServer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnChangeAccount</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            LoginCtrl.Instance.SdkLogOff();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnReLoginSubmit</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            mReLoginParent.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            LoginCtrl.Instance.SdkLogOff();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnLoginSubmit</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            mWaitingParent.gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            LoginCtrl.Instance.Login(mLoginAccountInput.<span class="keyword">value</span>, mLoginPassInput.<span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//登录成功</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">LoginSuceess</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            UIEventListener.Get(mPlaySubmitBtn.gameObject).onClick -= OnPlaySubmit;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在LoginWindow类中实现了一些逻辑的调用，大部分都是用封装好的事件机制实现的。下面给大家介绍一下关于代码的实现，构造函数主要实现了资源的加载，以及对是否常驻内存做了一个标记，函数代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LoginWindow</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mScenesType = EScenesType.EST_Login;</span><br><span class="line">    mResName = GameConstDefine.LoadGameLoginUI;</span><br><span class="line">    mResident = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行表示的是资源类型，资源类型主要分为两种：Login和Play，使用的是定义好的枚举。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EScenesType</span><br><span class="line">&#123;</span><br><span class="line">    EST_None,</span><br><span class="line">    EST_Login,</span><br><span class="line">    EST_Play,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Init函数主要是实现监听函数功能，它继承于它的父类BaseWindow，添加了监听消息函数AddListener，通过监听函数实现窗体显示Show和隐藏Hide的回调。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类对象初始化</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EventCenter.AddListener(EGameEvent.eGameEvent_LoginEnter, Show);</span><br><span class="line">    EventCenter.AddListener(EGameEvent.eGameEvent_LoginExit, Hide);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InitWidget函数主要作用是初始化需要操作界面的各个按钮回调的响应，这样单击界面按钮时会触发响应的回调函数。它继承了父类的InitWidget函数。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//窗口控件初始化</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">InitWidget</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mLoginParent = mRoot.FindChild(<span class="string">"Server_Choose"</span>);</span><br><span class="line">    mLoginInput = mRoot.FindChild(<span class="string">"Server_Choose/Loginer"</span>);</span><br><span class="line">    mLoginSubmit = mRoot.FindChild(<span class="string">"Server_Choose/Button"</span>);</span><br><span class="line"></span><br><span class="line">    mPlayParent = mRoot.Find(<span class="string">"LoginBG"</span>);</span><br><span class="line">    mPlaySubmitBtn = mRoot.Find(<span class="string">"LoginBG/LoginBtn"</span>);</span><br><span class="line"></span><br><span class="line">    UIEventListener.Get(mPlaySubmitBtn.gameObject).onClick += OnPlaySubmit;</span><br><span class="line">    UIEventListener.Get(mPlayServerBtn.gameObject).onClick += OnPlayServer;</span><br><span class="line"></span><br><span class="line">    UIEventListener.Get(mReLoginSubmit.gameObject).onClick += OnReLoginSubmit;</span><br><span class="line"></span><br><span class="line">    UIEventListener.Get(mLoginSubmit.gameObject).onClick += OnLoginSubmit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InitWidget函数利用UIEventListener进行窗体Button事件监听，这么做的好处是不需要把脚本挂接到UI上。该函数对应的UI界面如图4所示。</p>
<blockquote>
<p>图4 UI界面</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/4.jpg">

<p>如果Login界面不涉及数据的变化处理，则不需要Model模块。子类窗体的实现都可以采用上述脚本的实现方式，这里就不一一举例了，其他窗体按照这个模式编写就可以了，接下来开始MVC模式的Controller模块编写。</p>
<h1 id="控制类实现案例"><a href="#控制类实现案例" class="headerlink" title="控制类实现案例"></a><span style="color:#339AFF;">控制类实现案例</span></h1><p>本节讲解MVC中的Controller控制类设计，控制类是负责控制View窗体显示的，它的控制方式是通过消息事件的监听和分发实现的，这也有效地降低了模块之间的耦合性，它的实现方式是继承单例模式，它不继承mono，所以不会挂接到对象上，先把完整的代码给大家展示一下。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Game;</span><br><span class="line"><span class="keyword">using</span> Game.GameData;</span><br><span class="line"><span class="keyword">using</span> Game.Network;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Game.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Ctrl</span></span><br><span class="line">&#123;</span><br><span class="line">    public class LoginCtrl : Singleton&lt;LoginCtrl&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventCenter.Broadcast(EGameEvent.eGameEvent_LoginEnter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Exit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventCenter.Broadcast(EGameEvent.eGameEvent_LoginExit);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Login</span>(<span class="params"><span class="keyword">string</span> account, <span class="keyword">string</span> pass</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            SelectServerData.Instance.SetServerInfo((<span class="keyword">int</span>)SdkManager.Instance.GetPlatFrom(), account, pass);</span><br><span class="line">            NetworkManager.Instance.canReconnect = <span class="literal">false</span>;</span><br><span class="line">            NetworkManager.Instance.Close();</span><br><span class="line">            NetworkManager.Instance.Init(GameLogic.Instance.LoginServerAdress, <span class="number">49996</span>, NetworkManager.ServerType.LoginServer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录错误反馈</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoginError</span>(<span class="params"><span class="keyword">int</span> code</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            MsgInfoManager.Instance.ShowMsg(code);</span><br><span class="line">            EventCenter.Broadcast&lt;EErrorCode&gt;(EGameEvent.eGameEvent_LoginError, (EErrorCode)code);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录失败</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoginFail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            NetworkManager.Instance.canReconnect = <span class="literal">false</span>;</span><br><span class="line">            EventCenter.Broadcast(EGameEvent.eGameEvent_LoginFail);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始游戏</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GamePlay</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在该函数中读者可能注意到，它的分发消息是在Enter函数中，移除消息监听是在Exit函数中，因为它不继承mono，所以必须有其他类来调用Controller控制模块的方法才能运行。那如何去调用Controller控制类呢？请看下一节节状态类设计实现。</p>
<h1 id="状态类设计实现"><a href="#状态类设计实现" class="headerlink" title="状态类设计实现"></a><span style="color:#339AFF;">状态类设计实现</span></h1><p>上一节讲述了MVC中的View和Controller模块都不继承于mono，方便扩展，接下来设计的状态切换模式也是不继承mono的，用于View窗体的切换。下面开始状态模式的框架设计，首先设计一个状态的父类，这个父类将其定义为一个抽象类。抽象类架构设计如图5所示。</p>
<blockquote>
<p>图5 游戏抽象类架构设计</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/5.jpg">

<p>图5中iGameState作为所有状态的父类，状态模式是设计模式中的一种，它是根据物体状态的改变而改变的行为，所以在设计父类时，需要考虑到以下几点：设置某个状态，获取某个状态，进入某个状态，状态更新，状态停止，等等。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.GameState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IGameState</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">GameStateType <span class="title">GetStateType</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">SetStateTo</span>(<span class="params">GameStateType gsType</span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Enter</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="function">GameStateType <span class="title">Update</span>(<span class="params"><span class="keyword">float</span> fDeltaTime</span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"><span class="keyword">float</span> fixedDeltaTime</span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Exit</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>父类有了以后，接下来开始设计子类。以LoginState为例，LoginState是登录窗体的具体状态，它继承上述写的父类，状态主要是通过MVC中的Controller去控制窗体的显示，完整的代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> GameDefine;</span><br><span class="line"><span class="keyword">using</span> Game.Resource;</span><br><span class="line"><span class="keyword">using</span> Game.Ctrl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.GameState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">LoginState</span> : <span class="title">IGameState</span></span><br><span class="line">    &#123;</span><br><span class="line">        GameStateType stateTo;</span><br><span class="line"></span><br><span class="line">        GameObject mScenesRoot;</span><br><span class="line"></span><br><span class="line">        GameObject mUIRoot;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoginState</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GameStateType <span class="title">GetStateType</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> GameStateType.GS_Login;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetStateTo</span>(<span class="params">GameStateType gs</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            stateTo = gs;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            SetStateTo(GameStateType.GS_Continue);</span><br><span class="line">            ResourceUnit sceneRootUnit = ResourcesManager.Instance.loadImmediate(GameConstDefine.GameLogin, ResourceType.PREFAB);</span><br><span class="line">            mScenesRoot = GameObject.Instantiate(sceneRootUnit.Asset) <span class="keyword">as</span> GameObject;</span><br><span class="line"></span><br><span class="line">            LoginCtrl.Instance.Enter();</span><br><span class="line"></span><br><span class="line">            ResourceUnit audioClipUnit = ResourcesManager.Instance.loadImmediate(AudioDefine.PATH_UIBGSOUND, ResourceType.ASSET);</span><br><span class="line">            AudioClip clip = audioClipUnit.Asset <span class="keyword">as</span> AudioClip;       </span><br><span class="line"></span><br><span class="line">            AudioManager.Instance.PlayBgAudio(clip);</span><br><span class="line"></span><br><span class="line">            EventCenter.AddListener&lt;CEvent&gt;(EGameEvent.eGameEvent_InputUserData, OnEvent);</span><br><span class="line">            EventCenter.AddListener&lt;CEvent&gt;(EGameEvent.eGameEvent_IntoLobby, OnEvent);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Exit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            EventCenter.RemoveListener&lt;CEvent&gt;(EGameEvent.eGameEvent_InputUserData, OnEvent);</span><br><span class="line">            EventCenter.RemoveListener&lt;CEvent&gt;(EGameEvent.eGameEvent_IntoLobby, OnEvent);</span><br><span class="line">            LoginCtrl.Instance.Exit();</span><br><span class="line">            GameObject.DestroyImmediate(mScenesRoot);            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"><span class="keyword">float</span> fixedDeltaTime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GameStateType <span class="title">Update</span>(<span class="params"><span class="keyword">float</span> fDeltaTime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> stateTo;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnEvent</span>(<span class="params">CEvent evt</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            UIPlayMovie.PlayMovie(<span class="string">"cg.mp4"</span>, Color.black, <span class="number">2</span><span class="comment">/* FullScreenMovieControlMode.Hidden*/</span>, <span class="number">3</span><span class="comment">/*FullScreenMovieScalingMode.Fill*/</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (evt.GetEventId())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> EGameEvent.eGameEvent_InputUserData:</span><br><span class="line">                    SetStateTo(GameStateType.GS_User);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> EGameEvent.eGameEvent_IntoLobby:</span><br><span class="line">                    GameStateManager.Instance.ChangeGameStateTo(GameStateType.GS_Lobby);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我把类中的主要函数给读者介绍一下。在该类中使用了Enter函数的定义，在设计Controller时也定义了一个函数Enter，该函数在该类中具有非常重要的作用，它实现的内容包括：设置当前状态，调用Controller的Enter接口显示View层的UI，因为View层的UI显示面板需要将其实例化出来。面板的实例化也是在State状态类中去实现的，同时也可以包括声音、音效的加载以及其他逻辑的实现，函数代码如下。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SetStateTo(GameStateType.GS_Continue);</span><br><span class="line">    ResourceUnit sceneRootUnit = ResourcesManager.Instance.loadImmediate(GameConstDefine.GameLogin, ResourceType.PREFAB);</span><br><span class="line">    mScenesRoot = GameObject.Instantiate(sceneRootUnit.Asset) <span class="keyword">as</span> GameObject;</span><br><span class="line">    <span class="comment">//调用Controller控制类的Enter函数</span></span><br><span class="line">    LoginCtrl.Instance.Enter();</span><br><span class="line"></span><br><span class="line">    ResourceUnit audioClipUnit = ResourcesManager.Instance.loadImmediate(AudioDefine.PATH_UIBGSOUND, ResourceType.ASSET);</span><br><span class="line">    AudioClip clip = audioClipUnit.Asset <span class="keyword">as</span> AudioClip;       </span><br><span class="line"></span><br><span class="line">    AudioManager.Instance.PlayBgAudio(clip);</span><br><span class="line"></span><br><span class="line">    EventCenter.AddListener&lt;CEvent&gt;(EGameEvent.eGameEvent_InputUserData, OnEvent);</span><br><span class="line">    EventCenter.AddListener&lt;CEvent&gt;(EGameEvent.eGameEvent_IntoLobby, OnEvent);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过类的继承关系知道，它也不是继承mono的，所以它有自己的构造函数，它继承了父类的Enter函数。这个函数主要是处理状态的改变，以及将窗体的实例化，同时调用MVC的Controller模块中的Enter函数进行View窗体的显示。当然从逻辑上说在该函数中可以添加事件的监听。前面已经提过State没有继承mono，所以它不能挂到对象上直接使用。它调用与它相关的类挂到对象上，每个窗体都有自己的State状态，这么多状态也需要一个状态管理类去管理控制，下面实现GameStateManager类的设计。其架构设计和上面讲述的窗体设计的管理类类似，这里就不展示架构图了，先把完整的代码实现写出来。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.GameState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> GameStateType</span><br><span class="line">    &#123;</span><br><span class="line">        GS_Continue,</span><br><span class="line">        GS_Login,</span><br><span class="line">        GS_User,</span><br><span class="line">        GS_Lobby,</span><br><span class="line">        GS_Room,</span><br><span class="line">        GS_Hero,</span><br><span class="line">        GS_Loading,</span><br><span class="line">        GS_Play,</span><br><span class="line">        GS_Over,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class GameStateManager : Singleton&lt;GameStateManager&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Dictionary&lt;GameStateType, IGameState&gt; gameStates;</span><br><span class="line">        IGameState currentState;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GameStateManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            gameStates = <span class="keyword">new</span> Dictionary&lt;GameStateType, IGameState&gt;();</span><br><span class="line"></span><br><span class="line">            IGameState gameState;</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> LoginState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> UserState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> LobbyState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> RoomState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> HeroState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> LoadingState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> PlayState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line"></span><br><span class="line">            gameState = <span class="keyword">new</span> OverState();</span><br><span class="line">            gameStates.Add(gameState.GetStateType(), gameState);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IGameState <span class="title">GetCurState</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> currentState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeGameStateTo</span>(<span class="params">GameStateType stateType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span>(currentState!=<span class="literal">null</span>&amp;&amp;currentState.GetStateType()!= GameStateType.GS_Loading &amp;&amp; currentState.GetStateType() == stateType)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (gameStates.ContainsKey(stateType))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentState != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    currentState.Exit();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                currentState = gameStates[stateType];</span><br><span class="line">                currentState.Enter();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">EnterDefaultState</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ChangeGameStateTo(GameStateType.GS_Login);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"><span class="keyword">float</span> fixedDeltaTime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentState != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                currentState.FixedUpdate(fixedDeltaTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="keyword">float</span> fDeltaTime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            GameStateType nextStateType = GameStateType.GS_Continue;</span><br><span class="line">            <span class="keyword">if</span> (currentState != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                nextStateType = currentState.Update(fDeltaTime);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextStateType &gt; GameStateType.GS_Continue)</span><br><span class="line">            &#123;</span><br><span class="line">                ChangeGameStateTo(nextStateType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IGameState <span class="title">getState</span>(<span class="params">GameStateType type</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!gameStates.ContainsKey(type))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> gameStates[type];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面代码可以看出，状态管理类的实现功能通过枚举变量public enum GameStateType，把游戏中涉及的所有状态列出来，状态的变换是通过设置的枚举值作为标记实现的。状态管理类首先要做的是把所有的状态在管理类的构造函数中加入到字典Dictionary中，便于统一管理。声明语句如下所示。</p>
<p>Dictionary&lt;GameStateType, IGameState&gt; gameStates;<br>在构造函数public GameStateManager（）中将所有的状态存储到已声明的字典中便于读取。在该类中最重要的函数是：public void ChangeGameStateTo（GameStateType stateType），这个是对外提供的，可以单独使用，也可以在函数public voidupdate（float timeDelta）中去设置。该函数的主要作用是改变游戏状态，它也是状态管理类中最重要的函数。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeGameStateTo</span>(<span class="params">GameStateType stateType</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(currentState!=<span class="literal">null</span>&amp;&amp;currentState.GetStateType()!= GameStateType.GS_Loading &amp;&amp; currentState.GetStateType() == stateType)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gameStates.ContainsKey(stateType))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentState != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                currentState.Exit();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentState = gameStates[stateType];</span><br><span class="line">            currentState.Enter();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>该函数在窗口切换中非常重要，凡是涉及状态变换都要调用这个函数，这样就为逻辑实现了统一的接口调用，下面开始窗体管理类的案例讲解。</p>
<h1 id="窗体管理类实现案例"><a href="#窗体管理类实现案例" class="headerlink" title="窗体管理类实现案例"></a><span style="color:#339AFF;">窗体管理类实现案例</span></h1><p>窗体管理类的主要作用是管理游戏页面中的所有UI面板。在现实生活中，买汽车都要到车辆管理所登记，方便对车进行管理，将其思想应用到程序里面就是所有在游戏中使用的UI都要在窗体管理类中注册。当然管理类不只是负责注册，游戏UI要互相切换，编写逻辑不能把UI之间的切换写死，要有个关于UI切换的统一流程，这样才能真正地实现切换功能。下面把窗口管理类完整的代码给大家展示一下。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Game;</span><br><span class="line"><span class="keyword">using</span> Game.GameState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.View</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> EScenesType</span><br><span class="line">    &#123;</span><br><span class="line">        EST_None,</span><br><span class="line">        EST_Login,</span><br><span class="line">        EST_Play,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> EWindowType</span><br><span class="line">    &#123;</span><br><span class="line">        EWT_LoginWindow, <span class="comment">//登录</span></span><br><span class="line">        EWT_UserWindow, <span class="comment">//用户</span></span><br><span class="line">        EWT_LobbyWindow,</span><br><span class="line">        EWT_BattleWindow,</span><br><span class="line">        EWT_RoomWindow,</span><br><span class="line">        EWT_HeroWindow,</span><br><span class="line">        EWT_BattleInfoWindow,</span><br><span class="line">        EWT_MarketWindow,</span><br><span class="line">        EWT_MarketHeroListWindow,</span><br><span class="line">        EWT_MarketHeroInfoWindow,</span><br><span class="line">        EWT_MarketRuneListWindow,</span><br><span class="line">        EWT_MarketRuneInfoWindow,</span><br><span class="line">        EWT_SocialWindow,</span><br><span class="line">        EWT_GamePlayWindow,</span><br><span class="line">        EWT_InviteWindow,</span><br><span class="line">        EWT_ChatTaskWindow,</span><br><span class="line">        EWT_ScoreWindow,</span><br><span class="line">        EWT_InviteAddRoomWindow,</span><br><span class="line">        EWT_RoomInviteWindow,</span><br><span class="line">        EWT_TeamMatchWindow,</span><br><span class="line">        EWT_TeamMatchInvitationWindow,</span><br><span class="line">        EWT_TeamMatchSearchingWindow,</span><br><span class="line">        EWT_MailWindow,</span><br><span class="line">        EWT_HomePageWindow,</span><br><span class="line">        EWT_PresonInfoWindow,</span><br><span class="line">        EWT_ServerMatchInvitationWindow,</span><br><span class="line">        EWT_SoleSoldierWindow,</span><br><span class="line">        EWT_MessageWindow,</span><br><span class="line">        EWT_MiniMapWindow,</span><br><span class="line">        EWT_VIPPrerogativeWindow,</span><br><span class="line">        EWT_RuneEquipWindow,</span><br><span class="line">        EWT_DaliyBonusWindow,</span><br><span class="line">        EWT_EquipmentWindow,</span><br><span class="line">        EWT_SystemNoticeWindow,</span><br><span class="line">        EWT_TimeDownWindow,</span><br><span class="line">        EWT_RuneCombineWindow,</span><br><span class="line">        EWT_HeroDatumWindow,</span><br><span class="line">        EWT_RuneRefreshWindow,</span><br><span class="line">        EWT_GamePlayGuideWindow,</span><br><span class="line">        EMT_PurchaseSuccessWindow,</span><br><span class="line">        EMT_GameSettingWindow,</span><br><span class="line">        EMT_AdvancedGuideWindow,</span><br><span class="line">        EMT_ExtraBonusWindow,</span><br><span class="line">        EMT_EnemyWindow,</span><br><span class="line">        EMT_HeroTimeLimitWindow,</span><br><span class="line">        EMT_SkillWindow,</span><br><span class="line">        EMT_SkillDescribleWindow,</span><br><span class="line">        EMT_RuneBuyWindow,</span><br><span class="line">        EMT_DeathWindow,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class WindowManager : Singleton&lt;WindowManager&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WindowManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            mWidowDic = <span class="keyword">new</span> Dictionary&lt;EWindowType, BaseWindow&gt;();</span><br><span class="line"></span><br><span class="line">            mWidowDic[EWindowType.EWT_LoginWindow] = <span class="keyword">new</span> LoginWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_UserWindow] = <span class="keyword">new</span> UserInfoWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_LobbyWindow] = <span class="keyword">new</span> LobbyWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_BattleWindow] = <span class="keyword">new</span> BattleWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_RoomWindow] = <span class="keyword">new</span> RoomWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_HeroWindow] = <span class="keyword">new</span> HeroWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_BattleInfoWindow] = <span class="keyword">new</span> BattleInfoWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MarketWindow] = <span class="keyword">new</span> MarketWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MarketHeroListWindow] = <span class="keyword">new</span> MarketHeroListWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MarketHeroInfoWindow] = <span class="keyword">new</span> MarketHeroInfoWindow();    </span><br><span class="line">            mWidowDic[EWindowType.EWT_SocialWindow] = <span class="keyword">new</span> SocialWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_GamePlayWindow] = <span class="keyword">new</span> GamePlayWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_InviteWindow] = <span class="keyword">new</span> InviteWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_ChatTaskWindow] = <span class="keyword">new</span> ChatTaskWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_ScoreWindow] = <span class="keyword">new</span> ScoreWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_InviteAddRoomWindow] = <span class="keyword">new</span> InviteAddRoomWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_RoomInviteWindow] = <span class="keyword">new</span> RoomInviteWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_TeamMatchWindow] = <span class="keyword">new</span> TeamMatchWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_TeamMatchInvitationWindow] = <span class="keyword">new</span> TeamMatchInvitationWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_TeamMatchSearchingWindow] = <span class="keyword">new</span> TeamMatchSearchingWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MailWindow] = <span class="keyword">new</span> MailWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_HomePageWindow] = <span class="keyword">new</span> HomePageWindow(); </span><br><span class="line">            mWidowDic[EWindowType.EWT_PresonInfoWindow] = <span class="keyword">new</span> PresonInfoWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_ServerMatchInvitationWindow] = <span class="keyword">new</span> ServerMatchInvitationWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_SoleSoldierWindow] = <span class="keyword">new</span> SoleSoldierWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MessageWindow] = <span class="keyword">new</span> MessageWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MarketRuneListWindow] = <span class="keyword">new</span> MarketRuneListWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MiniMapWindow] = <span class="keyword">new</span> MiniMapWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_MarketRuneInfoWindow] = <span class="keyword">new</span> MarketRuneInfoWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_VIPPrerogativeWindow] = <span class="keyword">new</span> VIPPrerogativeWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_RuneEquipWindow] = <span class="keyword">new</span> RuneEquipWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_DaliyBonusWindow] = <span class="keyword">new</span> DaliyBonusWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_EquipmentWindow] = <span class="keyword">new</span> EquipmentWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_SystemNoticeWindow] = <span class="keyword">new</span> SystemNoticeWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_TimeDownWindow] = <span class="keyword">new</span> TimeDownWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_RuneCombineWindow] = <span class="keyword">new</span> RuneCombineWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_HeroDatumWindow] = <span class="keyword">new</span> HeroDatumWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_RuneRefreshWindow] = <span class="keyword">new</span> RuneRefreshWindow();</span><br><span class="line">            mWidowDic[EWindowType.EWT_GamePlayGuideWindow] = <span class="keyword">new</span> GamePlayGuideWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_PurchaseSuccessWindow] = <span class="keyword">new</span> PurchaseSuccessWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_GameSettingWindow] = <span class="keyword">new</span> GameSettingWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_AdvancedGuideWindow] = <span class="keyword">new</span> AdvancedGuideWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_ExtraBonusWindow] = <span class="keyword">new</span> ExtraBonusWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_EnemyWindow] = <span class="keyword">new</span> EnemyWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_HeroTimeLimitWindow] = <span class="keyword">new</span> HeroTimeLimitWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_SkillWindow] = <span class="keyword">new</span> SkillWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_SkillDescribleWindow] = <span class="keyword">new</span> SkillDescribleWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_RuneBuyWindow] = <span class="keyword">new</span> RuneBuyWindow();</span><br><span class="line">            mWidowDic[EWindowType.EMT_DeathWindow] = <span class="keyword">new</span> DeathWindow();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BaseWindow <span class="title">GetWindow</span>(<span class="params">EWindowType type</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mWidowDic.ContainsKey(type))</span><br><span class="line">                <span class="keyword">return</span> mWidowDic[type];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="keyword">float</span> deltaTime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (BaseWindow pWindow <span class="keyword">in</span> mWidowDic.Values)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pWindow.IsVisible())</span><br><span class="line">                &#123;</span><br><span class="line">                    pWindow.Update(deltaTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeScenseToPlay</span>(<span class="params">EScenesType front</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (BaseWindow pWindow <span class="keyword">in</span> mWidowDic.Values)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pWindow.GetScenseType() == EScenesType.EST_Play)</span><br><span class="line">                &#123;</span><br><span class="line">                    pWindow.Init();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(pWindow.IsResident())</span><br><span class="line">                    &#123;</span><br><span class="line">                        pWindow.PreLoad();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((pWindow.GetScenseType() == EScenesType.EST_Login) &amp;&amp; (front == EScenesType.EST_Login))</span><br><span class="line">                &#123;</span><br><span class="line">                    pWindow.Hide();</span><br><span class="line">                    pWindow.Realse();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (pWindow.IsResident())</span><br><span class="line">                    &#123;</span><br><span class="line">                        pWindow.DelayDestory();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeScenseToLogin</span>(<span class="params">EScenesType front</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (BaseWindow pWindow <span class="keyword">in</span> mWidowDic.Values)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (front == EScenesType.EST_None &amp;&amp; pWindow.GetScenseType() == EScenesType.EST_None)</span><br><span class="line">                &#123;</span><br><span class="line">                    pWindow.Init();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (pWindow.IsResident())</span><br><span class="line">                    &#123;</span><br><span class="line">                        pWindow.PreLoad();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pWindow.GetScenseType() == EScenesType.EST_Login)</span><br><span class="line">                &#123;</span><br><span class="line">                    pWindow.Init();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (pWindow.IsResident())</span><br><span class="line">                    &#123;</span><br><span class="line">                        pWindow.PreLoad();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((pWindow.GetScenseType() == EScenesType.EST_Play) &amp;&amp; (front == EScenesType.EST_Play))</span><br><span class="line">                &#123;</span><br><span class="line">                    pWindow.Hide();</span><br><span class="line">                    pWindow.Realse();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (pWindow.IsResident())</span><br><span class="line">                    &#123;</span><br><span class="line">                        pWindow.DelayDestory();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 隐藏所有的窗体</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="front"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HideAllWindow</span>(<span class="params">EScenesType front</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> mWidowDic)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (front == item.Value.GetScenseType())</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(item.Key);</span><br><span class="line">                    item.Value.Hide();</span><br><span class="line">                    <span class="comment">//item.Value.Realse();</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ShowWindowOfType</span>(<span class="params">EWindowType type</span>)</span></span><br><span class="line"><span class="function"></span>        &#123; </span><br><span class="line">            BaseWindow window;</span><br><span class="line">            <span class="keyword">if</span>(!mWidowDic.TryGetValue(type , <span class="keyword">out</span> window))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            window.Show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;EWindowType, BaseWindow&gt; mWidowDic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>窗体管理类的实现思路和状态管理类的实现思路类似，也需要先通过枚举把所有的窗体列出来，然后把窗体在已经定义好的字典Dictionary中注册，并且提供了获取某个窗体函数public BaseWindow GetWindow（EWindowType type）和场景跳转函数接口public void ChangeScense ToPlay（EScenesType front）以及场景跳转到UI函数接口public void ChangeScenseToLogin（EScenesType front），因为在游戏中我们只设计了登录场景login和游戏场景play，所以提供这两个接口就可以实现场景之间的跳转。两个跳转函数功能类似，下面我们以ChangeSceneToPlay为例，将其函数实现内容给大家展示一下。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeScenseToPlay</span>(<span class="params">EScenesType front</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (BaseWindow pWindow <span class="keyword">in</span> mWidowDic.Values)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pWindow.GetScenseType() == EScenesType.EST_Play)</span><br><span class="line">        &#123;</span><br><span class="line">            pWindow.Init();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(pWindow.IsResident())</span><br><span class="line">            &#123;</span><br><span class="line">                pWindow.PreLoad();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pWindow.GetScenseType() == EScenesType.EST_Login) &amp;&amp; (front == EScenesType.EST_Login))</span><br><span class="line">        &#123;</span><br><span class="line">            pWindow.Hide();</span><br><span class="line">            pWindow.Realse();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pWindow.IsResident())</span><br><span class="line">            &#123;</span><br><span class="line">                pWindow.DelayDestory();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数实现了窗体的初始化、窗体的更新、窗体的隐藏、窗体的破坏等功能，这样关于MVC的架构设计到此就全部讲完了，接下来通过案例的方式告诉大家怎么去使用它。</p>
<h1 id="MVC案例分享"><a href="#MVC案例分享" class="headerlink" title="MVC案例分享"></a><span style="color:#339AFF;">MVC案例分享</span></h1><p>首先需要把用到的UI资源做好，UI界面使用的是NGUI。如果使用UGUI，那么原理也是一样的。案例中只做了三个界面之间的切换，来应用MVC框架。首先要做的是实时检测State状态的改变，这需要将其代码放置到Update函数中，该脚本需要挂接到对象上，我们可以自己编写一个继承mono的脚本，直接挂到对象上，并且该对象不被销毁，函数代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//更新游戏状态机</span></span><br><span class="line">    GameStateManager.Instance.Update(Time.deltaTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//UI更新</span></span><br><span class="line">    WindowManager.Instance.Update(Time.deltaTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Awake函数和Start函数中要设置默认的状态函数，也就是说首先切换场景，然后设置默认状态，代码如下所示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WindowManager.Instance.ChangeScenseToLogin(EScenesType.EST_None);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GameStateManager.Instance.EnterDefaultState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用NGUI建三个面板窗口并将它们实例化出来，效果如图6所示。</p>
<blockquote>
<p>图6 UI实例化面板</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/6.jpg">

<p>这些实例化的UI是可以动态加载创建出来的，接下来就可以直接运行程序，动态加载的代码大家可以自己去实现，UI的第一个面板是登录面板，效果如图7所示。</p>
<blockquote>
<p>图7 UI登录面板</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/7.jpg">

<p>UI的第二个面板是创建角色面板，效果如图8所示。</p>
<blockquote>
<p>图8 UI创建角色面板</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/8.jpg">

<p>UI的第三个面板是创建关卡面板，界面效果如图9所示。</p>
<blockquote>
<p>图9 UI关卡面板</p>
</blockquote>
<img src="/2019/09/05/MVC架构设计/9.jpg">

<p>利用该架构实现了界面的搭建以及各个界面之间的切换功能。</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a><span style="color:#339AFF;">小结</span></h1><p>MVC对于UI的架构设计是非常方便的，我已经在多款游戏中使用，证明该架构设计对大部分游戏来说都是适用的。当然任何事情都不是绝对的，希望该架构能对开发者有所启发，并在未来能够做出更适合团队开发的架构系统。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Unity-3D实战核心技术详解/" rel="tag"># Unity 3D实战核心技术详解</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/04/迭代器与Unity协程/" rel="next" title="迭代器与Unity协程">
                <i class="fa fa-chevron-left"></i> 迭代器与Unity协程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/05/基于消息机制的Unity框架/" rel="prev" title="基于消息机制的Unity框架">
                基于消息机制的Unity框架 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Chebin">
            
              <p class="site-author-name" itemprop="name">Chebin</p>
              <div class="site-description motion-element" itemprop="description">记录自己的学习过程</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">457</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2019/09/18/命令模式-1/" title="命令模式" target="_blank">命令模式</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/18/在Unity中实现游戏命令模式/" title="在Unity中实现游戏命令模式" target="_blank">在Unity中实现游戏命令模式</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/18/职责链模式-1/" title="职责链模式" target="_blank">职责链模式</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/18/Editor/" title="Editor" target="_blank">Editor</a>
                  </li>
                
                  <li>
                    <a href="/2019/09/18/UguiEventListener/" title="UguiEventListener" target="_blank">UguiEventListener</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MVC代码模块设计"><span class="nav-number">2.</span> <span class="nav-text">MVC代码模块设计</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事件代码实现案例"><span class="nav-number">3.</span> <span class="nav-text">事件代码实现案例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#窗体基类的实现案例"><span class="nav-number">4.</span> <span class="nav-text">窗体基类的实现案例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#窗体子类代码实现案例"><span class="nav-number">5.</span> <span class="nav-text">窗体子类代码实现案例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#控制类实现案例"><span class="nav-number">6.</span> <span class="nav-text">控制类实现案例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#状态类设计实现"><span class="nav-number">7.</span> <span class="nav-text">状态类设计实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#窗体管理类实现案例"><span class="nav-number">8.</span> <span class="nav-text">窗体管理类实现案例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MVC案例分享"><span class="nav-number">9.</span> <span class="nav-text">MVC案例分享</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小结"><span class="nav-number">10.</span> <span class="nav-text">小结</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chebin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">3m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">45:04</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
